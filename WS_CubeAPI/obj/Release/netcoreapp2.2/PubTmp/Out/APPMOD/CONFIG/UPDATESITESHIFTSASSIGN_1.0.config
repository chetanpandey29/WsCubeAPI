--UPDATESITESHIFTSASSIGN_1.0
DECLARE @CC_TIMESTAMP DATETIME
SET @CC_TIMESTAMP=GETDATE()
CREATE TABLE #SHIFTLIST(SHIFTID INT)
INSERT INTO #SHIFTLIST(SHIFTID)
SELECT RESULT FROM  dbo.CSVtoTable(@SHIFTID)

UPDATE SS
SET STATUS = 1 ,
UPDATEDBY = @USERID,
UPDATEDDATE = @CC_TIMESTAMP
FROM SITESHIFTS SS
INNER JOIN #SHIFTLIST S ON S.SHIFTID=SS.SHIFTID
WHERE STATUS = 0 AND SITEID = @SITEID


INSERT INTO SITESHIFTS(SITEID,SHIFTID,STATUS,UPDATEDBY,UPDATEDDATE)
SELECT @SITEID,SHIFTID,1,@USERID,@CC_TIMESTAMP FROM #SHIFTLIST S
WHERE NOT EXISTS(SELECT 1 FROM SITESHIFTS WHERE SITEID=@SITEID AND SHIFTID=S.SHIFTID)

UPDATE SS
SET STATUS = 0,
UPDATEDBY = @USERID,
UPDATEDDATE = @CC_TIMESTAMP
FROM SITESHIFTS SS
WHERE SITEID = @SITEID
AND NOT EXISTS(SELECT 1 FROM #SHIFTLIST WHERE SHIFTID=SS.SHIFTID)


INSERT INTO dbo.AUDIT(TABLENAME,TRANS,STAMP,LASTUPDATEDBY,DATA)
SELECT 'SITESHIFTS','UPDATE-UPDATESITESHIFTSASSIGN_1.0',@CC_TIMESTAMP,@USERID,NULL

DROP TABLE #SHIFTLIST
