IF @ROLEID=1
BEGIN
IF ISNULL(@SITEID,'')=''
SELECT DISTINCT U.USERID,LASTNAME+' '+FIRSTNAME+CASE WHEN U.STATUS =0 THEN '( InActive )' WHEN U.STATUS =4 THEN '( Locked )' ELSE '' END FULLNAME FROM USERS U
INNER JOIN USERINFO UI ON UI.USERID = U.USERID
WHERE UI.USERTYPEID IN (1,2) AND U.STATUS IN(0,1,4)
ORDER BY  FULLNAME
ELSE
SELECT DISTINCT U.USERID,LASTNAME+' '+FIRSTNAME+CASE WHEN U.STATUS =0 THEN '( InActive )' WHEN U.STATUS =4 THEN '( Locked )'  ELSE '' END FULLNAME FROM USERS U
INNER JOIN USERINFO UI ON UI.USERID = U.USERID
INNER JOIN USERSITES US ON US.USERID = U.USERID
INNER JOIN dbo.CSVtoTable(@SITEID) R ON R.RESULT=US.SITEID
WHERE U.STATUS IN (0,1,4) AND UI.USERTYPEID IN (1,2) AND US.STATUS=1
ORDER BY  FULLNAME
END
ELSE
BEGIN
IF ISNULL(@SITEID,'')=''
SELECT DISTINCT U.USERID,LASTNAME+' '+FIRSTNAME+CASE WHEN U.STATUS =0 THEN '( InActive )' WHEN U.STATUS =4 THEN '( Locked )'  ELSE '' END FULLNAME FROM USERS U
INNER JOIN USERSITES US ON US.USERID = U.USERID
INNER JOIN USERINFO UI ON UI.USERID = U.USERID
WHERE U.STATUS IN(0,1,4) AND US.STATUS=1 AND US.SITEID IN (SELECT SITEID FROM USERSITES WHERE USERID = @USERID AND STATUS=1)
AND UI.USERTYPEID IN (1,2)
ORDER BY  FULLNAME
ELSE
SELECT DISTINCT U.USERID,LASTNAME+' '+FIRSTNAME+CASE WHEN U.STATUS =0 THEN '( InActive )' WHEN U.STATUS =4 THEN '( Locked )'  ELSE '' END FULLNAME FROM USERS U
INNER JOIN USERINFO UI ON UI.USERID = U.USERID
INNER JOIN USERSITES US ON US.USERID = U.USERID
INNER JOIN dbo.CSVtoTable(@SITEID) R ON R.RESULT=US.SITEID
WHERE U.STATUS IN(0,1,4) AND US.STATUS=1
AND UI.USERTYPEID IN (1,2)
ORDER BY  FULLNAME
END