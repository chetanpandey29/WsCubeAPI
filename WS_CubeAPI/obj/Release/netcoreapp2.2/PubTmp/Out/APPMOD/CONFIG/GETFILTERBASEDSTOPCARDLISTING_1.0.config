--GETFILTERBASEDSTOPCARDLISTING_1.0
CREATE TABLE #FINALRESULTS (CARDID NVARCHAR(16) PRIMARY KEY,CARDID1 INT,[OBSERVATION DATE] VARCHAR(32),OBSERVER INT,[AREAS] INT,[SUBAREAID] INT,[STATUS] NVARCHAR(64),[OBSDATE] DATETIME,CREATEDBY INT,APPROVALSTATUS INT,SORTBY INT,ISOBSERVER INT)
CREATE TABLE #FINALRESULTS1 (ID INT IDENTITY(1,1),CARDID INT,[OBSERVATION DATE] VARCHAR(32),OBSERVER NVARCHAR(512),[AREAS] NVARCHAR(512),[SUBAREANAME] NVARCHAR(512),[STATUS] NVARCHAR(64),[OBSDATE] DATETIME,CREATEDBY INT,APPROVALSTATUS INT,SORTBY INT)

DECLARE @QRY VARCHAR(MAX),@QRY1 VARCHAR(MAX),@ISADMIN VARCHAR(8),@FDATE VARCHAR(32),@TDATE VARCHAR(32),@UTCDATE DATETIME,@DURATION INT
SET @ISADMIN='0'
SELECT @FDATE='',@TDATE=''

SELECT @DURATION=DURATION FROM TIMEZONES WHERE TIMEZONEID IN (SELECT TIMEZONE FROM USERINFO WHERE USERID=@USERID)
SELECT @UTCDATE=DATEADD(MI,@DURATION,GETUTCDATE())--DBO.USERTIMEEMAIL(GETUTCDATE(),1,@DURATION)

IF @FILTERDATETYPE='YTD'
BEGIN
SET @FDATE='01/01/'+CAST(YEAR(@UTCDATE) AS VARCHAR(8))
SET @TDATE=CONVERT(NVARCHAR(32),@UTCDATE,101)
END
ELSE IF @FILTERDATETYPE='CMY'
BEGIN
SET @FDATE=CAST(MONTH(@UTCDATE) AS VARCHAR(8))+'/01/'+CAST(YEAR(@UTCDATE) AS VARCHAR(8))
SET @TDATE=CONVERT(NVARCHAR(32),@UTCDATE,101)
END
ELSE IF @FILTERDATETYPE='FTDATE'
BEGIN
SET @FDATE=@FROMDATE
SET @TDATE=@TODATE
END
ELSE IF @FILTERDATETYPE='PRVMONTH'
BEGIN
SET @FDATE=CAST(MONTH(DATEADD(MM,-(CAST(@FROMDATE AS INT)),@UTCDATE)) AS NVARCHAR(8))+'/01/'+CAST(YEAR(DATEADD(MM,-(CAST(@FROMDATE AS INT)),@UTCDATE)) AS NVARCHAR(8))
SET @TDATE=CASE WHEN @TODATE='1' THEN CONVERT(NVARCHAR(32),@UTCDATE,101) ELSE CONVERT(NVARCHAR(32),(DATEADD(S,-1,DATEADD(MM, DATEDIFF(M,0,@UTCDATE),0))),101) END
END

IF EXISTS(SELECT 1 FROM ROLES WHERE ALLSITES=1 AND ROLEID =(SELECT DEFAULTROLEID FROM USERINFO WHERE USERID = @USERID))
SET @ISADMIN='1'

CREATE TABLE #INPUTSITES(SITEID INT)
CREATE TABLE #INPUTAREAS(AREAID INT)
CREATE TABLE #INPUTSUBAREAS(SUBAREAID INT)
CREATE TABLE #INPUTSHIFTS(SHIFTID INT)
CREATE TABLE #INPUTOBS(OBSERVERID INT)
SET @QRY=''
SET @QRY1=''
SELECT @QRY1='
INSERT INTO #INPUTSITES
SELECT RESULT FROM DBO.CSVTOTABLE('''+@SITEID+''') '
EXEC(@QRY1)
SET @QRY1=''
SELECT @QRY1='
INSERT INTO #INPUTAREAS
SELECT RESULT FROM DBO.CSVTOTABLE('''+@AREAID+''') '
EXEC(@QRY1)
SET @QRY1=''
SELECT @QRY1='
INSERT INTO #INPUTSUBAREAS
SELECT RESULT FROM DBO.CSVTOTABLE('''+@SUBAREAID+''') '
EXEC(@QRY1)
SET @QRY1=''
SELECT @QRY1='
INSERT INTO #INPUTSHIFTS
SELECT RESULT FROM DBO.CSVTOTABLE('''+@SHIFTID+''') '
EXEC(@QRY1)
SET @QRY1=''
SELECT @QRY1='
INSERT INTO #INPUTOBS
SELECT RESULT FROM DBO.CSVTOTABLE('''+@OBSERVERID+''') '
EXEC(@QRY1)
SET @QRY1=''
IF @OBSAPPROVALPC = 0
BEGIN
SELECT @QRY='
DECLARE @ROLEID INT,@COPYFROM INT
SELECT @ROLEID = DEFAULTROLEID FROM USERINFO WHERE USERID = '+ @USERID + '
SELECT @COPYFROM =COPYFROM FROM ROLES WHERE ROLEID = @ROLEID

DECLARE @DTFORMAT INT
SELECT @DTFORMAT=ISNULL(DATEFORMAT,101) FROM USERINFO WHERE USERID ='+ @USERID + '
INSERT INTO #FINALRESULTS(CARDID,CARDID1,[OBSERVATION DATE],OBSERVER,[AREAS],[SUBAREAID],[STATUS],[OBSDATE],CREATEDBY,APPROVALSTATUS,SORTBY,ISOBSERVER)
SELECT DISTINCT
''1-''+CAST(SCE.CARDID AS NVARCHAR(16)),SCE.CARDID,CONVERT(VARCHAR,OBSERVATIONDATE,@DTFORMAT)[OBSERVATION DATE],
CASE OBSERVERCOUNT WHEN 0 THEN  SCOB.OBSERVERID ELSE NULL END [OBSERVER],
SCE.AREAID [AREAS],SCE.SUBAREAID,
CASE WHEN SCE.[STATUS]= 1 THEN ''LBLACTIVE'' WHEN SCE.[STATUS] = 0 THEN ''LBLINACTIVE''END AS [STATUS]
,SCE.OBSERVATIONDATE [OBSDATE]
--,CASE WHEN EXISTS(SELECT 1 FROM STOPCARDENTRYOBSERVERS WHERE CARDID=SCE.CARDID AND OBSERVERID='+CAST(@USERID AS VARCHAR(32))+') OR SCE.CREATEDBY='+CAST(@USERID AS VARCHAR(32))+' THEN SCE.CREATEDBY ELSE -1 END
,CASE WHEN  SCOB1.OBSERVERID='+CAST(@USERID AS VARCHAR(32))+' OR SCE.CREATEDBY='+CAST(@USERID AS VARCHAR(32))+' THEN SCE.CREATEDBY ELSE -1 END
,4,2 [SORTBY]
--,CASE WHEN EXISTS(SELECT 1 FROM STOPCARDENTRYOBSERVERS WHERE CARDID =SCE.CARDID AND OBSERVERID='+CAST(@USERID AS VARCHAR(32))+') AND (@ROLEID=5 OR @COPYFROM=5)  THEN 1 ELSE 0 END
,CASE WHEN  SCOB1.OBSERVERID='+CAST(@USERID AS VARCHAR(32))+' AND (@ROLEID=5 OR @COPYFROM=5) THEN 1 ELSE 0 END
FROM STOPCARDENTRY SCE
'
+CASE WHEN ISNULL(@UNSAFEOBS,'')='' AND ISNULL(@UNSAFEOBSWITHOUTCA,'')='' THEN ' ' ELSE ' INNER JOIN STOPCARDENTRYOBSERVATIONS SCOO ON SCOO.CARDID=SCE.CARDID ' END
+CASE WHEN ISNULL(@UNSAFEOBSWITHOUTCA,'')='' THEN ' ' ELSE ' LEFT JOIN STOPCARDENTRYCATEGORYCOMMENTS SCC ON SCC.CARDID=SCE.CARDID AND SCC.MAINCATEGORYID=SCOO.MAINCATEGORYID AND SCC.SUBCATEGORYID=SCOO.SUBCATEGORYID' END
+CASE WHEN ISNULL(@SITEID,'')='' THEN
CASE WHEN @ISADMIN='1' THEN ' INNER JOIN SITES SS ON SS.SITEID=SCE.SITEID AND SS.STATUS =1 ' ELSE
'INNER JOIN USERSITES US ON US.USERID = '+ @USERID + ' AND US.SITEID =SCE.SITEID AND US.STATUS = 1' END

ELSE ' INNER JOIN #INPUTSITES SR ON SR.SITEID=SCE.SITEID' END
+CASE WHEN ISNULL(@AREAID,'')='' THEN '' ELSE ' INNER JOIN #INPUTAREAS SA ON SA.AREAID=SCE.AREAID' END
+CASE WHEN ISNULL(@SUBAREAID,'')='' THEN '' ELSE ' INNER JOIN #INPUTSUBAREAS SU1 ON SU1.SUBAREAID=SCE.SUBAREAID' END
+CASE WHEN ISNULL(@SHIFTID,'')='' THEN '' ELSE ' INNER JOIN #INPUTSHIFTS SHR ON SHR.SHIFTID=SCE.SHIFTID' END
+CASE WHEN ISNULL(@OBSERVERID,'')='' THEN '' ELSE ' INNER JOIN STOPCARDENTRYOBSERVERS SCO ON SCO.CARDID=SCE.CARDID
INNER JOIN #INPUTOBS [OR] ON [OR].OBSERVERID=SCO.OBSERVERID' END
+' LEFT JOIN STOPCARDENTRYOBSERVERS SCOB ON SCOB.CARDID=SCE.CARDID '
+' LEFT JOIN STOPCARDENTRYOBSERVERS SCOB1 ON SCOB1.CARDID=SCE.CARDID AND SCOB1.OBSERVERID='+CAST(@USERID AS VARCHAR(32))
+' WHERE  STOPCARDTYPE = 1 '
+CASE WHEN ISNULL(@FDATE,'')='' THEN '' ELSE ' AND SCE.OBSERVATIONDATE BETWEEN CONVERT(DATETIME,'''+@FDATE+''') AND CONVERT(DATETIME,'''+@TDATE+''')' END
+CASE WHEN ISNULL(@STATUSID,'')='' THEN ' AND SCE.[STATUS]!=2 ' ELSE ' AND SCE.[STATUS] IN('+ @STATUSID + ')' END
+CASE WHEN ISNULL(@INCOMPLETEOBSERVATIONID,'')='' THEN ' ' ELSE ' AND SCE.ISINCOMPLETEOBS = 1' END
+CASE WHEN ISNULL(@CHECKLISTSETUPID,'')='' THEN ' ' ELSE ' AND SCE.CHECKLISTSETUPID IN('+ @CHECKLISTSETUPID + ')' END
+CASE WHEN ISNULL(@UNSAFEOBS,'')='' THEN ' ' ELSE ' AND SCOO.UNSAFE>0 ' END
+CASE WHEN ISNULL(@UNSAFEOBSWITHOUTCA,'')='' THEN ' ' ELSE ' AND ((SCOO.UNSAFE>0 AND ISNULL(SCOO.CAEXISTS,0)=0) OR (LEN(SCC.UNSAFECOMMENTS)>0 AND ISNULL(SCOO.CAEXISTS,0)=0)) ' END

SET @QRY1=' UNION  SELECT DISTINCT
''1-''+CAST(SCE.CARDID AS NVARCHAR(16)),SCE.CARDID,CONVERT(VARCHAR,OBSERVATIONDATE,@DTFORMAT)[OBSERVATION DATE],
CASE OBSERVERCOUNT WHEN 0 THEN  SCOB.OBSERVERID ELSE NULL END [OBSERVER],
SCE.AREAID [AREAS],SCE.SUBAREAID,
CASE WHEN SCE.[STATUS]= 1 THEN ''LBLACTIVE'' WHEN SCE.[STATUS] = 0 THEN ''LBLINACTIVE''END AS [STATUS]
,SCE.OBSERVATIONDATE [OBSDATE]
--,CASE WHEN EXISTS(SELECT 1 FROM STOPCARDENTRYOBSERVERS WHERE CARDID=SCE.CARDID AND OBSERVERID='+CAST(@USERID AS VARCHAR(32))+') OR SCE.CREATEDBY='+CAST(@USERID AS VARCHAR(32))+' THEN SCE.CREATEDBY ELSE -1 END
,CASE WHEN  SCOB1.OBSERVERID='+CAST(@USERID AS VARCHAR(32))+' OR SCE.CREATEDBY='+CAST(@USERID AS VARCHAR(32))+' THEN SCE.CREATEDBY ELSE -1 END
,4 APPROVALSTATUS
,2 [SORTBY]
--,CASE WHEN EXISTS(SELECT 1 FROM STOPCARDENTRYOBSERVERS WHERE CARDID =SCE.CARDID AND OBSERVERID='+CAST(@USERID AS VARCHAR(32))+') AND (@ROLEID=5 OR @COPYFROM=5)  THEN 1 ELSE 0 END
,CASE WHEN  SCOB1.OBSERVERID='+CAST(@USERID AS VARCHAR(32))+' AND (@ROLEID=5 OR @COPYFROM=5) THEN 1 ELSE 0 END
FROM STOPCARDENTRY SCE
'
+CASE WHEN ISNULL(@UNSAFEOBS,'')='' AND ISNULL(@UNSAFEOBSWITHOUTCA,'')='' THEN ' ' ELSE ' INNER JOIN STOPCARDENTRYOBSERVATIONS SCOO ON SCOO.CARDID=SCE.CARDID ' END
+CASE WHEN ISNULL(@UNSAFEOBSWITHOUTCA,'')='' THEN ' ' ELSE ' LEFT JOIN STOPCARDENTRYCATEGORYCOMMENTS SCC ON SCC.CARDID=SCE.CARDID AND SCC.MAINCATEGORYID=SCOO.MAINCATEGORYID AND SCC.SUBCATEGORYID=SCOO.SUBCATEGORYID' END
+CASE WHEN ISNULL(@SITEID,'')='' THEN
CASE WHEN @ISADMIN='1' THEN ' INNER JOIN SITES SS ON SS.SITEID=SCE.SITEID AND SS.STATUS =1 ' ELSE
'INNER JOIN USERSITES US ON US.USERID = '+ @USERID + ' AND US.SITEID =SCE.SITEID AND US.STATUS = 1' END

ELSE ' INNER JOIN #INPUTSITES SR ON SR.SITEID=SCE.SITEID ' END
+CASE WHEN ISNULL(@AREAID,'')='' THEN '' ELSE ' INNER JOIN #INPUTAREAS SA ON SA.AREAID=SCE.AREAID ' END
+CASE WHEN ISNULL(@SUBAREAID,'')='' THEN '' ELSE ' INNER JOIN #INPUTSUBAREAS SU1 ON SU1.SUBAREAID=SCE.SUBAREAID' END
+CASE WHEN ISNULL(@SHIFTID,'')='' THEN '' ELSE '  INNER JOIN #INPUTSHIFTS SHR ON SHR.SHIFTID=SCE.SHIFTID ' END
+CASE WHEN ISNULL(@OBSERVERID,'')='' THEN '' ELSE ' INNER JOIN STOPCARDENTRYOBSERVERS SCO ON SCO.CARDID=SCE.CARDID
INNER JOIN #INPUTOBS [OR] ON [OR].OBSERVERID=SCO.OBSERVERID ' END
+' LEFT JOIN STOPCARDENTRYOBSERVERS SCOB ON SCOB.CARDID=SCE.CARDID '
+' LEFT JOIN STOPCARDENTRYOBSERVERS SCOB1 ON SCOB1.CARDID=SCE.CARDID AND SCOB1.OBSERVERID='+CAST(@USERID AS VARCHAR(32))
+' WHERE  STOPCARDTYPE = 1  '
+' AND SCE.CREATEDBY='+CAST(@USERID AS VARCHAR(8))
+CASE WHEN ISNULL(@FDATE,'')='' THEN '' ELSE ' AND SCE.OBSERVATIONDATE BETWEEN CONVERT(DATETIME,'''+@FDATE+''') AND CONVERT(DATETIME,'''+@TDATE+''')' END
+CASE WHEN ISNULL(@STATUSID,'')='' THEN ' AND SCE.[STATUS]!=2 ' ELSE ' AND SCE.[STATUS] IN('+ @STATUSID + ')' END
+CASE WHEN ISNULL(@INCOMPLETEOBSERVATIONID,'')='' THEN ' ' ELSE ' AND SCE.ISINCOMPLETEOBS = 1' END
+CASE WHEN ISNULL(@CHECKLISTSETUPID,'')='' THEN ' ' ELSE ' AND SCE.CHECKLISTSETUPID IN('+ @CHECKLISTSETUPID + ')' END
+CASE WHEN ISNULL(@UNSAFEOBS,'')='' THEN ' ' ELSE ' AND SCOO.UNSAFE>0 ' END
+CASE WHEN ISNULL(@UNSAFEOBSWITHOUTCA,'')='' THEN ' ' ELSE ' AND ((SCOO.UNSAFE>0 AND ISNULL(SCOO.CAEXISTS,0)=0) OR (LEN(SCC.UNSAFECOMMENTS)>0 AND ISNULL(SCOO.CAEXISTS,0)=0)) ' END
PRINT @QRY
EXEC(@QRY+@QRY1)
END
ELSE IF @OBSAPPROVALPC = 1

BEGIN
SET @QRY=''
SELECT @QRY='
DECLARE @ROLEID INT,@COPYFROM INT
SELECT @ROLEID = DEFAULTROLEID FROM USERINFO WHERE USERID = '+ @USERID + '
SELECT @COPYFROM =COPYFROM FROM ROLES WHERE ROLEID = @ROLEID

DECLARE @DTFORMAT INT
SELECT @DTFORMAT=ISNULL(DATEFORMAT,101) FROM USERINFO WHERE USERID ='+ @USERID + '
INSERT INTO #FINALRESULTS(CARDID,CARDID1,[OBSERVATION DATE],OBSERVER,[AREAS],[SUBAREAID],[STATUS],[OBSDATE],CREATEDBY,APPROVALSTATUS,SORTBY,ISOBSERVER)
SELECT DISTINCT
''0-''+CAST(SCE.CARDID AS NVARCHAR(16)),SCE.CARDID,CONVERT(VARCHAR,OBSERVATIONDATE,@DTFORMAT)[OBSERVATION DATE],
CASE OBSERVERCOUNT WHEN 0 THEN  SCOB.OBSERVERID ELSE NULL END [OBSERVER],
SCE.AREAID [AREAS],SCE.SUBAREAID,
CASE SCE.[APPROVALSTATUS] WHEN 1 THEN ''LBLWAITINGAPPROVAL'' WHEN 2 THEN ''LBLUPDATEREQUESTED''  WHEN 3 THEN ''LBLRESUBMITTED'' END AS [STATUS]
,SCE.OBSERVATIONDATE [OBSDATE]
--,CASE WHEN EXISTS(SELECT 1 FROM STOPCARDENTRYOBSERVERS_OL WHERE CARDID=SCE.CARDID AND OBSERVERID='+CAST(@USERID AS VARCHAR(32))+') OR SCE.CREATEDBY='+CAST(@USERID AS VARCHAR(32))+' THEN SCE.CREATEDBY ELSE -1 END
,CASE WHEN  SCOB1.OBSERVERID='+CAST(@USERID AS VARCHAR(32))+' OR SCE.CREATEDBY='+CAST(@USERID AS VARCHAR(32))+' THEN SCE.CREATEDBY ELSE -1 END
,APPROVALSTATUS
,CASE APPROVALSTATUS WHEN 2 THEN 1 WHEN 3 THEN 2 WHEN 1 THEN 3  WHEN 4 THEN 4 END [SORTBY]
--,CASE WHEN EXISTS(SELECT 1 FROM STOPCARDENTRYOBSERVERS_OL WHERE CARDID =SCE.CARDID AND OBSERVERID='+CAST(@USERID AS VARCHAR(32))+') AND (@ROLEID=5 OR @COPYFROM=5)  THEN 1 ELSE 0 END
,CASE WHEN  SCOB1.OBSERVERID='+CAST(@USERID AS VARCHAR(32))+' AND (@ROLEID=5 OR @COPYFROM=5) THEN 1 ELSE 0 END
FROM STOPCARDENTRY_OL SCE
'
+CASE WHEN ISNULL(@UNSAFEOBS,'')='' THEN ' ' ELSE ' INNER JOIN STOPCARDENTRYOBSERVATIONS_OL SCO1 ON SCO1.CARDID=SCE.CARDID ' END
+CASE WHEN ISNULL(@SITEID,'')='' THEN
CASE WHEN @ISADMIN='1' THEN ' INNER JOIN SITES SS ON SS.SITEID=SCE.SITEID AND SS.STATUS =1 ' ELSE
'INNER JOIN USERSITES US ON US.USERID = '+ @USERID + ' AND US.SITEID =SCE.SITEID AND US.STATUS = 1' END

ELSE ' INNER JOIN #INPUTSITES SR ON SR.SITEID=SCE.SITEID' END
+CASE WHEN ISNULL(@AREAID,'')='' THEN '' ELSE ' INNER JOIN #INPUTAREAS SA ON SA.AREAID=SCE.AREAID' END
+CASE WHEN ISNULL(@SUBAREAID,'')='' THEN '' ELSE ' INNER JOIN #INPUTSUBAREAS SU1 ON SU1.SUBAREAID=SCE.SUBAREAID' END
+CASE WHEN ISNULL(@SHIFTID,'')='' THEN '' ELSE '  INNER JOIN #INPUTSHIFTS SHR ON SHR.SHIFTID=SCE.SHIFTID' END
+CASE WHEN ISNULL(@OBSERVERID,'')='' THEN '' ELSE ' INNER JOIN STOPCARDENTRYOBSERVERS_OL SCO ON SCO.CARDID=SCE.CARDID
INNER JOIN #INPUTOBS [OR] ON [OR].OBSERVERID=SCO.OBSERVERID' END
+' LEFT JOIN STOPCARDENTRYOBSERVERS_OL SCOB ON SCOB.CARDID=SCE.CARDID '
+' LEFT JOIN STOPCARDENTRYOBSERVERS_OL SCOB1 ON SCOB1.CARDID=SCE.CARDID AND SCOB1.OBSERVERID='+CAST(@USERID AS VARCHAR(32))
+' WHERE  STOPCARDTYPE = 1 AND ISAPPROVED=0 AND OFFLINECARDTYPE=2 '
+CASE WHEN ISNULL(@UNSAFEOBS,'')='' THEN ' ' ELSE ' AND SCO1.UNSAFE>0 ' END
+CASE WHEN ISNULL(@UNSAFEOBSWITHOUTCA,'')='' THEN ' ' ELSE ' AND 1=2 ' END
+CASE WHEN ISNULL(@FDATE,'')='' THEN '' ELSE ' AND SCE.OBSERVATIONDATE BETWEEN CONVERT(DATETIME,'''+@FDATE+''') AND CONVERT(DATETIME,'''+@TDATE+''')' END
+CASE WHEN ISNULL(@STATUSID,'')='' THEN ' AND SCE.[STATUS]!=2 ' ELSE ' AND SCE.[STATUS] IN('+ @STATUSID + ')' END
+CASE WHEN ISNULL(@INCOMPLETEOBSERVATIONID,'')='' THEN ' ' ELSE ' AND SCE.ISINCOMPLETEOBS = 1' END
+CASE WHEN ISNULL(@CHECKLISTSETUPID,'')='' THEN ' ' ELSE ' AND SCE.CHECKLISTSETUPID IN('+ @CHECKLISTSETUPID + ')' END
+' UNION ALL SELECT DISTINCT
''1-''+CAST(SCE.CARDID AS NVARCHAR(16)),SCE.CARDID,CONVERT(VARCHAR,OBSERVATIONDATE,@DTFORMAT)[OBSERVATION DATE],
CASE OBSERVERCOUNT WHEN 0 THEN  SCOB.OBSERVERID ELSE NULL END [OBSERVER],
SCE.AREAID [AREAS],SCE.SUBAREAID,
''LBLAPPROVED'' AS [STATUS]
,SCE.OBSERVATIONDATE [OBSDATE]
--,CASE WHEN EXISTS(SELECT 1 FROM STOPCARDENTRYOBSERVERS WHERE CARDID=SCE.CARDID AND OBSERVERID='+CAST(@USERID AS VARCHAR(32))+') OR SCE.CREATEDBY='+CAST(@USERID AS VARCHAR(32))+' THEN SCE.CREATEDBY ELSE -1 END
,CASE WHEN  SCOB1.OBSERVERID='+CAST(@USERID AS VARCHAR(32))+' OR SCE.CREATEDBY='+CAST(@USERID AS VARCHAR(32))+' THEN SCE.CREATEDBY ELSE -1 END
,4 APPROVALSTATUS
,4 [SORTBY]
--,CASE WHEN EXISTS(SELECT 1 FROM STOPCARDENTRYOBSERVERS WHERE CARDID =SCE.CARDID AND OBSERVERID='+CAST(@USERID AS VARCHAR(32))+') AND (@ROLEID=5 OR @COPYFROM=5)  THEN 1 ELSE 0 END
,CASE WHEN  SCOB1.OBSERVERID='+CAST(@USERID AS VARCHAR(32))+' AND (@ROLEID=5 OR @COPYFROM=5) THEN 1 ELSE 0 END
FROM STOPCARDENTRY SCE
'
+CASE WHEN ISNULL(@UNSAFEOBS,'')='' AND ISNULL(@UNSAFEOBSWITHOUTCA,'')='' THEN ' ' ELSE ' INNER JOIN STOPCARDENTRYOBSERVATIONS SCOO ON SCOO.CARDID=SCE.CARDID ' END
+CASE WHEN ISNULL(@UNSAFEOBSWITHOUTCA,'')='' THEN ' ' ELSE ' LEFT JOIN STOPCARDENTRYCATEGORYCOMMENTS SCC ON SCC.CARDID=SCE.CARDID AND SCC.MAINCATEGORYID=SCOO.MAINCATEGORYID AND SCC.SUBCATEGORYID=SCOO.SUBCATEGORYID' END

+CASE WHEN ISNULL(@SITEID,'')='' THEN
CASE WHEN @ISADMIN='1' THEN ' INNER JOIN SITES SS ON SS.SITEID=SCE.SITEID AND SS.STATUS =1 ' ELSE
'INNER JOIN USERSITES US ON US.USERID = '+ @USERID + ' AND US.SITEID =SCE.SITEID AND US.STATUS = 1' END

ELSE ' INNER JOIN #INPUTSITES SR ON SR.SITEID=SCE.SITEID ' END
+CASE WHEN ISNULL(@AREAID,'')='' THEN '' ELSE ' INNER JOIN #INPUTAREAS SA ON SA.AREAID=SCE.AREAID ' END
+CASE WHEN ISNULL(@SUBAREAID,'')='' THEN '' ELSE ' INNER JOIN #INPUTSUBAREAS SU1 ON SU1.SUBAREAID=SCE.SUBAREAID' END
+CASE WHEN ISNULL(@SHIFTID,'')='' THEN '' ELSE '  INNER JOIN #INPUTSHIFTS SHR ON SHR.SHIFTID=SCE.SHIFTID ' END
+CASE WHEN ISNULL(@OBSERVERID,'')='' THEN '' ELSE ' INNER JOIN STOPCARDENTRYOBSERVERS SCO ON SCO.CARDID=SCE.CARDID
INNER JOIN #INPUTOBS [OR] ON [OR].OBSERVERID=SCO.OBSERVERID ' END
+' LEFT JOIN STOPCARDENTRYOBSERVERS SCOB ON SCOB.CARDID=SCE.CARDID '
+' LEFT JOIN STOPCARDENTRYOBSERVERS SCOB1 ON SCOB1.CARDID=SCE.CARDID AND SCOB1.OBSERVERID='+CAST(@USERID AS VARCHAR(32))
+' WHERE  STOPCARDTYPE = 1 AND ISOFFLINEDATA=1 '
+CASE WHEN ISNULL(@FDATE,'')='' THEN '' ELSE ' AND SCE.OBSERVATIONDATE BETWEEN CONVERT(DATETIME,'''+@FDATE+''') AND CONVERT(DATETIME,'''+@TDATE+''')' END
+CASE WHEN ISNULL(@STATUSID,'')='' THEN ' AND SCE.[STATUS]!=2 ' ELSE ' AND SCE.[STATUS] IN('+ @STATUSID + ')' END
+CASE WHEN ISNULL(@INCOMPLETEOBSERVATIONID,'')='' THEN ' ' ELSE ' AND SCE.ISINCOMPLETEOBS = 1' END
+CASE WHEN ISNULL(@CHECKLISTSETUPID,'')='' THEN ' ' ELSE ' AND SCE.CHECKLISTSETUPID IN('+ @CHECKLISTSETUPID + ')' END
+CASE WHEN ISNULL(@UNSAFEOBS,'')='' THEN ' ' ELSE ' AND SCOO.UNSAFE>0 ' END
+CASE WHEN ISNULL(@UNSAFEOBSWITHOUTCA,'')='' THEN ' ' ELSE ' AND ((SCOO.UNSAFE>0 AND ISNULL(SCOO.CAEXISTS,0)=0) OR (LEN(SCC.UNSAFECOMMENTS)>0 AND ISNULL(SCOO.CAEXISTS,0)=0)) ' END

EXEC(@QRY)

END


SET @QRY=''
SET @QRY='

DECLARE @ROLEID INT,@COPYFROM INT
SELECT @ROLEID = DEFAULTROLEID FROM USERINFO WHERE USERID = '+ @USERID + '
SELECT @COPYFROM =COPYFROM FROM ROLES WHERE ROLEID = @ROLEID


INSERT INTO #FINALRESULTS1(CARDID,[OBSERVATION DATE],OBSERVER,[AREAS],SUBAREANAME,[STATUS],[OBSDATE],APPROVALSTATUS,SORTBY)
SELECT CARDID1,[OBSERVATION DATE],CASE WHEN OBSERVER IS NULL THEN ''LBLMULTIPLEOBSERVERS'' ELSE U.LASTNAME+'',''+U.FIRSTNAME END,A.AREANAME [AREAS],SA.SUBAREANAME,F.[STATUS],[OBSDATE],APPROVALSTATUS,SORTBY
FROM #FINALRESULTS F
LEFT JOIN USERS U ON U.USERID=F.OBSERVER
LEFT JOIN AREAS A ON A.AREAID=F.AREAS
LEFT JOIN SUBAREAS SA ON SA.SUBAREAID=F.SUBAREAID
WHERE (F.CREATEDBY = '+ @USERID + ' OR (ISOBSERVER=1 AND (@ROLEID=5 OR @COPYFROM=5))) ORDER BY [OBSDATE] DESC

IF (@ROLEID <=5 AND @ROLEID !=5) OR ( @ROLEID >5 AND @COPYFROM !=5)
INSERT INTO #FINALRESULTS1(CARDID,[OBSERVATION DATE],OBSERVER,[AREAS],SUBAREANAME,[STATUS],[OBSDATE],APPROVALSTATUS,SORTBY)
SELECT CARDID1,[OBSERVATION DATE],CASE WHEN OBSERVER IS NULL THEN ''LBLMULTIPLEOBSERVERS'' ELSE U.LASTNAME+'',''+U.FIRSTNAME END,A.AREANAME [AREAS],SA.SUBAREANAME,F.[STATUS][STATUS],[OBSDATE],APPROVALSTATUS,SORTBY FROM #FINALRESULTS F
LEFT JOIN USERS U ON U.USERID=F.OBSERVER
LEFT JOIN AREAS A ON A.AREAID=F.AREAS
LEFT JOIN SUBAREAS SA ON SA.SUBAREAID=F.SUBAREAID
WHERE F.CREATEDBY ! = '+ @USERID + ' ORDER BY [OBSDATE] DESC

SELECT CAST(CARDID AS VARCHAR(16))+ CASE WHEN APPROVALSTATUS IS NOT NULL THEN ''-''+CAST(ISNULL(APPROVALSTATUS,'''') AS VARCHAR(8)) ELSE '''' END CARDREQID,
CARDID,[OBSERVATION DATE],OBSERVER,[AREAS],SUBAREANAME,[STATUS],[OBSDATE],SORTBY
FROM #FINALRESULTS1 '
+CASE WHEN @OBSAPPROVALPC=1 THEN (CASE @APPROVALSTATUS WHEN 0 THEN ' ORDER BY SORTBY '
WHEN 1 THEN ' WHERE APPROVALSTATUS=1 ORDER BY ID ' WHEN 2 THEN ' WHERE APPROVALSTATUS=2 ORDER BY ID '
WHEN 3 THEN ' WHERE APPROVALSTATUS=3 ORDER BY ID ' WHEN 4 THEN ' WHERE APPROVALSTATUS=4 ORDER BY ID ' END )
ELSE  ' ORDER BY [OBSDATE] DESC,CARDID ' END+'
'

--PRINT @QRY

EXEC(@QRY)


DROP TABLE #INPUTSITES
DROP TABLE #INPUTAREAS
DROP TABLE #INPUTSUBAREAS
DROP TABLE #INPUTSHIFTS
DROP TABLE  #INPUTOBS
DROP TABLE #FINALRESULTS
DROP TABLE #FINALRESULTS1

