DECLARE @CC_TIMESTAMP DATETIME
SET @CC_TIMESTAMP=GETDATE()

UPDATE SITES SET [STATUS] = CASE  WHEN  [STATUS] = 1 THEN 0  WHEN  [STATUS] = 0 THEN 1 END,UPDATEDBY=@UPDATEDBY,UPDATEDDATE=@CC_TIMESTAMP
WHERE SITEID IN (SELECT RESULT FROM DBO.CSVtoTable(@SITEID))
--MAKING NEXT SITEID AS DEFAULT SITEID
UPDATE UI SET DEFAULTSITEID = S.SITEID,UPDATEDBY=@UPDATEDBY,UPDATEDDATE=@CC_TIMESTAMP
FROM USERINFO UI
INNER JOIN (SELECT ROW_NUMBER() OVER(PARTITION BY US.USERID ORDER BY US.SITEID) ID, US.USERID,US.SITEID FROM USERSITES US
INNER JOIN SITES S ON S.SITEID = US.SITEID
WHERE US.STATUS =1 AND S.STATUS=1
AND US.SITEID NOT IN ((SELECT SITEID FROM SITES WHERE STATUS = 0 AND SITEID IN (SELECT RESULT FROM DBO.CSVtoTable(@SITEID))))
AND US.USERID IN (SELECT USERID FROM USERINFO WHERE DEFAULTSITEID IN
(SELECT SITEID FROM SITES WHERE STATUS = 0 AND SITEID IN (SELECT RESULT FROM DBO.CSVtoTable(@SITEID))))
) S ON S.USERID=UI.USERID
WHERE S.ID=1

UPDATE USERINFO SET DEFAULTSITEID = -1,UPDATEDBY=@UPDATEDBY,UPDATEDDATE=@CC_TIMESTAMP WHERE DEFAULTSITEID IN (SELECT SITEID FROM SITES WHERE STATUS =0 AND SITEID IN (SELECT RESULT FROM DBO.CSVtoTable(@SITEID)))

--RESETTING DEFAULTSITEID WHILE DOING SITE ACTIVE
UPDATE UI SET DEFAULTSITEID =S.SITEID,UPDATEDBY=@UPDATEDBY,UPDATEDDATE=@CC_TIMESTAMP
FROM USERINFO UI
INNER JOIN(
SELECT US.USERID,S.SITEID FROM USERSITES US
INNER JOIN SITES S ON S.SITEID =US.SITEID
INNER JOIN DBO.CSVtoTable(@SITEID) SS ON SS.RESULT=S.SITEID
WHERE S.STATUS=1 AND US.STATUS =1 AND US.USERID IN (SELECT USERID FROM USERINFO WHERE DEFAULTSITEID = -1)) S ON
S.USERID=UI.USERID

IF EXISTS(SELECT 1 FROM USERINFO WHERE USERID = 1 AND DEFAULTSITEID =-1)
AND NOT EXISTS(SELECT 1 FROM USERSITES WHERE USERID = 1 AND STATUS=1)
UPDATE USERINFO SET DEFAULTSITEID =1,UPDATEDBY=@UPDATEDBY,UPDATEDDATE=@CC_TIMESTAMP WHERE USERID = 1


INSERT INTO dbo.AUDIT(TABLENAME,TRANS,STAMP,LASTUPDATEDBY,DATA)
SELECT 'USERS/USERINFO/SITES','UPDATE-CHANGESITESTATUS_1.0',@CC_TIMESTAMP,@UPDATEDBY,(SELECT SITEID,STATUS FROM SITES WHERE UPDATEDBY=@UPDATEDBY AND UPDATEDDATE=@CC_TIMESTAMP FOR XML AUTO)

INSERT INTO dbo.AUDIT(TABLENAME,TRANS,STAMP,LASTUPDATEDBY,DATA)
SELECT 'USERS/USERINFO/SITES','UPDATE-CHANGESITESTATUS_1.0',@CC_TIMESTAMP,@UPDATEDBY,(SELECT USERID,DEFAULTSITEID FROM USERINFO WHERE UPDATEDBY=@UPDATEDBY AND UPDATEDDATE=@CC_TIMESTAMP FOR XML AUTO)

