DECLARE @APPROVEOFFLINE INT, @ISADMIN VARCHAR(4)

SET @ISADMIN='0'

IF EXISTS(SELECT 1 FROM ROLES WHERE ALLSITES=1 AND ROLEID =(SELECT DEFAULTROLEID FROM USERINFO WHERE USERID = @USERID))
SET @ISADMIN='1'



SELECT @APPROVEOFFLINE=APPROVEOFFLINE FROM USERINFO WHERE USERID=@USERID

DECLARE @PERRESULTS1 TABLE(PERMISSIONID INT,PARENTID INT,PERMISSIONNAME NVARCHAR(51),IMAGENO INT,PERMISSIONVALUE INT,DISPLAYORDER INT)
INSERT INTO @PERRESULTS1
SELECT A.PERMISSIONID, B.PARENTID, PERMISSIONNAME,(CASE WHEN B.PARENTID=0 THEN A.PERMISSIONID ELSE 0 END) AS IMAGENO,A.PERMISSIONVALUE,B.DISPLAYORDER  FROM ROLEPERMISSIONS A
INNER JOIN PERMISSIONS B ON A.PERMISSIONID=B.PERMISSIONID
WHERE A.PERMISSIONVALUE=1 AND A.ROLEID=@ROLEID AND ISMENUDISPLAY=1 AND (B.PARENTID NOT IN (31) AND B.PERMISSIONID NOT IN (31))
UNION
SELECT 31,0,'LBLSUPPORT',31,1,101 UNION ALL
SELECT 45,31,'LBLTECHNICALREQ',0,1,102 UNION ALL
SELECT 44,31,'LBLCONTACTUS',0,1,103 UNION ALL
SELECT 37,31,'LBLHELPFILE',0,1,104

DECLARE @APPROVALPC INT,@APPROVALMOB INT
SET @APPROVALPC=0
SET @APPROVALMOB=0

IF EXISTS(SELECT 1 FROM COMPANYOPTIONS WHERE OPTIONNAME='ObsApprovePC' AND OPTIONVALUE='1')
SET @APPROVALPC=1

IF EXISTS(SELECT 1 FROM COMPANYOPTIONS WHERE OPTIONNAME='ObsApproveMobile' AND OPTIONVALUE='1')
SET @APPROVALMOB=1


IF @ISADMIN='1' AND NOT EXISTS(SELECT 1 FROM STOPCARDENTRY_OL SC WHERE ISAPPROVED=0 AND STATUS !=2) AND @APPROVALPC=0 AND @APPROVALMOB=0
DELETE FROM @PERRESULTS1 WHERE PERMISSIONID = 35
ELSE IF @ISADMIN='0' AND NOT EXISTS(SELECT 1 FROM STOPCARDENTRY_OL SC INNER JOIN USERSITES US ON US.SITEID=SC.SITEID AND US.USERID=@USERID  WHERE US.STATUS=1 AND SC.ISAPPROVED=0 AND SC.STATUS !=2) AND @APPROVALPC=0 AND @APPROVALMOB=0
DELETE FROM @PERRESULTS1 WHERE PERMISSIONID = 35

IF @APPROVEOFFLINE=0
DELETE FROM @PERRESULTS1 WHERE PERMISSIONID=35

SELECT PERMISSIONID ,PARENTID ,PERMISSIONNAME ,IMAGENO,PERMISSIONVALUE FROM @PERRESULTS1 ORDER BY DISPLAYORDER


