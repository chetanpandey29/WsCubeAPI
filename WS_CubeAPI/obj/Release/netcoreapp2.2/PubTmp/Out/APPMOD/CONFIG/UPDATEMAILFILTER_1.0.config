DECLARE @CC_TIMESTAMP DATETIME
SET @CC_TIMESTAMP=GETDATE()

DECLARE @TAB TABLE(ID INT IDENTITY(1,1),COL VARCHAR(MAX))
DECLARE @TEMP INT,@OPTIONID INT,@OPTIONLIST VARCHAR(MAX)
SET @TEMP = 1
INSERT INTO @TAB
SELECT ITEM
FROM dbo.FNSPLIT(@OPTIONVALUE,';')

IF EXISTS (SELECT 1 FROM SCHEDULEASSIGNMENTS WHERE SCHEDULEID=@SCHEDULEID AND OPTIONID=@OPTIONID)
DELETE FROM SCHEDULEASSIGNMENTS WHERE SCHEDULEID=@SCHEDULEID AND OPTIONID=@OPTIONID

ELSE
BEGIN
WHILE @TEMP < =(SELECT MAX(ID) FROM @TAB)
BEGIN
SELECT @OPTIONID=OPTIONID FROM REPORTOPTIONSMASTER WHERE REPORTPARAM=(SELECT SUBSTRING(COL,1,CHARINDEX('=',COL)-1) FROM @TAB WHERE ID = @TEMP)
SELECT @OPTIONLIST=SUBSTRING(COL,CHARINDEX('=',COL)+1,LEN(COL)) FROM @TAB WHERE ID = @TEMP
INSERT INTO SCHEDULEASSIGNMENTS(SCHEDULEID,OPTIONID,OPTIONVALUE)
SELECT @SCHEDULEID,@OPTIONID,RESULT FROM DBO.CSVtoTable(@OPTIONLIST)
SET @TEMP = @TEMP +1
END
END;
SELECT 2

INSERT INTO dbo.AUDIT(TABLENAME,TRANS,STAMP,LASTUPDATEDBY,DATA)
SELECT 'SCHEDULEASSIGNMENTS','UPDATE-UPDATEMAILFILTER_1.0',@CC_TIMESTAMP,@UPDATEDBY,NULL
