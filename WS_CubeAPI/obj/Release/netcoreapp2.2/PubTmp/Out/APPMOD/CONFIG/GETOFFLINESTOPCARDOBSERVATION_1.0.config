--GETOFFLINESTOPCARDOBSERVATION_1.0

CREATE TABLE #FINALRESULTS(ID INT IDENTITY(0,1),CHECKLISTSETUPID INT,MAINCATEGORYID INT,SUBCATEGORYID INT,MAINSEQUENCE INT,SUBSEQUENCE INT,MAINCATEGORYNAME NVARCHAR(512),SUBCATEGORYNAME NVARCHAR(512),SAFE INT,UNSAFE INT,SAFECOMMENTS NVARCHAR(MAX),UNSAFECOMMENTS NVARCHAR(MAX),COMMENTEXISTS INT,ALLSAFECHECK INT)
DECLARE @EXPANDCATEGORY NVARCHAR(8)
SET @EXPANDCATEGORY=''
SELECT @EXPANDCATEGORY = OPTIONVALUE FROM COMPANYOPTIONS WHERE OPTIONNAME='EXPANDCATEGORY'

IF NOT EXISTS(SELECT 1 FROM STOPCARDENTRYOBSERVATIONS_OL WHERE CARDID = @CARDID)
BEGIN

INSERT INTO #FINALRESULTS(CHECKLISTSETUPID,MAINCATEGORYID,SUBCATEGORYID,SUBSEQUENCE,MAINSEQUENCE,MAINCATEGORYNAME,SUBCATEGORYNAME,SAFE,UNSAFE,COMMENTEXISTS,ALLSAFECHECK)
SELECT DISTINCT CS.CHECKLISTSETUPID,CSC.MAINCATEGORYID,CSC.SUBCATEGORYID,CSC.SUBSEQUENCE,CSC.MAINSEQUENCE,ET1.ENTITYVALUE MAINCATEGORYNAME,ET.ENTITYVALUE [SUBCATEGORYNAME],0 [SAFE],0 [UNSAFE],
CASE WHEN EXISTS(SELECT 1 FROM STOPCARDENTRYCATEGORYCOMMENTS_OL WHERE CARDID = @CARDID AND MAINCATEGORYID = CSC.MAINCATEGORYID AND SUBCATEGORYID=CSC.SUBCATEGORYID ) OR EXISTS(SELECT 1 FROM STOPCARDENTRYATTACHMENTS_OL WHERE CARDID = @CARDID AND MAINCATEGORYID = CSC.MAINCATEGORYID AND SUBCATEGORYID=CSC.SUBCATEGORYID ) THEN 1 ELSE 0 END [COMMENTEXISTS]
,CS.ALLSAFECHECK
FROM CHECKLISTSETUP CS
INNER JOIN CHECKLISTSETUPCATEGORYASSIGNMENTS CSC ON CS.CHECKLISTSETUPID=CSC.CHECKLISTSETUPID
INNER JOIN MAINCATEGORIES M ON M.MAINCATEGORYID=CSC.MAINCATEGORYID
INNER JOIN SUBCATEGORIES S ON S.MAINCATEGORYID=CSC.MAINCATEGORYID AND S.SUBCATEGORYID=CSC.SUBCATEGORYID
INNER JOIN ENTITYTRANSLATION ET ON ET.PARENTID=CSC.MAINCATEGORYID AND ET.ENTITYID = CSC.SUBCATEGORYID AND ET.ENTITYTYPE='SUB_CTG' AND ET.LANGUAGEID =@LANGUAGEID
INNER JOIN ENTITYTRANSLATION ET1 ON ET1.PARENTID=CSC.MAINCATEGORYID  AND ET1.ENTITYTYPE='MAIN_CTG' AND ET1.LANGUAGEID =@LANGUAGEID
WHERE M.STATUS=1 AND S.STATUS=1 AND CS.STATUS IN (1,3) AND CSC.STATUS = 1 AND CSC.MAINISASSIGNED = 1 AND CSC.SUBISASSIGNED = 1
AND CS.CHECKLISTSETUPID=@CHECKLISTSETUPID
ORDER BY MAINCATEGORYNAME

SELECT MAINCATEGORYID,[MAINCATEGORYNAME],[COMMENTEXISTS],STARTINDEX,ENDINDEX,ALLSAFECHECK FROM(
SELECT DISTINCT CSC.MAINCATEGORYID,ET.ENTITYVALUE [MAINCATEGORYNAME],
CASE WHEN EXISTS(SELECT 1 FROM STOPCARDENTRYCATEGORYCOMMENTS_OL WHERE CARDID = @CARDID AND MAINCATEGORYID = CSC.MAINCATEGORYID AND SUBCATEGORYID = 0) OR EXISTS(SELECT 1 FROM STOPCARDENTRYATTACHMENTS_OL WHERE CARDID = @CARDID AND MAINCATEGORYID = CSC.MAINCATEGORYID AND SUBCATEGORYID = 0)  THEN 1 ELSE 0 END [COMMENTEXISTS]
,(SELECT MIN(ID) FROM #FINALRESULTS A WHERE A.MAINCATEGORYID = CSC.MAINCATEGORYID) STARTINDEX
,(SELECT MAX(ID) FROM #FINALRESULTS B WHERE B.MAINCATEGORYID = CSC.MAINCATEGORYID) ENDINDEX
,(SELECT TOP 1 ALLSAFECHECK FROM #FINALRESULTS C WHERE C.CHECKLISTSETUPID = CSC.CHECKLISTSETUPID) ALLSAFECHECK
,CSC.MAINSEQUENCE

FROM CHECKLISTSETUP CS
INNER JOIN CHECKLISTSETUPCATEGORYASSIGNMENTS CSC ON CS.CHECKLISTSETUPID=CSC.CHECKLISTSETUPID
INNER JOIN MAINCATEGORIES M ON M.MAINCATEGORYID=CSC.MAINCATEGORYID
INNER JOIN ENTITYTRANSLATION ET ON ET.ENTITYID = CSC.MAINCATEGORYID AND ET.ENTITYTYPE='MAIN_CTG' AND ET.LANGUAGEID =@LANGUAGEID
WHERE M.STATUS=1 AND CS.STATUS IN (1,3) AND CSC.STATUS = 1 AND CSC.MAINISASSIGNED = 1 AND CSC.SUBISASSIGNED = 1
AND CS.CHECKLISTSETUPID=@CHECKLISTSETUPID)A ORDER BY MAINSEQUENCE

SELECT CHECKLISTSETUPID,MAINCATEGORYID,SUBCATEGORYID,SUBSEQUENCE,SUBCATEGORYNAME,SAFE,UNSAFE,COMMENTEXISTS FROM #FINALRESULTS ORDER BY MAINSEQUENCE,SUBSEQUENCE,MAINCATEGORYID,SUBCATEGORYID

END
ELSE
BEGIN


INSERT INTO #FINALRESULTS(CHECKLISTSETUPID,MAINCATEGORYID ,SUBCATEGORYID ,MAINCATEGORYNAME,SUBCATEGORYNAME,SAFE,UNSAFE,SAFECOMMENTS,UNSAFECOMMENTS,COMMENTEXISTS,ALLSAFECHECK,SUBSEQUENCE,MAINSEQUENCE)
SELECT DISTINCT CS.CHECKLISTSETUPID,SCO.MAINCATEGORYID,SCO.SUBCATEGORYID,ET1.ENTITYVALUE [MAINCATEGORYNAME],ET.ENTITYVALUE [SUBCATEGORYNAME],SCO.SAFE,SCO.UNSAFE,SCO.SAFECOMMENTS,SCO.UNSAFECOMMENTS,
CASE WHEN EXISTS(SELECT 1 FROM STOPCARDENTRYCATEGORYCOMMENTS_OL WHERE CARDID = @CARDID AND MAINCATEGORYID = SCO.MAINCATEGORYID AND SUBCATEGORYID=SCO.SUBCATEGORYID ) OR EXISTS(SELECT 1 FROM STOPCARDENTRYATTACHMENTS_OL WHERE CARDID = @CARDID AND MAINCATEGORYID = SCO.MAINCATEGORYID AND SUBCATEGORYID=SCO.SUBCATEGORYID ) THEN 1 ELSE 0 END [COMMENTEXISTS]
,CS.ALLSAFECHECK,CSCA.SUBSEQUENCE,CSCA.MAINSEQUENCE
FROM STOPCARDENTRY_OL SCE
INNER JOIN STOPCARDENTRYOBSERVATIONS_OL SCO ON SCO.CARDID=SCE.CARDID
INNER JOIN MAINCATEGORIES M ON M.MAINCATEGORYID=SCO.MAINCATEGORYID
INNER JOIN SUBCATEGORIES S ON S.MAINCATEGORYID=SCO.MAINCATEGORYID AND S.SUBCATEGORYID=SCO.SUBCATEGORYID
INNER JOIN CHECKLISTSETUP CS ON CS.CHECKLISTSETUPID=SCE.CHECKLISTSETUPID
INNER JOIN CHECKLISTSETUPCATEGORYASSIGNMENTS CSCA ON CSCA.CHECKLISTSETUPID=CS.CHECKLISTSETUPID AND SCO.MAINCATEGORYID=CSCA.MAINCATEGORYID AND SCO.SUBCATEGORYID=CSCA.SUBCATEGORYID
INNER JOIN ENTITYTRANSLATION ET ON ET.PARENTID=SCO.MAINCATEGORYID AND ET.ENTITYID = SCO.SUBCATEGORYID AND ET.ENTITYTYPE='SUB_CTG' AND ET.LANGUAGEID =@LANGUAGEID
INNER JOIN ENTITYTRANSLATION ET1 ON ET1.PARENTID=SCO.MAINCATEGORYID  AND ET1.ENTITYTYPE='MAIN_CTG' AND ET1.LANGUAGEID =@LANGUAGEID
WHERE M.STATUS!=2 AND S.STATUS!=2 AND SCO.CARDID = @CARDID
AND CS.CHECKLISTSETUPID=@CHECKLISTSETUPID
ORDER BY MAINSEQUENCE

SELECT MAINCATEGORYID,[MAINCATEGORYNAME],[COMMENTEXISTS],STARTINDEX,ENDINDEX,ALLSAFECHECK FROM(
SELECT DISTINCT SCO.MAINCATEGORYID,ET.ENTITYVALUE [MAINCATEGORYNAME],
CASE WHEN EXISTS(SELECT 1 FROM STOPCARDENTRYCATEGORYCOMMENTS_OL WHERE CARDID = @CARDID AND MAINCATEGORYID = SCO.MAINCATEGORYID AND SUBCATEGORYID = 0) OR EXISTS(SELECT 1 FROM STOPCARDENTRYATTACHMENTS_OL WHERE CARDID = @CARDID AND MAINCATEGORYID = SCO.MAINCATEGORYID AND SUBCATEGORYID = 0) THEN 1 ELSE 0 END [COMMENTEXISTS]
,(SELECT MIN(ID) FROM #FINALRESULTS A WHERE A.MAINCATEGORYID = SCO.MAINCATEGORYID) STARTINDEX
,(SELECT MAX(ID) FROM #FINALRESULTS B WHERE B.MAINCATEGORYID = SCO.MAINCATEGORYID) ENDINDEX
,(SELECT TOP 1 ALLSAFECHECK FROM #FINALRESULTS C WHERE C.CHECKLISTSETUPID = CS.CHECKLISTSETUPID) ALLSAFECHECK
,CSCA.MAINSEQUENCE
FROM STOPCARDENTRY_OL SCE
INNER JOIN STOPCARDENTRYOBSERVATIONS_OL SCO ON SCO.CARDID=SCE.CARDID
INNER JOIN MAINCATEGORIES M ON M.MAINCATEGORYID=SCO.MAINCATEGORYID
INNER JOIN SUBCATEGORIES S ON S.MAINCATEGORYID=SCO.MAINCATEGORYID AND S.SUBCATEGORYID=SCO.SUBCATEGORYID
INNER JOIN CHECKLISTSETUP CS ON CS.CHECKLISTSETUPID=SCE.CHECKLISTSETUPID
INNER JOIN CHECKLISTSETUPCATEGORYASSIGNMENTS CSCA ON CSCA.CHECKLISTSETUPID=CS.CHECKLISTSETUPID AND SCO.MAINCATEGORYID=CSCA.MAINCATEGORYID AND SCO.SUBCATEGORYID=CSCA.SUBCATEGORYID
INNER JOIN ENTITYTRANSLATION ET ON ET.ENTITYID = SCO.MAINCATEGORYID AND ET.ENTITYTYPE='MAIN_CTG' AND ET.LANGUAGEID =@LANGUAGEID
WHERE M.STATUS!=2 AND S.STATUS!=2 AND SCO.CARDID = @CARDID
AND CS.CHECKLISTSETUPID=@CHECKLISTSETUPID) A ORDER BY MAINSEQUENCE

SELECT MAINCATEGORYID ,SUBCATEGORYID ,SUBCATEGORYNAME,SAFE,UNSAFE,SAFECOMMENTS,UNSAFECOMMENTS,COMMENTEXISTS,ALLSAFECHECK FROM #FINALRESULTS ORDER BY MAINSEQUENCE,SUBSEQUENCE,MAINCATEGORYID,SUBCATEGORYID
END

SELECT  ENABLESAFEUNSAFE
,@EXPANDCATEGORY EXPANDCATEGORY
FROM CHECKLISTSETUP WHERE CHECKLISTSETUPID=@CHECKLISTSETUPID

DROP TABLE #FINALRESULTS
