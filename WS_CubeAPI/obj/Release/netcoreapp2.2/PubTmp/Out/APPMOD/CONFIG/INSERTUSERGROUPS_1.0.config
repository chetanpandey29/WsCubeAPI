DECLARE @CC_TIMESTAMP DATETIME
SET @CC_TIMESTAMP=GETDATE()

UPDATE UG SET UG.STATUS = 1, UG.UPDATEDBY = @UPDATEDBY, UG.UPDATEDDATE = @CC_TIMESTAMP FROM USERGROUPS UG INNER JOIN GROUPS G ON G.GROUPID = UG.GROUPID AND G.GROUPTYPEID = UG.GROUPTYPEID WHERE UG.[STATUS] = 0 AND UG.USERID =@USERID AND  G.GROUPID IN (SELECT RESULT FROM DBO.CSVtoTable(@GROUPID));
INSERT INTO USERGROUPS(USERID,GROUPTYPEID,GROUPID,STATUS,UPDATEDBY,UPDATEDDATE) SELECT @USERID,G.GROUPTYPEID,T.RESULT,1,@UPDATEDBY,@CC_TIMESTAMP FROM DBO.CSVtoTable(@GROUPID) T INNER JOIN GROUPS G ON G.GROUPID = T.RESULT WHERE RESULT NOT IN (SELECT GROUPID FROM USERGROUPS WHERE USERID =@USERID);
UPDATE USERGROUPS SET STATUS = 0,UPDATEDBY = @UPDATEDBY,UPDATEDDATE = @CC_TIMESTAMP WHERE USERID =@USERID AND GROUPID NOT IN (SELECT RESULT FROM DBO.CSVtoTable(@GROUPID))


INSERT INTO dbo.AUDIT(TABLENAME,TRANS,STAMP,LASTUPDATEDBY,DATA)
SELECT 'USERGROUPS','INSERT-INSERTUSERGROUPS_1.0',@CC_TIMESTAMP,@UPDATEDBY,NULL
