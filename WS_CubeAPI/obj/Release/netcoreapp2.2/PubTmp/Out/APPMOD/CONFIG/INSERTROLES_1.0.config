--INSERTROLES_1.0
DECLARE @CC_TIMESTAMP DATETIME
SET @CC_TIMESTAMP=GETDATE()
DECLARE @ROLEID INT
IF EXISTS(SELECT 1 FROM ROLES WHERE ROLENAME=@ROLENAME AND [STATUS]!=2 )
SELECT -1
ELSE
BEGIN
IF @COPYFROM =-1
BEGIN
INSERT INTO ROLES(COMPANYID,ROLENAME,[DESCRIPTION],[STATUS],ALLSITES,CREATEDBY,CREATEDDATE,COPYFROM)VALUES(@COMPANYID,@ROLENAME,@DESCRIPTION,@STATUS,0,@CREATEDBY,@CC_TIMESTAMP,@COPYFROM)
SELECT @ROLEID=@@IDENTITY
INSERT INTO ROLEPERMISSIONS(ROLEID,PERMISSIONID,PERMISSIONVALUE,CREATEDBY,CREATEDDATE)
SELECT @ROLEID,PERMISSIONID,CASE WHEN PERMISSIONID IN (33,34,37,46) THEN 1 ELSE 0 END PERMISSIONVALUE,@CREATEDBY,@CC_TIMESTAMP
FROM [PERMISSIONS] WHERE STATUS=1 AND PERMISSIONID NOT IN (33,40,41,42,43,49)
END
ELSE
BEGIN
INSERT INTO ROLES(COMPANYID,ROLENAME,[DESCRIPTION],[STATUS],ALLSITES,CREATEDBY,CREATEDDATE,COPYFROM)VALUES(@COMPANYID,@ROLENAME,@DESCRIPTION,@STATUS,0,@CREATEDBY,@CC_TIMESTAMP,@COPYFROM)
SELECT @ROLEID=@@IDENTITY

INSERT INTO ROLEPERMISSIONS(ROLEID,PERMISSIONID,PERMISSIONVALUE,CREATEDBY,CREATEDDATE)
SELECT @ROLEID,PERMISSIONID,PERMISSIONVALUE,@CREATEDBY,@CC_TIMESTAMP
FROM ROLEPERMISSIONS WHERE ROLEID=@COPYFROM

INSERT INTO ROLEREPORTS(ROLEID,REPORTID,STATUS,UPDATEDBY,UPDATEDDATE)
SELECT @ROLEID,REPORTID,STATUS,@CREATEDBY,@CC_TIMESTAMP FROM ROLEREPORTS WHERE ROLEID = @COPYFROM
END
SELECT @ROLEID
END


INSERT INTO dbo.AUDIT(TABLENAME,TRANS,STAMP,LASTUPDATEDBY,DATA)
SELECT 'ROLES','INSERT-INSERTROLES_1.0',@CC_TIMESTAMP,@CREATEDBY,
(SELECT * FROM ROLES WHERE CREATEDBY=@CREATEDBY AND CREATEDDATE=@CC_TIMESTAMP FOR XML AUTO)

INSERT INTO dbo.AUDIT(TABLENAME,TRANS,STAMP,LASTUPDATEDBY,DATA)
SELECT 'ROLEPERMISSIONS','INSERT-INSERTROLES_1.0',@CC_TIMESTAMP,@CREATEDBY,
(SELECT * FROM ROLEPERMISSIONS WHERE CREATEDBY=@CREATEDBY AND CREATEDDATE=@CC_TIMESTAMP FOR XML AUTO)

