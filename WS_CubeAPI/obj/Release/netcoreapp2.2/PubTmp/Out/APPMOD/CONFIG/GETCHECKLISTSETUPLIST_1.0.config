DECLARE @QRY VARCHAR(MAX)
SET @QRY =''
IF EXISTS (SELECT 1 FROM USERINFO WHERE DEFAULTROLEID=1 AND USERID = @USERID)
SET @QRY = '
SELECT * FROM (
SELECT DISTINCT CS.CHECKLISTSETUPID,SETUPNAME [Checklist Setup Name],CASE WHEN CS.[STATUS]= 1 THEN ''LBLACTIVE'' WHEN CS.[STATUS] = 0 THEN ''LBLINACTIVE'' WHEN CS.[STATUS] = 3 THEN ''DEFAULT'' END [STATUS]

FROM CHECKLISTSETUP CS'
+CASE WHEN ISNULL(@SITEID,'')='' THEN '' ELSE '
INNER JOIN CHECKLISTSETUPSITES CSS ON CSS.CHECKLISTSETUPID = CS.CHECKLISTSETUPID AND CSS.STATUS=1
INNER JOIN DBO.CSVTOTABLE('''+@SITEID+''') SR ON SR.RESULT=CSS.SITEID' END
+CASE WHEN ISNULL(@CATEGORYTYPE,'')='' THEN '' ELSE ' INNER JOIN DBO.CSVTOTABLE('''+@CATEGORYTYPE+''') SC ON SC.RESULT=CS.CATEGORYTYPE ' END
+CASE WHEN ISNULL(@STATUS,'')='' THEN '' ELSE ' INNER JOIN DBO.CSVTOTABLE('''+@STATUS+''') ST ON ST.RESULT=CS.STATUS ' END
+ ' WHERE CS.ALLSITES=0 '
+CASE WHEN  ISNULL(@STATUS,'')='' THEN ' AND CS.[STATUS]!=2 ' ELSE '' END

+'
UNION
SELECT DISTINCT CS.CHECKLISTSETUPID,SETUPNAME [Checklist Setup Name],CASE WHEN CS.[STATUS]= 1 THEN ''LBLACTIVE'' WHEN CS.[STATUS] = 0 THEN ''LBLINACTIVE'' WHEN CS.[STATUS] = 3 THEN ''DEFAULT'' END [STATUS]

FROM CHECKLISTSETUP CS'
+CASE WHEN ISNULL(@CATEGORYTYPE,'')='' THEN '' ELSE ' INNER JOIN DBO.CSVTOTABLE('''+@CATEGORYTYPE+''') SC ON SC.RESULT=CS.CATEGORYTYPE ' END
+CASE WHEN ISNULL(@STATUS,'')='' THEN '' ELSE ' INNER JOIN DBO.CSVTOTABLE('''+@STATUS+''') ST ON ST.RESULT=CS.STATUS ' END
+' WHERE CS.ALLSITES=1  '
+CASE WHEN  ISNULL(@STATUS,'')='' THEN ' AND CS.[STATUS]!=2 ' ELSE '' END

+') A '
+' ORDER BY [Checklist Setup Name] ASC'
ELSE
SET @QRY = '
SELECT * FROM (
SELECT DISTINCT CS.CHECKLISTSETUPID,SETUPNAME [Checklist Setup Name],CASE WHEN CS.[STATUS]= 1 THEN ''LBLACTIVE'' WHEN CS.[STATUS] = 0 THEN ''LBLINACTIVE'' WHEN CS.[STATUS] = 3 THEN ''DEFAULT'' END [STATUS]

FROM CHECKLISTSETUP CS'
+CASE WHEN ISNULL(@SITEID,'')='' THEN '
INNER JOIN CHECKLISTSETUPSITES CSS ON CSS.CHECKLISTSETUPID = CS.CHECKLISTSETUPID AND CSS.STATUS=1
INNER JOIN SITES S ON S.SITEID = CSS.SITEID AND S.STATUS=1
INNER JOIN USERSITES US ON US.STATUS = 1 AND US.SITEID=CSS.SITEID AND US.USERID='+CAST(@USERID AS VARCHAR(8)) ELSE '
INNER JOIN CHECKLISTSETUPSITES CSS ON CSS.CHECKLISTSETUPID = CS.CHECKLISTSETUPID AND CSS.STATUS=1
INNER JOIN DBO.CSVTOTABLE('''+@SITEID+''') SR ON SR.RESULT=CSS.SITEID' END
+CASE WHEN ISNULL(@CATEGORYTYPE,'')='' THEN '' ELSE ' INNER JOIN DBO.CSVTOTABLE('''+@CATEGORYTYPE+''') SC ON SC.RESULT=CS.CATEGORYTYPE ' END
+CASE WHEN ISNULL(@STATUS,'')='' THEN '' ELSE ' INNER JOIN DBO.CSVTOTABLE('''+@STATUS+''') ST ON ST.RESULT=CS.STATUS ' END
+ ' WHERE CS.ALLSITES=0 '
+CASE WHEN  ISNULL(@STATUS,'')='' THEN ' AND CS.[STATUS]!=2 ' ELSE '' END

+'
UNION
SELECT DISTINCT CS.CHECKLISTSETUPID,SETUPNAME [Checklist Setup Name],CASE WHEN CS.[STATUS]= 1 THEN ''LBLACTIVE'' WHEN CS.[STATUS] = 0 THEN ''LBLINACTIVE'' WHEN CS.[STATUS] = 3 THEN ''DEFAULT'' END [STATUS]

FROM CHECKLISTSETUP CS'
+CASE WHEN ISNULL(@CATEGORYTYPE,'')='' THEN '' ELSE ' INNER JOIN DBO.CSVTOTABLE('''+@CATEGORYTYPE+''') SC ON SC.RESULT=CS.CATEGORYTYPE ' END
+CASE WHEN ISNULL(@STATUS,'')='' THEN '' ELSE ' INNER JOIN DBO.CSVTOTABLE('''+@STATUS+''') ST ON ST.RESULT=CS.STATUS ' END
+' WHERE CS.ALLSITES=1  '
+CASE WHEN  ISNULL(@STATUS,'')='' THEN ' AND CS.[STATUS]!=2 ' ELSE '' END

+') A '
+' ORDER BY [Checklist Setup Name] ASC'

EXEC(@QRY)

