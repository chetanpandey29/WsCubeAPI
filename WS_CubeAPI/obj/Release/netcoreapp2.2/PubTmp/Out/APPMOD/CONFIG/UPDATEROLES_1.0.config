DECLARE @CC_TIMESTAMP DATETIME
SET @CC_TIMESTAMP=GETDATE()

IF EXISTS(SELECT 1 FROM ROLES WHERE ROLEID!=@ROLEID AND ROLENAME=@ROLENAME AND [STATUS]!=2 ) SELECT -1
ELSE
BEGIN
UPDATE ROLES SET ROLENAME=@ROLENAME,[DESCRIPTION]=@DESCRIPTION,[STATUS]=CASE WHEN ALLSITES=1 THEN 1 ELSE @STATUS END ,UPDATEDBY=@UPDATEDBY,UPDATEDDATE=@CC_TIMESTAMP
WHERE ROLEID=@ROLEID;
IF @STATUS = 0 AND NOT EXISTS(SELECT 1 FROM ROLES WHERE ROLEID = @ROLEID AND ALLSITES=1)
UPDATE USERINFO SET DEFAULTROLEID =-1,UPDATEDBY=@UPDATEDBY,UPDATEDDATE=@CC_TIMESTAMP WHERE DEFAULTROLEID = @ROLEID
ELSE IF @STATUS = 1
UPDATE USERINFO SET DEFAULTROLEID=@ROLEID,UPDATEDBY=@UPDATEDBY,UPDATEDDATE=@CC_TIMESTAMP WHERE USERID IN (SELECT USERID FROM USERROLES WHERE ROLEID = @ROLEID AND STATUS =1) AND DEFAULTROLEID = -1

SELECT 2
END


INSERT INTO dbo.AUDIT(TABLENAME,TRANS,STAMP,LASTUPDATEDBY,DATA)
SELECT 'ROLES','UPDATE-UPDATEROLES_1.0',@CC_TIMESTAMP,@UPDATEDBY,NULL

INSERT INTO dbo.AUDIT(TABLENAME,TRANS,STAMP,LASTUPDATEDBY,DATA)
SELECT 'USERINFO','UPDATE-UPDATEROLES_1.0',@CC_TIMESTAMP,@UPDATEDBY,
(SELECT * FROM USERINFO WHERE UPDATEDBY=@UPDATEDBY AND UPDATEDDATE=@CC_TIMESTAMP FOR XML AUTO)