
DECLARE @CC_TIMESTAMP DATETIME
SET @CC_TIMESTAMP=GETDATE()

IF EXISTS ( SELECT 1 FROM SITES WHERE SITENAME=@SITENAME AND SITEID!= @SITEID AND [STATUS]!=2)
BEGIN
SELECT -1
END
ELSE
BEGIN
UPDATE [SITES] SET [SITENAME] = @SITENAME,[ADDRESS] = @ADDRESS,[CITY] = @CITY,[STATE] = @STATE,[ZIPCODE] = @ZIPCODE,[COUNTRYID] = @COUNTRYID,
[COMMENTS] = @COMMENTS,[STATUS] = @STATUS,[EMPCOUNT] = @EMPCOUNT,[UPDATEDBY] = @UPDATEDBY,[UPDATEDDATE] = @CC_TIMESTAMP,TIMEZONEID=@TIMEZONEID WHERE SITEID = @SITEID
IF @STATUS =0
BEGIN
UPDATE UI SET DEFAULTSITEID = S.SITEID,TIMEZONE=S.TIMEZONEID,[UPDATEDBY] = @UPDATEDBY,[UPDATEDDATE] = @CC_TIMESTAMP
FROM USERINFO UI
INNER JOIN (SELECT ROW_NUMBER() OVER(PARTITION BY US.USERID ORDER BY US.SITEID) ID, US.USERID,US.SITEID,S.TIMEZONEID FROM USERSITES US
INNER JOIN SITES S ON US.SITEID = S.SITEID
WHERE US.SITEID != @SITEID
AND US.STATUS =1 AND S.STATUS=1 ) S ON S.USERID=UI.USERID
WHERE S.ID=1 AND UI.DEFAULTSITEID =@SITEID

UPDATE USERINFO SET DEFAULTSITEID = -1,[UPDATEDBY] = @UPDATEDBY,[UPDATEDDATE] = @CC_TIMESTAMP WHERE  DEFAULTSITEID = @SITEID

IF EXISTS(SELECT 1 FROM USERINFO WHERE USERID = 1 AND DEFAULTSITEID=@SITEID)
UPDATE USERINFO SET DEFAULTSITEID=1,[UPDATEDBY] = @UPDATEDBY,[UPDATEDDATE] = @CC_TIMESTAMP WHERE USERID = 1
END
ELSE IF @STATUS =1
BEGIN
UPDATE USERINFO SET DEFAULTSITEID = @SITEID,[UPDATEDBY] = @UPDATEDBY,[UPDATEDDATE] = @CC_TIMESTAMP,TIMEZONE=@TIMEZONEID
WHERE DEFAULTSITEID=-1 AND USERID IN (SELECT USERID FROM USERSITES WHERE STATUS =1 AND SITEID =@SITEID)
END
SELECT 1
END

--PHASE1 2017
UPDATE UI SET TIMEZONE=S.TIMEZONEID,UPDATEDBY = @UPDATEDBY,UPDATEDDATE = @CC_TIMESTAMP
FROM USERINFO UI
INNER JOIN SITES S ON S.SITEID=UI.DEFAULTSITEID
WHERE UI.DEFAULTSITEID=@SITEID

INSERT INTO dbo.AUDIT(TABLENAME,TRANS,STAMP,LASTUPDATEDBY,DATA)
SELECT 'SITES','UPDATE-UPDATESITEINFO_1.0',@CC_TIMESTAMP,@UPDATEDBY,
(SELECT * FROM SITES WHERE UPDATEDBY=@UPDATEDBY AND UPDATEDDATE=@CC_TIMESTAMP FOR XML AUTO)

INSERT INTO dbo.AUDIT(TABLENAME,TRANS,STAMP,LASTUPDATEDBY,DATA)
SELECT 'USERINFO','UPDATE-UPDATESITEINFO_1.0',@CC_TIMESTAMP,@UPDATEDBY,
(SELECT * FROM USERINFO WHERE UPDATEDBY=@UPDATEDBY AND UPDATEDDATE=@CC_TIMESTAMP FOR XML AUTO)