DECLARE @PCURR_LA  INT
DECLARE @PGLO_ENA_LA INT
DECLARE @PGLO_LA  INT
DECLARE @DATEFORMAT INT
DECLARE @ISOBSERVER INT
DECLARE @PWDEXPPERIOD INT
DECLARE @USERID BIGINT,@USERLANGCODE VARCHAR(128),@ENABLEAREAMGR INT,@AUDITCLEAR INT
DECLARE @SESSIONID BIGINT,@TIMEZONEID INT,@EDITOBSERVATION TINYINT,@ADDNEWOBS INT,@ADDCAPA TINYINT,@EXPANDCATEGORY INT

UPDATE USERS SET STATUS =3 WHERE USERID=1

SELECT @USERID=USERID FROM USERS WHERE USERNAME=@PUSERNAME AND [STATUS] != 2
SELECT @DATEFORMAT=[DATEFORMAT] FROM USERS U
INNER JOIN USERINFO UI ON UI.USERID=U.USERID
WHERE COMPANYID=@PCOMPANYID AND USERNAME=@PUSERNAME
SELECT @ISOBSERVER = UI.USERTYPEID FROM USERS U
INNER JOIN USERINFO UI ON UI.USERID=U.USERID
WHERE COMPANYID=@PCOMPANYID AND USERNAME=@PUSERNAME AND [STATUS] != 2

SELECT @EDITOBSERVATION=CASE WHEN EXISTS(SELECT 1 FROM USERINFO UI
INNER JOIN ROLEPERMISSIONS RF ON RF.ROLEID = UI.DEFAULTROLEID AND PERMISSIONID=36--EDITOBSERVATION
WHERE UI.USERID=@USERID AND RF.PERMISSIONVALUE=1) THEN 1 ELSE 0 END

SELECT @ADDCAPA=CASE WHEN EXISTS(SELECT 1 FROM USERINFO UI
INNER JOIN ROLEPERMISSIONS RF ON RF.ROLEID = UI.DEFAULTROLEID AND PERMISSIONID=15--ADDCAPA
WHERE UI.USERID=@USERID AND RF.PERMISSIONVALUE=1) THEN 1 ELSE 0 END

SELECT @ADDNEWOBS=CASE WHEN EXISTS(SELECT 1 FROM USERINFO UI
INNER JOIN ROLEPERMISSIONS RF ON RF.ROLEID = UI.DEFAULTROLEID AND PERMISSIONID=39--ADDNEWOBS
WHERE UI.USERID=@USERID AND RF.PERMISSIONVALUE=1) THEN 1 ELSE 0 END

IF (@ISOBSERVER !=1)
BEGIN
IF @DATEFORMAT IS NULL
SELECT @DATEFORMAT=101
-----------------------------
SELECT @PGLO_ENA_LA = OPTIONVALUE FROM COMPANYOPTIONS WHERE COMPANYID=@PCOMPANYID AND OPTIONNAME='EnableLoginAttempts'
SELECT @PGLO_LA = OPTIONVALUE FROM COMPANYOPTIONS WHERE COMPANYID=@PCOMPANYID AND OPTIONNAME='LoginAttempts'
SELECT @PWDEXPPERIOD = OPTIONVALUE FROM COMPANYOPTIONS WHERE COMPANYID=@PCOMPANYID AND OPTIONNAME='PasswordExpirationPeriod'
SELECT @USERLANGCODE=INTERNALNAME FROM LANGUAGES WHERE LANGUAGEID=(SELECT LANGUAGEID FROM USERINFO WHERE USERID=(SELECT USERID FROM USERS WHERE USERNAME=@PUSERNAME AND [STATUS] != 2))
SELECT @ENABLEAREAMGR = OPTIONVALUE FROM COMPANYOPTIONS WHERE COMPANYID=@PCOMPANYID AND OPTIONNAME='ENABLEAREAMANAGER'
SELECT @AUDITCLEAR = OPTIONVALUE FROM COMPANYOPTIONS WHERE COMPANYID=@PCOMPANYID AND OPTIONNAME='AUDITCLEAR'
SELECT @EXPANDCATEGORY = OPTIONVALUE FROM COMPANYOPTIONS WHERE OPTIONNAME='EXPANDCATEGORY'

SELECT @PCURR_LA = LOGINATTEMPTS FROM USERS U
INNER JOIN USERINFO UI ON UI.USERID=U.USERID
WHERE COMPANYID=@PCOMPANYID AND USERNAME=@PUSERNAME AND [STATUS] != 2

IF EXISTS(SELECT 1 FROM USERS WHERE COMPANYID=@PCOMPANYID AND USERNAME=@PUSERNAME AND [PASSWORD]=@PPASSWORD AND [STATUS] != 2)
BEGIN
IF EXISTS(SELECT 1 FROM USERS WHERE COMPANYID=@PCOMPANYID AND USERNAME=@PUSERNAME AND [PASSWORD]=@PPASSWORD AND STATUS!=4)
BEGIN
UPDATE UI SET LOGINATTEMPTS=0
FROM USERINFO UI
INNER JOIN USERS U ON U.USERID = UI.USERID
WHERE COMPANYID=@PCOMPANYID AND USERNAME=@PUSERNAME AND [STATUS] != 2

INSERT INTO dbo.[SESSION](USERID,LASTACTIONTIME) VALUES(@USERID,GETUTCDATE())

SELECT @SESSIONID=@@IDENTITY

INSERT INTO DBO.SSLINFO(MSG,COMPANYID,USERID,PASSWORD,STATUS,USERNAME,PASSWORDLASTUPDATE,LANGUAGEID,LASTNAME,FIRSTNAME,USERTYPEID,SITEID,
DATEFORMAT,USERLOGINATTEMPTS,GLOBALLOGINATTEMPTS,PWDEXPPERIOD,SITENAME,DEFAULTROLEID,ALERTMSG,USERLANGCODE,SESSIONID,EDITOBSERVATION,
TIMEZONEID,ADDNEWOBS,COPYFROM,UNSAFEALERTPER,UNSAFEALERTENABLE,OBSAPPROVALPC,ADDCAPA,ENABLEAREAMGR,EXPANDCATEGORY)
SELECT 'VALID' AS MSG,A.COMPANYID,A.USERID,[PASSWORD],A.STATUS,A.USERNAME,UI.PASSWORDLASTUPDATE,
UI.LANGUAGEID,A.LASTNAME,A.FIRSTNAME,UI.USERTYPEID,ISNULL(UI.DEFAULTSITEID,'1')[SITEID],
UI.DATEFORMAT,UI.LOGINATTEMPTS USERLOGINATTEMPTS,
E.OPTIONVALUE GLOBALLOGINATTEMPTS,@PWDEXPPERIOD 'PWDEXPPERIOD',
(SELECT SITENAME FROM SITES WHERE SITEID=ISNULL(UI.DEFAULTSITEID,'1'))[SITENAME],
UI.DEFAULTROLEID,UI.ALERTMSG,@USERLANGCODE 'USERLANGCODE',@SESSIONID SESSIONID ,@EDITOBSERVATION EDITOBSERVATION,UI.TIMEZONE [TIMEZONEID],
@ADDNEWOBS ADDNEWOBS,(SELECT COPYFROM FROM ROLES WHERE ROLEID=(SELECT DEFAULTROLEID FROM USERINFO WHERE USERID =@USERID))
,CASE WHEN EXISTS(SELECT 1 FROM ROLEPERMISSIONS WHERE PERMISSIONVALUE=1 AND PERMISSIONID = 46 AND ROLEID =(SELECT DEFAULTROLEID FROM USERINFO WHERE USERID =@USERID)) THEN 1 ELSE 0 END UNSAFEALERTPER
,CASE WHEN EXISTS(SELECT 1 FROM SCHEDULEASSIGNMENTS WHERE ALERTUSERID=@USERID AND SCHEDULEID = (SELECT SCHEDULEID FROM SCHEDULE WHERE SCHEDULETYPEID = 12)) THEN 1 ELSE 0 END  UNSAFEALERTENABLE
,ISNULL((SELECT OBSAPPROVEPC FROM ROLES WHERE ROLEID = UI.DEFAULTROLEID),0)
,@ADDCAPA ADDCAPA,@ENABLEAREAMGR ENABLEAREAMGR,@EXPANDCATEGORY EXPANDCATEGORY
FROM USERS A
INNER JOIN USERINFO UI ON UI.USERID = A.USERID
INNER JOIN COMPANYOPTIONS E
ON E.COMPANYID = A.COMPANYID
AND E.OPTIONNAME = 'LoginAttempts'
WHERE A.COMPANYID=@PCOMPANYID AND A.USERNAME=@PUSERNAME AND [PASSWORD]=@PPASSWORD AND A.[STATUS] != 2

IF (SELECT DEFAULTROLEID FROM USERINFO WHERE USERID =@USERID)=1
BEGIN
DELETE FROM AUDIT WHERE STAMP <= DATEADD(DD,-(@AUDITCLEAR),GETDATE())
INSERT INTO AUDIT(TABLENAME,TRANS,STAMP,LASTUPDATEDBY,DATA) VALUES('AUDIT CLEAR','DELETE',GETDATE(),@USERID,NULL)
END

IF EXISTS(SELECT 1 FROM USERINFO WHERE USERID = @USERID AND DEFAULTROLEID!=-1) AND
EXISTS(SELECT 1 FROM USERINFO WHERE USERID = @USERID AND DEFAULTSITEID!=-1)
BEGIN
SELECT ID AS SSLID,MSG,COMPANYID,USERID,STATUS,USERNAME,PASSWORDLASTUPDATE,LANGUAGEID,LASTNAME,FIRSTNAME,USERTYPEID,SITEID,DATEFORMAT,USERLOGINATTEMPTS,GLOBALLOGINATTEMPTS,PWDEXPPERIOD,SITENAME,DEFAULTROLEID,ALERTMSG,USERLANGCODE,SESSIONID , EDITOBSERVATION,[TIMEZONEID],ADDNEWOBS,ISNULL(COPYFROM, -1) COPYFROM,UNSAFEALERTPER,UNSAFEALERTENABLE,OBSAPPROVALPC,ADDCAPA,ENABLEAREAMGR,EXPANDCATEGORY FROM DBO.SSLINFO WHERE SESSIONID = @SESSIONID
DELETE FROM CACHEKEYTABLE WHERE CACHEDURATION < GETUTCDATE()
END
ELSE IF NOT EXISTS(SELECT 1 FROM USERINFO WHERE USERID = @USERID AND DEFAULTROLEID!=-1) AND
NOT EXISTS(SELECT 1 FROM USERINFO WHERE USERID = @USERID AND DEFAULTSITEID!=-1)
SELECT 'NO ROLE ASSIGNED/SITE ASSIGNED' AS MSG, @PGLO_LA AS GLOBALLOGINATTEMPTS, LOGINATTEMPTS USERLOGINATTEMPTS,USERTYPEID
FROM USERS U
INNER JOIN USERINFO UI ON UI.USERID = U.USERID
WHERE COMPANYID=@PCOMPANYID AND USERNAME=@PUSERNAME AND [STATUS] != 2
ELSE IF NOT EXISTS(SELECT 1 FROM USERINFO WHERE USERID = @USERID AND DEFAULTROLEID!=-1)
SELECT 'NO ROLE ASSIGNED' AS MSG, @PGLO_LA AS GLOBALLOGINATTEMPTS, LOGINATTEMPTS USERLOGINATTEMPTS,USERTYPEID
FROM USERS U
INNER JOIN USERINFO UI ON UI.USERID = U.USERID
WHERE COMPANYID=@PCOMPANYID AND USERNAME=@PUSERNAME AND [STATUS] != 2
ELSE IF NOT EXISTS(SELECT 1 FROM USERINFO WHERE USERID = @USERID AND DEFAULTSITEID!=-1)
SELECT 'NO SITE ASSIGNED' AS MSG, @PGLO_LA AS GLOBALLOGINATTEMPTS, LOGINATTEMPTS USERLOGINATTEMPTS,USERTYPEID
FROM USERS U
INNER JOIN USERINFO UI ON UI.USERID = U.USERID
WHERE COMPANYID=@PCOMPANYID AND USERNAME=@PUSERNAME AND [STATUS] != 2

END
ELSE
BEGIN
SELECT 'LOCKED' AS MSG, @PGLO_LA AS GLOBALLOGINATTEMPTS, LOGINATTEMPTS USERLOGINATTEMPTS,@PWDEXPPERIOD 'PasswordExpirationPeriod',USERTYPEID,UI.ALERTMSG
FROM USERS U
INNER JOIN USERINFO UI ON UI.USERID = U.USERID
WHERE COMPANYID=@PCOMPANYID AND USERNAME=@PUSERNAME AND [STATUS] != 2

END
END
ELSE
BEGIN
IF EXISTS(SELECT 1 FROM USERS WHERE COMPANYID=@PCOMPANYID AND USERNAME=@PUSERNAME AND [STATUS] = 1)
BEGIN
IF @PGLO_ENA_LA != 0
BEGIN
IF @PCURR_LA < @PGLO_LA            
                   BEGIN            
                        UPDATE UI SET LOGINATTEMPTS=@PCURR_LA+1 
                        FROM USERINFO UI
                        INNER JOIN USERS U ON U.USERID=UI.USERID
                        WHERE COMPANYID=@PCOMPANYID AND USERNAME=@PUSERNAME AND [STATUS] NOT IN (2,3)
                   END            

                   SELECT @PCURR_LA = LOGINATTEMPTS FROM USERS U 
                   INNER JOIN USERINFO UI ON U.USERID=UI.USERID
                   WHERE COMPANYID=@PCOMPANYID AND USERNAME=@PUSERNAME  AND [STATUS] != 2          

                   PRINT @PCURR_LA            
                   PRINT @PGLO_LA            

                   IF @PCURR_LA = @PGLO_LA            
                   BEGIN            
                        UPDATE USERS SET [STATUS]=4 WHERE COMPANYID=@PCOMPANYID AND USERNAME=@PUSERNAME AND [STATUS] NOT IN (2,3) AND USERID!=1            
                   END            
              END            
              ELSE            
              BEGIN               
                   IF @PCURR_LA > 0            
                   BEGIN            
                        UPDATE UI SET LOGINATTEMPTS=0 
                        FROM USERINFO UI
                        INNER JOIN USERS U ON U.USERID = UI.USERID
                        WHERE COMPANYID=@PCOMPANYID AND USERNAME=@PUSERNAME AND [STATUS] != 2           
                   END            
              END 
          END      
          SELECT 'PWD_INVALID' AS MSG, @PGLO_LA AS GLOBALLOGINATTEMPTS, UI.LOGINATTEMPTS USERLOGINATTEMPTS,@PWDEXPPERIOD 'PasswordExpirationPeriod',USERTYPEID,UI.ALERTMSG,U.USERID,@PGLO_ENA_LA ENABLELOGINATTEMPTS 
          FROM USERS U
          INNER JOIN USERINFO UI ON UI.USERID = U.USERID
          WHERE COMPANYID=@PCOMPANYID AND USERNAME=@PUSERNAME AND [STATUS] != 2           
     END 
END
ELSE
BEGIN
SELECT 'ISOBSERVER' AS MSG, 3 AS GLOBALLOGINATTEMPTS, LOGINATTEMPTS USERLOGINATTEMPTS,@PWDEXPPERIOD 'PasswordExpirationPeriod',USERTYPEID,UI.ALERTMSG 
     FROM USERS U
     INNER JOIN USERINFO UI ON UI.USERID = U.USERID 
     WHERE COMPANYID=@PCOMPANYID AND USERNAME=@PUSERNAME  AND [STATUS] != 2           
END
