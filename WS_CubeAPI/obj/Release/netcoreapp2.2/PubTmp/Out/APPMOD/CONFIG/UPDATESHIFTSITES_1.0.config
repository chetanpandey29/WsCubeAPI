DECLARE @CC_TIMESTAMP DATETIME
SET @CC_TIMESTAMP=GETDATE()

IF EXISTS(SELECT 1 FROM ROLES WHERE ROLEID=@ROLEID AND ALLSITES=1)
BEGIN
UPDATE SITESHIFTS SET STATUS = 1,UPDATEDBY = @USERID,UPDATEDDATE = @CC_TIMESTAMP WHERE SHIFTID = @SHIFTID AND SITEID IN (SELECT RESULT FROM DBO.CSVtoTable(@SITEID));
INSERT INTO SITESHIFTS(SITEID,SHIFTID,STATUS,UPDATEDBY,UPDATEDDATE) SELECT RESULT,@SHIFTID,1,@USERID,@CC_TIMESTAMP FROM DBO.CSVtoTable(@SITEID) WHERE RESULT NOT IN (SELECT SITEID FROM SITESHIFTS WHERE SITEID IN (SELECT RESULT FROM DBO.CSVtoTable(@SITEID)) AND SHIFTID = @SHIFTID);
UPDATE SITESHIFTS SET STATUS = 0,UPDATEDBY = @USERID,UPDATEDDATE = @CC_TIMESTAMP WHERE SHIFTID = @SHIFTID AND SITEID NOT IN (SELECT RESULT FROM DBO.CSVtoTable(@SITEID))
END
ELSE
BEGIN
UPDATE SITESHIFTS SET STATUS = 1,UPDATEDBY = @USERID,UPDATEDDATE = @CC_TIMESTAMP WHERE SHIFTID = @SHIFTID AND SITEID IN (SELECT RESULT FROM DBO.CSVtoTable(@SITEID));
INSERT INTO SITESHIFTS(SITEID,SHIFTID,STATUS,UPDATEDBY,UPDATEDDATE) SELECT RESULT,@SHIFTID,1,@USERID,@CC_TIMESTAMP FROM DBO.CSVtoTable(@SITEID) WHERE RESULT NOT IN (SELECT SITEID FROM SITESHIFTS WHERE SITEID IN (SELECT RESULT FROM DBO.CSVtoTable(@SITEID)) AND SHIFTID = @SHIFTID);
UPDATE SITESHIFTS SET STATUS = 0,UPDATEDBY = @USERID,UPDATEDDATE = @CC_TIMESTAMP WHERE SHIFTID = @SHIFTID AND SITEID IN (SELECT SITEID FROM USERSITES WHERE STATUS=1 AND USERID =@USERID AND SITEID NOT IN (SELECT RESULT FROM DBO.CSVtoTable(@SITEID)))
END

INSERT INTO dbo.AUDIT(TABLENAME,TRANS,STAMP,LASTUPDATEDBY,DATA)
SELECT 'SHIFTS','UPDATE-UPDATESHIFTGENERALINFO_1.0',@CC_TIMESTAMP,@USERID,NULL