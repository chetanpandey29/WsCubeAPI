DECLARE @QRY VARCHAR(MAX),@QRY1 VARCHAR(MAX),@ISADMIN VARCHAR(8)
SET @ISADMIN='0'

IF EXISTS(SELECT 1 FROM ROLES WHERE ALLSITES=1 AND ROLEID =(SELECT DEFAULTROLEID FROM USERINFO WHERE USERID = @USERID))
SET @ISADMIN='1'
CREATE TABLE #INPUTSITES(SITEID INT)
SET @QRY=''
SET @QRY1=''
SELECT @QRY1='
INSERT INTO #INPUTSITES
SELECT RESULT FROM DBO.CSVTOTABLE('''+@SITEID+''')
'
EXEC(@QRY1)
SET @QRY = ' SELECT DISTINCT S.INJURYID,S.INJURYYEAR [YEAR],CASE WHEN S.SITEID = 0 THEN (SELECT [SITENAME] FROM SITES WHERE SITEID=SI.SITEID) ELSE ''Multiple Sites'' END [SITE NAME],S.INJURIES [No of injuries]
,CASE WHEN S.STATUS= 1 THEN ''LBLACTIVE'' WHEN S.STATUS = 0 THEN ''LBLINACTIVE''END AS [STATUS]
FROM [INJURYSTATS]  S
INNER JOIN SITEINJURYSTATS SI ON SI.INJURYID=S.INJURYID
'
+CASE WHEN ISNULL(@SITEID,'')='' THEN CASE WHEN @ISADMIN='1' THEN ' INNER JOIN SITES SS ON SS.SITEID=SI.SITEID AND SS.STATUS =1 ' ELSE
' INNER JOIN USERSITES US ON US.USERID = '+ @USERID + ' AND US.SITEID =SI.SITEID AND US.STATUS = 1' END
ELSE ' INNER JOIN #INPUTSITES SR ON SR.SITEID=SI.SITEID' END
+' WHERE S.[STATUS]<>2 AND SI.STATUS = 1'
EXEC(@QRY)