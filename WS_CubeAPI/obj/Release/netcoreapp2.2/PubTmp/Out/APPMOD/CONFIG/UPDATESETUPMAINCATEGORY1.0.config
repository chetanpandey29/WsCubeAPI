DECLARE @CC_TIMESTAMP DATETIME
SET @CC_TIMESTAMP=GETDATE()

--UPDATESETUPMAINCATEGORY1.0.config
UPDATE CHECKLISTSETUPCATEGORYASSIGNMENTS SET MAINISASSIGNED = 1,SUBISASSIGNED=1,UPDATEDBY=@UPDATEDBY,UPDATEDDATE=@CC_TIMESTAMP
WHERE CHECKLISTSETUPID=@CHECKLISTSETUPID AND MAINCATEGORYID IN (SELECT RESULT FROM DBO.CSVTOTABLE(@MAINCATEGORYID))
AND STATUS = 1

UPDATE CHECKLISTSETUPCATEGORYASSIGNMENTS SET MAINISASSIGNED = 0,SUBISASSIGNED=0,UPDATEDBY=@UPDATEDBY,UPDATEDDATE=@CC_TIMESTAMP
WHERE CHECKLISTSETUPID=@CHECKLISTSETUPID AND MAINCATEGORYID NOT IN (SELECT RESULT FROM DBO.CSVTOTABLE(@MAINCATEGORYID))
AND STATUS = 1

INSERT INTO CHECKLISTSETUPCATEGORYASSIGNMENTS(CHECKLISTSETUPID,MAINCATEGORYID,SUBCATEGORYID,MAINISASSIGNED,
SUBISASSIGNED,MAINSEQUENCE,SUBSEQUENCE,STATUS,UPDATEDBY,UPDATEDDATE)
SELECT @CHECKLISTSETUPID,RESULT,S.SUBCATEGORYID,1,1,0,0,1,@UPDATEDBY,@CC_TIMESTAMP FROM DBO.CSVTOTABLE(@MAINCATEGORYID) R
INNER JOIN SUBCATEGORIES S ON S.MAINCATEGORYID = R.RESULT
WHERE S.MAINCATEGORYID NOT IN (SELECT MAINCATEGORYID FROM CHECKLISTSETUPCATEGORYASSIGNMENTS WHERE CHECKLISTSETUPID=@CHECKLISTSETUPID);SELECT 2


INSERT INTO dbo.AUDIT(TABLENAME,TRANS,STAMP,LASTUPDATEDBY,DATA)
SELECT 'CHECKLISTSETUPCATEGORYASSIGNMENTS','UPDATE-UPDATESETUPMAINCATEGORY1.0',@CC_TIMESTAMP,@UPDATEDBY,NULL
