--INSERTSTOPCARDOBSERVATIONSFOROFFLINEAPP_1.0
DECLARE @CC_TIMESTAMP DATETIME
SET @CC_TIMESTAMP=GETDATE()

DECLARE @CARDID INT,@OBSAPPROVEMOBILE INT,@SITEID INT,@AREAID INT,@SHIFTID INT,@SETUPID INT,@OBSERVERID INT
DECLARE @MAINCTGCMTS TABLE(MAINCATEGORYID INT,SAFECMTS NVARCHAR(1024),UNSAFECMTS NVARCHAR(1024))
DECLARE @UPDATEREQUEST TABLE(USERID INT,COMMENTS NVARCHAR(1024),[TIMESTAMP] DATETIME,REQUESTTYPE INT)

DECLARE @SCOBS TABLE(MAINCATEGORYID INT,SUBCATEGORYID INT,SAFECNT INT,UNSAFECNT INT,SAFECOMMENTS NVARCHAR(MAX),UNSAFECOMMENTS NVARCHAR(MAX))
DECLARE @QRY VARCHAR(MAX),@GROUPTYPEID VARCHAR(256), @GROUPTYPENAME VARCHAR(1024),@GROUPTYPENAME1 VARCHAR(1024),@SELOBSERVERID VARCHAR(1024),@SASOCDEL NVARCHAR(8),@CUSTOMFIELDS NVARCHAR(512)
DECLARE @OBS TABLE(OBSERVERID VARCHAR(8))
DECLARE @CUSTOMFIELD1 INT,@CUSTOMFIELD2 INT,@CUSTOMFIELD3 INT
SET @SELOBSERVERID = ''

SET @CUSTOMFIELDS=''
SET @SASOCDEL=''
SELECT @SELOBSERVERID = SC.DETAIL.value('(obsid)[1]', 'int') FROM @STOPCARDOL.nodes('/card1') SC(DETAIL)


SELECT @OBSAPPROVEMOBILE=ISNULL(OBSAPPROVEMOBILE,0) FROM ROLES WHERE ROLEID =(SELECT DEFAULTROLEID FROM USERINFO WHERE USERID= (SELECT TOP 1 RESULT USERID FROM dbo.CSVTOTABLE(@SELOBSERVERID)))

INSERT INTO dbo.AUDIT(TABLENAME,TRANS,STAMP,LASTUPDATEDBY,DATA)
SELECT 'STOPCARDENTRY_OL/STOPCARDENTRYOBSERVERS_OL/STOPCARDENTRYCATEGORYCOMMENTS_OL/STOPCARDENTRYOBSERVATIONS_OL/ALL STOPCARD TABLES','VER0 AUDIT INIT',@CC_TIMESTAMP,(SELECT TOP 1 RESULT USERID FROM dbo.CSVTOTABLE(@SELOBSERVERID)) ,@STOPCARDOL


IF @OBSAPPROVEMOBILE=1
BEGIN
SELECT @CARDID = SC.DETAIL.value('(cardid)[1]', 'int') FROM @STOPCARDOL.nodes('/card1') SC(DETAIL)

IF ISNULL(@CARDID,0)=0
BEGIN
SET @SELOBSERVERID = ''
SELECT @SELOBSERVERID = SC.DETAIL.value('(obsid)[1]', 'int')
FROM @STOPCARDOL.nodes('/card1') SC(DETAIL)

INSERT INTO dbo.STOPCARDENTRY_OL(COMPANYID,CHECKLISTSETUPID,SITEID,OBSERVERCOUNT,SHIFTID,AREAID,LENGTH,PEOPLECONTACTED,PEOPLEOBSERVED,SAFECOMMENTS,
UNSAFECOMMENTS,STATUS,STOPCARDTYPE,OBSERVATIONDATE,CREATEDBY,CREATEDDATE,APPROVALSTATUS,OFFLINECARDTYPE,ISAPPROVED)

SELECT
COMPANYID=@COMPANYID,
SETUPID = SC.DETAIL.value('(setid)[1]', 'int'),
SITEID = SC.DETAIL.value('(siteid)[1]', 'int'),
OBSERVERCNT=0,
SHIFTID = SC.DETAIL.value('(shid)[1]', 'int'),
AREAID = SC.DETAIL.value('(arid)[1]', 'int'),
LENGTH = SC.DETAIL.value('(len)[1]', 'int'),
PEOPLECONTACTED = SC.DETAIL.value('(pc)[1]', 'int'),
PEOPLEOBSERVED = SC.DETAIL.value('(po)[1]', 'int'),
SC = REPLACE(REPLACE(REPLACE(SC.DETAIL.value('(sc)[1]', 'NVARCHAR(MAX)'),'&quot;','"'), '\u0027',''''),'\\','\') ,
                                USC = REPLACE(REPLACE(REPLACE(SC.DETAIL.value('(usc)[1]', 'NVARCHAR(MAX)'),'&quot;','"'), '\u0027',''''),'\\','\'),
                                STATUS=1,
                                STOPCARDTYPE=1,
                                OBSERVATIONDATE = SC.DETAIL.value('(obsdate)[1]', 'datetime'),
                                (SELECT TOP 1 RESULT USERID FROM dbo.CSVTOTABLE(@SELOBSERVERID)) CREATEDBY,
                                @CC_TIMESTAMP,1,1,0
                                FROM @STOPCARDOL.nodes('/card1') SC(DETAIL)
                                
                                SELECT @CUSTOMFIELDS=SC.DETAIL.value('(customfields)[1]', 'NVARCHAR(512)')
                                FROM @STOPCARDOL.nodes('/card1') SC(DETAIL)

                                                SELECT @CARDID=@@IDENTITY
                                                
                                                 SELECT @SITEID=SITEID,@AREAID=AREAID,@SHIFTID=SHIFTID,@SETUPID=CHECKLISTSETUPID FROM STOPCARDENTRY_OL WHERE CARDID=@CARDID
                                     
                                                 
                                                 INSERT INTO @MAINCTGCMTS
                                                SELECT MAINCATEGORYID = MAINCTG.COM.value('(id)[1]', 'INT'),
                                                SAFECOMMENT = MAINCTG.COM.value('(sc)[1]', 'NVARCHAR(MAX)'),
                                                UNSAFECOMMENT = MAINCTG.COM.value('(usc)[1]', 'NVARCHAR(MAX)')
                                                FROM
                                                @STOPCARDOL.nodes('/card1/mctg') MAINCTG(com)
                                     
                                                 UPDATE @MAINCTGCMTS SET SAFECMTS=REPLACE(REPLACE(REPLACE(SAFECMTS,'&quot;','"'), '\u0027',''''),'\\','\') 
                                                UPDATE @MAINCTGCMTS SET UNSAFECMTS=REPLACE(REPLACE(REPLACE(UNSAFECMTS,'&quot;','"'), '\u0027',''''),'\\','\') 

                                                INSERT INTO @SCOBS
                                                SELECT SUB.MAINCATEGORYID,
                                                SUBCATEGORYID = SUBCTG.CNT.value('(id)[1]', 'INT'),
                                                SAFECNT = SUBCTG.CNT.value('(sfcnt)[1]', 'int'),
                                                UNSAFECNT = SUBCTG.CNT.value('(usfcnt)[1]', 'int'),
                                                SAFECOMMENT = SUBCTG.CNT.value('(sc)[1]', 'NVARCHAR(MAX)'),
                                                UNSAFECOMMENT = SUBCTG.CNT.value('(usc)[1]', 'NVARCHAR(MAX)')
                                                FROM
                                                @STOPCARDOL.nodes('/card1/mctg/sctg') SUBCTG(CNT)
                                                INNER JOIN SUBCATEGORIES SUB ON SUB.SUBCATEGORYID=SUBCTG.CNT.value('(id)[1]', 'INT')
                                                INSERT INTO @OBS
                                                SELECT
                                                SC.DETAIL.value('(obsid)[1]', 'VARCHAR(MAX)')
                                                FROM @STOPCARDOL.nodes('/card1') SC(DETAIL)

                                                UPDATE @SCOBS SET SAFECOMMENTS=REPLACE(REPLACE(REPLACE(SAFECOMMENTS,'&quot;','"'), '\u0027',''''),'\\','\') 
                                                UPDATE @SCOBS SET UNSAFECOMMENTS=REPLACE(REPLACE(REPLACE(UNSAFECOMMENTS,'&quot;','"'), '\u0027',''''),'\\','\') 
                                     
                                                 DELETE FROM STOPCARDENTRYOBSERVERS_OL WHERE CARDID = @CARDID

                                                INSERT INTO STOPCARDENTRYOBSERVERS_OL(CARDID,OBSERVERID,GROUP1,GROUP1NAME,GROUP2,GROUP2NAME,GROUP3,GROUP3NAME,GROUP4,GROUP4NAME,GROUP5,GROUP5NAME,GROUP6,GROUP6NAME,GROUP7,GROUP7NAME,GROUP8,GROUP8NAME,GROUP9,GROUP9NAME,GROUP10,GROUP10NAME,UPDATEDBY,UPDATEDDATE)
                                                SELECT @CARDID,RESULT USERID,
                                                (SELECT GROUPID FROM USERGROUPS WHERE STATUS=1 AND USERID = RESULT AND GROUPTYPEID=(SELECT RELATIONID FROM REPORTOPTIONSMASTER WHERE STATUS = 1 AND REPORTPARAM='GROUP1')),
                                                (SELECT GROUPNAME FROM GROUPS WHERE GROUPID=(SELECT GROUPID FROM USERGROUPS WHERE STATUS=1 AND USERID = RESULT AND GROUPTYPEID=(SELECT RELATIONID FROM REPORTOPTIONSMASTER WHERE STATUS = 1 AND REPORTPARAM='GROUP1'))),
                                                (SELECT GROUPID FROM USERGROUPS WHERE STATUS=1 AND USERID = RESULT AND GROUPTYPEID=(SELECT RELATIONID FROM REPORTOPTIONSMASTER WHERE STATUS = 1 AND REPORTPARAM='GROUP2')),
                                                (SELECT GROUPNAME FROM GROUPS WHERE GROUPID=(SELECT GROUPID FROM USERGROUPS WHERE STATUS=1 AND USERID = RESULT AND GROUPTYPEID=(SELECT RELATIONID FROM REPORTOPTIONSMASTER WHERE STATUS = 1 AND REPORTPARAM='GROUP2'))),
                                                (SELECT GROUPID FROM USERGROUPS WHERE STATUS=1 AND USERID = RESULT AND GROUPTYPEID=(SELECT RELATIONID FROM REPORTOPTIONSMASTER WHERE STATUS = 1 AND REPORTPARAM='GROUP3')),
                                                (SELECT GROUPNAME FROM GROUPS WHERE GROUPID=(SELECT GROUPID FROM USERGROUPS WHERE STATUS=1 AND USERID = RESULT AND GROUPTYPEID=(SELECT RELATIONID FROM REPORTOPTIONSMASTER WHERE STATUS = 1 AND REPORTPARAM='GROUP3'))),
                                                (SELECT GROUPID FROM USERGROUPS WHERE STATUS=1 AND USERID = RESULT AND GROUPTYPEID=(SELECT RELATIONID FROM REPORTOPTIONSMASTER WHERE STATUS = 1 AND REPORTPARAM='GROUP4')),
                                                (SELECT GROUPNAME FROM GROUPS WHERE GROUPID=(SELECT GROUPID FROM USERGROUPS WHERE STATUS=1 AND USERID = RESULT AND GROUPTYPEID=(SELECT RELATIONID FROM REPORTOPTIONSMASTER WHERE STATUS = 1 AND REPORTPARAM='GROUP4'))),
                                                (SELECT GROUPID FROM USERGROUPS WHERE STATUS=1 AND USERID = RESULT AND GROUPTYPEID=(SELECT RELATIONID FROM REPORTOPTIONSMASTER WHERE STATUS = 1 AND REPORTPARAM='GROUP5')),
                                                (SELECT GROUPNAME FROM GROUPS WHERE GROUPID=(SELECT GROUPID FROM USERGROUPS WHERE STATUS=1 AND USERID = RESULT AND GROUPTYPEID=(SELECT RELATIONID FROM REPORTOPTIONSMASTER WHERE STATUS = 1 AND REPORTPARAM='GROUP5'))),
                                                (SELECT GROUPID FROM USERGROUPS WHERE STATUS=1 AND USERID = RESULT AND GROUPTYPEID=(SELECT RELATIONID FROM REPORTOPTIONSMASTER WHERE STATUS = 1 AND REPORTPARAM='GROUP6')),
                                                (SELECT GROUPNAME FROM GROUPS WHERE GROUPID=(SELECT GROUPID FROM USERGROUPS WHERE STATUS=1 AND USERID = RESULT AND GROUPTYPEID=(SELECT RELATIONID FROM REPORTOPTIONSMASTER WHERE STATUS = 1 AND REPORTPARAM='GROUP6'))),
                                                (SELECT GROUPID FROM USERGROUPS WHERE STATUS=1 AND USERID = RESULT AND GROUPTYPEID=(SELECT RELATIONID FROM REPORTOPTIONSMASTER WHERE STATUS = 1 AND REPORTPARAM='GROUP7')),
                                                (SELECT GROUPNAME FROM GROUPS WHERE GROUPID=(SELECT GROUPID FROM USERGROUPS WHERE STATUS=1 AND USERID = RESULT AND GROUPTYPEID=(SELECT RELATIONID FROM REPORTOPTIONSMASTER WHERE STATUS = 1 AND REPORTPARAM='GROUP7'))),
                                                (SELECT GROUPID FROM USERGROUPS WHERE STATUS=1 AND USERID = RESULT AND GROUPTYPEID=(SELECT RELATIONID FROM REPORTOPTIONSMASTER WHERE STATUS = 1 AND REPORTPARAM='GROUP8')),
                                                (SELECT GROUPNAME FROM GROUPS WHERE GROUPID=(SELECT GROUPID FROM USERGROUPS WHERE STATUS=1 AND USERID = RESULT AND GROUPTYPEID=(SELECT RELATIONID FROM REPORTOPTIONSMASTER WHERE STATUS = 1 AND REPORTPARAM='GROUP8'))),
                                                (SELECT GROUPID FROM USERGROUPS WHERE STATUS=1 AND USERID = RESULT AND GROUPTYPEID=(SELECT RELATIONID FROM REPORTOPTIONSMASTER WHERE STATUS = 1 AND REPORTPARAM='GROUP9')),
                                                (SELECT GROUPNAME FROM GROUPS WHERE GROUPID=(SELECT GROUPID FROM USERGROUPS WHERE STATUS=1 AND USERID = RESULT AND GROUPTYPEID=(SELECT RELATIONID FROM REPORTOPTIONSMASTER WHERE STATUS = 1 AND REPORTPARAM='GROUP9'))),
                                                (SELECT GROUPID FROM USERGROUPS WHERE STATUS=1 AND USERID = RESULT AND GROUPTYPEID=(SELECT RELATIONID FROM REPORTOPTIONSMASTER WHERE STATUS = 1 AND REPORTPARAM='GROUP10')),
                                                (SELECT GROUPNAME FROM GROUPS WHERE GROUPID=(SELECT GROUPID FROM USERGROUPS WHERE STATUS=1 AND USERID = RESULT AND GROUPTYPEID=(SELECT RELATIONID FROM REPORTOPTIONSMASTER WHERE STATUS = 1 AND REPORTPARAM='GROUP10'))),
                                                (SELECT TOP 1 RESULT USERID FROM dbo.CSVTOTABLE(@SELOBSERVERID)),
                                                @CC_TIMESTAMP
                                                FROM dbo.CSVTOTABLE(@SELOBSERVERID) U1
                                                INNER JOIN USERS U ON U.USERID=U1.RESULT
                                                INNER JOIN USERINFO UI ON UI.USERID=U.USERID
                                                WHERE U.STATUS !=2 AND UI.USERTYPEID IN (1,2)
                                                
                                                
                                     
                                                 INSERT INTO STOPCARDENTRYOBSERVERS_OL(CARDID,OBSERVERID,STATUS,UPDATEDBY,UPDATEDDATE)
                                                SELECT @CARDID,RESULT,1,(SELECT TOP 1 RESULT USERID FROM dbo.CSVTOTABLE(@SELOBSERVERID)),
                                                @CC_TIMESTAMP FROM DBO.CSVTOTABLE(@SELOBSERVERID)  U1
                                                INNER JOIN USERS U ON U.USERID=U1.RESULT
                                                INNER JOIN USERINFO UI ON UI.USERID=U.USERID
                                                WHERE U.STATUS !=2 AND UI.USERTYPEID IN (1,2)
                                                AND RESULT NOT IN (SELECT OBSERVERID FROM STOPCARDENTRYOBSERVERS_OL WHERE CARDID=@CARDID)

                                                
                                                IF (SELECT COUNT(DISTINCT RESULT) FROM dbo.CSVTOTABLE(@SELOBSERVERID))=1
                                                BEGIN
													IF EXISTS(SELECT 1 FROM dbo.CSVTOTABLE(@SELOBSERVERID) UU INNER JOIN USERS U ON U.USERID=UU.RESULT WHERE U.STATUS=2)
													BEGIN
														SET @SASOCDEL='-3'
														UPDATE STOPCARDENTRY_OL SET STATUS=2 WHERE CARDID=@CARDID
													END
													IF EXISTS(SELECT 1 FROM dbo.CSVTOTABLE(@SELOBSERVERID) SCO 
													INNER JOIN USERINFO UI ON UI.USERID=SCO.RESULT WHERE UI.USERTYPEID=0)
													BEGIN
														--WILL WORK FOR ONLY OLDER VERSION WITH USERTYPE AS USER(0) IN NEW VERSION ONLY USERTYPEID 1,2 TYPE USER IS SELECTED
														INSERT INTO STOPCARDENTRYOBSERVERS_OL(CARDID,OBSERVERID,STATUS,UPDATEDBY,UPDATEDDATE)
															SELECT @CARDID,RESULT,1,(SELECT TOP 1 RESULT USERID FROM dbo.CSVTOTABLE(@SELOBSERVERID)),
															@CC_TIMESTAMP FROM DBO.CSVTOTABLE(@SELOBSERVERID)  U1
															INNER JOIN USERS U ON U.USERID=U1.RESULT
															INNER JOIN USERINFO UI ON UI.USERID=U.USERID
															WHERE U.STATUS !=2 AND UI.USERTYPEID = 0
															AND RESULT NOT IN (SELECT OBSERVERID FROM STOPCARDENTRYOBSERVERS_OL WHERE CARDID=@CARDID)
															
														UPDATE STOPCARDENTRY_OL SET OFFLINECARDTYPE=2 WHERE CARDID=@CARDID 
														AND EXISTS(SELECT 1 FROM STOPCARDENTRYOBSERVERS_OL SCO 
														INNER JOIN USERINFO UI ON UI.USERID=SCO.OBSERVERID WHERE UI.USERTYPEID=0)
													END
													
                                                END
                                                ELSE IF (SELECT COUNT(DISTINCT RESULT) FROM dbo.CSVTOTABLE(@SELOBSERVERID))>1
                                                BEGIN
													IF (SELECT COUNT(DISTINCT RESULT) FROM dbo.CSVTOTABLE(@SELOBSERVERID))=
													(SELECT COUNT(DISTINCT USERID) FROM dbo.CSVTOTABLE(@SELOBSERVERID) UU INNER JOIN USERS U ON U.USERID=UU.RESULT WHERE U.STATUS=2)
													BEGIN
														SET @SASOCDEL='-3'
														UPDATE STOPCARDENTRY_OL SET STATUS=2 WHERE CARDID=@CARDID
													END
                                                END
                                                IF (SELECT COUNT(DISTINCT OBSERVERID) FROM STOPCARDENTRYOBSERVERS_OL WHERE CARDID=@CARDID)>1
                                                                UPDATE dbo.STOPCARDENTRY_OL SET OBSERVERCOUNT=1 WHERE CARDID=@CARDID
                                                ELSE IF (SELECT COUNT(DISTINCT OBSERVERID) FROM STOPCARDENTRYOBSERVERS_OL WHERE CARDID=@CARDID)=1
                                                                UPDATE dbo.STOPCARDENTRY_OL SET OBSERVERCOUNT=0 WHERE CARDID=@CARDID
                                                --MAINCATEGORY COMMENTS
                                                INSERT INTO STOPCARDENTRYCATEGORYCOMMENTS_OL(CARDID,MAINCATEGORYID,SUBCATEGORYID,SAFECOMMENTS,
                                                UNSAFECOMMENTS,STATUS,UPDATEDBY,UPDATEDDATE)
                                                SELECT @CARDID,MAINCATEGORYID,0,SAFECMTS,UNSAFECMTS,1,(SELECT TOP 1 RESULT USERID FROM dbo.CSVTOTABLE(@SELOBSERVERID)),@CC_TIMESTAMP FROM @MAINCTGCMTS
                                                WHERE LEN(SAFECMTS)>0 OR LEN(UNSAFECMTS)>0

                                                --SUBCATEGORY COMMENTS
                                                INSERT INTO STOPCARDENTRYCATEGORYCOMMENTS_OL(CARDID,MAINCATEGORYID,SUBCATEGORYID,SAFECOMMENTS,
                                                UNSAFECOMMENTS,STATUS,UPDATEDBY,UPDATEDDATE)
                                                SELECT @CARDID,MAINCATEGORYID,SUBCATEGORYID,SAFECOMMENTS,UNSAFECOMMENTS,1,(SELECT TOP 1 RESULT USERID FROM dbo.CSVTOTABLE(@SELOBSERVERID)),@CC_TIMESTAMP UPDATEDDATE FROM @SCOBS
                                                WHERE LEN(SAFECOMMENTS)>0 OR LEN(UNSAFECOMMENTS)>0

                                                INSERT INTO STOPCARDENTRYOBSERVATIONS_OL(CARDID,MAINCATEGORYID,SUBCATEGORYID,SAFE,UNSAFE,SAFECOMMENTS,
                                                UNSAFECOMMENTS,STATUS,UPDATEDBY,UPDATEDDATE)
                                                SELECT @CARDID,MAINCATEGORYID,SUBCATEGORYID,SAFECNT,UNSAFECNT,NULL SAFECMTS,NULL UNSAFECMTS,1 STATUS,(SELECT TOP 1 RESULT USERID FROM dbo.CSVTOTABLE(@SELOBSERVERID)),@CC_TIMESTAMP UPDATEDDATE FROM @SCOBS
                                                
                                                SET @QRY=''
                                                SET @QRY='INSERT INTO STOPCARDENTRYCUSTOMFIELDS_OL(CARDID,CUSTOMFIELD1,CUSTOMFIELD2,CUSTOMFIELD3,STATUS,UPDATEDBY,UPDATEDDATE)
                                                
                                                SELECT '+CAST(@CARDID AS NVARCHAR(8))+','+REPLACE(@CUSTOMFIELDS,'|',',')+',1,'+(SELECT TOP 1 CAST(RESULT AS NVARCHAR(8)) FROM dbo.CSVTOTABLE(@SELOBSERVERID))+',GETDATE()'
                                                EXEC(@QRY)
                                                
                                                SELECT @CUSTOMFIELD1=CUSTOMFIELD1,@CUSTOMFIELD2=CUSTOMFIELD2,@CUSTOMFIELD3=CUSTOMFIELD3  FROM STOPCARDENTRYCUSTOMFIELDS_OL WHERE CARDID=@CARDID
                                                                                        
                                                UPDATE STOPCARDENTRYCUSTOMFIELDS_OL SET CUSTOMFIELD1 = NULL WHERE CUSTOMFIELD1=0 AND CARDID=@CARDID                          
												UPDATE STOPCARDENTRYCUSTOMFIELDS_OL SET CUSTOMFIELD2 = NULL WHERE CUSTOMFIELD2=0 AND CARDID=@CARDID
												UPDATE STOPCARDENTRYCUSTOMFIELDS_OL SET CUSTOMFIELD3 = NULL WHERE CUSTOMFIELD3=0 AND CARDID=@CARDID
												
												UPDATE STOPCARDENTRYCUSTOMFIELDS_OL SET CUSTOMFIELD1 = NULL WHERE CARDID=@CARDID AND EXISTS(SELECT 1 FROM CUSTOMFIELDVALUES WHERE CUSTOMFIELDVALUEID=CUSTOMFIELD1 AND STATUS =2) 
												UPDATE STOPCARDENTRYCUSTOMFIELDS_OL SET CUSTOMFIELD2 = NULL WHERE CARDID=@CARDID AND EXISTS(SELECT 1 FROM CUSTOMFIELDVALUES WHERE CUSTOMFIELDVALUEID=CUSTOMFIELD2 AND STATUS =2) 
												UPDATE STOPCARDENTRYCUSTOMFIELDS_OL SET CUSTOMFIELD3 = NULL WHERE CARDID=@CARDID AND EXISTS(SELECT 1 FROM CUSTOMFIELDVALUES WHERE CUSTOMFIELDVALUEID=CUSTOMFIELD3 AND STATUS =2) 
												
												DELETE FROM STOPCARDENTRYCUSTOMFIELDS_OL WHERE CUSTOMFIELD1 IS NULL AND CUSTOMFIELD2 IS NULL AND CUSTOMFIELD3 IS NULL AND CARDID=@CARDID

												IF EXISTS(SELECT 1 FROM SITES WHERE SITEID=@SITEID AND STATUS=2) OR
                                                EXISTS(SELECT 1 FROM AREAS WHERE AREAID=@AREAID AND STATUS=2) OR
                                                EXISTS(SELECT 1 FROM SHIFTS WHERE SHIFTID=@SHIFTID AND STATUS=2)OR
                                                EXISTS(SELECT 1 FROM CHECKLISTSETUP WHERE CHECKLISTSETUPID=@SETUPID AND STATUS=2) OR
                                                (@CUSTOMFIELD1>0 AND EXISTS(SELECT 1 FROM CUSTOMFIELDVALUES WHERE STATUS =2 AND CUSTOMFIELDVALUEID=@CUSTOMFIELD1)) OR
                                                (@CUSTOMFIELD2>0 AND EXISTS(SELECT 1 FROM CUSTOMFIELDVALUES WHERE STATUS =2 AND CUSTOMFIELDVALUEID=@CUSTOMFIELD2)) OR
                                                (@CUSTOMFIELD3>0 AND EXISTS(SELECT 1 FROM CUSTOMFIELDVALUES WHERE STATUS =2 AND CUSTOMFIELDVALUEID=@CUSTOMFIELD3))
                                                BEGIN
												      UPDATE STOPCARDENTRY_OL SET STATUS=2 WHERE CARDID=@CARDID
														SET @SASOCDEL='-3'
												END
												INSERT INTO AUDIT(TABLENAME,TRANS,STAMP,LASTUPDATEDBY,DATA)
												SELECT 'STOPCARDENTRY_/STOPCARDENTRYOBSERVERS_OL/ALL_OL TABLES','VER0 INSERT:'+CAST(@CARDID AS NVARCHAR(8)),GETDATE(),@SELOBSERVERID,@STOPCARDOL
												
                                                SELECT CAST(@CARDID AS NVARCHAR(8))+'~'+CASE WHEN EXISTS(SELECT 1 FROM STOPCARDENTRY_OL WHERE CARDID=@CARDID AND OFFLINECARDTYPE=2) THEN '4' /*WORKS ONLY FOR OLDER VERSION CARDS*/ WHEN EXISTS(SELECT 1 FROM STOPCARDENTRY_OL WHERE CARDID=@CARDID AND STATUS =2 AND OFFLINECARDTYPE=1) AND @SASOCDEL='-3' THEN '-3'  WHEN EXISTS(SELECT 1 FROM STOPCARDENTRY_OL WHERE CARDID=@CARDID AND STATUS =2 AND OFFLINECARDTYPE=1) AND @SASOCDEL='' THEN '-4' ELSE (SELECT CAST(APPROVALSTATUS AS NVARCHAR(8)) FROM STOPCARDENTRY_OL WHERE CARDID=@CARDID AND OFFLINECARDTYPE=1) END CARDID
                END
                ELSE IF @CARDID>0 AND EXISTS(SELECT 1 FROM STOPCARDENTRY_OL WHERE CARDID=@CARDID AND STATUS !=2 AND ISAPPROVED=0 AND OFFLINECARDTYPE=1)
                BEGIN
                                
                                SET @SELOBSERVERID = ''
                                SELECT @SELOBSERVERID = SC.DETAIL.value('(obsid)[1]', 'int')
                                FROM @STOPCARDOL.nodes('/card1') SC(DETAIL)


                                --INSERT INTO dbo.STOPCARDENTRY_OL(COMPANYID,CHECKLISTSETUPID,SITEID,OBSERVERCOUNT,SHIFTID,AREAID,LENGTH,PEOPLECONTACTED,PEOPLEOBSERVED,SAFECOMMENTS,
                                --UNSAFECOMMENTS,STATUS,STOPCARDTYPE,OBSERVATIONDATE,CREATEDBY,CREATEDDATE,APPROVALSTATUS,ISPOAPPROVED)
                                UPDATE OL SET OBSERVERCOUNT=0,SHIFTID=T.SHIFTID,AREAID=T.AREAID,
                LENGTH=T.LENGTH,PEOPLECONTACTED=T.PEOPLECONTACTED,PEOPLEOBSERVED=T.PEOPLEOBSERVED,SAFECOMMENTS=T.SC,UNSAFECOMMENTS=T.USC,
                OBSERVATIONDATE=T.OBSERVATIONDATE,UPDATEDBY=T.CREATEDBY,UPDATEDDATE=@CC_TIMESTAMP,APPROVALSTATUS=T.CARDSTATUS,EDITOR=NULL,EDITORTIMESTAMP=NULL
                                FROM STOPCARDENTRY_OL OL
                                INNER JOIN (
                                SELECT
                                @CARDID CARDID,
                                SETUPID = SC.DETAIL.value('(setid)[1]', 'int'),
                                SITEID = SC.DETAIL.value('(siteid)[1]', 'int'),
                                OBSERVERCNT=0,
                                SHIFTID = SC.DETAIL.value('(shid)[1]', 'int'),
                                AREAID = SC.DETAIL.value('(arid)[1]', 'int'),
                                LENGTH = SC.DETAIL.value('(len)[1]', 'int'),
                                PEOPLECONTACTED = SC.DETAIL.value('(pc)[1]', 'int'),
                                PEOPLEOBSERVED = SC.DETAIL.value('(po)[1]', 'int'),
                                SC = REPLACE(REPLACE(REPLACE(SC.DETAIL.value('(sc)[1]', 'NVARCHAR(MAX)'),'&quot;','"'), '\u0027',''''),'\\','\') ,
                                USC = REPLACE(REPLACE(REPLACE(SC.DETAIL.value('(usc)[1]', 'NVARCHAR(MAX)'),'&quot;','"'), '\u0027',''''),'\\','\'),
                                STATUS=1,
                                STOPCARDTYPE=1,
                                OBSERVATIONDATE = SC.DETAIL.value('(obsdate)[1]', 'datetime'),
                                (SELECT TOP 1 RESULT USERID FROM dbo.CSVTOTABLE(@SELOBSERVERID)) CREATEDBY,
                                CARDSTATUS = SC.DETAIL.value('(cardstatus)[1]', 'int')
                                FROM @STOPCARDOL.nodes('/card1') SC(DETAIL)) T ON T.CARDID=OL.CARDID

								SELECT @CUSTOMFIELDS=SC.DETAIL.value('(customfields)[1]', 'NVARCHAR(512)')
                                FROM @STOPCARDOL.nodes('/card1') SC(DETAIL)
                                
                                SELECT @SITEID=SITEID,@AREAID=AREAID,@SHIFTID=SHIFTID,@SETUPID=CHECKLISTSETUPID FROM STOPCARDENTRY_OL WHERE CARDID=@CARDID
                                     
                                     
                                INSERT INTO @UPDATEREQUEST(USERID,COMMENTS,[TIMESTAMP],REQUESTTYPE)                  
                                SELECT USERID = RESUBMIT.COM.value('(userid)[1]', 'INT'),
                                COMMENTS = RESUBMIT.COM.value('(comments)[1]', 'NVARCHAR(MAX)'),
                                [TIMESTAMP] = RESUBMIT.COM.value('(timestamp)[1]', 'DATETIME'),
                                REQUESTTYPE = RESUBMIT.COM.value('(requesttype)[1]', 'INT')
                                FROM
                                @STOPCARDOL.nodes('/card1/resubmit') RESUBMIT(com)
                                   
                                INSERT INTO @MAINCTGCMTS
                                SELECT MAINCATEGORYID = MAINCTG.COM.value('(id)[1]', 'INT'),
                                SAFECOMMENT = MAINCTG.COM.value('(sc)[1]', 'NVARCHAR(MAX)'),
                                UNSAFECOMMENT = MAINCTG.COM.value('(usc)[1]', 'NVARCHAR(MAX)')
                                FROM
                                @STOPCARDOL.nodes('/card1/mctg') MAINCTG(com)
                                     
                                 UPDATE @MAINCTGCMTS SET SAFECMTS=REPLACE(REPLACE(REPLACE(SAFECMTS,'&quot;','"'), '\u0027',''''),'\\','\') 
                                 UPDATE @MAINCTGCMTS SET UNSAFECMTS=REPLACE(REPLACE(REPLACE(UNSAFECMTS,'&quot;','"'), '\u0027',''''),'\\','\') 

                                INSERT INTO @SCOBS
                                SELECT SUB.MAINCATEGORYID,
                                SUBCATEGORYID = SUBCTG.CNT.value('(id)[1]', 'INT'),
                                SAFECNT = SUBCTG.CNT.value('(sfcnt)[1]', 'int'),
                                UNSAFECNT = SUBCTG.CNT.value('(usfcnt)[1]', 'int'),
                                SAFECOMMENT = SUBCTG.CNT.value('(sc)[1]', 'NVARCHAR(MAX)'),
                                UNSAFECOMMENT = SUBCTG.CNT.value('(usc)[1]', 'NVARCHAR(MAX)')
                                FROM
                                @STOPCARDOL.nodes('/card1/mctg/sctg') SUBCTG(CNT)
                                INNER JOIN SUBCATEGORIES SUB ON SUB.SUBCATEGORYID=SUBCTG.CNT.value('(id)[1]', 'INT')
                                INSERT INTO @OBS
                                SELECT
                                SC.DETAIL.value('(obsid)[1]', 'VARCHAR(MAX)')
                                FROM @STOPCARDOL.nodes('/card1') SC(DETAIL)

                                UPDATE @SCOBS SET SAFECOMMENTS=REPLACE(REPLACE(REPLACE(SAFECOMMENTS,'&quot;','"'), '\u0027',''''),'\\','\') 
								UPDATE @SCOBS SET UNSAFECOMMENTS=REPLACE(REPLACE(REPLACE(UNSAFECOMMENTS,'&quot;','"'), '\u0027',''''),'\\','\') 
                                     
                                 DELETE FROM STOPCARDENTRYOBSERVERS_OL WHERE CARDID = @CARDID

                                INSERT INTO STOPCARDENTRYOBSERVERS_OL(CARDID,OBSERVERID,GROUP1,GROUP1NAME,GROUP2,GROUP2NAME,GROUP3,GROUP3NAME,GROUP4,GROUP4NAME,GROUP5,GROUP5NAME,GROUP6,GROUP6NAME,GROUP7,GROUP7NAME,GROUP8,GROUP8NAME,GROUP9,GROUP9NAME,GROUP10,GROUP10NAME,UPDATEDBY,UPDATEDDATE)
                                SELECT @CARDID,RESULT USERID,
                                (SELECT GROUPID FROM USERGROUPS WHERE STATUS=1 AND USERID = RESULT AND GROUPTYPEID=(SELECT RELATIONID FROM REPORTOPTIONSMASTER WHERE STATUS = 1 AND REPORTPARAM='GROUP1')),
                                (SELECT GROUPNAME FROM GROUPS WHERE GROUPID=(SELECT GROUPID FROM USERGROUPS WHERE STATUS=1 AND USERID = RESULT AND GROUPTYPEID=(SELECT RELATIONID FROM REPORTOPTIONSMASTER WHERE STATUS = 1 AND REPORTPARAM='GROUP1'))),
                                (SELECT GROUPID FROM USERGROUPS WHERE STATUS=1 AND USERID = RESULT AND GROUPTYPEID=(SELECT RELATIONID FROM REPORTOPTIONSMASTER WHERE STATUS = 1 AND REPORTPARAM='GROUP2')),
                                (SELECT GROUPNAME FROM GROUPS WHERE GROUPID=(SELECT GROUPID FROM USERGROUPS WHERE STATUS=1 AND USERID = RESULT AND GROUPTYPEID=(SELECT RELATIONID FROM REPORTOPTIONSMASTER WHERE STATUS = 1 AND REPORTPARAM='GROUP2'))),
                                (SELECT GROUPID FROM USERGROUPS WHERE STATUS=1 AND USERID = RESULT AND GROUPTYPEID=(SELECT RELATIONID FROM REPORTOPTIONSMASTER WHERE STATUS = 1 AND REPORTPARAM='GROUP3')),
                                (SELECT GROUPNAME FROM GROUPS WHERE GROUPID=(SELECT GROUPID FROM USERGROUPS WHERE STATUS=1 AND USERID = RESULT AND GROUPTYPEID=(SELECT RELATIONID FROM REPORTOPTIONSMASTER WHERE STATUS = 1 AND REPORTPARAM='GROUP3'))),
                                (SELECT GROUPID FROM USERGROUPS WHERE STATUS=1 AND USERID = RESULT AND GROUPTYPEID=(SELECT RELATIONID FROM REPORTOPTIONSMASTER WHERE STATUS = 1 AND REPORTPARAM='GROUP4')),
                                (SELECT GROUPNAME FROM GROUPS WHERE GROUPID=(SELECT GROUPID FROM USERGROUPS WHERE STATUS=1 AND USERID = RESULT AND GROUPTYPEID=(SELECT RELATIONID FROM REPORTOPTIONSMASTER WHERE STATUS = 1 AND REPORTPARAM='GROUP4'))),
                                (SELECT GROUPID FROM USERGROUPS WHERE STATUS=1 AND USERID = RESULT AND GROUPTYPEID=(SELECT RELATIONID FROM REPORTOPTIONSMASTER WHERE STATUS = 1 AND REPORTPARAM='GROUP5')),
                                (SELECT GROUPNAME FROM GROUPS WHERE GROUPID=(SELECT GROUPID FROM USERGROUPS WHERE STATUS=1 AND USERID = RESULT AND GROUPTYPEID=(SELECT RELATIONID FROM REPORTOPTIONSMASTER WHERE STATUS = 1 AND REPORTPARAM='GROUP5'))),
                                (SELECT GROUPID FROM USERGROUPS WHERE STATUS=1 AND USERID = RESULT AND GROUPTYPEID=(SELECT RELATIONID FROM REPORTOPTIONSMASTER WHERE STATUS = 1 AND REPORTPARAM='GROUP6')),
                                (SELECT GROUPNAME FROM GROUPS WHERE GROUPID=(SELECT GROUPID FROM USERGROUPS WHERE STATUS=1 AND USERID = RESULT AND GROUPTYPEID=(SELECT RELATIONID FROM REPORTOPTIONSMASTER WHERE STATUS = 1 AND REPORTPARAM='GROUP6'))),
                                (SELECT GROUPID FROM USERGROUPS WHERE STATUS=1 AND USERID = RESULT AND GROUPTYPEID=(SELECT RELATIONID FROM REPORTOPTIONSMASTER WHERE STATUS = 1 AND REPORTPARAM='GROUP7')),
                                (SELECT GROUPNAME FROM GROUPS WHERE GROUPID=(SELECT GROUPID FROM USERGROUPS WHERE STATUS=1 AND USERID = RESULT AND GROUPTYPEID=(SELECT RELATIONID FROM REPORTOPTIONSMASTER WHERE STATUS = 1 AND REPORTPARAM='GROUP7'))),
                                (SELECT GROUPID FROM USERGROUPS WHERE STATUS=1 AND USERID = RESULT AND GROUPTYPEID=(SELECT RELATIONID FROM REPORTOPTIONSMASTER WHERE STATUS = 1 AND REPORTPARAM='GROUP8')),
                                (SELECT GROUPNAME FROM GROUPS WHERE GROUPID=(SELECT GROUPID FROM USERGROUPS WHERE STATUS=1 AND USERID = RESULT AND GROUPTYPEID=(SELECT RELATIONID FROM REPORTOPTIONSMASTER WHERE STATUS = 1 AND REPORTPARAM='GROUP8'))),
                                (SELECT GROUPID FROM USERGROUPS WHERE STATUS=1 AND USERID = RESULT AND GROUPTYPEID=(SELECT RELATIONID FROM REPORTOPTIONSMASTER WHERE STATUS = 1 AND REPORTPARAM='GROUP9')),
                                (SELECT GROUPNAME FROM GROUPS WHERE GROUPID=(SELECT GROUPID FROM USERGROUPS WHERE STATUS=1 AND USERID = RESULT AND GROUPTYPEID=(SELECT RELATIONID FROM REPORTOPTIONSMASTER WHERE STATUS = 1 AND REPORTPARAM='GROUP9'))),
                                (SELECT GROUPID FROM USERGROUPS WHERE STATUS=1 AND USERID = RESULT AND GROUPTYPEID=(SELECT RELATIONID FROM REPORTOPTIONSMASTER WHERE STATUS = 1 AND REPORTPARAM='GROUP10')),
                                (SELECT GROUPNAME FROM GROUPS WHERE GROUPID=(SELECT GROUPID FROM USERGROUPS WHERE STATUS=1 AND USERID = RESULT AND GROUPTYPEID=(SELECT RELATIONID FROM REPORTOPTIONSMASTER WHERE STATUS = 1 AND REPORTPARAM='GROUP10'))),
                                (SELECT TOP 1 RESULT USERID FROM dbo.CSVTOTABLE(@SELOBSERVERID)),
                                @CC_TIMESTAMP
                                FROM dbo.CSVTOTABLE(@SELOBSERVERID) U1
                                INNER JOIN USERS U ON U.USERID=U1.RESULT
                                INNER JOIN USERINFO UI ON UI.USERID=U.USERID
                                WHERE U.STATUS !=2 AND UI.USERTYPEID IN (1,2)
                                                     
                                 INSERT INTO STOPCARDENTRYOBSERVERS_OL(CARDID,OBSERVERID,STATUS,UPDATEDBY,UPDATEDDATE)
                                SELECT @CARDID,RESULT,1,(SELECT TOP 1 RESULT USERID FROM dbo.CSVTOTABLE(@SELOBSERVERID)),
                                @CC_TIMESTAMP FROM DBO.CSVTOTABLE(@SELOBSERVERID)  U1
                                INNER JOIN USERS U ON U.USERID=U1.RESULT
                                INNER JOIN USERINFO UI ON UI.USERID=U.USERID
                                WHERE U.STATUS !=2 AND UI.USERTYPEID IN (1,2)
                                AND RESULT NOT IN (SELECT OBSERVERID FROM STOPCARDENTRYOBSERVERS_OL WHERE CARDID=@CARDID)

                               IF (SELECT COUNT(DISTINCT RESULT) FROM dbo.CSVTOTABLE(@SELOBSERVERID))=1
                                BEGIN
									IF EXISTS(SELECT 1 FROM dbo.CSVTOTABLE(@SELOBSERVERID) UU INNER JOIN USERS U ON U.USERID=UU.RESULT WHERE U.STATUS=2)
									BEGIN
										SET @SASOCDEL='-3'
										UPDATE STOPCARDENTRY_OL SET STATUS=2 WHERE CARDID=@CARDID
									END
									
                                END
                                ELSE IF (SELECT COUNT(DISTINCT RESULT) FROM dbo.CSVTOTABLE(@SELOBSERVERID))>1
                                BEGIN
									IF (SELECT COUNT(DISTINCT RESULT) FROM dbo.CSVTOTABLE(@SELOBSERVERID))=
									(SELECT COUNT(DISTINCT USERID) FROM dbo.CSVTOTABLE(@SELOBSERVERID) UU INNER JOIN USERS U ON U.USERID=UU.RESULT WHERE U.STATUS=2)
									BEGIN
										SET @SASOCDEL='-3'
										UPDATE STOPCARDENTRY_OL SET STATUS=2 WHERE CARDID=@CARDID
									END
                                END
                                IF (SELECT COUNT(DISTINCT OBSERVERID) FROM STOPCARDENTRYOBSERVERS_OL WHERE CARDID=@CARDID)>1
                                                UPDATE dbo.STOPCARDENTRY_OL SET OBSERVERCOUNT=1 WHERE CARDID=@CARDID
                                ELSE IF (SELECT COUNT(DISTINCT OBSERVERID) FROM STOPCARDENTRYOBSERVERS_OL WHERE CARDID=@CARDID)=1
                                                UPDATE dbo.STOPCARDENTRY_OL SET OBSERVERCOUNT=0 WHERE CARDID=@CARDID
                                
                                --STOPCARDENTRYCATEGORYCOMMENTS_OL
                                DELETE FROM STOPCARDENTRYCATEGORYCOMMENTS_OL WHERE CARDID=@CARDID
                                --MAINCATEGORY COMMENTS
                                INSERT INTO STOPCARDENTRYCATEGORYCOMMENTS_OL(CARDID,MAINCATEGORYID,SUBCATEGORYID,SAFECOMMENTS,
                                UNSAFECOMMENTS,STATUS,UPDATEDBY,UPDATEDDATE)
                                SELECT @CARDID,MAINCATEGORYID,0,SAFECMTS,UNSAFECMTS,1,(SELECT TOP 1 RESULT USERID FROM dbo.CSVTOTABLE(@SELOBSERVERID)),@CC_TIMESTAMP FROM @MAINCTGCMTS
                                WHERE LEN(SAFECMTS)>0 OR LEN(UNSAFECMTS)>0

                                --SUBCATEGORY COMMENTS
                                INSERT INTO STOPCARDENTRYCATEGORYCOMMENTS_OL(CARDID,MAINCATEGORYID,SUBCATEGORYID,SAFECOMMENTS,
                                UNSAFECOMMENTS,STATUS,UPDATEDBY,UPDATEDDATE)
                                SELECT @CARDID,MAINCATEGORYID,SUBCATEGORYID,SAFECOMMENTS,UNSAFECOMMENTS,1,(SELECT TOP 1 RESULT USERID FROM dbo.CSVTOTABLE(@SELOBSERVERID)),@CC_TIMESTAMP UPDATEDDATE FROM @SCOBS
                                WHERE LEN(SAFECOMMENTS)>0 OR LEN(UNSAFECOMMENTS)>0
                                --STOPCARDENTRYOBSERVATIONS_OL
                                DELETE FROM STOPCARDENTRYOBSERVATIONS_OL WHERE CARDID=@CARDID
                                
                                 INSERT INTO STOPCARDENTRYOBSERVATIONS_OL(CARDID,MAINCATEGORYID,SUBCATEGORYID,SAFE,UNSAFE,SAFECOMMENTS,
	                              UNSAFECOMMENTS,STATUS,UPDATEDBY,UPDATEDDATE)
                                SELECT @CARDID,MAINCATEGORYID,SUBCATEGORYID,SAFECNT,UNSAFECNT,NULL SAFECMTS,NULL UNSAFECMTS,1 STATUS,(SELECT TOP 1 RESULT USERID FROM dbo.CSVTOTABLE(@SELOBSERVERID)),@CC_TIMESTAMP UPDATEDDATE FROM @SCOBS
                                
                                IF EXISTS(SELECT 1 FROM @UPDATEREQUEST WHERE LEN(COMMENTS)>1) AND EXISTS(SELECT 1 FROM STOPCARDENTRY_OL WHERE APPROVALSTATUS=3 AND CARDID=@CARDID)
									INSERT INTO STOPCARDENTRYUPDATEREQUEST_OL(CARDID,COMMENTS,REQUESTTYPE,CREATEDBY,CREATEDDATE)
									SELECT @CARDID,REPLACE(REPLACE(REPLACE(COMMENTS,'&quot;','"'), '\u0027',''''),'\\','\')  ,REQUESTTYPE,USERID,[TIMESTAMP] FROM @UPDATEREQUEST WHERE LEN(COMMENTS)>1 ORDER BY [TIMESTAMP]
								 SET @QRY=''
                                SET @QRY='DELETE FROM STOPCARDENTRYCUSTOMFIELDS_OL WHERE CARDID='+CAST(@CARDID AS NVARCHAR(8))+' 
                                INSERT INTO STOPCARDENTRYCUSTOMFIELDS_OL(CARDID,CUSTOMFIELD1,CUSTOMFIELD2,CUSTOMFIELD3,STATUS,UPDATEDBY,UPDATEDDATE)
                                
                                SELECT '+CAST(@CARDID AS NVARCHAR(8))+','+REPLACE(@CUSTOMFIELDS,'|',',')+',1,'+(SELECT TOP 1 CAST(RESULT AS NVARCHAR(8)) FROM dbo.CSVTOTABLE(@SELOBSERVERID))+',GETDATE()'
                                EXEC(@QRY)
                                
                                SELECT @CUSTOMFIELD1=CUSTOMFIELD1,@CUSTOMFIELD2=CUSTOMFIELD2,@CUSTOMFIELD3=CUSTOMFIELD3  FROM STOPCARDENTRYCUSTOMFIELDS_OL WHERE CARDID=@CARDID 
                                
                                    UPDATE STOPCARDENTRYCUSTOMFIELDS_OL SET CUSTOMFIELD1 = NULL WHERE CUSTOMFIELD1=0 AND CARDID=@CARDID                          
									UPDATE STOPCARDENTRYCUSTOMFIELDS_OL SET CUSTOMFIELD2 = NULL WHERE CUSTOMFIELD2=0 AND CARDID=@CARDID
									UPDATE STOPCARDENTRYCUSTOMFIELDS_OL SET CUSTOMFIELD3 = NULL WHERE CUSTOMFIELD3=0 AND CARDID=@CARDID
									UPDATE STOPCARDENTRYCUSTOMFIELDS_OL SET CUSTOMFIELD1 = NULL WHERE CARDID=@CARDID AND EXISTS(SELECT 1 FROM CUSTOMFIELDVALUES WHERE CUSTOMFIELDVALUEID=CUSTOMFIELD1 AND STATUS =2) 
									UPDATE STOPCARDENTRYCUSTOMFIELDS_OL SET CUSTOMFIELD2 = NULL WHERE CARDID=@CARDID AND EXISTS(SELECT 1 FROM CUSTOMFIELDVALUES WHERE CUSTOMFIELDVALUEID=CUSTOMFIELD2 AND STATUS =2) 
									UPDATE STOPCARDENTRYCUSTOMFIELDS_OL SET CUSTOMFIELD3 = NULL WHERE CARDID=@CARDID AND EXISTS(SELECT 1 FROM CUSTOMFIELDVALUES WHERE CUSTOMFIELDVALUEID=CUSTOMFIELD3 AND STATUS =2) 

									DELETE FROM STOPCARDENTRYCUSTOMFIELDS_OL WHERE CUSTOMFIELD1 IS NULL AND CUSTOMFIELD2 IS NULL AND CUSTOMFIELD3 IS NULL AND CARDID=@CARDID

								IF EXISTS(SELECT 1 FROM SITES WHERE SITEID=@SITEID AND STATUS=2) OR
                                EXISTS(SELECT 1 FROM AREAS WHERE AREAID=@AREAID AND STATUS=2) OR
                                EXISTS(SELECT 1 FROM SHIFTS WHERE SHIFTID=@SHIFTID AND STATUS=2)OR
                                EXISTS(SELECT 1 FROM CHECKLISTSETUP WHERE CHECKLISTSETUPID=@SETUPID AND STATUS=2) OR
                                (@CUSTOMFIELD1>0 AND EXISTS(SELECT 1 FROM CUSTOMFIELDVALUES WHERE STATUS =2 AND CUSTOMFIELDVALUEID=@CUSTOMFIELD1)) OR
                                (@CUSTOMFIELD2>0 AND EXISTS(SELECT 1 FROM CUSTOMFIELDVALUES WHERE STATUS =2 AND CUSTOMFIELDVALUEID=@CUSTOMFIELD2)) OR
                                (@CUSTOMFIELD3>0 AND EXISTS(SELECT 1 FROM CUSTOMFIELDVALUES WHERE STATUS =2 AND CUSTOMFIELDVALUEID=@CUSTOMFIELD3))
                                BEGIN
                                     UPDATE STOPCARDENTRY_OL SET STATUS=2 WHERE CARDID=@CARDID
                                     SET @SASOCDEL='-3'
                                END    				
								INSERT INTO AUDIT(TABLENAME,TRANS,STAMP,LASTUPDATEDBY,DATA)
								SELECT 'STOPCARDENTRY_/STOPCARDENTRYOBSERVERS_OL/ALL_OL TABLES','VER0 UPDATE:'+CAST(@CARDID AS NVARCHAR(8)),GETDATE(),@SELOBSERVERID,@STOPCARDOL			
																
                                SELECT CAST(@CARDID AS NVARCHAR(8))+'~'+CASE WHEN EXISTS(SELECT 1 FROM STOPCARDENTRY_OL WHERE CARDID=@CARDID AND STATUS =2 AND OFFLINECARDTYPE=1) AND @SASOCDEL='-3' THEN '-3' WHEN EXISTS(SELECT 1 FROM STOPCARDENTRY_OL WHERE CARDID=@CARDID AND STATUS =2 AND OFFLINECARDTYPE=1) AND @SASOCDEL='' THEN '-4' ELSE (SELECT CAST(APPROVALSTATUS AS NVARCHAR(8)) FROM STOPCARDENTRY_OL WHERE CARDID=@CARDID AND OFFLINECARDTYPE=1) END CARDID
                END       
                ELSE IF EXISTS(SELECT 1 FROM STOPCARDENTRY_OL WHERE CARDID=@CARDID AND STATUS=2 AND OFFLINECARDTYPE=1)                   
                                SELECT CAST(@CARDID AS NVARCHAR(8))+'~-3' CARDID
END
ELSE IF @OBSAPPROVEMOBILE=0 
BEGIN
     SET @SELOBSERVERID = ''
     SELECT @SELOBSERVERID = SC.DETAIL.value('(obsid)[1]', 'int')
     FROM @STOPCARDOL.nodes('/card1') SC(DETAIL)

                
     
     INSERT INTO dbo.STOPCARDENTRY(COMPANYID,CHECKLISTSETUPID,SITEID,OBSERVERCOUNT,SHIFTID,AREAID,LENGTH,PEOPLECONTACTED,PEOPLEOBSERVED,SAFECOMMENTS,
                UNSAFECOMMENTS,STATUS,STOPCARDTYPE,OBSERVATIONDATE,CREATEDBY,CREATEDDATE)

     SELECT
     COMPANYID=@COMPANYID,
     SETUPID = SC.DETAIL.value('(setid)[1]', 'int'),
     SITEID = SC.DETAIL.value('(siteid)[1]', 'int'),
     OBSERVERCNT=0,
     SHIFTID = SC.DETAIL.value('(shid)[1]', 'int'),
     AREAID = SC.DETAIL.value('(arid)[1]', 'int'),
     LENGTH = SC.DETAIL.value('(len)[1]', 'int'),
     PEOPLECONTACTED = SC.DETAIL.value('(pc)[1]', 'int'),
     PEOPLEOBSERVED = SC.DETAIL.value('(po)[1]', 'int'),
    SC = REPLACE(REPLACE(REPLACE(SC.DETAIL.value('(sc)[1]', 'NVARCHAR(MAX)'),'&quot;','"'), '\u0027',''''),'\\','\') ,
    USC = REPLACE(REPLACE(REPLACE(SC.DETAIL.value('(usc)[1]', 'NVARCHAR(MAX)'),'&quot;','"'), '\u0027',''''),'\\','\'),
     
     STATUS=1,
     STOPCARDTYPE=1,
     OBSERVATIONDATE = SC.DETAIL.value('(obsdate)[1]', 'datetime'),
     (SELECT TOP 1 RESULT USERID FROM dbo.CSVTOTABLE(@SELOBSERVERID)) CREATEDBY,
     @CC_TIMESTAMP
     FROM @STOPCARDOL.nodes('/card1') SC(DETAIL)

     SELECT @CARDID=@@IDENTITY
	
	SELECT @CUSTOMFIELDS=SC.DETAIL.value('(customfields)[1]', 'NVARCHAR(512)')
                                FROM @STOPCARDOL.nodes('/card1') SC(DETAIL)
                                
     SELECT @SITEID=SITEID,@AREAID=AREAID,@SHIFTID=SHIFTID,@SETUPID=CHECKLISTSETUPID FROM STOPCARDENTRY WHERE CARDID=@CARDID
     
     

     INSERT INTO @MAINCTGCMTS
     SELECT MAINCATEGORYID = MAINCTG.COM.value('(id)[1]', 'INT'),
     SAFECOMMENT = MAINCTG.COM.value('(sc)[1]', 'NVARCHAR(MAX)'),
     UNSAFECOMMENT = MAINCTG.COM.value('(usc)[1]', 'NVARCHAR(MAX)')
     FROM
     @STOPCARDOL.nodes('/card1/mctg') MAINCTG(com)

      UPDATE @MAINCTGCMTS SET SAFECMTS=REPLACE(REPLACE(REPLACE(SAFECMTS,'&quot;','"'), '\u0027',''''),'\\','\') 
     UPDATE @MAINCTGCMTS SET UNSAFECMTS=REPLACE(REPLACE(REPLACE(UNSAFECMTS,'&quot;','"'), '\u0027',''''),'\\','\') 

     INSERT INTO @SCOBS
     SELECT SUB.MAINCATEGORYID,
     SUBCATEGORYID = SUBCTG.CNT.value('(id)[1]', 'INT'),
     SAFECNT = SUBCTG.CNT.value('(sfcnt)[1]', 'int'),
     UNSAFECNT = SUBCTG.CNT.value('(usfcnt)[1]', 'int'),
     SAFECOMMENT = SUBCTG.CNT.value('(sc)[1]', 'NVARCHAR(MAX)'),
     UNSAFECOMMENT = SUBCTG.CNT.value('(usc)[1]', 'NVARCHAR(MAX)')
     FROM
     @STOPCARDOL.nodes('/card1/mctg/sctg') SUBCTG(CNT)
     INNER JOIN SUBCATEGORIES SUB ON SUB.SUBCATEGORYID=SUBCTG.CNT.value('(id)[1]', 'INT')
     
     UPDATE @SCOBS SET SAFECOMMENTS=REPLACE(REPLACE(REPLACE(SAFECOMMENTS,'&quot;','"'), '\u0027',''''),'\\','\') 
     UPDATE @SCOBS SET UNSAFECOMMENTS=REPLACE(REPLACE(REPLACE(UNSAFECOMMENTS,'&quot;','"'), '\u0027',''''),'\\','\') 
     
     INSERT INTO @OBS
     SELECT
     SC.DETAIL.value('(obsid)[1]', 'VARCHAR(MAX)')
     FROM @STOPCARDOL.nodes('/card1') SC(DETAIL)

     DELETE FROM STOPCARDENTRYOBSERVERS WHERE CARDID = @CARDID

     INSERT INTO STOPCARDENTRYOBSERVERS(CARDID,OBSERVERID,GROUP1,GROUP1NAME,GROUP2,GROUP2NAME,GROUP3,GROUP3NAME,GROUP4,GROUP4NAME,GROUP5,GROUP5NAME,GROUP6,GROUP6NAME,GROUP7,GROUP7NAME,GROUP8,GROUP8NAME,GROUP9,GROUP9NAME,GROUP10,GROUP10NAME,UPDATEDBY,UPDATEDDATE)
     SELECT @CARDID,RESULT USERID,
     (SELECT GROUPID FROM USERGROUPS WHERE STATUS=1 AND USERID = RESULT AND GROUPTYPEID=(SELECT RELATIONID FROM REPORTOPTIONSMASTER WHERE STATUS = 1 AND REPORTPARAM='GROUP1')),
     (SELECT GROUPNAME FROM GROUPS WHERE GROUPID=(SELECT GROUPID FROM USERGROUPS WHERE STATUS=1 AND USERID = RESULT AND GROUPTYPEID=(SELECT RELATIONID FROM REPORTOPTIONSMASTER WHERE STATUS = 1 AND REPORTPARAM='GROUP1'))),
     (SELECT GROUPID FROM USERGROUPS WHERE STATUS=1 AND USERID = RESULT AND GROUPTYPEID=(SELECT RELATIONID FROM REPORTOPTIONSMASTER WHERE STATUS = 1 AND REPORTPARAM='GROUP2')),
     (SELECT GROUPNAME FROM GROUPS WHERE GROUPID=(SELECT GROUPID FROM USERGROUPS WHERE STATUS=1 AND USERID = RESULT AND GROUPTYPEID=(SELECT RELATIONID FROM REPORTOPTIONSMASTER WHERE STATUS = 1 AND REPORTPARAM='GROUP2'))),
     (SELECT GROUPID FROM USERGROUPS WHERE STATUS=1 AND USERID = RESULT AND GROUPTYPEID=(SELECT RELATIONID FROM REPORTOPTIONSMASTER WHERE STATUS = 1 AND REPORTPARAM='GROUP3')),
     (SELECT GROUPNAME FROM GROUPS WHERE GROUPID=(SELECT GROUPID FROM USERGROUPS WHERE STATUS=1 AND USERID = RESULT AND GROUPTYPEID=(SELECT RELATIONID FROM REPORTOPTIONSMASTER WHERE STATUS = 1 AND REPORTPARAM='GROUP3'))),
     (SELECT GROUPID FROM USERGROUPS WHERE STATUS=1 AND USERID = RESULT AND GROUPTYPEID=(SELECT RELATIONID FROM REPORTOPTIONSMASTER WHERE STATUS = 1 AND REPORTPARAM='GROUP4')),
     (SELECT GROUPNAME FROM GROUPS WHERE GROUPID=(SELECT GROUPID FROM USERGROUPS WHERE STATUS=1 AND USERID = RESULT AND GROUPTYPEID=(SELECT RELATIONID FROM REPORTOPTIONSMASTER WHERE STATUS = 1 AND REPORTPARAM='GROUP4'))),
     (SELECT GROUPID FROM USERGROUPS WHERE STATUS=1 AND USERID = RESULT AND GROUPTYPEID=(SELECT RELATIONID FROM REPORTOPTIONSMASTER WHERE STATUS = 1 AND REPORTPARAM='GROUP5')),
     (SELECT GROUPNAME FROM GROUPS WHERE GROUPID=(SELECT GROUPID FROM USERGROUPS WHERE STATUS=1 AND USERID = RESULT AND GROUPTYPEID=(SELECT RELATIONID FROM REPORTOPTIONSMASTER WHERE STATUS = 1 AND REPORTPARAM='GROUP5'))),
     (SELECT GROUPID FROM USERGROUPS WHERE STATUS=1 AND USERID = RESULT AND GROUPTYPEID=(SELECT RELATIONID FROM REPORTOPTIONSMASTER WHERE STATUS = 1 AND REPORTPARAM='GROUP6')),
     (SELECT GROUPNAME FROM GROUPS WHERE GROUPID=(SELECT GROUPID FROM USERGROUPS WHERE STATUS=1 AND USERID = RESULT AND GROUPTYPEID=(SELECT RELATIONID FROM REPORTOPTIONSMASTER WHERE STATUS = 1 AND REPORTPARAM='GROUP6'))),
     (SELECT GROUPID FROM USERGROUPS WHERE STATUS=1 AND USERID = RESULT AND GROUPTYPEID=(SELECT RELATIONID FROM REPORTOPTIONSMASTER WHERE STATUS = 1 AND REPORTPARAM='GROUP7')),
     (SELECT GROUPNAME FROM GROUPS WHERE GROUPID=(SELECT GROUPID FROM USERGROUPS WHERE STATUS=1 AND USERID = RESULT AND GROUPTYPEID=(SELECT RELATIONID FROM REPORTOPTIONSMASTER WHERE STATUS = 1 AND REPORTPARAM='GROUP7'))),
     (SELECT GROUPID FROM USERGROUPS WHERE STATUS=1 AND USERID = RESULT AND GROUPTYPEID=(SELECT RELATIONID FROM REPORTOPTIONSMASTER WHERE STATUS = 1 AND REPORTPARAM='GROUP8')),
     (SELECT GROUPNAME FROM GROUPS WHERE GROUPID=(SELECT GROUPID FROM USERGROUPS WHERE STATUS=1 AND USERID = RESULT AND GROUPTYPEID=(SELECT RELATIONID FROM REPORTOPTIONSMASTER WHERE STATUS = 1 AND REPORTPARAM='GROUP8'))),
     (SELECT GROUPID FROM USERGROUPS WHERE STATUS=1 AND USERID = RESULT AND GROUPTYPEID=(SELECT RELATIONID FROM REPORTOPTIONSMASTER WHERE STATUS = 1 AND REPORTPARAM='GROUP9')),
     (SELECT GROUPNAME FROM GROUPS WHERE GROUPID=(SELECT GROUPID FROM USERGROUPS WHERE STATUS=1 AND USERID = RESULT AND GROUPTYPEID=(SELECT RELATIONID FROM REPORTOPTIONSMASTER WHERE STATUS = 1 AND REPORTPARAM='GROUP9'))),
     (SELECT GROUPID FROM USERGROUPS WHERE STATUS=1 AND USERID = RESULT AND GROUPTYPEID=(SELECT RELATIONID FROM REPORTOPTIONSMASTER WHERE STATUS = 1 AND REPORTPARAM='GROUP10')),
     (SELECT GROUPNAME FROM GROUPS WHERE GROUPID=(SELECT GROUPID FROM USERGROUPS WHERE STATUS=1 AND USERID = RESULT AND GROUPTYPEID=(SELECT RELATIONID FROM REPORTOPTIONSMASTER WHERE STATUS = 1 AND REPORTPARAM='GROUP10'))),
     (SELECT TOP 1 RESULT USERID FROM dbo.CSVTOTABLE(@SELOBSERVERID)),
     @CC_TIMESTAMP
     FROM dbo.CSVTOTABLE(@SELOBSERVERID)U1
     INNER JOIN USERS U ON U.USERID=U1.RESULT
    INNER JOIN USERINFO UI ON UI.USERID=U.USERID
                WHERE U.STATUS !=2 AND UI.USERTYPEID IN (1,2)



     INSERT INTO STOPCARDENTRYOBSERVERS(CARDID,OBSERVERID,STATUS,UPDATEDBY,UPDATEDDATE)
     SELECT @CARDID,RESULT,1,(SELECT TOP 1 RESULT USERID FROM dbo.CSVTOTABLE(@SELOBSERVERID)),
     @CC_TIMESTAMP FROM DBO.CSVTOTABLE(@SELOBSERVERID) U1
     INNER JOIN USERS U ON U.USERID=U1.RESULT
    INNER JOIN USERINFO UI ON UI.USERID=U.USERID
                WHERE U.STATUS !=2 AND UI.USERTYPEID IN (1,2)      
     AND RESULT NOT IN (SELECT OBSERVERID FROM STOPCARDENTRYOBSERVERS WHERE CARDID=@CARDID)
                
                IF (SELECT COUNT(DISTINCT RESULT) FROM dbo.CSVTOTABLE(@SELOBSERVERID))=1
                BEGIN
					IF EXISTS(SELECT 1 FROM dbo.CSVTOTABLE(@SELOBSERVERID) UU INNER JOIN USERS U ON U.USERID=UU.RESULT WHERE U.STATUS=2)
					BEGIN
						UPDATE STOPCARDENTRY SET STATUS=2 WHERE CARDID=@CARDID
					END
					--WILL WORK FOR ONLY OLDER VERSION WITH USERTYPE AS USER(0) IN NEW VERSION ONLY USERTYPEID 1,2 TYPE USER IS SELECTED
					INSERT INTO STOPCARDENTRYOBSERVERS(CARDID,OBSERVERID,STATUS,UPDATEDBY,UPDATEDDATE)
						SELECT @CARDID,RESULT,1,(SELECT TOP 1 RESULT USERID FROM dbo.CSVTOTABLE(@SELOBSERVERID)),
						@CC_TIMESTAMP FROM DBO.CSVTOTABLE(@SELOBSERVERID)  U1
						INNER JOIN USERS U ON U.USERID=U1.RESULT
						INNER JOIN USERINFO UI ON UI.USERID=U.USERID
						WHERE U.STATUS !=2 AND UI.USERTYPEID = 0
						AND RESULT NOT IN (SELECT OBSERVERID FROM STOPCARDENTRYOBSERVERS WHERE CARDID=@CARDID)
                END
                ELSE IF (SELECT COUNT(DISTINCT RESULT) FROM dbo.CSVTOTABLE(@SELOBSERVERID))>1
                BEGIN
					IF (SELECT COUNT(DISTINCT RESULT) FROM dbo.CSVTOTABLE(@SELOBSERVERID))=
					(SELECT COUNT(DISTINCT USERID) FROM dbo.CSVTOTABLE(@SELOBSERVERID) UU INNER JOIN USERS U ON U.USERID=UU.RESULT WHERE U.STATUS=2)
					BEGIN
						UPDATE STOPCARDENTRY SET STATUS=2 WHERE CARDID=@CARDID
					END
                END
                
                IF (SELECT COUNT(DISTINCT OBSERVERID) FROM STOPCARDENTRYOBSERVERS WHERE CARDID=@CARDID)>1
                                UPDATE dbo.STOPCARDENTRY SET OBSERVERCOUNT=1 WHERE CARDID=@CARDID
                ELSE IF (SELECT COUNT(DISTINCT OBSERVERID) FROM STOPCARDENTRYOBSERVERS WHERE CARDID=@CARDID)=1
                                UPDATE dbo.STOPCARDENTRY SET OBSERVERCOUNT=0 WHERE CARDID=@CARDID
                
     --MAINCATEGORY COMMENTS
     INSERT INTO STOPCARDENTRYCATEGORYCOMMENTS(CARDID,MAINCATEGORYID,SUBCATEGORYID,SAFECOMMENTS,
     UNSAFECOMMENTS,STATUS,UPDATEDBY,UPDATEDDATE)
     SELECT @CARDID,MAINCATEGORYID,0,SAFECMTS,UNSAFECMTS,1,(SELECT TOP 1 RESULT USERID FROM dbo.CSVTOTABLE(@SELOBSERVERID)),@CC_TIMESTAMP FROM @MAINCTGCMTS
     WHERE LEN(SAFECMTS)>0 OR LEN(UNSAFECMTS)>0

     --SUBCATEGORY COMMENTS
     INSERT INTO STOPCARDENTRYCATEGORYCOMMENTS(CARDID,MAINCATEGORYID,SUBCATEGORYID,SAFECOMMENTS,
     UNSAFECOMMENTS,STATUS,UPDATEDBY,UPDATEDDATE)
     SELECT @CARDID,MAINCATEGORYID,SUBCATEGORYID,SAFECOMMENTS,UNSAFECOMMENTS,1,(SELECT TOP 1 RESULT USERID FROM dbo.CSVTOTABLE(@SELOBSERVERID)),@CC_TIMESTAMP UPDATEDDATE FROM @SCOBS
     WHERE LEN(SAFECOMMENTS)>0 OR LEN(UNSAFECOMMENTS)>0

     INSERT INTO STOPCARDENTRYOBSERVATIONS(CARDID,MAINCATEGORYID,SUBCATEGORYID,SAFE,UNSAFE,SAFECOMMENTS,
     UNSAFECOMMENTS,STATUS,UPDATEDBY,UPDATEDDATE)
     SELECT @CARDID,MAINCATEGORYID,SUBCATEGORYID,SAFECNT,UNSAFECNT,NULL SAFECMTS,NULL UNSAFECMTS,1 STATUS,(SELECT TOP 1 RESULT USERID FROM dbo.CSVTOTABLE(@SELOBSERVERID)),@CC_TIMESTAMP UPDATEDDATE FROM @SCOBS
     
     SET @QRY=''
    SET @QRY='INSERT INTO STOPCARDENTRYCUSTOMFIELDS(CARDID,CUSTOMFIELD1,CUSTOMFIELD2,CUSTOMFIELD3,STATUS,UPDATEDBY,UPDATEDDATE)
    SELECT '+CAST(@CARDID AS NVARCHAR(8))+','+REPLACE(@CUSTOMFIELDS,'|',',')+',1,'+(SELECT TOP 1 CAST(RESULT AS NVARCHAR(8)) FROM dbo.CSVTOTABLE(@SELOBSERVERID))+',GETDATE()'
    EXEC(@QRY)
    SELECT @CUSTOMFIELD1=CUSTOMFIELD1,@CUSTOMFIELD2=CUSTOMFIELD2,@CUSTOMFIELD3=CUSTOMFIELD3  FROM STOPCARDENTRYCUSTOMFIELDS WHERE CARDID=@CARDID 
    
    IF EXISTS(SELECT 1 FROM SITES WHERE SITEID=@SITEID AND STATUS=2) OR
     EXISTS(SELECT 1 FROM AREAS WHERE AREAID=@AREAID AND STATUS=2) OR
     EXISTS(SELECT 1 FROM SHIFTS WHERE SHIFTID=@SHIFTID AND STATUS=2)OR
     EXISTS(SELECT 1 FROM CHECKLISTSETUP WHERE CHECKLISTSETUPID=@SETUPID AND STATUS=2) OR
     (@CUSTOMFIELD1>0 AND EXISTS(SELECT 1 FROM CUSTOMFIELDVALUES WHERE STATUS =2 AND CUSTOMFIELDVALUEID=@CUSTOMFIELD1)) OR
    (@CUSTOMFIELD2>0 AND EXISTS(SELECT 1 FROM CUSTOMFIELDVALUES WHERE STATUS =2 AND CUSTOMFIELDVALUEID=@CUSTOMFIELD2)) OR
    (@CUSTOMFIELD3>0 AND EXISTS(SELECT 1 FROM CUSTOMFIELDVALUES WHERE STATUS =2 AND CUSTOMFIELDVALUEID=@CUSTOMFIELD3))
          UPDATE STOPCARDENTRY SET STATUS=2 WHERE CARDID=@CARDID
          
    UPDATE STOPCARDENTRYCUSTOMFIELDS SET CUSTOMFIELD1 = NULL WHERE CUSTOMFIELD1=0 AND CARDID=@CARDID                          
    UPDATE STOPCARDENTRYCUSTOMFIELDS SET CUSTOMFIELD2 = NULL WHERE CUSTOMFIELD2=0 AND CARDID=@CARDID
    UPDATE STOPCARDENTRYCUSTOMFIELDS SET CUSTOMFIELD3 = NULL WHERE CUSTOMFIELD3=0 AND CARDID=@CARDID
    
    UPDATE STOPCARDENTRYCUSTOMFIELDS SET CUSTOMFIELD1 = NULL WHERE CARDID=@CARDID AND EXISTS(SELECT 1 FROM CUSTOMFIELDVALUES WHERE CUSTOMFIELDVALUEID=CUSTOMFIELD1 AND STATUS =2) 
	UPDATE STOPCARDENTRYCUSTOMFIELDS SET CUSTOMFIELD2 = NULL WHERE CARDID=@CARDID AND EXISTS(SELECT 1 FROM CUSTOMFIELDVALUES WHERE CUSTOMFIELDVALUEID=CUSTOMFIELD2 AND STATUS =2) 
	UPDATE STOPCARDENTRYCUSTOMFIELDS SET CUSTOMFIELD3 = NULL WHERE CARDID=@CARDID AND EXISTS(SELECT 1 FROM CUSTOMFIELDVALUES WHERE CUSTOMFIELDVALUEID=CUSTOMFIELD3 AND STATUS =2) 

	DELETE FROM STOPCARDENTRYCUSTOMFIELDS WHERE CUSTOMFIELD1 IS NULL AND CUSTOMFIELD2 IS NULL AND CUSTOMFIELD3 IS NULL AND CARDID=@CARDID
		INSERT INTO AUDIT(TABLENAME,TRANS,STAMP,LASTUPDATEDBY,DATA)
	SELECT 'STOPCARDENTRY/STOPCARDENTRYOBSERVERS/ALL TABLES','VER0 INSERT(DIRECT):'+CAST(@CARDID AS NVARCHAR(8)),GETDATE(),@SELOBSERVERID,@STOPCARDOL							
								
      SELECT CAST(@CARDID AS NVARCHAR(8))+'~'+CASE WHEN EXISTS(SELECT 1 FROM STOPCARDENTRY WHERE CARDID=@CARDID AND STATUS =2) THEN '-4' ELSE '4' END CARDID
END

