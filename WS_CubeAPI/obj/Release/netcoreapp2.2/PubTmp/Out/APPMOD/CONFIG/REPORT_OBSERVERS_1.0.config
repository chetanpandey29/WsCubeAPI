--SITES FILTER
DECLARE @TSITES TABLE(SITEID INT,SITENAME VARCHAR(256))
IF @SITEID = '' OR @SITEID IS NULL
BEGIN
IF EXISTS(SELECT 1 FROM USERINFO UR
INNER JOIN ROLES R ON R.ROLEID = UR.DEFAULTROLEID
WHERE R.STATUS=1 AND UR.USERID = @USERID AND R.ALLSITES=1)
INSERT INTO @TSITES
SELECT SITEID,SITENAME FROM SITES WHERE STATUS = 1
ELSE
INSERT INTO @TSITES
SELECT S.SITEID,S.SITENAME FROM SITES S
INNER JOIN USERSITES US ON US.SITEID = S.SITEID
WHERE S.STATUS = 1 AND US.STATUS = 1 AND US.USERID = @USERID

END
ELSE
INSERT INTO @TSITES
SELECT SITEID,SITENAME FROM SITES
WHERE SITEID IN (SELECT RESULT FROM DBO.CSVTOTABLE(@SITEID))

--GROUPS FILTER
DECLARE @USERLIST TABLE(USERID INT,GROUPTYPEID INT)
DECLARE @USERGROUPS TABLE(GROUPTYPEID INT,GROUPID INT)
INSERT INTO @USERGROUPS
SELECT GG.GROUPTYPEID,RESULT AS GROUPID FROM DBO.CSVTOTABLE(@GROUPID) G
INNER JOIN GROUPS GG ON GG.GROUPID = G.RESULT
--OBSERVERS

CREATE TABLE #OBSERVERS(USERID INT)
IF @OBSERVERID ='' OR @OBSERVERID IS NULL
INSERT INTO #OBSERVERS
SELECT USERID FROM USERS WHERE STATUS = 1
ELSE
INSERT INTO #OBSERVERS
SELECT RESULT FROM DBO.CSVTOTABLE(@OBSERVERID)

CREATE TABLE #USERSITES (SITEID INT,USERID INT)
INSERT INTO #USERSITES
SELECT US.SITEID,US.USERID FROM USERSITES US
INNER JOIN @TSITES S ON S.SITEID = US.SITEID
INNER JOIN #OBSERVERS U ON U.USERID = US.USERID
WHERE US.STATUS = 1

IF EXISTS(SELECT 1 FROM @USERGROUPS)
BEGIN
INSERT INTO @USERLIST
SELECT DISTINCT U.USERID,UG.GROUPTYPEID FROM USERS U
INNER JOIN USERGROUPS UG ON U.USERID = UG.USERID
INNER JOIN @USERGROUPS TUG ON TUG.GROUPTYPEID = UG.GROUPTYPEID AND TUG.GROUPID = UG.GROUPID
WHERE U.STATUS=1 AND UG.STATUS = 1

SELECT S.SITEID,U.USERID,S.SITENAME,
U.LASTNAME,U.FIRSTNAME,U.EMAIL,UI.JOBTITLE,UI.DEFAULTROLEID,U.STATUS,
TU.JAN,TU.FEB,TU.MAR,TU.APR,TU.MAY,TU.JUN,TU.JUL,TU.AUG,TU.SEP,TU.OCT,TU.NOV,TU.DEC
FROM USERSITES US
INNER JOIN USERS U ON U.USERID =US.USERID
INNER JOIN USERINFO UI ON UI.USERID = U.USERID
INNER JOIN #USERSITES TUS ON TUS.USERID = US.USERID AND TUS.SITEID = US.SITEID
INNER JOIN SITES S ON S.SITEID =US.SITEID
INNER JOIN TARGETUSERS TU ON TU.SITEID = US.SITEID AND TU.USERID = US.USERID
WHERE US.USERID IN(SELECT USERID FROM @USERLIST GROUP BY USERID HAVING COUNT(DISTINCT GROUPTYPEID)=(SELECT COUNT(DISTINCT GROUPTYPEID) FROM @USERGROUPS))
AND US.STATUS=1 AND U.STATUS=1 AND S.STATUS=1



END
ELSE
BEGIN

SELECT S.SITEID,U.USERID,S.SITENAME,
U.LASTNAME,U.FIRSTNAME,U.EMAIL,UI.JOBTITLE,UI.DEFAULTROLEID,U.STATUS,
TU.JAN,TU.FEB,TU.MAR,TU.APR,TU.MAY,TU.JUN,TU.JUL,TU.AUG,TU.SEP,TU.OCT,TU.NOV,TU.DEC
FROM USERSITES US
INNER JOIN USERS U ON U.USERID =US.USERID
INNER JOIN USERINFO UI ON UI.USERID = U.USERID
INNER JOIN #USERSITES TUS ON TUS.USERID = US.USERID AND TUS.SITEID = US.SITEID
INNER JOIN SITES S ON S.SITEID =US.SITEID
INNER JOIN TARGETUSERS TU ON TU.SITEID = US.SITEID AND TU.USERID = US.USERID
WHERE US.STATUS=1 AND U.STATUS=1 AND S.STATUS=1

END

DROP TABLE #OBSERVERS
DROP TABLE #USERSITES