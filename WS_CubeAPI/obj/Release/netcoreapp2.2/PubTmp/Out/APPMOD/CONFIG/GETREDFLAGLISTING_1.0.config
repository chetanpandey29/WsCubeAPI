DECLARE @QRY VARCHAR(MAX),@QRY1 VARCHAR(MAX),@ISADMIN VARCHAR(8)
SET @ISADMIN='0'

IF EXISTS(SELECT 1 FROM ROLES WHERE ALLSITES=1 AND ROLEID =(SELECT DEFAULTROLEID FROM USERINFO WHERE USERID = @USERID))
SET @ISADMIN='1'

CREATE TABLE #INPUTSITES(SITEID INT)
SET @QRY=''
SET @QRY1=''
SELECT @QRY1='
INSERT INTO #INPUTSITES
SELECT RESULT FROM DBO.CSVTOTABLE('''+@SITEID+''')
'
EXEC(@QRY1)

SET @QRY ='SELECT
DISTINCT [REDFLAGID]
,[REDFLAGNAME][RED FLAG NAME]
,(SELECT SITENAME FROM SITES WHERE SITEID = RF.SITEID)[SITE NAME]
,CASE WHEN RF.OBSERVERID = -1 THEN ''LBLALL'' ELSE (SELECT LASTNAME+'',''+FIRSTNAME FROM USERS WHERE USERID = RF.OBSERVERID) END [OBSERVER]
,CASE WHEN RF.AREAID = -1 THEN ''LBLALL'' ELSE (SELECT AREANAME FROM AREAS WHERE AREAID =RF.AREAID) END [AREAS]
,CASE WHEN RF.SUBAREAID = -1 THEN ''LBLALL'' ELSE (SELECT SUBAREANAME FROM SUBAREAS WHERE SUBAREAID =RF.SUBAREAID) END [SUBAREAS]
,CASE WHEN RF.STATUS= 1 THEN ''LBLACTIVE'' WHEN RF.STATUS = 0 THEN ''LBLINACTIVE''END AS [STATUS]
FROM [REDFLAGS]RF

'
+CASE WHEN ISNULL(@SITEID,'')='' THEN CASE WHEN @ISADMIN='1' THEN ' INNER JOIN SITES SS ON SS.SITEID=RF.SITEID AND SS.STATUS IN (0,1) ' ELSE
' INNER JOIN USERSITES US ON US.USERID = '+ @USERID + ' AND US.SITEID =RF.SITEID AND US.STATUS = 1' END
ELSE ' INNER JOIN #INPUTSITES SR ON SR.SITEID=RF.SITEID' END
+CASE WHEN ISNULL(@AREAID,'')='' THEN '' ELSE ' INNER JOIN DBO.CSVTOTABLE('''+@AREAID+''') RS ON RS.RESULT=CASE WHEN RF.AREAID = -1 THEN RS.RESULT ELSE RF.AREAID END' END
+CASE WHEN ISNULL(@SUBAREAID,'')='' THEN '' ELSE ' INNER JOIN DBO.CSVTOTABLE('''+@SUBAREAID+''') SA ON SA.RESULT=CASE WHEN RF.SUBAREAID = -1 THEN SA.RESULT ELSE RF.SUBAREAID END' END
+' WHERE '
+CASE WHEN ISNULL(@STATUSID,'')='' THEN ' RF.[STATUS]!=2 ' ELSE ' RF.[STATUS] IN('+ @STATUSID + ')' END
+'ORDER BY REDFLAGNAME'
EXEC(@QRY)
DROP TABLE #INPUTSITES


