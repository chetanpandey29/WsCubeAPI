--UPDATECORRACTIVEACTIONCATEGORYASSIGN_1.0
CREATE TABLE #NOTUSERLIST(USERID INT,ISDISPLAY INT)

DECLARE @CC_TIMESTAMP DATETIME
SET @CC_TIMESTAMP=GETDATE()

DECLARE @CAMODIFIEDLIST XML
SET @CAMODIFIEDLIST= @UPDATECORRECTIVEACTIONDATA

DECLARE @IAMCREATOR INT,@IAMRESP INT,@IAMACTOWN INT

DECLARE @MIOTHERRESPONSIBLEPERSON INT,@MIRESPONSEDATE INT,@MIRESPONSEREQUIREDDATE INT,@MIPRIORITY INT,@MIOTHEREMAILID INT,@MIACTIONPLANNED INT,@MIACTIONPERFORMED INT
,@MICARDSTATUS INT,@MISUBJECT INT,@MIOWNER INT,@MIRESPONSIBLEPERSON INT,@MICATEGORYLIST INT,@MIRESPONSIBLEPERSONLIST NVARCHAR(4000),@MICATEGORYLIST1 NVARCHAR(4000),@MODID INT
SELECT @MIRESPONSIBLEPERSONLIST='',@MICATEGORYLIST1=''

CREATE TABLE #CACATEGORYOLD(MAINCATEGORYID INT,SUBCATEGORYID INT)
CREATE TABLE #CACATEGORYNEW(MAINCATEGORYID INT,SUBCATEGORYID INT,STATUS INT)

UPDATE CORRECTIVEACTIONS
SET
OTHERRESPONSIBLEPERSON=@OTHERRESPONSIBLEPERSON,
RESPONSEDATE= CASE WHEN ISNULL(@RESPONSEDATE,'') ='' THEN NULL ELSE @RESPONSEDATE END,
RESPONSEREQUIREDDATE=CASE WHEN ISNULL(@RESPONSEREQUIREDDATE,'') ='' THEN NULL ELSE @RESPONSEREQUIREDDATE END,
PRIORITY=@PRIORITY,
OTHEREMAILID=@OTHEREMAILID,
ACTIONPLANNED=@ACTIONPLANNED,
ACTIONPERFORMED=@ACTIONPERFORMED,
CARDSTATUS=@CARDSTATUS,
[OWNER] = @OWNER,
UPDATEDBY=@UPDATEDBY,
UPDATEDDATE=@CC_TIMESTAMP
WHERE CORRACTIONID=@CORRACTIONID

DELETE FROM SCHEDULEOTHERUSERLOG WHERE  CORRACTIONID=@CORRACTIONID

DELETE FROM CORRECTIVEACTIONSRESPONSIBLEPERSONS WHERE CORRACTIONID=@CORRACTIONID

INSERT INTO dbo.CORRECTIVEACTIONSRESPONSIBLEPERSONS(CORRACTIONID,USERID,UPDATEDBY,UPDATEDDATE)
SELECT @CORRACTIONID,RESULT,@UPDATEDBY,@CC_TIMESTAMP FROM DBO.CSVtoTable(@RESPONSIBLEPERSON)

INSERT INTO #CACATEGORYOLD(MAINCATEGORYID,SUBCATEGORYID)
SELECT MAINCATEGORYID,SUBCATEGORYID FROM CORRECTIVEACTIONSCATEGORY WHERE CORRACTIONID=@CORRACTIONID ORDER BY MAINCATEGORYID,SUBCATEGORYID

DELETE FROM CORRECTIVEACTIONSCATEGORY WHERE CORRACTIONID=@CORRACTIONID

INSERT INTO CORRECTIVEACTIONSCATEGORY(COMPANYID,CORRACTIONID,MAINCATEGORYID,SUBCATEGORYID,ISASSIGNED,STATUS,UPDATEDBY,UPDATEDDATE)
SELECT @COMPANYID,@CORRACTIONID,SUBSTRING(ITEM,1,CHARINDEX('=>',ITEM)-1),SUBSTRING(ITEM,CHARINDEX('=>',ITEM)+2,LEN(ITEM)),1,1,@UPDATEDBY,@CC_TIMESTAMP FROM DBO.FNSPLIT(@ASSIGNEDCATEGORYLIST,',')

UPDATE STOPCARDENTRYOBSERVATIONS SET CAEXISTS=NULL,CORRACTIONID=NULL WHERE CARDID=@CARDID

UPDATE SCO SET CAEXISTS =1,CORRACTIONID =CA.CORRACTIONID
FROM STOPCARDENTRYOBSERVATIONS SCO
INNER JOIN CORRECTIVEACTIONS CA ON CA.CARDID=SCO.CARDID
INNER JOIN CORRECTIVEACTIONSCATEGORY CAC ON CAC.CORRACTIONID=CA.CORRACTIONID AND CAC.MAINCATEGORYID=SCO.MAINCATEGORYID AND CAC.SUBCATEGORYID=SCO.SUBCATEGORYID
WHERE SCO.UNSAFE>0 AND SCO.CARDID=@CARDID AND CA.STATUS!=2

UPDATE SCO SET CAEXISTS =1,CORRACTIONID =CA.CORRACTIONID
FROM STOPCARDENTRYOBSERVATIONS SCO
INNER JOIN CORRECTIVEACTIONS CA ON CA.CARDID=SCO.CARDID
INNER JOIN STOPCARDENTRYCATEGORYCOMMENTS SCC ON SCC.CARDID=SCO.CARDID AND SCC.MAINCATEGORYID=SCO.MAINCATEGORYID AND SCC.SUBCATEGORYID=SCO.SUBCATEGORYID
INNER JOIN CORRECTIVEACTIONSCATEGORY CAC ON CAC.CORRACTIONID=CA.CORRACTIONID AND CAC.MAINCATEGORYID=SCO.MAINCATEGORYID AND CAC.SUBCATEGORYID=SCO.SUBCATEGORYID
WHERE LEN(SCC.UNSAFECOMMENTS)>1 AND SCO.CARDID=@CARDID  AND CA.STATUS!=2


INSERT INTO #CACATEGORYNEW(MAINCATEGORYID,SUBCATEGORYID)
SELECT MAINCATEGORYID,SUBCATEGORYID FROM CORRECTIVEACTIONSCATEGORY WHERE CORRACTIONID=@CORRACTIONID ORDER BY MAINCATEGORYID,SUBCATEGORYID


DECLARE @MAINCATEGORYID1 NVARCHAR(MAX),@SUBCATEGORYID1 NVARCHAR(MAX)
SET @MAINCATEGORYID1=''
SET @SUBCATEGORYID1=''
SELECT @MAINCATEGORYID1=@MAINCATEGORYID1+CAST(MAINCATEGORYID AS NVARCHAR(MAX))+',' FROM(
SELECT DISTINCT CC.MAINCATEGORYID FROM  CORRECTIVEACTIONSCATEGORY CC
WHERE CC.CORRACTIONID=@CORRACTIONID AND CC.ISASSIGNED=1) A

SELECT @SUBCATEGORYID1=@SUBCATEGORYID1+CAST(SUBCATEGORYID AS NVARCHAR(MAX))+',' FROM(
SELECT DISTINCT CC.SUBCATEGORYID FROM CORRECTIVEACTIONSCATEGORY CC
WHERE CC.CORRACTIONID=@CORRACTIONID AND CC.ISASSIGNED=1 AND CC.SUBCATEGORYID<>0) A

IF LEN(@MAINCATEGORYID1)>0
SET @MAINCATEGORYID1=SUBSTRING(@MAINCATEGORYID1,1,LEN(@MAINCATEGORYID1)-1)
IF LEN(@SUBCATEGORYID1)>0
SET @SUBCATEGORYID1=SUBSTRING(@SUBCATEGORYID1,1,LEN(@SUBCATEGORYID1)-1)

INSERT INTO dbo.AUDIT(TABLENAME,TRANS,STAMP,LASTUPDATEDBY,DATA)
SELECT 'CORRECTIVEACTIONS','UPDATE-UPDATECORRACTIVEACTIONCATEGORYASSIGN_1.0',@CC_TIMESTAMP,@UPDATEDBY,
(SELECT * FROM CORRECTIVEACTIONS WHERE CORRACTIONID=@CORRACTIONID AND UPDATEDBY=@UPDATEDBY AND UPDATEDDATE=@CC_TIMESTAMP FOR XML AUTO)

INSERT INTO dbo.AUDIT(TABLENAME,TRANS,STAMP,LASTUPDATEDBY,DATA)
SELECT 'CORRECTIVEACTIONSRESPONSIBLEPERSONS','UPDATE-UPDATECORRACTIVEACTIONCATEGORYASSIGN_1.0',@CC_TIMESTAMP,@UPDATEDBY,
(SELECT * FROM CORRECTIVEACTIONSRESPONSIBLEPERSONS WHERE CORRACTIONID=@CORRACTIONID AND UPDATEDBY=@UPDATEDBY AND UPDATEDDATE=@CC_TIMESTAMP FOR XML AUTO)


INSERT INTO #NOTUSERLIST(USERID,ISDISPLAY)
SELECT USERID, 1 FROM CORRECTIVEACTIONSRESPONSIBLEPERSONS WHERE CORRACTIONID=@CORRACTIONID AND USERID!=@UPDATEDBY
UNION
SELECT OWNER,1 FROM CORRECTIVEACTIONS WHERE CORRACTIONID=@CORRACTIONID AND OWNER!=@UPDATEDBY
UNION
SELECT UPDATEDBY,1 FROM CORRECTIVEACTIONS CA WHERE CORRACTIONID=@CORRACTIONID AND UPDATEDBY!=@UPDATEDBY

SELECT @IAMCREATOR =CASE WHEN @UPDATEDBY=UPDATEDBY THEN 1 ELSE 0 END FROM CORRECTIVEACTIONS WHERE CORRACTIONID=@CORRACTIONID
SELECT @IAMRESP =CASE WHEN @UPDATEDBY=USERID THEN 1 ELSE 0 END FROM CORRECTIVEACTIONSRESPONSIBLEPERSONS WHERE CORRACTIONID=@CORRACTIONID
SELECT @IAMACTOWN=CASE WHEN @UPDATEDBY=OWNER THEN 1 ELSE 0 END FROM CORRECTIVEACTIONS WHERE CORRACTIONID=@CORRACTIONID

IF (@IAMRESP=1 OR @IAMACTOWN=1)
	INSERT INTO #NOTUSERLIST(USERID,ISDISPLAY)
	SELECT @UPDATEDBY,1
ELSE
	INSERT INTO #NOTUSERLIST(USERID,ISDISPLAY)
	SELECT @UPDATEDBY,0

SELECT
@MIOTHERRESPONSIBLEPERSON=SC.DETAIL.value('(otherrespperson)[1]', 'int') ,
@MIRESPONSEDATE=SC.DETAIL.value('(respdate)[1]', 'int') ,
@MIRESPONSEREQUIREDDATE=SC.DETAIL.value('(respreqdate)[1]', 'int') ,
@MIPRIORITY=SC.DETAIL.value('(priority)[1]', 'int') ,
@MIOTHEREMAILID=SC.DETAIL.value('(othermailid)[1]', 'int') ,
@MIACTIONPLANNED=SC.DETAIL.value('(planned)[1]', 'int') ,
@MIACTIONPERFORMED=SC.DETAIL.value('(performed)[1]', 'int') ,
@MICARDSTATUS=SC.DETAIL.value('(castatus)[1]', 'int') ,
@MIOWNER=SC.DETAIL.value('(actowner)[1]', 'int') ,
@MIRESPONSIBLEPERSON=SC.DETAIL.value('(respperson)[1]', 'int'),
@MICATEGORYLIST=SC.DETAIL.value('(categoryassigned)[1]', 'int')
FROM @CAMODIFIEDLIST.nodes('/modified') SC(DETAIL)--cardid

IF (ISNULL(@MIOTHERRESPONSIBLEPERSON,0)+ISNULL(@MIRESPONSEDATE,0)+ISNULL(@MIRESPONSEREQUIREDDATE,0)+ISNULL(@MIPRIORITY,0)+ISNULL(@MIOTHEREMAILID,0)+
ISNULL(@MIACTIONPLANNED,0)+ISNULL(@MIACTIONPERFORMED,0)+ISNULL(@MICARDSTATUS,0)+ISNULL(@MIOWNER,0)+ISNULL(@MIRESPONSIBLEPERSON,0)+ISNULL(@MICATEGORYLIST,0))>0
BEGIN
IF ISNULL(@MIRESPONSIBLEPERSON,0)>0
BEGIN

SELECT @MIRESPONSIBLEPERSONLIST=@MIRESPONSIBLEPERSONLIST + LASTNAME +' '+FIRSTNAME+','
FROM CORRECTIVEACTIONSRESPONSIBLEPERSONS CR
INNER JOIN USERS U ON U.USERID=CR.USERID
WHERE CORRACTIONID=@CORRACTIONID
IF LEN(@MIRESPONSIBLEPERSONLIST)>1
SELECT @MIRESPONSIBLEPERSONLIST=SUBSTRING(@MIRESPONSIBLEPERSONLIST,1,LEN(@MIRESPONSIBLEPERSONLIST)-1)

END
IF ISNULL(@MICATEGORYLIST,0)>0
BEGIN

UPDATE C SET STATUS =1
FROM #CACATEGORYNEW C
INNER JOIN #CACATEGORYOLD O ON O.MAINCATEGORYID=C.MAINCATEGORYID AND O.SUBCATEGORYID=C.SUBCATEGORYID

IF EXISTS(SELECT 1 FROM #CACATEGORYNEW WHERE ISNULL(STATUS,0)=0)
	SELECT @MICATEGORYLIST1=@MICATEGORYLIST1 + CAST(MAINCATEGORYID AS NVARCHAR(8))+'|'+CAST(SUBCATEGORYID AS NVARCHAR(8))+','
	FROM #CACATEGORYNEW CAC
	WHERE ISNULL(CAC.STATUS,0)=0
ELSE 
	SELECT @MICATEGORYLIST1=@MICATEGORYLIST1 + CAST(MAINCATEGORYID AS NVARCHAR(8))+'|'+CAST(SUBCATEGORYID AS NVARCHAR(8))+','
	FROM #CACATEGORYNEW CAC

IF LEN(@MICATEGORYLIST1)>1
SELECT @MICATEGORYLIST1=SUBSTRING(@MICATEGORYLIST1,1,LEN(@MICATEGORYLIST1)-1)

END

INSERT INTO CORRECTIVEACTIONSMI(CORRACTIONID,CARDID,OTHERRESPONSIBLEPERSON,RESPONSEDATE,RESPONSEREQUIREDDATE,PRIORITY,OTHEREMAILID,ACTIONPLANNED,ACTIONPERFORMED,
CARDSTATUS,OWNER,RESPONSIBLEPERSON,CATEGORYLIST,CREATEDBY,CREATEDDATE,APPTYPE,INSERTSTATUS)
SELECT @CORRACTIONID,@CARDID,
CASE WHEN @MIOTHERRESPONSIBLEPERSON=0 THEN NULL ELSE OTHERRESPONSIBLEPERSON END,
CASE WHEN @MIRESPONSEDATE=0 THEN NULL ELSE RESPONSEDATE END,
CASE WHEN @MIRESPONSEREQUIREDDATE=0 THEN NULL ELSE RESPONSEREQUIREDDATE END,
CASE WHEN @MIPRIORITY=0 THEN NULL ELSE PRIORITY END,
CASE WHEN @MIOTHEREMAILID=0 THEN NULL ELSE OTHEREMAILID END,
CASE WHEN @MIACTIONPLANNED=0 THEN NULL ELSE ACTIONPLANNED END,
CASE WHEN @MIACTIONPERFORMED=0 THEN NULL ELSE ACTIONPERFORMED END,
CASE WHEN @MICARDSTATUS=0 THEN NULL ELSE CARDSTATUS END,
CASE WHEN @MIOWNER=0 THEN NULL ELSE OWNER END,
CASE WHEN @MIRESPONSIBLEPERSON=0 THEN NULL ELSE (CASE WHEN LEN(@MIRESPONSIBLEPERSONLIST)>0 THEN @MIRESPONSIBLEPERSONLIST ELSE NULL END) END,
CASE WHEN @MICATEGORYLIST=0 THEN NULL ELSE (CASE WHEN LEN(@MICATEGORYLIST1)>0 THEN @MICATEGORYLIST1 ELSE NULL END) END,
@UPDATEDBY,
@CC_TIMESTAMP,
1 APPTYPE,2 INSERTSTATUS
FROM CORRECTIVEACTIONS
WHERE CORRACTIONID=@CORRACTIONID

SELECT @MODID=@@IDENTITY
END

IF @MODID>0
INSERT INTO USERINBOXAPP(USERID,CARDID,CORRACTIONID,CREATEDON,READON,READSTATUS,ISDISPLAY,MODID,INSERTSTATUS)
SELECT U.USERID,CA.CARDID,CA.CORRACTIONID,@CC_TIMESTAMP,NULL,0 ,ISDISPLAY,@MODID,2 INSERTSTATUS
FROM CORRECTIVEACTIONS CA
FULL OUTER JOIN #NOTUSERLIST U ON 1=1
WHERE CA.CORRACTIONID=@CORRACTIONID

SELECT @CARDID,@MODID MODID

DROP TABLE #NOTUSERLIST
DROP TABLE #CACATEGORYOLD
DROP TABLE #CACATEGORYNEW
