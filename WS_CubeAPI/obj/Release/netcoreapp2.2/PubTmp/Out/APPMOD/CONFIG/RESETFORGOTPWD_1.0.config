DECLARE @SCHEDULETYPEID INT,@SCHEDULEID INT,@OPTIONID INT,@EMAILID VARCHAR(256),@URL VARCHAR(1024),@FROM VARCHAR(256)
DECLARE @REGEXREPLACETEXT NVARCHAR(1024),@LANGUAGEID INT,@RANDOMPWD NVARCHAR(16)
SET @REGEXREPLACETEXT=''
SET @RANDOMPWD=''
SELECT @RANDOMPWD=dbo.GETRANDOMPASSWORD()
SET @FROM=''
SELECT @REGEXREPLACETEXT=USERNAME+'|'+LASTNAME+'|'+FIRSTNAME+'|'+@RANDOMPWD FROM USERS U
INNER JOIN USERINFO UI ON UI.USERID = U.USERID
INNER JOIN ROLES R ON R.ROLEID=UI.DEFAULTROLEID
WHERE U.USERID = @USERID

SELECT @LANGUAGEID =LANGUAGEID FROM USERINFO WHERE USERID =@USERID

SET @URL = ''
SELECT @URL = OPTIONVALUE FROM COMPANYOPTIONS WHERE OPTIONNAME ='URL'
SELECT @FROM = OPTIONVALUE FROM COMPANYOPTIONS WHERE OPTIONNAME ='MAILFROM'
SELECT @SCHEDULETYPEID=SCHEDULETYPEID FROM SCHEDULETYPES WHERE SCHEDULETYPENAME='Forgot Password'
SELECT @SCHEDULEID=SCHEDULEID FROM SCHEDULE WHERE SCHEDULETYPEID=@SCHEDULETYPEID
SELECT @OPTIONID = OPTIONID FROM REPORTOPTIONSMASTER WHERE OPTIONNAME= 'SITES'
SELECT @EMAILID=EMAIL FROM USERS WHERE USERID = @USERID
IF EXISTS(SELECT 1 FROM SCHEDULETYPES WHERE SCHEDULETYPEID=@SCHEDULETYPEID AND STATUS = 1)
IF EXISTS(SELECT 1 FROM SCHEDULE WHERE SCHEDULETYPEID=@SCHEDULETYPEID)
BEGIN
IF EXISTS(SELECT 1 FROM USERSITES US
INNER JOIN SCHEDULEASSIGNMENTS SA ON SA.OPTIONVALUE=US.SITEID AND SA.OPTIONID = @OPTIONID WHERE US.USERID =@USERID)
BEGIN
UPDATE USERS SET PASSWORD= dbo.fn40Encrypt(@RANDOMPWD),STATUS=CASE WHEN STATUS=4 THEN 1 ELSE STATUS END,UPDATEDDATE=GETDATE(),UPDATEDBY=@USERID WHERE USERID = @USERID
UPDATE USERINFO SET PASSWORDLASTUPDATE=NULL,LOGINATTEMPTS=0,UPDATEDDATE=GETDATE(),UPDATEDBY=@USERID WHERE USERID = @USERID
INSERT INTO USERINBOX (COMPANYID,USERID,[FROM],REPLYTO,[TO],CC,BCC,[SUBJECT],BODY,SENTDATE,READSTATUS,[TYPE],[STATUS])
SELECT COMPANYID,@USERID USERID,@FROM [FROM],REPLYTO,@EMAILID [TO],S.CC CC,'' BCC,ISNULL(SEC.SUBJECT,S.SUBJECT) [SUBJECT],DBO.REGEXREPLACE(ISNULL(SEC.BODY,S.BODY),'01|02|03|33',@REGEXREPLACETEXT) BODY,GETDATE() SENTDATE,0,1,1 FROM SCHEDULE S
LEFT JOIN SCHEDULEEMAILCONTENT SEC ON SEC.SCHEDULEID=S.SCHEDULEID AND SEC.LANGUAGEID = @LANGUAGEID
WHERE S.SCHEDULEID = @SCHEDULEID

SELECT S.SCHEDULEID,COMPANYID,@USERID USERID, @FROM [FROM],S.REPLYTO,@EMAILID [TO],S.CC CC,'' BCC,ISNULL(SEC.SUBJECT,S.SUBJECT) [SUBJECT],DBO.REGEXREPLACE(ISNULL(SEC.BODY,S.BODY),'01|02|03|33',@REGEXREPLACETEXT) BODY,GETDATE() SENTDATE,@URL URL FROM SCHEDULE S
LEFT JOIN SCHEDULEEMAILCONTENT SEC ON SEC.SCHEDULEID=S.SCHEDULEID AND SEC.LANGUAGEID = @LANGUAGEID
WHERE S.SCHEDULEID = @SCHEDULEID
END
ELSE
BEGIN
UPDATE USERS SET PASSWORD= dbo.fn40Encrypt(@RANDOMPWD),STATUS=CASE WHEN STATUS=4 THEN 1 ELSE STATUS END,UPDATEDDATE=GETDATE(),UPDATEDBY=@USERID WHERE USERID = @USERID
UPDATE USERINFO SET PASSWORDLASTUPDATE=NULL,LOGINATTEMPTS=0,UPDATEDDATE=GETDATE(),UPDATEDBY=@USERID WHERE USERID = @USERID
INSERT INTO USERINBOX (COMPANYID,USERID,[FROM],REPLYTO,[TO],CC,BCC,[SUBJECT],BODY,SENTDATE,READSTATUS,[TYPE],[STATUS])
SELECT COMPANYID,@USERID USERID, @FROM [FROM],S.REPLYTO [REPLYTO],@EMAILID [TO],S.CC CC,'' BCC,ISNULL(SEC.SUBJECT,S.SUBJECT) [SUBJECT],DBO.REGEXREPLACE(ISNULL(SEC.BODY,S.BODY),'01|02|03|33',@REGEXREPLACETEXT) BODY,GETUTCDATE() SENTDATE,0,1,1 FROM SCHEDULE S
LEFT JOIN SCHEDULEEMAILCONTENT SEC ON SEC.SCHEDULEID=S.SCHEDULEID AND SEC.LANGUAGEID = @LANGUAGEID
WHERE S.SCHEDULEID = @SCHEDULEID

SELECT S.SCHEDULEID,COMPANYID,@USERID USERID, @FROM [FROM],S.REPLYTO [REPLYTO],@EMAILID [TO],S.CC CC,'' BCC,ISNULL(SEC.SUBJECT,S.SUBJECT) [SUBJECT],DBO.REGEXREPLACE(ISNULL(SEC.BODY,S.BODY),'01|02|03|33',@REGEXREPLACETEXT) BODY,GETUTCDATE() SENTDATE,@URL URL FROM SCHEDULE S
LEFT JOIN SCHEDULEEMAILCONTENT SEC ON SEC.SCHEDULEID=S.SCHEDULEID AND SEC.LANGUAGEID = @LANGUAGEID
WHERE S.SCHEDULEID = @SCHEDULEID

END
END
