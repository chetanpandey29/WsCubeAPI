SELECT T.CHECKLISTSETUPID,
STUFF(
         (SELECT ', ' + CAST(T2.SITEID AS VARCHAR(50))
          FROM CHECKLISTSETUPSITES T2
          WHERE T.CHECKLISTSETUPID = T2.CHECKLISTSETUPID 
          AND  T2.SITEID IN (SELECT RESULT FROM DBO.CSVTOTABLE(@SITEID))
           FOR XML PATH (''))
          , 1, 1, '')  AS SITEIDS
FROM CHECKLISTSETUPSITES T
INNER JOIN CHECKLISTSETUP CS ON CS.CHECKLISTSETUPID=T.CHECKLISTSETUPID 
WHERE CS.ALLSITES=0 AND T.STATUS = 1 AND CS.STATUS=1 AND  T.SITEID IN (SELECT RESULT FROM DBO.CSVTOTABLE(@SITEID))
GROUP BY T.CHECKLISTSETUPID
UNION 
SELECT CHECKLISTSETUPID,@SITEID SITEIDS FROM CHECKLISTSETUP  WHERE ALLSITES=1 AND STATUS=1
