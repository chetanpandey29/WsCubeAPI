--GETUSERSAVAILFORGROUPS_1.0
IF EXISTS(SELECT 1 FROM USERINFO WHERE DEFAULTROLEID=1 AND USERID = @USERID)
SELECT '<option value="'+CAST(USERID AS VARCHAR(32))+'">'+LASTNAME + ' , ' + FIRSTNAME+'</option>' AS 'data()'  FROM USERS U
WHERE NOT EXISTS(SELECT 1 FROM USERGROUPS WHERE GROUPTYPEID = @GROUPTYPEID  AND STATUS = 1 AND USERID=U.USERID)
AND STATUS IN(1,4)  AND USERID !=@USERID ORDER BY LASTNAME + ' , ' + FIRSTNAME FOR XML PATH('')

ELSE

SELECT '<option value="'+CAST(U.USERID AS VARCHAR(32))+'">'+U.LASTNAME + ' , ' + U.FIRSTNAME+'</option>' AS 'data()'  FROM USERS U
INNER JOIN USERSITES US ON US.USERID = U.USERID
WHERE
NOT EXISTS(SELECT 1 FROM USERGROUPS WHERE GROUPTYPEID = @GROUPTYPEID  AND STATUS = 1 AND USERID=U.USERID)
AND U.STATUS IN(1,4)
AND US.STATUS=1
AND US.SITEID IN (SELECT SITEID FROM USERSITES WHERE USERID = @USERID AND STATUS =1)
AND U.USERID !=@USERID
ORDER BY U.LASTNAME + ' , ' + U.FIRSTNAME FOR XML PATH('') ;
