IF EXISTS(SELECT 1 FROM USERINFO UI INNER JOIN ROLES R ON R.ROLEID=UI.DEFAULTROLEID WHERE R.ALLSITES=1 AND R.STATUS=1 AND UI.USERID=@USERID)
SELECT DISTINCT U.USERID,U.LASTNAME+' '+U.FIRSTNAME EMAIL
FROM USERS U
WHERE U.STATUS!=2 AND ISNULL(U.EMAIL,'')!='' ORDER BY U.LASTNAME+' '+U.FIRSTNAME
ELSE
SELECT DISTINCT U.USERID,U.LASTNAME+' '+U.FIRSTNAME EMAIL
FROM USERS U
WHERE  ISNULL(U.EMAIL,'')!=''  AND U.STATUS!=2 AND U.USERID IN (SELECT USERID FROM USERSITES WHERE STATUS=1 AND SITEID IN (SELECT SITEID FROM USERSITES WHERE USERID =@USERID AND STATUS=1))
ORDER BY U.LASTNAME+' '+U.FIRSTNAME
