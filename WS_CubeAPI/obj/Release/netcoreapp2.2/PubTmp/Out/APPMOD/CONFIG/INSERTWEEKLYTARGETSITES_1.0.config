--INSERTWEEKLYTARGETSITES_1.0
DECLARE @CC_TIMESTAMP DATETIME
SET @CC_TIMESTAMP=GETDATE()

IF EXISTS(SELECT 1 FROM WEEKLYTARGETSITES WHERE SITEID = @SITEID)
UPDATE WEEKLYTARGETSITES SET WEEKTARGET=@WEEKTARGET,UPDATEDBY=@CREATEDBY,UPDATEDDATE=@CC_TIMESTAMP WHERE SITEID =@SITEID
ELSE
INSERT INTO WEEKLYTARGETSITES(SITEID,WEEKTARGET,CREATEDBY,CREATEDDATE) SELECT @SITEID,@WEEKTARGET,@CREATEDBY,@CC_TIMESTAMP

IF @APPLYTOALLOBSERVERS = 1
BEGIN
INSERT INTO dbo.AUDIT(TABLENAME,TRANS,STAMP,LASTUPDATEDBY,DATA)
SELECT 'WEEKLYTARGETUSERS','INSERT-INSERTWEEKLYTARGETSITES_1.0',@CC_TIMESTAMP,@CREATEDBY,(SELECT * FROM WEEKLYTARGETUSERS WHERE SITEID = @SITEID FOR XML AUTO)

UPDATE WEEKLYTARGETUSERS SET WEEKTARGET=@WEEKTARGET,CREATEDBY=@CREATEDBY,CREATEDDATE=@CC_TIMESTAMP
WHERE USERID IN (SELECT USERID FROM USERINFO WHERE DEFAULTSITEID = @SITEID)
AND SITEID = @SITEID


INSERT INTO WEEKLYTARGETUSERS(SITEID,USERID,WEEKTARGET,CREATEDBY,CREATEDDATE)
SELECT @SITEID SITEID,UI.USERID,@WEEKTARGET,@CREATEDBY,@CC_TIMESTAMP FROM USERINFO UI
INNER JOIN USERS U ON U.USERID=UI.USERID
WHERE DEFAULTSITEID =@SITEID AND U.STATUS!=2
AND UI.USERID NOT IN (SELECT USERID FROM WEEKLYTARGETUSERS WHERE SITEID = @SITEID)

END

SELECT 1

INSERT INTO dbo.AUDIT(TABLENAME,TRANS,STAMP,LASTUPDATEDBY,DATA)
SELECT 'WEEKLYTARGETSITES','INSERT-INSERTWEEKLYTARGETSITES_1.0',@CC_TIMESTAMP,@CREATEDBY,NULL
