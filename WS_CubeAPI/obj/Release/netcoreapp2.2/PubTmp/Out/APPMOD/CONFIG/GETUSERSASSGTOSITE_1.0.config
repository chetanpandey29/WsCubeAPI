
IF EXISTS(SELECT 1 FROM USERINFO WHERE USERID = @USERID AND DEFAULTROLEID=1)
SELECT DISTINCT USERID,LASTNAME + ',' + FIRSTNAME+CASE WHEN [STATUS] = 0 THEN ' ( InActive ) ' WHEN [STATUS] = 4 THEN ' ( Locked ) '  ELSE '' END AS [FULLNAME]
FROM USERS
WHERE USERID IN(SELECT USERID FROM USERSITES WHERE SITEID= @SITEID AND STATUS=1) AND STATUS <> 2
ORDER BY FULLNAME
ELSE
SELECT DISTINCT U.USERID,LASTNAME + ',' + FIRSTNAME+CASE WHEN U.[STATUS] = 0 THEN ' ( InActive ) ' WHEN U.[STATUS] = 4 THEN ' ( Locked ) '  ELSE '' END AS [FULLNAME]
FROM USERS U
INNER JOIN USERSITES US ON US.USERID =U.USERID
WHERE U.USERID IN(SELECT USERID FROM USERSITES WHERE SITEID= @SITEID AND STATUS=1)
AND U.STATUS <> 2
AND US.SITEID IN (SELECT SITEID FROM USERSITES WHERE USERID = @USERID AND STATUS =1)
ORDER BY FULLNAME