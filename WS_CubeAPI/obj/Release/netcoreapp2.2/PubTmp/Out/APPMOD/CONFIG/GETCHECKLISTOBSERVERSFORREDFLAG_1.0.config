IF @MODE=0
SELECT DISTINCT U.USERID,LASTNAME+','+FIRSTNAME [FULLNAME] FROM USERS U
INNER JOIN USERINFO UI ON UI.USERID = U.USERID
INNER JOIN USERSITES US ON US.USERID = U.USERID
WHERE US.SITEID = @SITEID AND U.STATUS IN(1,4) AND US.STATUS = 1 AND UI.USERTYPEID IN (1,2)
ORDER BY FULLNAME
ELSE
BEGIN
IF EXISTS (SELECT 1 FROM REDFLAGS WHERE REDFLAGID = @REDFLAGID AND OBSERVERID=-1)
SELECT DISTINCT U.USERID,LASTNAME+',' +FIRSTNAME+CASE WHEN U.STATUS=0 THEN '( InActive )' WHEN EXISTS(SELECT 1 FROM USERSITES WHERE SITEID=@SITEID AND USERID=U.USERID AND STATUS=0) THEN ' ( Unassigned )' ELSE '' END [FULLNAME]
FROM USERS U
INNER JOIN USERSITES SU ON SU.SITEID =@SITEID AND SU.USERID=U.USERID
WHERE U.STATUS  IN(1,4) AND SU.STATUS =1
ELSE
SELECT USERID , [FULLNAME] FROM(
SELECT DISTINCT U.USERID,LASTNAME+',' +FIRSTNAME+CASE WHEN U.STATUS=0 THEN '( InActive )' WHEN EXISTS(SELECT 1 FROM USERSITES WHERE SITEID=@SITEID AND USERID=U.USERID AND STATUS=0) THEN ' ( Unassigned )' ELSE '' END [FULLNAME]
FROM USERS U
WHERE U.USERID IN (SELECT OBSERVERID FROM REDFLAGS WHERE REDFLAGID =@REDFLAGID)
UNION
SELECT DISTINCT U.USERID,LASTNAME+',' +FIRSTNAME [FULLNAME]
FROM USERS U
INNER JOIN USERSITES SU ON SU.SITEID =@SITEID AND SU.USERID=U.USERID
WHERE U.STATUS IN(1,4) AND SU.STATUS = 1 AND U.USERID NOT IN  (SELECT OBSERVERID FROM REDFLAGS WHERE REDFLAGID =@REDFLAGID))A
ORDER BY FULLNAME
END


