--MAILCORRECTIVEACTIONUPDATE_1.0
DECLARE @USERID INT,@OTHERRESPONSIBLEPERSON NVARCHAR(512),@OTHEREMAILID VARCHAR(256),@URL VARCHAR(1024),@FROM VARCHAR(256),@INTERNALNAME NVARCHAR(32),@DEFAULTLANGUAGEID INT
DECLARE @SCHEDULETYPEID INT,@EMAILID VARCHAR(256)
DECLARE @SCHEDULETBL TABLE([TYPE] INT,SCHEDULEID INT)
SELECT @INTERNALNAME=''
SELECT @INTERNALNAME=OPTIONVALUE FROM COMPANYOPTIONS WHERE OPTIONNAME='Languages'
SELECT @DEFAULTLANGUAGEID=LANGUAGEID FROM LANGUAGES WHERE INTERNALNAME=@INTERNALNAME

SELECT @SCHEDULETYPEID=SCHEDULETYPEID FROM SCHEDULETYPES WHERE SCHEDULETYPENAME='Corrective Actions Updated'
DECLARE @OTHERUSER TABLE(SCHEDULEID INT)
DECLARE @OTHERUSERNAME NVARCHAR(512),@ACTIONOWNER INT,@DEFAULTDATEFORMAT INT

SELECT @DEFAULTDATEFORMAT=CAST(OPTIONVALUE AS INT) FROM COMPANYOPTIONS WHERE OPTIONNAME='DefaultDateFormat'
CREATE TABLE #CAMODITEMS(USERID INT,CAMODIFIED NVARCHAR(MAX))

DECLARE @LBLAREANAME NVARCHAR(512),
@LBLSUBAREANAME NVARCHAR(512),
@LBLCORRECTIVEACTIONPLANNED NVARCHAR(512),
@LBLRESPONSEREQUIREDDATE DATETIME,
@LBLPRIORITY NVARCHAR(512),
@LBLSTATUS NVARCHAR(512),
@LBLOWNER NVARCHAR(512),
@LBLCORRECTIVEACTIONPERFORMED NVARCHAR(MAX),
@LBLRESPONDEDDATE DATETIME,
@LBLMAINCATEGORYNAME NVARCHAR(2000),
@LBLSUBCATNAME NVARCHAR(4000),
@LBLOBSDATE DATETIME,
@LBLCARDSTATUS NVARCHAR(24),
@LBLCASUBJECT NVARCHAR(1024),
@SITENAME NVARCHAR(512),
@ACTIONOWNERMAILID NVARCHAR(512),
@LBLCHECKLISTNO NVARCHAR(64),
@LBLCAUPDATEDBY NVARCHAR(512),
--@LBLCAMODIFIEDLIST NVARCHAR(MAX),
@LBLCARESPONSIBLEPERSONS NVARCHAR(4000)

SELECT @LBLAREANAME ='',@LBLSUBAREANAME ='',@LBLCORRECTIVEACTIONPLANNED ='',@LBLRESPONSEREQUIREDDATE =GETDATE(),@LBLPRIORITY ='',
@LBLSTATUS ='',@LBLOWNER='',@LBLCORRECTIVEACTIONPERFORMED='',@LBLRESPONDEDDATE=NULL,@LBLMAINCATEGORYNAME ='',@LBLSUBCATNAME ='',@LBLOBSDATE =GETDATE(),@LBLCARDSTATUS='',@LBLCASUBJECT='',@SITENAME='',
@ACTIONOWNERMAILID='',@LBLCHECKLISTNO='',@LBLCAUPDATEDBY='',@LBLCARESPONSIBLEPERSONS=''

SET @OTHERUSERNAME = ''
SET @FROM=''

CREATE TABLE #SCHEDULETEMP(ID INT IDENTITY(1,1),SCHEDULEID INT,OPTIONID INT)
CREATE TABLE #CORRECTIVEACTIONUSER(ID INT IDENTITY(1,1),USERID INT)
CREATE TABLE #FINALSCHEDULE(SCHEDULEID INT,USERID INT,OPTIONID INT)
CREATE TABLE #MAILSCHEDULE(SCHEDULEID INT,USERID INT,BODYTEXT NVARCHAR(MAX),ACTIONOWNER INT,CCLIST NVARCHAR(MAX))
CREATE TABLE #MAILSCHEDULERP(SCHEDULEID INT,OTHERRESPONSIBLEPERSON NVARCHAR(512),OTHEREMAILID VARCHAR(256),BODYTEXT NVARCHAR(MAX),ACTIONOWNER INT,CCLIST NVARCHAR(MAX))

SELECT @OTHERRESPONSIBLEPERSON=OTHERRESPONSIBLEPERSON,@OTHEREMAILID=REPLACE(OTHEREMAILID,',','; '),@ACTIONOWNER=[OWNER],
@LBLAREANAME =(SELECT ISNULL(AREANAME,'') FROM AREAS WHERE AREAID = SC.AREAID)
,@LBLSUBAREANAME =ISNULL((SELECT ISNULL(SUBAREANAME,'') FROM SUBAREAS WHERE SUBAREAID = SC.SUBAREAID),'')
,@LBLCORRECTIVEACTIONPLANNED = CA.ACTIONPLANNED,
@LBLRESPONSEREQUIREDDATE =CA.RESPONSEREQUIREDDATE,@LBLPRIORITY =CASE CA.PRIORITY WHEN 1 THEN 'LBLHIGH' WHEN 2 THEN 'LBLMEDIUM' WHEN 3 THEN 'LBLLOW' END ,
@LBLSTATUS = CASE CA.STATUS WHEN 0 THEN 'Inactive' WHEN 1 THEN 'Active' END,
@LBLOWNER=(SELECT ISNULL(LASTNAME + ' ' + FIRSTNAME,'') FROM USERS WHERE USERID = CA.[OWNER]),
@LBLCORRECTIVEACTIONPERFORMED=ISNULL(ACTIONPERFORMED,''),@LBLRESPONDEDDATE=RESPONSEDATE,
@LBLMAINCATEGORYNAME ='',@LBLSUBCATNAME ='',@LBLOBSDATE =SC.OBSERVATIONDATE,@LBLCARDSTATUS=CASE CA.CARDSTATUS WHEN 1 THEN 'LBLOPEN' WHEN 2 THEN 'LBLCOMPLETED' WHEN 3 THEN 'LBLALTERNATEACTION' END,
@LBLCASUBJECT=ISNULL(CA.[SUBJECT],''),
@SITENAME=(SELECT TOP 1 SITENAME FROM SITES WHERE SITEID = SC.SITEID),
@LBLCAUPDATEDBY=ISNULL((SELECT LASTNAME+' '+FIRSTNAME FROM USERS WHERE USERID = CA.UPDATEDBY),'')

FROM CORRECTIVEACTIONS CA INNER JOIN STOPCARDENTRY SC ON SC.CARDID=CA.CARDID WHERE CORRACTIONID=@CORRACTIONID

SET @LBLCHECKLISTNO=(SELECT TOP 1 CAST(CARDID AS NVARCHAR(32)) FROM CORRECTIVEACTIONS WHERE CORRACTIONID=@CORRACTIONID)+' / '+CAST(@CORRACTIONID AS NVARCHAR(32))





SELECT @LBLCARESPONSIBLEPERSONS=@LBLCARESPONSIBLEPERSONS+LASTNAME+' '+FIRSTNAME+',' FROM CORRECTIVEACTIONSRESPONSIBLEPERSONS CA
INNER JOIN USERS U ON U.USERID=CA.USERID
WHERE CA.CORRACTIONID=@CORRACTIONID AND U.STATUS!=2
SELECT @ACTIONOWNERMAILID=EMAIL FROM USERS WHERE USERID = @ACTIONOWNER AND STATUS !=2

IF LEN(@LBLCARESPONSIBLEPERSONS)> 1
SET @LBLCARESPONSIBLEPERSONS = SUBSTRING(@LBLCARESPONSIBLEPERSONS,1,LEN(@LBLCARESPONSIBLEPERSONS)-1)

SET @LBLMAINCATEGORYNAME=''
SET @LBLSUBCATNAME=''


SELECT @LBLMAINCATEGORYNAME=@LBLMAINCATEGORYNAME+ET.ENTITYVALUE +'<BR>
  ' FROM ENTITYTRANSLATION ET
  INNER JOIN (SELECT DISTINCT MAINCATEGORYID FROM CORRECTIVEACTIONSCATEGORY WHERE CORRACTIONID=@CORRACTIONID AND ISASSIGNED=1) E
  ON E.MAINCATEGORYID=ET.ENTITYID
  WHERE ET.ENTITYTYPE='MAIN_CTG' AND ET.LANGUAGEID=4

  IF LEN(@LBLMAINCATEGORYNAME)>4
  SET @LBLMAINCATEGORYNAME=SUBSTRING(@LBLMAINCATEGORYNAME,1,LEN(@LBLMAINCATEGORYNAME)-4)
  ELSE
  SET @LBLMAINCATEGORYNAME=''

  SELECT @LBLSUBCATNAME=@LBLSUBCATNAME+ET.ENTITYVALUE +' - '+ET1.ENTITYVALUE+'<BR>
    ' FROM CORRECTIVEACTIONSCATEGORY CA
    INNER JOIN ENTITYTRANSLATION ET ON CA.MAINCATEGORYID=ET.PARENTID AND CA.SUBCATEGORYID=ET.ENTITYID AND ET.ENTITYTYPE='SUB_CTG' AND ET.LANGUAGEID=4
    INNER JOIN ENTITYTRANSLATION ET1 ON CA.MAINCATEGORYID=ET1.ENTITYID AND ET1.ENTITYTYPE='MAIN_CTG' AND ET1.LANGUAGEID=4
    WHERE CA.CORRACTIONID=@CORRACTIONID AND CA.ISASSIGNED=1

    IF LEN(ISNULL(@LBLSUBCATNAME,''))>4
    SET @LBLSUBCATNAME=SUBSTRING(@LBLSUBCATNAME,1,LEN(@LBLSUBCATNAME)-4)
    ELSE
    SET @LBLSUBCATNAME=''

    SET @URL = ''
    SELECT @URL = OPTIONVALUE FROM COMPANYOPTIONS WHERE OPTIONNAME ='URL'
    SELECT @FROM = OPTIONVALUE FROM COMPANYOPTIONS WHERE OPTIONNAME ='MAILFROM'

    DECLARE @TEMP INT,@TEMPUSER INT,@TEMPSCHEDULEID INT,@TEMPOPTIONID INT

    INSERT INTO #CORRECTIVEACTIONUSER(USERID)
    SELECT USERID FROM CORRECTIVEACTIONSRESPONSIBLEPERSONS WHERE CORRACTIONID=@CORRACTIONID

    SET @TEMP = 1
    SET @TEMPUSER=1


    INSERT INTO #SCHEDULETEMP(SCHEDULEID,OPTIONID)
    SELECT S.SCHEDULEID,SA.OPTIONID
    FROM SCHEDULE S
    INNER JOIN SCHEDULEASSIGNMENTS SA ON SA.SCHEDULEID =S.SCHEDULEID
    WHERE S.STATUS=1 AND S.SCHEDULETYPEID=@SCHEDULETYPEID
    ORDER BY S.SCHEDULEID,SA.OPTIONID

    WHILE @TEMP < =(SELECT MAX(ID) FROM #SCHEDULETEMP)
BEGIN
     SELECT @TEMPSCHEDULEID = SCHEDULEID,@TEMPOPTIONID=OPTIONID FROM #SCHEDULETEMP WHERE ID = @TEMP
     SELECT @USERID=USERID FROM #CORRECTIVEACTIONUSER WHERE ID=@TEMPUSER
     WHILE @TEMPUSER < =(SELECT MAX(ID) FROM #CORRECTIVEACTIONUSER)
     BEGIN
     IF EXISTS(SELECT OPTIONID FROM REPORTOPTIONSMASTER WHERE OPTIONID = @TEMPOPTIONID AND REPORTPARAM = 'SITEID')
     BEGIN
     IF EXISTS(SELECT 1 FROM #SCHEDULETEMP S
     INNER JOIN SCHEDULEASSIGNMENTS SA ON SA.SCHEDULEID = S.SCHEDULEID
     INNER JOIN USERSITES US ON US.SITEID = SA.OPTIONVALUE
     WHERE SA.OPTIONID = @TEMPOPTIONID AND US.USERID=@USERID AND S.ID=@TEMP AND US.STATUS=1)
     INSERT INTO #FINALSCHEDULE
     SELECT @TEMPSCHEDULEID,@USERID,@TEMPOPTIONID
END

ELSE IF EXISTS(SELECT OPTIONID FROM REPORTOPTIONSMASTER WHERE OPTIONID = @TEMPOPTIONID AND REPORTPARAM = 'ROLEID')
BEGIN
IF EXISTS(SELECT 1 FROM #SCHEDULETEMP S
INNER JOIN SCHEDULEASSIGNMENTS SA ON SA.SCHEDULEID = S.SCHEDULEID
INNER JOIN USERINFO UI ON UI.DEFAULTROLEID=SA.OPTIONVALUE
WHERE SA.OPTIONID = @TEMPOPTIONID AND UI.USERID=@USERID AND S.ID=@TEMP)
INSERT INTO #FINALSCHEDULE
SELECT @TEMPSCHEDULEID,@USERID,@TEMPOPTIONID
END
ELSE IF EXISTS(SELECT OPTIONID FROM REPORTOPTIONSMASTER WHERE OPTIONID = @TEMPOPTIONID AND REPORTPARAM = 'ROLEID')
BEGIN
IF EXISTS(SELECT 1 FROM #SCHEDULETEMP S
INNER JOIN SCHEDULEASSIGNMENTS SA ON SA.SCHEDULEID = S.SCHEDULEID
INNER JOIN USERINFO UI ON UI.DEFAULTROLEID = SA.OPTIONVALUE
WHERE SA.OPTIONID = @TEMPOPTIONID AND UI.USERID=@USERID AND S.ID=@TEMP)
INSERT INTO #FINALSCHEDULE
SELECT @TEMPSCHEDULEID,@USERID,@TEMPOPTIONID
END
ELSE IF EXISTS(SELECT OPTIONID FROM REPORTOPTIONSMASTER WHERE OPTIONID BETWEEN 22 AND 31 AND REPORTPARAM LIKE 'Group%')
BEGIN
IF EXISTS(SELECT 1 FROM #SCHEDULETEMP S
INNER JOIN SCHEDULEASSIGNMENTS SA ON SA.SCHEDULEID = S.SCHEDULEID
INNER JOIN USERGROUPS UG ON UG.GROUPID = SA.OPTIONVALUE
WHERE UG.USERID=@USERID AND SA.OPTIONID =@TEMPOPTIONID AND S.ID=@TEMP AND UG.STATUS=1)
BEGIN

INSERT INTO #FINALSCHEDULE
SELECT @TEMPSCHEDULEID,@USERID,@TEMPOPTIONID
END
END
SET @TEMPUSER=@TEMPUSER+1
SELECT @USERID=USERID FROM #CORRECTIVEACTIONUSER WHERE ID=@TEMPUSER
END

SET @TEMPUSER=1
SET @TEMP = @TEMP+ 1
END


INSERT INTO #MAILSCHEDULE(SCHEDULEID,USERID)
SELECT SA.SCHEDULEID,SA.USERID FROM
(SELECT SCHEDULEID,USERID,COUNT(DISTINCT OPTIONID) CNT FROM #FINALSCHEDULE GROUP BY SCHEDULEID,USERID)SA
INNER JOIN (SELECT SCHEDULEID,COUNT(DISTINCT OPTIONID) CNT FROM #SCHEDULETEMP GROUP BY SCHEDULEID) A ON SA.SCHEDULEID=A.SCHEDULEID AND SA.CNT=A.CNT

IF EXISTS(SELECT SCHEDULEID FROM SCHEDULE WHERE STATUS=1 AND SCHEDULETYPEID = 4 AND SCHEDULEID NOT IN (SELECT SCHEDULEID FROM SCHEDULEASSIGNMENTS WHERE SCHEDULEID IN (SELECT SCHEDULEID FROM SCHEDULE WHERE SCHEDULETYPEID = 4 AND STATUS =1)))
INSERT INTO #MAILSCHEDULE
SELECT S.SCHEDULEID,CA.USERID,NULL,NULL,NULL FROM 
(SELECT SCHEDULEID FROM SCHEDULE WHERE STATUS=1 AND SCHEDULETYPEID = 4 AND SCHEDULEID NOT IN (SELECT SCHEDULEID FROM SCHEDULEASSIGNMENTS WHERE SCHEDULEID IN (SELECT SCHEDULEID FROM SCHEDULE WHERE SCHEDULETYPEID = 4 AND STATUS =1)) ) s
FULL OUTER JOIN #CORRECTIVEACTIONUSER CA ON 1=1

UPDATE #MAILSCHEDULE SET ACTIONOWNER=@ACTIONOWNER

INSERT INTO #CAMODITEMS(USERID)
SELECT DISTINCT ACTIONOWNER FROM #MAILSCHEDULE

DECLARE @CACATLIST TABLE(MAINCATEGORYID INT,SUBCATEGORYID INT)
DECLARE @MODUSERID INT,@MODUSERLANGUAGEID INT,@MODUSERDATEFORMAT INT,@CATEGORYLIST NVARCHAR(4000),@CATEGORYLISTNAMES NVARCHAR(MAX)
SELECT @CATEGORYLIST='',@CATEGORYLISTNAMES=''
SELECT @MODUSERID= MIN (USERID) FROM #CAMODITEMS 
WHILE @MODUSERID<=(SELECT MAX(USERID) FROM #CAMODITEMS)
    BEGIN

    SELECT @MODUSERLANGUAGEID=ISNULL(LANGUAGEID,4),@MODUSERDATEFORMAT=DATEFORMAT FROM USERINFO WHERE USERID=@MODUSERID
    SELECT @CATEGORYLIST=CATEGORYLIST FROM CORRECTIVEACTIONSMI WHERE  ID=@MODID
    IF LEN(@CATEGORYLIST)>1
    INSERT INTO @CACATLIST(MAINCATEGORYID,SUBCATEGORYID)
    SELECT SUBSTRING(ITEM,1,CHARINDEX('|',ITEM)-1),SUBSTRING(ITEM,CHARINDEX('|',ITEM)+1,LEN(ITEM)) FROM DBO.FNSPLIT(@CATEGORYLIST,',')

    SELECT @CATEGORYLISTNAMES=@CATEGORYLISTNAMES+ET1.ENTITYVALUE+CASE WHEN C.SUBCATEGORYID>0 THEN '=>' ELSE '' END +ISNULL(ET2.ENTITYVALUE,'') +'<BR>'
      FROM @CACATLIST C
      LEFT JOIN ENTITYTRANSLATION ET1 ON ET1.LANGUAGEID=@MODUSERLANGUAGEID AND ET1.ENTITYTYPE='MAIN_CTG' AND ET1.PARENTID=C.MAINCATEGORYID
      LEFT JOIN ENTITYTRANSLATION ET2 ON ET2.LANGUAGEID=@MODUSERLANGUAGEID AND ET2.ENTITYTYPE='SUB_CTG' AND ET2.PARENTID=C.MAINCATEGORYID AND ET2.ENTITYID=C.SUBCATEGORYID


      IF LEN(@CATEGORYLISTNAMES)>4
      SELECT @CATEGORYLISTNAMES=SUBSTRING(@CATEGORYLISTNAMES,1,LEN(@CATEGORYLISTNAMES)-4)
      UPDATE C SET CAMODIFIED=
      (SELECT N'<table border=''1''>
        <tr>
          <th colspan=''2''>'+(SELECT LABELVALUE FROM COMMONTRANSLATIONS WHERE LANGUAGEID=@MODUSERLANGUAGEID AND LABELNAME='LBLCAUPDATEDLIST')+'</th>
        </tr>' +
        CASE WHEN ISNULL(RESPONSIBLEPERSON,'')='' THEN '' ELSE N'<tr>
          <td>'+(SELECT LABELVALUE FROM COMMONTRANSLATIONS WHERE LANGUAGEID=@MODUSERLANGUAGEID AND LABELNAME='LBLRESPONSIBLEPERSON')+'</td>
          <td>'+@LBLCARESPONSIBLEPERSONS+'</td>
        </tr>' END+
        CASE WHEN ISNULL(RESPONSEDATE,'')='' THEN '' ELSE N'<tr>
          <td>'+(SELECT LABELVALUE FROM COMMONTRANSLATIONS WHERE LANGUAGEID=@MODUSERLANGUAGEID AND LABELNAME='LBLRESPONDEDDATE')+'</td>
          <td>'+CONVERT(NVARCHAR(32),RESPONSEDATE,@MODUSERDATEFORMAT)+'</td>
        </tr>' END+
        CASE WHEN ISNULL(RESPONSEREQUIREDDATE,'')='' THEN '' ELSE N'<tr>
          <td>'+(SELECT LABELVALUE FROM COMMONTRANSLATIONS WHERE LANGUAGEID=@MODUSERLANGUAGEID AND LABELNAME='LBLRESDATEREQ')+'</td>
          <td>'+CONVERT(NVARCHAR(32),RESPONSEREQUIREDDATE,@MODUSERDATEFORMAT)+'</td>
        </tr>' END+
        CASE WHEN ISNULL(PRIORITY,'')='' THEN '' ELSE N'<tr>
          <td>'+(SELECT LABELVALUE FROM COMMONTRANSLATIONS WHERE LANGUAGEID=@MODUSERLANGUAGEID AND LABELNAME='LBLPRIORITY')+'</td>
          <td>'+(SELECT TOP 1 LABELVALUE FROM [DBO].[COMMONTRANSLATIONS] WHERE LANGUAGEID=@MODUSERLANGUAGEID AND LABELNAME=@LBLPRIORITY)+'</td>
        </tr>' END+
        CASE WHEN ISNULL(OTHEREMAILID,'')='' THEN '' ELSE N'<tr>
          <td>'+(SELECT LABELVALUE FROM COMMONTRANSLATIONS WHERE LANGUAGEID=@MODUSERLANGUAGEID AND LABELNAME='LBLEMAILIDS')+'</td>
          <td>'+OTHEREMAILID+'</td>
        </tr>' END+
        CASE WHEN ISNULL(OTHERRESPONSIBLEPERSON,'')='' THEN '' ELSE N'<tr>
          <td>'+(SELECT LABELVALUE FROM COMMONTRANSLATIONS WHERE LANGUAGEID=@MODUSERLANGUAGEID AND LABELNAME='LBLOTHERS')+'</td>
          <td>'+OTHERRESPONSIBLEPERSON+'</td>
        </tr>' END+
        CASE WHEN ISNULL(ACTIONPLANNED,'')='' THEN '' ELSE N'<tr>
          <td>'+(SELECT LABELVALUE FROM COMMONTRANSLATIONS WHERE LANGUAGEID=@MODUSERLANGUAGEID AND LABELNAME='LBLCORRECTIVEACTIONPLANNED')+'</td>
          <td>'+ACTIONPLANNED+'</td>
        </tr>' END+
        CASE WHEN ISNULL(ACTIONPERFORMED,'')='' THEN '' ELSE N'<tr>
          <td>'+(SELECT LABELVALUE FROM COMMONTRANSLATIONS WHERE LANGUAGEID=@MODUSERLANGUAGEID AND LABELNAME='LBLCORRECTIVEACTIONPERFORMED')+'</td>
          <td>'+ACTIONPERFORMED+'</td>
        </tr>' END+
        CASE WHEN ISNULL(CARDSTATUS,'')='' THEN '' ELSE N'<tr>
          <td>'+(SELECT LABELVALUE FROM COMMONTRANSLATIONS WHERE LANGUAGEID=@MODUSERLANGUAGEID AND LABELNAME='LBLCARDSTATUS')+'</td>
          <td>'+(SELECT TOP 1 LABELVALUE FROM [DBO].[COMMONTRANSLATIONS] WHERE LANGUAGEID=@MODUSERLANGUAGEID AND LABELNAME=@LBLCARDSTATUS)+'</td>
        </tr>' END+
        CASE WHEN ISNULL(OWNER,'')='' THEN '' ELSE N'<tr>
          <td>'+(SELECT LABELVALUE FROM COMMONTRANSLATIONS WHERE LANGUAGEID=@MODUSERLANGUAGEID AND LABELNAME='LBLACTOWNER')+'</td>
          <td>'+(SELECT LASTNAME +' '+FIRSTNAME FROM USERS WHERE USERID=OWNER)+'</td>
        </tr>' END+
        CASE WHEN ISNULL(CATEGORYLIST,'')='' THEN '' ELSE N'<tr>
          <td>'+(SELECT LABELVALUE FROM COMMONTRANSLATIONS WHERE LANGUAGEID=@MODUSERLANGUAGEID AND LABELNAME='LBLCATEGORIESCORRACTASSIGNMENT')+'</td>
          <td>'+@CATEGORYLISTNAMES+'</td>
        </tr>' END+
        '
      </table>' FROM CORRECTIVEACTIONSMI WHERE  ID=@MODID)
		FROM #CAMODITEMS C
		WHERE USERID=@MODUSERID
		SELECT @MODUSERID= MIN (USERID) FROM #CAMODITEMS WHERE USERID>@MODUSERID

		DELETE FROM @CACATLIST
		END

		UPDATE MS SET BODYTEXT=U.LASTNAME+'|'+U.FIRSTNAME+'|'+@LBLAREANAME+'|'+ISNULL(@LBLSUBAREANAME,'')+'|'+@LBLCORRECTIVEACTIONPLANNED+'|'+CONVERT(VARCHAR(32),@LBLRESPONSEREQUIREDDATE,ISNULL(UI.DATEFORMAT,@DEFAULTDATEFORMAT))+'|'+(SELECT TOP 1 LABELVALUE FROM [DBO].[COMMONTRANSLATIONS] WHERE LANGUAGEID=UI.LANGUAGEID AND LABELNAME=@LBLPRIORITY)+'|'+@LBLSTATUS+'|'+ISNULL(@LBLOWNER,'')+'|'+@LBLCORRECTIVEACTIONPERFORMED+'|'+CASE WHEN @LBLRESPONDEDDATE IS NULL THEN '-' ELSE CONVERT(VARCHAR(32),@LBLRESPONDEDDATE,UI.DATEFORMAT) END+'|'
		FROM #MAILSCHEDULE MS
		INNER JOIN USERS U ON U.USERID =MS.ACTIONOWNER
		INNER JOIN USERINFO UI ON UI.USERID = U.USERID


		IF ISNULL(@OTHERRESPONSIBLEPERSON,'')!=''
		BEGIN

		INSERT INTO #MAILSCHEDULERP(SCHEDULEID,OTHERRESPONSIBLEPERSON,OTHEREMAILID)
		SELECT DISTINCT CASE WHEN SA.SCHEDULEID IS NULL THEN S.SCHEDULEID ELSE SA.SCHEDULEID  END [SCHEDULEID],@OTHERRESPONSIBLEPERSON,@OTHEREMAILID FROM SCHEDULE S
		INNER JOIN #MAILSCHEDULE S1 ON S1.SCHEDULEID=S.SCHEDULEID
		LEFT JOIN SCHEDULEASSIGNMENTS SA ON SA.SCHEDULEID=S.SCHEDULEID
		WHERE S.SCHEDULETYPEID=@SCHEDULETYPEID AND S.STATUS=1
		UPDATE #MAILSCHEDULERP SET ACTIONOWNER=@ACTIONOWNER
		UPDATE #MAILSCHEDULERP SET BODYTEXT='|'+@OTHERRESPONSIBLEPERSON+'|'+@LBLAREANAME+'|'+ISNULL(@LBLSUBAREANAME,'')+'|'+@LBLCORRECTIVEACTIONPLANNED+'|'+CONVERT(VARCHAR(32),@LBLRESPONSEREQUIREDDATE,@DEFAULTDATEFORMAT)+'|'+(SELECT TOP 1 LABELVALUE FROM [DBO].[COMMONTRANSLATIONS] WHERE LANGUAGEID=@DEFAULTLANGUAGEID AND LABELNAME=@LBLPRIORITY)+'|'+@LBLSTATUS+'|'+ISNULL(@LBLOWNER,'')+'|'+@LBLCORRECTIVEACTIONPERFORMED+'|'+CASE WHEN @LBLRESPONDEDDATE IS NULL THEN '-' ELSE CONVERT(VARCHAR(32),@LBLRESPONDEDDATE,@DEFAULTDATEFORMAT) END+'|'

		END

		DECLARE @SLIST TABLE(SCHEDULEID INT)
		INSERT INTO @SLIST
		SELECT DISTINCT SCHEDULEID FROM #MAILSCHEDULE

		DECLARE @MINSCHEDULEID INT,@CCLIST NVARCHAR(MAX)
		SET @CCLIST =''
		SELECT @MINSCHEDULEID=MIN(SCHEDULEID) FROM @SLIST
		WHILE  @MINSCHEDULEID<=(SELECT MAX(SCHEDULEID) FROM @SLIST)
      BEGIN

      SELECT @CCLIST=@CCLIST+EMAIL+'; ' FROM USERS U
      INNER JOIN #MAILSCHEDULE MS ON MS.SCHEDULEID=@MINSCHEDULEID AND MS.USERID=U.USERID

      IF LEN(@CCLIST)>2
      SET @CCLIST=SUBSTRING(@CCLIST,1,LEN(@CCLIST)-1)

      UPDATE #MAILSCHEDULE SET CCLIST=@CCLIST WHERE SCHEDULEID=@MINSCHEDULEID

      SELECT @MINSCHEDULEID=MIN(SCHEDULEID) FROM #MAILSCHEDULE WHERE SCHEDULEID>@MINSCHEDULEID
      SET @CCLIST=''
      END

      SELECT DISTINCT ST.SCHEDULEID,S.COMPANYID,ST.ACTIONOWNER USERID, @FROM [FROM],S.REPLYTO [REPLYTO],U.EMAIL [TO],ISNULL(S.CC,'')+CASE WHEN LEN(ISNULL(S.CC,''))>1 THEN '; ' ELSE '' END+ST.CCLIST+CASE WHEN LEN(ISNULL(@OTHEREMAILID,''))>1 THEN '; ' ELSE '' END+@OTHEREMAILID CC,'' BCC,SUBJECT,DBO.REGEXREPLACE(S.BODY,'02|03|07|50|25|26|27|28|29|31|32|36|37|38|39|40|06|41|42|43|44',ST.BODYTEXT+ISNULL(@LBLMAINCATEGORYNAME,'')+'|'+ISNULL(@LBLSUBCATNAME,'')+'|'+CONVERT(VARCHAR(32),@LBLOBSDATE,UI.DATEFORMAT)+'|'+(SELECT TOP 1 LABELVALUE FROM [DBO].[COMMONTRANSLATIONS] WHERE LANGUAGEID=UI.LANGUAGEID AND LABELNAME=@LBLCARDSTATUS)+'|'+@LBLCASUBJECT+'|'+@SITENAME+'|'+@LBLCHECKLISTNO+'|'+@LBLCAUPDATEDBY+'|'+ISNULL(C.CAMODIFIED,'')+'|'+@LBLCARESPONSIBLEPERSONS) [BODY],GETUTCDATE() SENTDATE ,0 READSTATUS,@URL URL
      FROM #MAILSCHEDULE ST
      INNER JOIN SCHEDULE S ON S.SCHEDULEID=ST.SCHEDULEID
      INNER JOIN USERS U ON U.USERID =ST.ACTIONOWNER
      INNER JOIN USERINFO UI ON UI.USERID =U.USERID
      LEFT JOIN #CAMODITEMS C ON 1=1
      --UNION ALL
      --SELECT DISTINCT ST.SCHEDULEID,S.COMPANYID,ST.ACTIONOWNER,@FROM [FROM],S.REPLYTO [REPLYTO],@ACTIONOWNERMAILID [TO],ISNULL(S.CC,'')+CASE WHEN LEN(ISNULL(S.CC,''))>1 THEN '; ' ELSE '' END+ST.OTHEREMAILID CC,'' BCC,SUBJECT,DBO.REGEXREPLACE(S.BODY,'02|03|07|25|26|27|28|29|31|32|36|37|38|39|40|06|41|42|43|44',ST.BODYTEXT+ISNULL(@LBLMAINCATEGORYNAME,'')+'|'+ISNULL(@LBLSUBCATNAME,'')+'|'+CONVERT(VARCHAR(32),@LBLOBSDATE,@DEFAULTDATEFORMAT)+'|'+@LBLCARDSTATUS+'|'+@LBLCASUBJECT+'|'+@SITENAME+'|'+@LBLCHECKLISTNO+'|'+@LBLCAUPDATEDBY+'|'+@LBLCAMODIFIEDLIST+'|'+@LBLCARESPONSIBLEPERSONS) [BODY],GETUTCDATE() SENTDATE ,0 READSTATUS,@URL URL
      --FROM #MAILSCHEDULERP ST
      --INNER JOIN SCHEDULE S ON S.SCHEDULEID=ST.SCHEDULEID

      CREATE TABLE #USERINBOX(
      [COMPANYID] [bigint],
      [USERID] [bigint],
      [FROM] [nvarchar](512),
      [REPLYTO] [nvarchar](512),
      [TO] [nvarchar](512),
      [CC] [nvarchar](512),
      [BCC] [nvarchar](512),
      [SUBJECT] [nvarchar](2048),
      [BODY] [nvarchar](max),
      [SENTDATE] [datetime],
      [READSTATUS] [tinyint],
      [TYPE] [tinyint],
      [STATUS] [tinyint],
      [TOKENID] [bigint]
      )

      INSERT INTO #USERINBOX(COMPANYID,USERID,[FROM],REPLYTO,[TO],CC,BCC,[SUBJECT],BODY,SENTDATE,READSTATUS,[TYPE],[STATUS],TOKENID)
      SELECT DISTINCT S.COMPANYID,ST.ACTIONOWNER,@FROM [FROM],S.REPLYTO [REPLYTO],U.EMAIL [TO],ISNULL(S.CC,'')+CASE WHEN LEN(ISNULL(S.CC,''))>1 THEN '; ' ELSE '' END+ST.CCLIST+CASE WHEN LEN(ISNULL(@OTHEREMAILID,''))>1 THEN '; ' ELSE '' END+@OTHEREMAILID CC,'' BCC,SUBJECT,DBO.REGEXREPLACE(S.BODY,'02|03|07|50|25|26|27|28|29|31|32|36|37|38|39|40|06|41|42|43|44',ST.BODYTEXT+ISNULL(@LBLMAINCATEGORYNAME,'')+'|'+ISNULL(@LBLSUBCATNAME,'')+'|'+CONVERT(VARCHAR(32),@LBLOBSDATE,UI.DATEFORMAT)+'|'+(SELECT TOP 1 LABELVALUE FROM [DBO].[COMMONTRANSLATIONS] WHERE LANGUAGEID=UI.LANGUAGEID AND LABELNAME=@LBLCARDSTATUS)+'|'+@LBLCASUBJECT+'|'+@SITENAME+'|'+@LBLCHECKLISTNO+'|'+@LBLCAUPDATEDBY+'|'+ISNULL(C.CAMODIFIED,'')+'|'+@LBLCARESPONSIBLEPERSONS) [BODY],GETUTCDATE() SENTDATE ,0 READSTATUS,1,1,S.SCHEDULEID
      FROM #MAILSCHEDULE ST
      INNER JOIN SCHEDULE S ON S.SCHEDULEID=ST.SCHEDULEID
      INNER JOIN USERS U ON U.USERID =ST.ACTIONOWNER
      INNER JOIN USERINFO UI ON UI.USERID=U.USERID
      LEFT JOIN #CAMODITEMS C ON C.USERID=ST.ACTIONOWNER
      INSERT INTO USERINBOX(COMPANYID,USERID,[FROM],REPLYTO,[TO],CC,BCC,[SUBJECT],BODY,SENTDATE,READSTATUS,[TYPE],[STATUS],TOKENID,CORRACTIONID)
      SELECT COMPANYID,USERID,[FROM],REPLYTO,[TO],CC,BCC,[SUBJECT],BODY,SENTDATE,READSTATUS,[TYPE],[STATUS],TOKENID,@CORRACTIONID FROM #USERINBOX
      UNION
      SELECT DISTINCT COMPANYID,MS.USERID,[FROM],REPLYTO,[TO],CC,BCC,[SUBJECT],BODY,SENTDATE,READSTATUS,[TYPE],[STATUS],TOKENID,@CORRACTIONID FROM #USERINBOX U
      FULL OUTER JOIN #MAILSCHEDULE MS ON 1=1

      SELECT @SCHEDULETYPEID SCHEDULETYPEID

      DROP TABLE #SCHEDULETEMP
      DROP TABLE #CORRECTIVEACTIONUSER
      DROP TABLE #FINALSCHEDULE
      DROP TABLE #MAILSCHEDULE
      DROP TABLE #MAILSCHEDULERP
      DROP TABLE #USERINBOX
      DROP TABLE #CAMODITEMS
    
	