--UPDATECORRACTIVEACTION_1.0
DECLARE @CC_TIMESTAMP DATETIME
SET @CC_TIMESTAMP=GETDATE()

DECLARE @INPUTCUSTOMFIELDS TABLE(CUSTOMFIELDID INT,CUSTOMFIELDVALUEID INT)
INSERT INTO @INPUTCUSTOMFIELDS
SELECT CUSTOMFIELDID,CUSTOMFIELDVALUEID FROM CUSTOMFIELDVALUES CFV
INNER JOIN dbo.CSVTOTABLE(@CUSTOMFIELDVALUEID) T ON T.RESULT=CFV.CUSTOMFIELDVALUEID

DECLARE @QRY VARCHAR(MAX),@GROUPTYPEID VARCHAR(256), @GROUPTYPENAME VARCHAR(1024),@GROUPTYPENAME1 VARCHAR(1024)


UPDATE [STOPCARDENTRY]
SET [OBSERVATIONDATE] = @OBSERVATIONDATE
,[SHIFTID] = @SHIFTID
,[AREAID] = @AREAID
,[SUBAREAID] = @SUBAREAID
,OBSERVERCOUNT = CASE WHEN (SELECT COUNT(RESULT) FROM DBO.CSVTOTABLE(@SELOBSERVERID))>1 THEN 1 ELSE 0 END
,[UPDATEDBY] = @UPDATEDBY
,[UPDATEDDATE] = @CC_TIMESTAMP
,ISMODIFIED=1
WHERE CARDID = @CARDID



SET @QRY=''
SET @GROUPTYPEID=''
SET @GROUPTYPENAME=''
SET @GROUPTYPENAME1=''
SELECT @GROUPTYPEID=@GROUPTYPEID+'['+CAST(GROUPTYPEID AS VARCHAR(10))+'],' FROM GROUPTYPES WHERE STATUS = 1
SELECT @GROUPTYPENAME=@GROUPTYPENAME+',['+CAST(GROUPTYPEID AS VARCHAR(10))+'] AS GROUP'+CAST(GROUPTYPEID AS VARCHAR(10))+',(SELECT TOP 1 GROUPNAME FROM GROUPS G WHERE G.GROUPID = +['+CAST(GROUPTYPEID AS VARCHAR(10))+']) AS GROUP'+CAST(GROUPTYPEID AS VARCHAR(10))+'NAME' FROM GROUPTYPES WHERE STATUS = 1
SELECT @GROUPTYPENAME1=@GROUPTYPENAME1+',GROUP'+CAST(GROUPTYPEID AS VARCHAR(10))+',GROUP'+CAST(GROUPTYPEID AS VARCHAR(10))+'NAME' FROM GROUPTYPES WHERE STATUS = 1


IF LEN(@GROUPTYPEID)>0
SET @GROUPTYPEID=SUBSTRING(@GROUPTYPEID,1,LEN(@GROUPTYPEID)-1)
DELETE FROM STOPCARDENTRYOBSERVERS WHERE CARDID = @CARDID

IF LEN(@GROUPTYPEID)>1
BEGIN
SET @QRY= ('
INSERT INTO STOPCARDENTRYOBSERVERS(CARDID,OBSERVERID'+@GROUPTYPENAME1+')
SELECT DISTINCT '+CAST(@CARDID AS VARCHAR(10))+',USERID'+@GROUPTYPENAME+' FROM

(SELECT UG.USERID,UG.GROUPTYPEID,UG.GROUPID FROM USERGROUPS UG WHERE UG.STATUS = 1 AND UG.USERID IN ('+@SELOBSERVERID+')
) AS TABTOPIOT
PIVOT
(
MAX(GROUPID)
FOR GROUPTYPEID IN ('+@GROUPTYPEID+')
)AS PIVOTEDTAB   ')



EXEC (@QRY)
UPDATE STOPCARDENTRYOBSERVERS SET UPDATEDBY=@UPDATEDBY,UPDATEDDATE=@CC_TIMESTAMP WHERE CARDID=@CARDID
END
ELSE
BEGIN
INSERT INTO STOPCARDENTRYOBSERVERS(CARDID,OBSERVERID,UPDATEDBY,UPDATEDDATE)
SELECT DISTINCT @CARDID,RESULT,@UPDATEDBY,@CC_TIMESTAMP FROM DBO.CSVTOTABLE(@SELOBSERVERID)

END


INSERT INTO STOPCARDENTRYOBSERVERS(CARDID,OBSERVERID,UPDATEDBY,UPDATEDDATE)
SELECT @CARDID,RESULT,@UPDATEDBY,@CC_TIMESTAMP FROM DBO.CSVTOTABLE(@SELOBSERVERID) WHERE RESULT NOT IN (SELECT OBSERVERID FROM STOPCARDENTRYOBSERVERS WHERE CARDID=@CARDID)

DELETE FROM STOPCARDENTRYCUSTOMFIELDS WHERE CARDID=@CARDID
IF EXISTS(SELECT 1 FROM @INPUTCUSTOMFIELDS)
INSERT INTO STOPCARDENTRYCUSTOMFIELDS(CARDID,CUSTOMFIELD1,CUSTOMFIELD2,CUSTOMFIELD3,STATUS,UPDATEDBY,UPDATEDDATE)
SELECT @CARDID,(SELECT CUSTOMFIELDVALUEID FROM @INPUTCUSTOMFIELDS WHERE CUSTOMFIELDID=1)
,(SELECT CUSTOMFIELDVALUEID FROM @INPUTCUSTOMFIELDS WHERE CUSTOMFIELDID=2)
,(SELECT CUSTOMFIELDVALUEID FROM @INPUTCUSTOMFIELDS WHERE CUSTOMFIELDID=3)
,1,@UPDATEDBY,@CC_TIMESTAMP

SELECT @CARDID


INSERT INTO dbo.AUDIT(TABLENAME,TRANS,STAMP,LASTUPDATEDBY,DATA)
SELECT 'STOPCARDENTRY','UPDATE-UPDATECORRACTIVEACTION_1.0',@CC_TIMESTAMP,@UPDATEDBY,
(SELECT * FROM STOPCARDENTRY WHERE CARDID=@CARDID AND UPDATEDBY=@UPDATEDBY AND UPDATEDDATE=@CC_TIMESTAMP FOR XML AUTO)

INSERT INTO dbo.AUDIT(TABLENAME,TRANS,STAMP,LASTUPDATEDBY,DATA)
SELECT 'STOPCARDENTRYOBSERVERS','UPDATE-UPDATECORRACTIVEACTION_1.0',@CC_TIMESTAMP,@UPDATEDBY,
(SELECT * FROM STOPCARDENTRYOBSERVERS WHERE CARDID=@CARDID AND UPDATEDBY=@UPDATEDBY AND UPDATEDDATE=@CC_TIMESTAMP FOR XML AUTO)
