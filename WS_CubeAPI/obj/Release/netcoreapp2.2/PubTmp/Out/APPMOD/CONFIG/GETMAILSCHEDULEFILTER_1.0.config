DECLARE @REPORTFILTEROPTIONS TABLE(OPTIONID INT,OPTIONNAME NVARCHAR(256),QUERY VARCHAR(256),REPORTPARAM VARCHAR(256),
FILTERPARAM VARCHAR(MAX),FILTERPARAMMAP VARCHAR(MAX),OPTIONSCATEGORYID INT)

DECLARE @SCHEDULEFILTERS TABLE(ID INT,OPTIONID INT,REPORTPARAM VARCHAR(256),VAL VARCHAR(MAX))
DECLARE @RESULT VARCHAR(MAX)
SET @RESULT =''


INSERT INTO @REPORTFILTEROPTIONS
SELECT DISTINCT M.OPTIONID,CASE WHEN M.RELATIONID>0 THEN (SELECT TOP 1 ENTITYVALUE FROM ENTITYTRANSLATION WHERE LANGUAGEID=@LANGUAGEID AND ENTITYTYPE='GRP_TYPE' AND ENTITYID=M.RELATIONID) ELSE M.OPTIONNAME END OPTIONNAME,M.WACCESS QUERY,M.REPORTPARAM,M.FILTERPARAM,M.FILTERPARAMMAP,M.OPTIONSCATEGORYID
FROM REPORTOPTIONSMASTER M
WHERE M.STATUS=1 AND OPTIONSCATEGORYID=2
UNION ALL
SELECT DISTINCT M.OPTIONID,CASE WHEN M.RELATIONID>0 THEN (SELECT TOP 1 ENTITYVALUE FROM ENTITYTRANSLATION WHERE LANGUAGEID=@LANGUAGEID AND ENTITYTYPE='GRP_TYPE' AND ENTITYID=M.RELATIONID) ELSE M.OPTIONNAME END OPTIONNAME,M.WACCESS QUERY,M.REPORTPARAM,M.FILTERPARAM,M.FILTERPARAMMAP,M.OPTIONSCATEGORYID
FROM REPORTOPTIONSMASTER M
WHERE M.STATUS=1 AND M.OPTIONID IN(1)
UNION ALL
SELECT DISTINCT M.OPTIONID,CASE WHEN M.RELATIONID>0 THEN (SELECT TOP 1 ENTITYVALUE FROM ENTITYTRANSLATION WHERE LANGUAGEID=@LANGUAGEID AND ENTITYTYPE='GRP_TYPE' AND ENTITYID=M.RELATIONID) ELSE M.OPTIONNAME END OPTIONNAME,M.WACCESS QUERY,M.REPORTPARAM,M.FILTERPARAM,M.FILTERPARAMMAP,M.OPTIONSCATEGORYID
FROM REPORTOPTIONSMASTER M
WHERE M.STATUS=1 AND M.OPTIONID IN(17) AND @SCHEDULETYPEID IN('1','2','3','4')


SELECT * FROM @REPORTFILTEROPTIONS ORDER BY OPTIONID
IF @SCHEDULETYPEID IN (1,2,3,4)
SELECT OPTIONSCATEGORYID,CATEGORYNAME FROM REPORTOPTIONSCATEGORY
WHERE OPTIONSCATEGORYID IN (1,2,5)
ELSE
SELECT OPTIONSCATEGORYID,CATEGORYNAME FROM REPORTOPTIONSCATEGORY
WHERE OPTIONSCATEGORYID IN (1,2)

INSERT INTO @SCHEDULEFILTERS
SELECT ROW_NUMBER() OVER(PARTITION BY ROF.REPORTPARAM ORDER BY ROF.REPORTPARAM) ,RF.OPTIONID,ROF.REPORTPARAM+':',CAST(RF.OPTIONVALUE AS VARCHAR(8))+'~~!~~'+ISNULL(S.SITENAME,'')+ISNULL(A.AREANAME,'')+ISNULL(U.LASTNAME+U.FIRSTNAME,'')+ISNULL(SH.SHIFTNAME,'')
+ISNULL(CASE WHEN ROF.OPTIONNAME='Observer Status' THEN (CASE WHEN CAST(RF.OPTIONVALUE AS VARCHAR(8))='1' THEN 'LBLACTIVE' WHEN CAST(RF.OPTIONVALUE AS VARCHAR(8))='0' THEN 'LBLINACTIVE' WHEN CAST(RF.OPTIONVALUE AS VARCHAR(8))='4' THEN 'Locked' END ) ELSE NULL END,'')
+ISNULL(CASE WHEN ROF.OPTIONNAME='Observer With Zero Checklist' THEN (CASE WHEN CAST(RF.OPTIONVALUE AS VARCHAR(8))='1' THEN 'Yes' WHEN CAST(RF.OPTIONVALUE AS VARCHAR(8))='0' THEN 'No' END ) ELSE NULL END ,'')
+ISNULL((SELECT ENTITYVALUE FROM ENTITYTRANSLATION WHERE ENTITYTYPE='UGP_TYPE' AND LANGUAGEID=@LANGUAGEID AND PARENTID=G.GROUPTYPEID AND ENTITYID=G.GROUPID),'')
+ISNULL(CK.SETUPNAME,'')
+ISNULL(M.MAINCATEGORYNAME,'')
+ISNULL(SU.SUBCATEGORYNAME,'')
+ISNULL(R.REDFLAGNAME,'')
+ISNULL(RO.ROLENAME,'')
+ISNULL(CASE WHEN ROF.REPORTPARAM='INCLUDEHISTDATAVALUE' THEN (CASE WHEN CAST(RF.OPTIONVALUE AS VARCHAR(8))='1' THEN 'Yes' WHEN CAST(RF.OPTIONVALUE AS VARCHAR(8))='0' THEN 'No' END ) ELSE NULL END ,'')
+ISNULL(CASE WHEN ROF.REPORTPARAM='INCLUDECHECKLISTVALUE' THEN (CASE WHEN CAST(RF.OPTIONVALUE AS VARCHAR(8))='1' THEN 'Yes' WHEN CAST(RF.OPTIONVALUE AS VARCHAR(8))='0' THEN 'No' END ) ELSE NULL END ,'')
+ISNULL(CASE WHEN ROF.REPORTPARAM='PRIORITYVALUE' THEN (CASE WHEN CAST(RF.OPTIONVALUE AS VARCHAR(8))='1' THEN 'High' WHEN CAST(RF.OPTIONVALUE AS VARCHAR(8))='2' THEN 'Medium' WHEN CAST(RF.OPTIONVALUE AS VARCHAR(8))='3' THEN 'Low' END ) ELSE NULL END ,'')
+ISNULL(CASE WHEN ROF.REPORTPARAM='CARDSTATUSID' THEN (CASE WHEN CAST(RF.OPTIONVALUE AS VARCHAR(8))='1' THEN 'Open' WHEN CAST(RF.OPTIONVALUE AS VARCHAR(8))='2' THEN 'Completed' WHEN CAST(RF.OPTIONVALUE AS VARCHAR(8))='3' THEN 'Alternate action' END ) ELSE NULL END ,'')
+ISNULL(CASE WHEN ROF.REPORTPARAM='METRICSVALUE' THEN (CASE WHEN CAST(RF.OPTIONVALUE AS VARCHAR(8))='1' THEN 'Safe' WHEN CAST(RF.OPTIONVALUE AS VARCHAR(8))='0' THEN 'Unsafe' END ) ELSE NULL END ,'')
+ISNULL(CASE WHEN ROF.REPORTPARAM='SETUPTYPE' THEN (CASE WHEN CAST(RF.OPTIONVALUE AS VARCHAR(8))='1' THEN 'Maincategories' WHEN CAST(RF.OPTIONVALUE AS VARCHAR(8))='0' THEN 'Line Items' END ) ELSE NULL END ,'')
+ISNULL(CASE WHEN ROF.REPORTPARAM='TRIGGER' THEN (CASE WHEN CAST(RF.OPTIONVALUE AS VARCHAR(8))='1' THEN 'Greater #' WHEN CAST(RF.OPTIONVALUE AS VARCHAR(8))='2' THEN 'Lesser #' WHEN CAST(RF.OPTIONVALUE AS VARCHAR(8))='3' THEN 'Greater %' WHEN CAST(RF.OPTIONVALUE AS VARCHAR(8))='4' THEN 'Lesser %' END ) ELSE NULL END ,'')
+ISNULL(CASE WHEN ROF.REPORTPARAM='USERTYPE' THEN (CASE WHEN CAST(RF.OPTIONVALUE AS VARCHAR(8))='2' THEN 'User and Observer' WHEN CAST(RF.OPTIONVALUE AS VARCHAR(8))='1' THEN 'Observer' WHEN CAST(RF.OPTIONVALUE AS VARCHAR(8))='0' THEN 'User' END ) ELSE NULL END ,'')
FROM SCHEDULEASSIGNMENTS RF
INNER JOIN @REPORTFILTEROPTIONS ROF ON ROF.OPTIONID=RF.OPTIONID
LEFT JOIN SITES S ON S.SITEID=CASE WHEN ROF.OPTIONID=1 THEN CAST(CAST(RF.OPTIONVALUE AS VARCHAR(8)) AS INT) ELSE NULL END
LEFT JOIN AREAS A ON A.AREAID=CASE WHEN ROF.OPTIONID=2 THEN CAST(CAST(RF.OPTIONVALUE AS VARCHAR(8)) AS INT) ELSE NULL END
LEFT JOIN USERS U ON U.USERID=CASE WHEN ROF.OPTIONID=3 THEN CAST(CAST(RF.OPTIONVALUE AS VARCHAR(8)) AS INT) ELSE NULL END
LEFT JOIN SHIFTS SH ON SH.SHIFTID=CASE WHEN ROF.OPTIONID=4 THEN CAST(CAST(RF.OPTIONVALUE AS VARCHAR(8)) AS INT) ELSE NULL END
LEFT JOIN GROUPS G ON G.GROUPID=CASE WHEN ROF.REPORTPARAM LIKE'GROUP%' THEN CAST(CAST(RF.OPTIONVALUE AS VARCHAR(8)) AS INT) ELSE NULL END
LEFT JOIN CHECKLISTSETUP CK ON CK.CHECKLISTSETUPID=CASE WHEN ROF.OPTIONID=5 THEN CAST(CAST(RF.OPTIONVALUE AS VARCHAR(8)) AS INT) ELSE NULL END
LEFT JOIN MAINCATEGORIES M ON M.MAINCATEGORYID=CASE WHEN ROF.OPTIONID=6 THEN CAST(CAST(RF.OPTIONVALUE AS VARCHAR(8)) AS INT) ELSE NULL END
LEFT JOIN SUBCATEGORIES SU ON SU.SUBCATEGORYID=CASE WHEN ROF.OPTIONID=7 THEN CAST(CAST(RF.OPTIONVALUE AS VARCHAR(8)) AS INT) ELSE NULL END
LEFT JOIN REDFLAGS R ON R.REDFLAGID=CASE WHEN ROF.OPTIONID=9 THEN CAST(CAST(RF.OPTIONVALUE AS VARCHAR(8)) AS INT) ELSE NULL END
LEFT JOIN ROLES RO ON RO.ROLEID=CASE WHEN ROF.OPTIONID=17 THEN CAST(CAST(RF.OPTIONVALUE AS VARCHAR(8)) AS INT) ELSE NULL END
WHERE RF.SCHEDULEID=@SCHEDULEID

UPDATE @SCHEDULEFILTERS SET VAL=REPLACE(VAL,',','^^^')

UPDATE @SCHEDULEFILTERS SET REPORTPARAM='' WHERE ID>1
SELECT @RESULT=@RESULT+CASE WHEN REPORTPARAM ='' THEN REPORTPARAM ELSE '*'+REPORTPARAM END+VAL+'*~*' FROM @SCHEDULEFILTERS ORDER BY OPTIONID

IF LEN(@RESULT)>0
SELECT REPLACE(CASE WHEN SUBSTRING(ITEM,LEN(ITEM)-1,2)='*~' THEN SUBSTRING(ITEM,1,LEN(ITEM)-2) ELSE ITEM END,'^^^',',') RESULT FROM DBO.FNSPLIT(REPLACE(SUBSTRING(@RESULT,2,LEN(@RESULT)-4),'**',','),',')
ELSE
SELECT RESULT FROM
(SELECT 1 RESULT) A WHERE RESULT <>1
