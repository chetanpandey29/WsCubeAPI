DECLARE @USERGROUPS TABLE(GROUPTYPEID INT,GROUPID INT)
DECLARE @USERLIST TABLE(USERID INT,GROUPTYPEID INT)
DECLARE @QRY VARCHAR(MAX),@DEFAULTSITEID INT
SELECT @DEFAULTSITEID=DEFAULTSITEID FROM USERINFO WHERE USERID =@USERID
CREATE TABLE #FINALGRPUSERS(USERID INT)
DECLARE @GROUPID NVARCHAR(MAX)

IF ISNULL(@GROUP1,'')<> '' OR ISNULL(@GROUP2,'')<> '' OR ISNULL(@GROUP3,'')<> '' OR ISNULL(@GROUP4,'')<> '' OR ISNULL(@GROUP5,'')<> ''
OR ISNULL(@GROUP6,'')<> '' OR ISNULL(@GROUP7,'')<> '' OR ISNULL(@GROUP8,'')<> '' OR ISNULL(@GROUP9,'')<> '' OR ISNULL(@GROUP10,'')<> ''
BEGIN

SET @GROUPID =''
SET @GROUPID = CASE WHEN ISNULL(@GROUP1,'')='' THEN '' ELSE @GROUP1+',' END +
CASE WHEN ISNULL(@GROUP2,'')='' THEN '' ELSE @GROUP2+',' END +
CASE WHEN ISNULL(@GROUP3,'')='' THEN '' ELSE @GROUP3+',' END +
CASE WHEN ISNULL(@GROUP4,'')='' THEN '' ELSE @GROUP4+',' END +
CASE WHEN ISNULL(@GROUP5,'')='' THEN '' ELSE @GROUP5+',' END +
CASE WHEN ISNULL(@GROUP6,'')='' THEN '' ELSE @GROUP6+',' END +
CASE WHEN ISNULL(@GROUP7,'')='' THEN '' ELSE @GROUP7+',' END +
CASE WHEN ISNULL(@GROUP8,'')='' THEN '' ELSE @GROUP8+',' END +
CASE WHEN ISNULL(@GROUP9,'')='' THEN '' ELSE @GROUP9+',' END +
CASE WHEN ISNULL(@GROUP10,'')='' THEN '' ELSE @GROUP10+',' END

INSERT INTO @USERGROUPS
SELECT GG.GROUPTYPEID,RESULT AS GROUPID FROM DBO.CSVTOTABLE(@GROUPID) G
INNER JOIN GROUPS GG ON GG.GROUPID = G.RESULT

INSERT INTO @USERLIST(USERID,GROUPTYPEID)
SELECT UG.USERID,UG.GROUPTYPEID
FROM USERGROUPS UG
INNER JOIN @USERGROUPS UG1 ON UG1.GROUPTYPEID=UG.GROUPTYPEID AND UG.GROUPID=UG1.GROUPID
WHERE UG.STATUS =1

INSERT INTO #FINALGRPUSERS
SELECT USERID FROM @USERLIST GROUP BY USERID HAVING COUNT(DISTINCT GROUPTYPEID)=(SELECT COUNT(DISTINCT GROUPTYPEID) FROM @USERGROUPS)

END


SET @QRY=''
SET @QRY=


'SELECT DISTINCT U.USERID,U.USERNAME,U.LASTNAME,U.FIRSTNAME,U.EMAIL,
CASE WHEN U.[STATUS]=1 OR U.STATUS=3 THEN ''LBLACTIVE'' WHEN U.[STATUS] = 0 THEN ''LBLINACTIVE'' WHEN U.[STATUS] = 4 THEN ''LOCKED'' END AS [STATUS]
FROM USERS U
INNER JOIN USERINFO UI ON UI.USERID=U.USERID '
+ CASE WHEN ISNULL(@SITEID,'')='' AND EXISTS (SELECT 1 FROM ROLES WHERE ROLEID=@DEFAULTROLEID AND ALLSITES=1) THEN ''
WHEN ISNULL(@SITEID,'')='' AND NOT EXISTS (SELECT 1 FROM ROLES WHERE ROLEID=@DEFAULTROLEID AND ALLSITES=1)
THEN ' INNER JOIN USERSITES US ON US.USERID = '+ CAST(@USERID AS VARCHAR(8))+' AND US.STATUS = 1 '
+' INNER JOIN USERSITES US1 ON US1.SITEID=US.SITEID AND U.USERID=US1.USERID AND US1.STATUS =1 '

WHEN ISNULL(@SITEID,'')!='' THEN ' INNER JOIN USERSITES US ON US.USERID = U.USERID
INNER JOIN DBO.CSVTOTABLE('''+@SITEID+''') T ON T.RESULT=US.SITEID ' END

+ CASE WHEN (ISNULL(@GROUP1,'')<> '' OR ISNULL(@GROUP2,'')<> '' OR ISNULL(@GROUP3,'')<> '' OR ISNULL(@GROUP4,'')<> '' OR ISNULL(@GROUP5,'')<> ''
OR ISNULL(@GROUP6,'')<> '' OR ISNULL(@GROUP7,'')<> '' OR ISNULL(@GROUP8,'')<> '' OR ISNULL(@GROUP9,'')<> '' OR ISNULL(@GROUP10,'')<> '')
THEN '  INNER JOIN #FINALGRPUSERS UGS ON UGS.USERID=U.USERID  ' ELSE '' END

+' WHERE U.USERID != ' + CAST(@USERID AS VARCHAR(8))
+ CASE WHEN ISNULL(@USERTYPE,'') = '' THEN '' ELSE
' AND UI.USERTYPEID IN ('+@USERTYPE+')' END
+ CASE WHEN ISNULL(@ROLEID,'') = '' THEN '' ELSE
' AND UI.DEFAULTROLEID IN ('+@ROLEID+')' END
+CASE WHEN ISNULL(@STATUSID,'')='' THEN ' AND U.STATUS NOT IN (2,3) ' ELSE ' AND U.STATUS IN('+CASE WHEN CHARINDEX('1',@STATUSID)>0 THEN @STATUSID+',3)' ELSE @STATUSID+')' END END
+ CASE WHEN ISNULL(@SITEID,'')='' AND EXISTS (SELECT 1 FROM ROLES WHERE ROLEID=@DEFAULTROLEID AND ALLSITES=1) THEN ''
WHEN ISNULL(@SITEID,'')='' AND NOT EXISTS (SELECT 1 FROM ROLES WHERE ROLEID=@DEFAULTROLEID AND ALLSITES=1)
THEN ' AND US.STATUS=1  '
WHEN ISNULL(@SITEID,'')!='' THEN ' AND US.STATUS = 1' END
+ ' ORDER BY LASTNAME,FIRSTNAME '

EXEC(@QRY)

DROP TABLE #FINALGRPUSERS

