DECLARE @IMAGENAME NVARCHAR(MAX)
DECLARE @COMPANYID NVARCHAR(8),@IMAGEPATH NVARCHAR(1024),@OLDCARDID INT
SET @COMPANYID=''
SET @IMAGEPATH=''
SELECT @COMPANYID=CAST(COMPANYID AS NVARCHAR(8)) FROM COMPANY

IF @OBSAPPROVALPC=0
BEGIN

IF EXISTS(SELECT 1 FROM STOPCARDENTRYATTACHMENTS WHERE CARDID = @CARDID AND  MAINCATEGORYID=@MAINCATEGORYID AND SUBCATEGORYID =@SUBCATEGORYID)
BEGIN
	SELECT @OLDCARDID =OLDCARDID FROM STOPCARDENTRYATTACHMENTS WHERE CARDID=@CARDID AND MAINCATEGORYID=@MAINCATEGORYID AND SUBCATEGORYID=@SUBCATEGORYID
	IF @OLDCARDID IS NULL 
		SELECT @IMAGEPATH=@COMPANYID+'/'+CAST(CARDID AS NVARCHAR(8))+'/'+CAST(MAINCATEGORYID AS NVARCHAR(8))+CASE WHEN SUBCATEGORYID>0 THEN '/'+CAST(SUBCATEGORYID AS NVARCHAR(8)) ELSE '' END +'/'+IMAGENAME 
		FROM STOPCARDENTRYATTACHMENTS WHERE CARDID=@CARDID AND MAINCATEGORYID=@MAINCATEGORYID AND SUBCATEGORYID=@SUBCATEGORYID
	ELSE
		SELECT @IMAGEPATH=@COMPANYID+'/OL/'+CAST(@OLDCARDID AS NVARCHAR(8))+'/'+CAST(MAINCATEGORYID AS NVARCHAR(8))+CASE WHEN SUBCATEGORYID>0 THEN '/'+CAST(SUBCATEGORYID AS NVARCHAR(8)) ELSE '' END +'/'+IMAGENAME 
		FROM STOPCARDENTRYATTACHMENTS WHERE CARDID=@CARDID AND MAINCATEGORYID=@MAINCATEGORYID AND SUBCATEGORYID=@SUBCATEGORYID
END
ELSE
	SELECT @IMAGEPATH='' 
	
IF EXISTS (SELECT 1 FROM [STOPCARDENTRYCATEGORYCOMMENTS] WHERE CARDID = @CARDID AND  MAINCATEGORYID=@MAINCATEGORYID AND SUBCATEGORYID =@SUBCATEGORYID)
SELECT (SELECT ENTITYVALUE FROM ENTITYTRANSLATION WHERE ENTITYID=@MAINCATEGORYID AND ENTITYTYPE='MAIN_CTG' AND LANGUAGEID=@LANGUAGEID) MAINCATEGORYNAME,
(SELECT ENTITYVALUE FROM ENTITYTRANSLATION WHERE PARENTID=@MAINCATEGORYID AND ENTITYID = @SUBCATEGORYID AND ENTITYTYPE='SUB_CTG' AND LANGUAGEID=@LANGUAGEID) SUBCATEGORYNAME,
[SAFECOMMENTS]
,[UNSAFECOMMENTS]
,@IMAGEPATH IMAGEPATH
FROM [STOPCARDENTRYCATEGORYCOMMENTS]SC
INNER JOIN MAINCATEGORIES M
ON SC.MAINCATEGORYID = M.MAINCATEGORYID
LEFT JOIN SUBCATEGORIES S
ON SC.SUBCATEGORYID = S.SUBCATEGORYID
WHERE CARDID = @CARDID
AND SC.MAINCATEGORYID=@MAINCATEGORYID
AND SC.SUBCATEGORYID=@SUBCATEGORYID
ELSE
SELECT (SELECT ENTITYVALUE FROM ENTITYTRANSLATION WHERE ENTITYID=@MAINCATEGORYID AND ENTITYTYPE='MAIN_CTG' AND LANGUAGEID=@LANGUAGEID) MAINCATEGORYNAME,
(SELECT ENTITYVALUE FROM ENTITYTRANSLATION WHERE PARENTID=@MAINCATEGORYID AND ENTITYID = @SUBCATEGORYID AND ENTITYTYPE='SUB_CTG' AND LANGUAGEID=@LANGUAGEID) SUBCATEGORYNAME,
'' SAFECOMMENTS,'' UNSAFECOMMENTS,@IMAGEPATH IMAGEPATH


SET @IMAGENAME = ''
SELECT @IMAGENAME=@IMAGENAME+IMAGENAME+' , ' FROM dbo.STOPCARDENTRYATTACHMENTS
WHERE CARDID=@CARDID AND MAINCATEGORYID=@MAINCATEGORYID AND SUBCATEGORYID =@SUBCATEGORYID

SELECT CASE WHEN @IMAGENAME ='' THEN '' ELSE SUBSTRING(@IMAGENAME,1,LEN(@IMAGENAME)-2) END IMAGENAME

END
ELSE IF @OBSAPPROVALPC=1
BEGIN


IF EXISTS(SELECT 1 FROM STOPCARDENTRYATTACHMENTS_OL WHERE CARDID = @CARDID AND  MAINCATEGORYID=@MAINCATEGORYID AND SUBCATEGORYID =@SUBCATEGORYID)
	SELECT @IMAGEPATH=@COMPANYID+'/OL/'+CAST(CARDID AS NVARCHAR(8))+'/'+CAST(MAINCATEGORYID AS NVARCHAR(8))+CASE WHEN SUBCATEGORYID>0 THEN '/'+CAST(SUBCATEGORYID AS NVARCHAR(8)) ELSE '' END +'/'+IMAGENAME 
	FROM STOPCARDENTRYATTACHMENTS_OL WHERE CARDID=@CARDID AND MAINCATEGORYID=@MAINCATEGORYID AND SUBCATEGORYID=@SUBCATEGORYID
ELSE
	SELECT @IMAGEPATH='' 
IF EXISTS (SELECT 1 FROM [STOPCARDENTRYCATEGORYCOMMENTS_OL] WHERE CARDID = @CARDID AND  MAINCATEGORYID=@MAINCATEGORYID AND SUBCATEGORYID =@SUBCATEGORYID)
SELECT (SELECT ENTITYVALUE FROM ENTITYTRANSLATION WHERE ENTITYID=@MAINCATEGORYID AND ENTITYTYPE='MAIN_CTG' AND LANGUAGEID=@LANGUAGEID) MAINCATEGORYNAME,
(SELECT ENTITYVALUE FROM ENTITYTRANSLATION WHERE PARENTID=@MAINCATEGORYID AND ENTITYID = @SUBCATEGORYID AND ENTITYTYPE='SUB_CTG' AND LANGUAGEID=@LANGUAGEID) SUBCATEGORYNAME,
[SAFECOMMENTS]
,[UNSAFECOMMENTS]
,@IMAGEPATH IMAGEPATH
FROM [STOPCARDENTRYCATEGORYCOMMENTS_OL]SC
INNER JOIN MAINCATEGORIES M
ON SC.MAINCATEGORYID = M.MAINCATEGORYID
LEFT JOIN SUBCATEGORIES S
ON SC.SUBCATEGORYID = S.SUBCATEGORYID
WHERE CARDID = @CARDID
AND SC.MAINCATEGORYID=@MAINCATEGORYID
AND SC.SUBCATEGORYID=@SUBCATEGORYID
ELSE
SELECT (SELECT ENTITYVALUE FROM ENTITYTRANSLATION WHERE ENTITYID=@MAINCATEGORYID AND ENTITYTYPE='MAIN_CTG' AND LANGUAGEID=@LANGUAGEID) MAINCATEGORYNAME,
(SELECT ENTITYVALUE FROM ENTITYTRANSLATION WHERE PARENTID=@MAINCATEGORYID AND ENTITYID = @SUBCATEGORYID AND ENTITYTYPE='SUB_CTG' AND LANGUAGEID=@LANGUAGEID) SUBCATEGORYNAME,
'' SAFECOMMENTS,'' UNSAFECOMMENTS,@IMAGEPATH IMAGEPATH

SET @IMAGENAME = ''
SELECT @IMAGENAME=@IMAGENAME+IMAGENAME+' , ' FROM dbo.STOPCARDENTRYATTACHMENTS_OL
WHERE CARDID=@CARDID AND MAINCATEGORYID=@MAINCATEGORYID AND SUBCATEGORYID =@SUBCATEGORYID

SELECT CASE WHEN @IMAGENAME ='' THEN '' ELSE SUBSTRING(@IMAGENAME,1,LEN(@IMAGENAME)-2) END IMAGENAME

END
