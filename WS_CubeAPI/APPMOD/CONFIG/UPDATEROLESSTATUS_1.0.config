DECLARE @CC_TIMESTAMP DATETIME
SET @CC_TIMESTAMP=GETDATE()

UPDATE ROLES SET STATUS = CASE WHEN STATUS = 1 THEN 0 WHEN STATUS = 0 THEN 1 END,UPDATEDBY=@UPDATEDBY,UPDATEDDATE=@CC_TIMESTAMP
WHERE ROLEID IN (SELECT RESULT FROM DBO.CSVTOTABLE(@ROLEID)) AND ROLEID NOT IN(1,2,3,4,5) AND ALLSITES !=1

UPDATE USERINFO SET DEFAULTROLEID =-1,UPDATEDBY=@UPDATEDBY,UPDATEDDATE=@CC_TIMESTAMP WHERE DEFAULTROLEID IN( SELECT ROLEID FROM ROLES WHERE STATUS = 0 AND ROLEID IN (SELECT RESULT FROM DBO.CSVTOTABLE(@ROLEID)))

UPDATE UI SET DEFAULTROLEID = A.ROLEID,UPDATEDBY=@UPDATEDBY,UPDATEDDATE=@CC_TIMESTAMP
FROM USERINFO UI
INNER JOIN
(
SELECT ROW_NUMBER() OVER (PARTITION BY UR.USERID ORDER BY UR.UPDATEDDATE DESC ) ID,UR.USERID,UR.ROLEID FROM USERROLES UR
INNER JOIN USERS U ON U.USERID = UR.USERID
INNER JOIN USERINFO UI ON UI.USERID = UR.USERID
INNER JOIN ROLES R ON R.ROLEID = UR.ROLEID
WHERE R.STATUS=1 AND U.STATUS=1 AND UR.STATUS = 1 AND UI.DEFAULTROLEID=-1
AND R.ROLEID IN (SELECT RESULT FROM DBO.CSVTOTABLE(@ROLEID))
) A ON A.USERID=UI.USERID
WHERE A.ID=1

INSERT INTO dbo.AUDIT(TABLENAME,TRANS,STAMP,LASTUPDATEDBY,DATA)
SELECT 'ROLES','UPDATE-UPDATEROLESSTATUS_1.0',@CC_TIMESTAMP,@UPDATEDBY,NULL

INSERT INTO dbo.AUDIT(TABLENAME,TRANS,STAMP,LASTUPDATEDBY,DATA)
SELECT 'USERINFO','UPDATE-UPDATEROLESSTATUS_1.0',@CC_TIMESTAMP,@UPDATEDBY,
(SELECT * FROM USERINFO WHERE UPDATEDBY=@UPDATEDBY AND UPDATEDDATE=@CC_TIMESTAMP FOR XML AUTO)