DECLARE @CC_TIMESTAMP DATETIME
SET @CC_TIMESTAMP=GETDATE()
--DELETE FROM USERSITES WHERE SITEID IN (SELECT RESULT FROM DBO.CSVTOTABLE(@SITEID))

UPDATE UI SET DEFAULTSITEID = S.SITEID,UPDATEDBY=@UPDATEDBY,UPDATEDDATE=@CC_TIMESTAMP
FROM USERINFO UI
INNER JOIN (SELECT ROW_NUMBER() OVER(PARTITION BY US.USERID ORDER BY US.SITEID) ID, US.USERID,US.SITEID FROM USERSITES US
INNER JOIN SITES S ON S.SITEID = US.SITEID
WHERE US.STATUS =1 AND S.STATUS =1
AND US.USERID IN (SELECT USERID FROM USERINFO WHERE DEFAULTSITEID IN (SELECT RESULT FROM DBO.CSVTOTABLE(@SITEID)))
) S ON S.USERID=UI.USERID
WHERE S.ID=1

UPDATE USERINFO SET DEFAULTSITEID = -1,UPDATEDBY=@UPDATEDBY,UPDATEDDATE=@CC_TIMESTAMP WHERE DEFAULTSITEID IN (SELECT RESULT FROM DBO.CSVTOTABLE(@SITEID))

IF EXISTS(SELECT 1 FROM USERINFO WHERE USERID = 1 AND DEFAULTSITEID = -1)
AND NOT EXISTS(SELECT 1 FROM USERSITES WHERE USERID = 1 AND STATUS=1)
UPDATE USERINFO SET DEFAULTSITEID =1,UPDATEDBY=@UPDATEDBY,UPDATEDDATE=@CC_TIMESTAMP WHERE USERID = 1

INSERT INTO dbo.AUDIT(TABLENAME,TRANS,STAMP,LASTUPDATEDBY,DATA)
SELECT 'USERINFO','DELETE-DELETEUSERSITES_1.0',@CC_TIMESTAMP,@UPDATEDBY,NULL
