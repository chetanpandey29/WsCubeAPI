--SITES FILTER
DECLARE @TSITES TABLE(SITEID INT,SITENAME VARCHAR(256))
IF @SITEID = '' OR @SITEID IS NULL
BEGIN
IF EXISTS(SELECT 1 FROM USERINFO UR
INNER JOIN ROLES R ON R.ROLEID = UR.DEFAULTROLEID
WHERE R.STATUS=1 AND UR.USERID = @USERID AND R.ALLSITES=1)
BEGIN
INSERT INTO @TSITES
SELECT SITEID,SITENAME FROM SITES WHERE STATUS = 1
END
ELSE
INSERT INTO @TSITES
SELECT S.SITEID,S.SITENAME FROM SITES S
INNER JOIN USERSITES US ON US.SITEID = S.SITEID
WHERE S.STATUS = 1 AND US.STATUS = 1 AND US.USERID = @USERID

END
ELSE
INSERT INTO @TSITES
SELECT SITEID,SITENAME FROM SITES
WHERE SITEID IN (SELECT RESULT FROM DBO.CSVTOTABLE(@SITEID))


IF @FROMDATE = '' OR @FROMDATE IS NULL
SET @FROMDATE = '01/01/1900'
IF @TODATE = '' OR @TODATE IS NULL
SET @TODATE = '12/31/9999'

SELECT TS.SITEID,TS.SITENAME,S.ADDRESS,S.STATE,S.CITY,ISNULL(S.ISDEFAULT,0) AS ISDEFAULT,S.EMPCOUNT,
(SELECT COUNT(*) FROM USERSITES WHERE SITEID=S.SITEID AND STATUS=1)[USRCNT],
U.USERID,U.USERNAME,U.LASTNAME,
U.FIRSTNAME,UI.DEFAULTROLEID USERLEVEL,U.[STATUS]
FROM @TSITES TS
INNER JOIN SITES S ON S.SITEID = TS.SITEID
INNER JOIN USERSITES US ON TS.SITEID=US.SITEID
INNER JOIN USERS U ON US.USERID=U.USERID
INNER JOIN USERINFO UI ON UI.USERID = U.USERID
WHERE U.STATUS=1 AND US.STATUS=1
AND S.CREATEDDATE BETWEEN @FROMDATE AND @TODATE
ORDER BY TS.SITENAME,U.LASTNAME,U.FIRSTNAME
