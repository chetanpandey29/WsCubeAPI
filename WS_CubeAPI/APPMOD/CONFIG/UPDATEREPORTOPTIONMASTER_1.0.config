--UPDATEREPORTOPTIONMASTER_1.0
DECLARE @CC_TIMESTAMP DATETIME
SET @CC_TIMESTAMP=GETDATE()

IF @OPTIONID=''
BEGIN
DELETE FROM REPORTFILTER  WHERE REPORTID =@REPORTID AND USERID =@USERID
AND OPTIONID NOT IN (SELECT OPTIONID FROM REPORTSOPTION WHERE REPORTID=@REPORTID AND MANDATORY=1)

DELETE FROM SCHEDULEASSIGNMENTS WHERE SCHEDULEID IN (SELECT SCHEDULEID FROM SCHEDULE WHERE REPORTID=@REPORTID AND STATUS!=2)
AND OPTIONID NOT IN (SELECT OPTIONID FROM REPORTSOPTION WHERE REPORTID=@REPORTID AND MANDATORY=1)

DELETE FROM REPORTFILTERMASTER WHERE REPORTID =@REPORTID AND USERID =@USERID

INSERT INTO REPORTFILTERMASTER (REPORTID,OPTIONID,USERID,[STATUS],CREATEDDATE)
SELECT REPORTID,OPTIONID,@USERID,0,@CC_TIMESTAMP FROM REPORTSOPTION WHERE REPORTID=@REPORTID AND MANDATORY<>1
END

UPDATE REPORTFILTERMASTER SET STATUS= 1,CREATEDDATE=@CC_TIMESTAMP
WHERE REPORTID = @REPORTID AND OPTIONID IN (SELECT RESULT FROM DBO.CSVTOTABLE(@OPTIONID)) AND USERID = @USERID;

UPDATE  RFM SET RFM.STATUS= CASE WHEN RO.MANDATORY=1 THEN RFM.STATUS ELSE 0 END,CREATEDDATE=@CC_TIMESTAMP
FROM REPORTFILTERMASTER RFM
INNER JOIN REPORTSOPTION RO ON RO.REPORTID = RFM.REPORTID AND RO.OPTIONID = RFM.OPTIONID
WHERE RFM.REPORTID = @REPORTID AND RFM.OPTIONID NOT IN (SELECT RESULT FROM DBO.CSVTOTABLE(@OPTIONID)) AND USERID = @USERID;

INSERT INTO REPORTFILTERMASTER(REPORTID,OPTIONID,USERID,STATUS,CREATEDDATE)
SELECT @REPORTID,RESULT,@USERID,1,@CC_TIMESTAMP FROM DBO.CSVTOTABLE(@OPTIONID)  WHERE RESULT NOT IN
(SELECT OPTIONID FROM REPORTFILTERMASTER WHERE REPORTID = @REPORTID AND USERID = @USERID);

DELETE FROM REPORTFILTER  WHERE REPORTID =@REPORTID AND USERID =@USERID
AND OPTIONID NOT IN (SELECT RESULT FROM DBO.CSVTOTABLE(@OPTIONID) UNION SELECT OPTIONID FROM REPORTSOPTION WHERE REPORTID=@REPORTID AND MANDATORY=1)

DELETE FROM SCHEDULEASSIGNMENTS WHERE SCHEDULEID IN (SELECT SCHEDULEID FROM SCHEDULE WHERE REPORTID=@REPORTID AND STATUS!=2)
AND OPTIONID NOT IN (SELECT RESULT FROM DBO.CSVTOTABLE(@OPTIONID) UNION SELECT OPTIONID FROM REPORTSOPTION WHERE REPORTID=@REPORTID AND MANDATORY=1)

SELECT 1

INSERT INTO dbo.AUDIT(TABLENAME,TRANS,STAMP,LASTUPDATEDBY,DATA)
SELECT 'REPORTFILTERMASTER','UPDATE-UPDATEREPORTOPTIONMASTER_1.0',@CC_TIMESTAMP,@USERID,NULL
