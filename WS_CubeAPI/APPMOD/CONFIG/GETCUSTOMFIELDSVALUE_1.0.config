--GETCUSTOMFIELDSVALUE_1.0
DECLARE @INPUTCUSTOMFIELDS TABLE(CUSTOMFIELDID INT,CUSTOMFIELDVALUEID INT,CUSTOMFIELDVALUE NVARCHAR(256))
IF @CARDID='0'
BEGIN
SELECT CFV.CUSTOMFIELDID,CFV.CUSTOMFIELDVALUEID,ET.ENTITYVALUE CUSTOMFIELDVALUE,0 FLAG
FROM CUSTOMFIELDS CF
INNER JOIN CUSTOMFIELDVALUES CFV ON CFV.CUSTOMFIELDID=CF.CUSTOMFIELDID
INNER JOIN ENTITYTRANSLATION ET ON ET.PARENTID=CFV.CUSTOMFIELDID AND ET.ENTITYID=CFV.CUSTOMFIELDVALUEID AND ET.LANGUAGEID=@LANGUAGEID AND ET.ENTITYTYPE='CUS_VALUE'
WHERE CF.STATUS=1 AND CFV.STATUS=1 AND CFV.ALLSITES=1
UNION
SELECT CFV.CUSTOMFIELDID,CFV.CUSTOMFIELDVALUEID,ET.ENTITYVALUE CUSTOMFIELDVALUE,0 FLAG
FROM CUSTOMFIELDS CF
INNER JOIN CUSTOMFIELDVALUES CFV ON CFV.CUSTOMFIELDID=CF.CUSTOMFIELDID
INNER JOIN SITECUSTOMFIELDS SCF ON SCF.SITEID=@SITEID AND SCF.CUSTOMFIELDID=CF.CUSTOMFIELDID AND SCF.CUSTOMFIELDVALUEID=CFV.CUSTOMFIELDVALUEID
INNER JOIN ENTITYTRANSLATION ET ON ET.PARENTID=CFV.CUSTOMFIELDID AND ET.ENTITYID=CFV.CUSTOMFIELDVALUEID AND ET.LANGUAGEID=@LANGUAGEID AND ET.ENTITYTYPE='CUS_VALUE'
WHERE CF.STATUS=1 AND SCF.STATUS=1 AND CFV.STATUS=1  AND CFV.ALLSITES=0
ORDER BY CUSTOMFIELDVALUE
END
ELSE
BEGIN
IF @OBSAPPROVALPC=0--APROOVAL NOT REQUIRED
BEGIN
INSERT INTO @INPUTCUSTOMFIELDS(CUSTOMFIELDID,CUSTOMFIELDVALUEID,CUSTOMFIELDVALUE)
SELECT 1,CUSTOMFIELD1,ET.ENTITYVALUE CUSTOMFIELD1NAME FROM STOPCARDENTRYCUSTOMFIELDS SCF
INNER JOIN ENTITYTRANSLATION ET ON ET.PARENTID=1 AND ET.ENTITYID=SCF.CUSTOMFIELD1 AND ET.LANGUAGEID=@LANGUAGEID
AND ET.ENTITYTYPE='CUS_VALUE'
WHERE CARDID=@CARDID
UNION ALL
SELECT 2,CUSTOMFIELD2,ET.ENTITYVALUE CUSTOMFIELD2NAME FROM STOPCARDENTRYCUSTOMFIELDS SCF
INNER JOIN ENTITYTRANSLATION ET ON ET.PARENTID=2 AND ET.ENTITYID=SCF.CUSTOMFIELD2 AND ET.LANGUAGEID=@LANGUAGEID
AND ET.ENTITYTYPE='CUS_VALUE'
WHERE CARDID=@CARDID
UNION ALL
SELECT 3,CUSTOMFIELD3,ET.ENTITYVALUE CUSTOMFIELD3NAME FROM STOPCARDENTRYCUSTOMFIELDS SCF
INNER JOIN ENTITYTRANSLATION ET ON ET.PARENTID=3 AND ET.ENTITYID=SCF.CUSTOMFIELD3 AND ET.LANGUAGEID=@LANGUAGEID
AND ET.ENTITYTYPE='CUS_VALUE'
WHERE CARDID=@CARDID

END
ELSE IF @OBSAPPROVALPC=1--APROOVAL REQUIRED
BEGIN
INSERT INTO @INPUTCUSTOMFIELDS(CUSTOMFIELDID,CUSTOMFIELDVALUEID,CUSTOMFIELDVALUE)
SELECT 1,CUSTOMFIELD1,ET.ENTITYVALUE CUSTOMFIELD1NAME FROM STOPCARDENTRYCUSTOMFIELDS_OL SCF
INNER JOIN ENTITYTRANSLATION ET ON ET.PARENTID=1 AND ET.ENTITYID=SCF.CUSTOMFIELD1 AND ET.LANGUAGEID=@LANGUAGEID
AND ET.ENTITYTYPE='CUS_VALUE'
WHERE CARDID=@CARDID
UNION ALL
SELECT 2,CUSTOMFIELD2,ET.ENTITYVALUE CUSTOMFIELD2NAME FROM STOPCARDENTRYCUSTOMFIELDS_OL SCF
INNER JOIN ENTITYTRANSLATION ET ON ET.PARENTID=2 AND ET.ENTITYID=SCF.CUSTOMFIELD2 AND ET.LANGUAGEID=@LANGUAGEID
AND ET.ENTITYTYPE='CUS_VALUE'
WHERE CARDID=@CARDID
UNION ALL
SELECT 3,CUSTOMFIELD3,ET.ENTITYVALUE CUSTOMFIELD3NAME FROM STOPCARDENTRYCUSTOMFIELDS_OL SCF
INNER JOIN ENTITYTRANSLATION ET ON ET.PARENTID=3 AND ET.ENTITYID=SCF.CUSTOMFIELD3 AND ET.LANGUAGEID=@LANGUAGEID
AND ET.ENTITYTYPE='CUS_VALUE'
WHERE CARDID=@CARDID
END

SELECT ICF.CUSTOMFIELDID,ICF.CUSTOMFIELDVALUEID,ICF.CUSTOMFIELDVALUE+CASE WHEN CFV.STATUS=0 THEN ' (Inactive) ' ELSE '' END CUSTOMFIELDVALUE,1 FLAG FROM @INPUTCUSTOMFIELDS ICF
INNER JOIN CUSTOMFIELDVALUES CFV ON CFV.CUSTOMFIELDID=ICF.CUSTOMFIELDID AND CFV.CUSTOMFIELDVALUEID=ICF.CUSTOMFIELDVALUEID
UNION
SELECT CFV.CUSTOMFIELDID,CFV.CUSTOMFIELDVALUEID,ET.ENTITYVALUE CUSTOMFIELDVALUE,0 FLAG
FROM CUSTOMFIELDS CF
INNER JOIN CUSTOMFIELDVALUES CFV ON CFV.CUSTOMFIELDID=CF.CUSTOMFIELDID
INNER JOIN SITECUSTOMFIELDS SCF ON SCF.SITEID=@SITEID AND SCF.CUSTOMFIELDID=CF.CUSTOMFIELDID AND SCF.CUSTOMFIELDVALUEID=CFV.CUSTOMFIELDVALUEID
INNER JOIN ENTITYTRANSLATION ET ON ET.PARENTID=CFV.CUSTOMFIELDID AND ET.ENTITYID=CFV.CUSTOMFIELDVALUEID AND ET.LANGUAGEID=@LANGUAGEID AND ET.ENTITYTYPE='CUS_VALUE'
WHERE CF.STATUS=1 AND CFV.STATUS=1 AND CFV.ALLSITES=0
AND NOT EXISTS(SELECT 1 FROM @INPUTCUSTOMFIELDS WHERE CUSTOMFIELDID=CFV.CUSTOMFIELDID AND CUSTOMFIELDVALUEID=CFV.CUSTOMFIELDVALUEID)
UNION
SELECT CFV.CUSTOMFIELDID,CFV.CUSTOMFIELDVALUEID,ET.ENTITYVALUE CUSTOMFIELDVALUE,0 FLAG
FROM CUSTOMFIELDS CF
INNER JOIN CUSTOMFIELDVALUES CFV ON CFV.CUSTOMFIELDID=CF.CUSTOMFIELDID
INNER JOIN ENTITYTRANSLATION ET ON ET.PARENTID=CFV.CUSTOMFIELDID AND ET.ENTITYID=CFV.CUSTOMFIELDVALUEID AND ET.LANGUAGEID=@LANGUAGEID AND ET.ENTITYTYPE='CUS_VALUE'
WHERE CF.STATUS=1 AND CFV.STATUS=1 AND CFV.ALLSITES=1
AND NOT EXISTS(SELECT 1 FROM @INPUTCUSTOMFIELDS WHERE CUSTOMFIELDID=CFV.CUSTOMFIELDID AND CUSTOMFIELDVALUEID=CFV.CUSTOMFIELDVALUEID)
ORDER BY CUSTOMFIELDVALUE
END
