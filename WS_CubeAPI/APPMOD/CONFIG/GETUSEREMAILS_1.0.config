IF EXISTS(SELECT 1 FROM USERINFO WHERE USERID = @USERID AND DEFAULTROLEID =1)
BEGIN
SELECT USERID,LASTNAME+','+FIRSTNAME FULLNAME,EMAIL FROM USERS
WHERE EMAIL IS NOT NULL
ORDER BY LASTNAME+','+FIRSTNAME
END
ELSE
SELECT DISTINCT U.USERID,LASTNAME+','+FIRSTNAME FULLNAME,EMAIL FROM USERS U
INNER JOIN USERSITES US ON US.USERID = U.USERID
WHERE U.STATUS=1 AND US.STATUS=1 AND US.SITEID IN (SELECT SITEID FROM USERSITES WHERE USERID = @USERID) AND U.EMAIL IS NOT NULL
ORDER BY LASTNAME+','+FIRSTNAME
