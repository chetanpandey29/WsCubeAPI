--GETCOMMONCHECKLISTINFO_1.0
DECLARE @STARTDATE DATETIME,@ENDDATE DATETIME,@CURRDATE DATETIME,@SCHEDULETYPEID INT,@MONTH INT,@YEAR INT
SELECT @SCHEDULETYPEID=SCHEDULETYPEID FROM SDPMCPSADMIN40..SCHEDULE WHERE SCHEDULEID=@SCHEDULEID

DECLARE @REPORTTYPE INT,@PREMONWEEKVALUE INT
SELECT @REPORTTYPE=REPORTTYPE,@PREMONWEEKVALUE =CASE  WHEN PREMONWEEKVALUE IS NULL THEN 1 WHEN PREMONWEEKVALUE =0 THEN 1 ELSE PREMONWEEKVALUE END FROM SDPMCPSADMIN40..SCHEDULEOPTIONS WHERE SCHEDULEID=@SCHEDULEID

DECLARE @WEEKDATE DATETIME
IF @SCHEDULETYPEID=2
BEGIN
IF @REPORTTYPE=1 -- MONTH
BEGIN
SELECT @STARTDATE=CAST(DATEPART(MM,DATEADD(MM,-(@PREMONWEEKVALUE),GETDATE())) AS VARCHAR(8))+'/'+'05/'+CAST(DATEPART(YYYY,DATEADD(MM,-(@PREMONWEEKVALUE),GETDATE())) AS VARCHAR(8))
SELECT @ENDDATE=CAST(DATEPART(MM,GETDATE()) AS VARCHAR(8))+'/'+'04/'+CAST(DATEPART(YYYY,GETDATE()) AS VARCHAR(8))
END
ELSE IF @REPORTTYPE=2 -- WEEK
BEGIN
SET @WEEKDATE=DATEADD(DD,-(@PREMONWEEKVALUE*7),GETDATE())

SELECT @STARTDATE=CONVERT(VARCHAR(32),@WEEKDATE,101)
SELECT @ENDDATE=CONVERT(VARCHAR(32),GETDATE()-1,101)
END
END
ELSE IF @SCHEDULETYPEID=3
BEGIN
SET @MONTH=MONTH(DATEADD(MM,-1,GETDATE()))
SET @YEAR=YEAR(DATEADD(MM,-1,GETDATE()))

SET @STARTDATE = CAST(@YEAR AS VARCHAR(8)) + RIGHT('0' + CAST(@MONTH AS VARCHAR(8)), 2) + '01'
SET @ENDDATE = DATEADD(DD, -1, DATEADD(MM, 1, @STARTDATE))
END
ELSE IF @SCHEDULETYPEID=4
BEGIN
SET @STARTDATE=DATEADD(wk,DATEDIFF(wk,7,GETDATE()),0) --RETURNS LAST MONDAY
SET @ENDDATE=DATEADD(DD,6,@STARTDATE)
SELECT @ENDDATE=DATEADD(MI,1439,CONVERT(DATETIME,@ENDDATE))
END

SELECT @CURRDATE = CAST(DATEPART(MM,GETDATE()) AS VARCHAR(8))+'/'+CAST(DATEPART(DD,GETDATE()) AS VARCHAR(8))+'/'+CAST(DATEPART(YYYY,GETDATE()) AS VARCHAR(8))


SELECT S.COMPANYID,S.SCHEDULEID,CASE S.SCHEDULETYPEID WHEN 2 THEN '[SDPMCPSADMIN40].[dbo].[MCPSOBSERVATIONCHECKLISTDETAIL]' WHEN 3 THEN '[SDPMCPSADMIN40].[dbo].[MCPSTARGETVSACTIVITYDETAIL]' WHEN 4 THEN '[SDPMCPSADMIN40].[dbo].[MCPSOBSERVATIONCHECKLISTDETAILWEEKLY]' ELSE '' END QUERYVALUE,
0 ISQUERY,
1 DESIGNID,
S.RPTDESIGN RPTDESIGN
,CASE S.SCHEDULETYPEID WHEN 2 THEN 'Observation Checklist Details' WHEN 3 THEN 'Target vs Activity Details' WHEN 4 THEN 'Weekly Observation Report' ELSE '' END REPORTNAME,
'Option name' RPTNAME,
1001 USERID,
'en-us' LANGUAGECODE,
4 LANGUAGEID,
'' REPORTPARAM,
null REPORTID,
(SELECT TOP 1 URL FROM [SDPMCPSADMIN40].[dbo].DSNCON WHERE COMPANYID=@COMPANYID) URL,
'NOREPLY@DUPONT40.COM' MAILFROM,
'NOREPLY@DUPONT40.COM' REPLYTO,
CC,CASE S.SCHEDULETYPEID WHEN 2 THEN 'Observation Checklist Details' WHEN 3 THEN 'Target vs Activity Details' WHEN 4 THEN 'Weekly Observation Report' ELSE '' END SUBJECT,
CONVERT(VARCHAR(32),@STARTDATE,101)+' - '+CONVERT(VARCHAR(32),@ENDDATE,101) DATE
,CONVERT(VARCHAR(32),@CURRDATE,101) IMPORTDATE
,'MM/dd/yyyy' DATEFORMAT
,CASE S.EXPORTTYPE WHEN 1 THEN 'PDF' WHEN 2 THEN 'XLS' WHEN 3 THEN 'XLSX' END EXPORTTYPE
,S.EXPORTFORMAT
,NULL RELATIVEFOR
,NULL RELATIVEFOR
,SO.STARTDATE
,SO.ENDDATE
,SO.DWM
,SO.EVERYDWM
,SO.DAY
,SO.MONTH
,S.STATUS
,CASE WHEN SO.DWM=1  AND EVERYDWM=1 THEN dbo.[USERTIMEEMAIL](GETUTCDATE(),SO.STARTTIME,SO.TIMEZONEDURATION)
WHEN SO.DWM=1  AND EVERYDWM>1 THEN dbo.[USERTIMEEMAIL](DATEADD(MM,1,GETUTCDATE()-1),SO.STARTTIME,SO.TIMEZONEDURATION)
WHEN SO.DWM=2  THEN dbo.[USERTIMEEMAIL](DATEADD(dd,7,GETUTCDATE()),SO.STARTTIME,SO.TIMEZONEDURATION)
ELSE dbo.[USERTIMEEMAIL](GETUTCDATE(),SO.STARTTIME,SO.TIMEZONEDURATION) END [TOCKENTOBESENTDATE]
,SO.STARTTIME
,SO.[TIMEZONE]
,'#951200' CUSTOMCOLOR
,'#CCFFFF' CUSTOMFONT
,'' URL
,S.SCHEDULETYPEID
,S.BODY
FROM SDPMCPSADMIN40..SCHEDULE S
INNER JOIN SDPMCPSADMIN40..SCHEDULEOPTIONS SO ON SO.SCHEDULEID = S.SCHEDULEID
WHERE S.SCHEDULEID =@SCHEDULEID


SELECT 1001 USERID,REPLYTO EMAIL,BODY FROM SDPMCPSADMIN40..SCHEDULE WHERE SCHEDULEID=@SCHEDULEID