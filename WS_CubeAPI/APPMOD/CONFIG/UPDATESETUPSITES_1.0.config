DECLARE @CC_TIMESTAMP DATETIME
SET @CC_TIMESTAMP=GETDATE()

UPDATE CHECKLISTSETUPSITES SET STATUS=0,UPDATEDBY=@UPDATEDBY,UPDATEDDATE=@CC_TIMESTAMP WHERE CHECKLISTSETUPID=@CHECKLISTSETUPID

UPDATE CHECKLISTSETUPSITES SET STATUS = 1,UPDATEDBY=@UPDATEDBY,UPDATEDDATE=@CC_TIMESTAMP
WHERE CHECKLISTSETUPID=@CHECKLISTSETUPID AND SITEID IN (SELECT RESULT FROM DBO.CSVTOTABLE(@SITEID))
AND STATUS = 0

UPDATE CHECKLISTSETUPSITES SET STATUS = 0,UPDATEDBY=@UPDATEDBY,UPDATEDDATE=@CC_TIMESTAMP
WHERE CHECKLISTSETUPID=@CHECKLISTSETUPID AND SITEID NOT IN (SELECT RESULT FROM DBO.CSVTOTABLE(@SITEID))
AND STATUS = 1

INSERT INTO CHECKLISTSETUPSITES(CHECKLISTSETUPID,SITEID,STATUS,UPDATEDBY,UPDATEDDATE)
SELECT @CHECKLISTSETUPID,RESULT,1,@UPDATEDBY,@CC_TIMESTAMP FROM DBO.CSVTOTABLE(@SITEID) R
WHERE RESULT NOT IN (SELECT SITEID FROM CHECKLISTSETUPSITES WHERE CHECKLISTSETUPID=@CHECKLISTSETUPID);SELECT 2


INSERT INTO dbo.AUDIT(TABLENAME,TRANS,STAMP,LASTUPDATEDBY,DATA)
SELECT 'CHECKLISTSETUPSITES','UPDATE-UPDATESETUPSITES_1.0',@CC_TIMESTAMP,@UPDATEDBY,NULL
