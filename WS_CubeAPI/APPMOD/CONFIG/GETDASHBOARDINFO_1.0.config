--GETDASHBOARDINFO_1.0
DECLARE @STARTDATE DATETIME,@ENDDATE DATETIME,@OBSERVED INT,@RESPCAPACNT INT,@ACTIONOWNERCAPACNT INT,@INBOXCOUNT INT,@APPROVALCOUNT INT,@APPROVALPERMISSION INT
DECLARE @QRY VARCHAR(MAX)
SET @QRY=''
DECLARE @TARGET TABLE(ID INT,[TARGET] VARCHAR(8))

SELECT @STARTDATE=DATEADD(DD,-(DAY(GETUTCDATE())-1),GETUTCDATE())
SELECT @ENDDATE=DATEADD(DD,-(DAY(DATEADD(MM,1,GETUTCDATE()))),DATEADD(MM,1,GETUTCDATE()))
SELECT @STARTDATE=CAST(CONVERT(VARCHAR(32),@STARTDATE,101) AS DATETIME) , @ENDDATE=DATEADD(MI,1439,CAST(CONVERT(VARCHAR(32),@ENDDATE,101) AS DATETIME))


SELECT @INBOXCOUNT=COUNT(1) FROM USERINBOX WHERE USERID=@USERID AND READSTATUS=0 AND [STATUS] =1

SELECT @APPROVALCOUNT=COUNT(DISTINCT SC.CARDID)  FROM STOPCARDENTRY_OL SC
--INNER JOIN STOPCARDENTRYOBSERVERS_OL SCO ON SCO.CARDID=SC.CARDID
WHERE SC.STATUS<>2 AND SC.STOPCARDTYPE=1 AND SC.ISAPPROVED=0 AND (EDITOR IS NULL OR EDITOR =2)
--AND SCO.OBSERVERID=CASE WHEN @USERID = '1'  THEN SCO.OBSERVERID ELSE @USERID END
AND SC.SITEID =@SITEID
DECLARE @WEEKSTART DATETIME,@WEEKEND DATETIME,@MONTHSTART DATETIME,@MONTHEND DATETIME,@WEEKOBS NVARCHAR(8),@MONTHOBS NVARCHAR(8)
SET @WEEKOBS=''
SET @MONTHOBS=''

SELECT @MONTHSTART=CAST(CAST(MONTH(GETDATE()) AS NVARCHAR(8))+'/01/'+CAST(YEAR(GETDATE()) AS NVARCHAR(8)) AS DATETIME)
SELECT @MONTHEND=DATEADD(S,-1,DATEADD(MM, DATEDIFF(M,0,GETDATE())+1,0))
SELECT @WEEKSTART=CAST(CONVERT(NVARCHAR(32),DATEADD(dd, DATEPART(DW,GETDATE())*-1+1, GETDATE()),101) AS DATETIME)
SELECT @WEEKEND=DATEADD(MI,1439,CONVERT(DATETIME,DATEADD(DD,6,@WEEKSTART)))

INSERT INTO @TARGET
SELECT 1, CASE WHEN EXISTS(SELECT 1 FROM WEEKLYTARGETUSERS WHERE SITEID=@SITEID AND USERID=@USERID) THEN (SELECT TOP 1 CAST(WEEKTARGET AS NVARCHAR(8)) FROM WEEKLYTARGETUSERS WHERE SITEID=@SITEID AND USERID=@USERID)
WHEN EXISTS(SELECT 1 FROM WEEKLYTARGETSITES WHERE SITEID=@SITEID) THEN (SELECT TOP 1 CAST(WEEKTARGET AS NVARCHAR(8)) FROM WEEKLYTARGETSITES WHERE SITEID=@SITEID)
ELSE '--' END

SET @QRY='SELECT 2,CASE WHEN EXISTS(SELECT ' + SUBSTRING(DATENAME(MM,GETDATE()),1,3) +' FROM TARGETUSERS WHERE SITEID='+ CAST(@SITEID AS VARCHAR(8))+' AND USERID=' +CAST(@USERID AS VARCHAR(8))+') THEN '
+'( SELECT  CAST('+ SUBSTRING(DATENAME(MM,GETDATE()),1,3) +' AS VARCHAR(8)) FROM TARGETUSERS WHERE SITEID='+ CAST(@SITEID AS VARCHAR(8))+' AND USERID=' +CAST(@USERID AS VARCHAR(8))+')'
+' WHEN EXISTS(SELECT ' + SUBSTRING(DATENAME(MM,GETDATE()),1,3) +' FROM TARGETSITES WHERE SITEID='+ CAST(@SITEID AS VARCHAR(8))+') THEN '
+'( SELECT  CAST('+ SUBSTRING(DATENAME(MM,GETDATE()),1,3) +' AS VARCHAR(8)) FROM TARGETSITES WHERE SITEID='+ CAST(@SITEID AS VARCHAR(8))+')'
+' ELSE ''--'' END AS TARGET'
PRINT @QRY
INSERT INTO @TARGET
EXEC(@QRY)

SELECT  @WEEKOBS=CAST(COUNT(DISTINCT SC.CARDID) AS NVARCHAR(8))
FROM STOPCARDENTRY SC
INNER JOIN SITES S ON S.SITEID=SC.SITEID
INNER JOIN USERSITES US ON US.USERID=@USERID AND US.SITEID=SC.SITEID
INNER JOIN STOPCARDENTRYOBSERVERS SO ON SO.CARDID = SC.CARDID
WHERE SO.OBSERVERID = @USERID AND SC.STOPCARDTYPE=1 AND SC.STATUS=1 AND S.STATUS=1 AND US.STATUS=1
AND SC.OBSERVATIONDATE BETWEEN @WEEKSTART AND @WEEKEND

SELECT  @MONTHOBS=CAST(COUNT(DISTINCT SC.CARDID) AS NVARCHAR(8))
FROM STOPCARDENTRY SC
INNER JOIN SITES S ON S.SITEID=SC.SITEID
INNER JOIN USERSITES US ON US.USERID=@USERID AND US.SITEID=SC.SITEID
INNER JOIN STOPCARDENTRYOBSERVERS SO ON SO.CARDID = SC.CARDID
WHERE SO.OBSERVERID = @USERID AND SC.STOPCARDTYPE=1 AND SC.STATUS=1 AND S.STATUS=1 AND US.STATUS=1
AND SC.OBSERVATIONDATE BETWEEN @MONTHSTART AND @MONTHEND

SELECT @RESPCAPACNT=COUNT(DISTINCT CA.CORRACTIONID) FROM CORRECTIVEACTIONS CA
INNER JOIN STOPCARDENTRY SCE ON SCE.CARDID=CA.CARDID
INNER JOIN CORRECTIVEACTIONSRESPONSIBLEPERSONS CARP ON CARP.CORRACTIONID=CA.CORRACTIONID
WHERE CA.CARDSTATUS IN (1,3) AND CA.STATUS=1 AND SCE.STATUS=1
AND CA.RESPONSEREQUIREDDATE BETWEEN @MONTHSTART AND @MONTHEND
AND CARP.USERID=CAST(@USERID AS VARCHAR(8)) AND SCE.SITEID=@SITEID

SELECT @ACTIONOWNERCAPACNT=COUNT(DISTINCT CA.CORRACTIONID) FROM CORRECTIVEACTIONS CA
INNER JOIN STOPCARDENTRY SCE ON SCE.CARDID=CA.CARDID
INNER JOIN CORRECTIVEACTIONSRESPONSIBLEPERSONS CARP ON CARP.CORRACTIONID=CA.CORRACTIONID
WHERE CA.CARDSTATUS IN (1,3) AND CA.STATUS=1 AND SCE.STATUS=1
AND CA.RESPONSEREQUIREDDATE BETWEEN @MONTHSTART AND @MONTHEND
AND CA.[OWNER]=CAST(@USERID AS VARCHAR(8)) AND SCE.SITEID=@SITEID


SELECT @APPROVALPERMISSION=PERMISSIONVALUE FROM ROLEPERMISSIONS WHERE ROLEID = (SELECT DEFAULTROLEID FROM USERINFO WHERE USERID=@USERID) AND PERMISSIONID=35

IF @ISADMIN='1'  AND NOT EXISTS(SELECT 1 FROM STOPCARDENTRY_OL WHERE ISAPPROVED=0 AND STATUS !=2) AND @APPROVALPC=0 AND @APPROVALMOB=0
SET @APPROVALPERMISSION=0
ELSE IF @ISADMIN='0' AND NOT EXISTS(SELECT 1 FROM STOPCARDENTRY_OL SC INNER JOIN USERSITES US ON US.SITEID=SC.SITEID AND US.USERID=@USERID  WHERE US.STATUS=1 AND SC.ISAPPROVED=0 AND SC.STATUS !=2) AND @APPROVALPC=0 AND @APPROVALMOB=0
SET @APPROVALPERMISSION=0

IF @APPROVEOFFLINE=0
SET @APPROVALPERMISSION=0

SELECT @INBOXCOUNT INBOXCOUNT,@APPROVALCOUNT APPROVALCOUNT,
(SELECT ROLENAME  FROM ROLES WHERE ROLEID IN ( SELECT DEFAULTROLEID FROM USERINFO WHERE USERID=@USERID)) ROLENAME
,(SELECT SITENAME  FROM SITES WHERE SITEID=@SITEID) SITENAME
,CASE WHEN (SELECT USERTYPEID FROM USERINFO WHERE USERID = @USERID)=0 THEN 'N/A' ELSE @WEEKOBS+' / '+(SELECT CAST(TARGET AS VARCHAR(8)) FROM @TARGET WHERE ID=1) END WEEKLYOBSTARGET
,CASE WHEN (SELECT USERTYPEID FROM USERINFO WHERE USERID = @USERID)=0 THEN 'N/A' ELSE @MONTHOBS+' / '+(SELECT CAST(TARGET AS VARCHAR(8)) FROM @TARGET WHERE ID=2) END MONTHLYOBSTARGET
,@RESPCAPACNT CAPARESP
,@ACTIONOWNERCAPACNT CAPAACTIONOWNER
,@APPROVALPERMISSION APPROVALPERMISSION