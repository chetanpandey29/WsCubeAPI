--GETSTOPCARDOBSERVATION_1.0
DECLARE @EXPANDCATEGORY NVARCHAR(8),@CREATECA INT
SET @EXPANDCATEGORY=''
SELECT @EXPANDCATEGORY = OPTIONVALUE FROM COMPANYOPTIONS WHERE OPTIONNAME='EXPANDCATEGORY'

SET @CREATECA=0
IF EXISTS(SELECT 1 FROM STOPCARDENTRYOBSERVATIONS WHERE CARDID=@CARDID AND UNSAFE>0) OR
EXISTS(SELECT 1 FROM STOPCARDENTRYCATEGORYCOMMENTS WHERE CARDID=@CARDID AND LEN(UNSAFECOMMENTS)>0)
SET @CREATECA=1

CREATE TABLE #FINALRESULTS(ID INT IDENTITY(0,1),CHECKLISTSETUPID INT,MAINCATEGORYID INT,SUBCATEGORYID INT,MAINSEQUENCE INT,SUBSEQUENCE INT,MAINCATEGORYNAME NVARCHAR(512),SUBCATEGORYNAME NVARCHAR(512),SAFE INT,UNSAFE INT,SAFECOMMENTS NVARCHAR(MAX),UNSAFECOMMENTS NVARCHAR(MAX),COMMENTEXISTS INT,ALLSAFECHECK INT,OBSCAEXISTS INT DEFAULT 0,CORRACTIONID INT DEFAULT 0,CAFROMOBS INT DEFAULT 0)
DECLARE @DATEFORMAT INT
SELECT @DATEFORMAT = ISNULL(DATEFORMAT,(SELECT CAST(OPTIONVALUE AS INT) FROM COMPANYOPTIONS WHERE OPTIONNAME ='DEFAULTDATEFORMAT')) FROM USERINFO WHERE USERID = @USERID


DECLARE @MULTIPLEOBS NVARCHAR(512)
SET @MULTIPLEOBS =N''
IF @OBSAPPROVALPC=0
BEGIN
IF NOT EXISTS(SELECT 1 FROM STOPCARDENTRYOBSERVATIONS WHERE CARDID = @CARDID)
BEGIN

INSERT INTO #FINALRESULTS(CHECKLISTSETUPID,MAINCATEGORYID,SUBCATEGORYID,SUBSEQUENCE,MAINSEQUENCE,MAINCATEGORYNAME,SUBCATEGORYNAME,SAFE,UNSAFE,COMMENTEXISTS,ALLSAFECHECK,OBSCAEXISTS,CORRACTIONID,CAFROMOBS)
SELECT DISTINCT CS.CHECKLISTSETUPID,CSC.MAINCATEGORYID,CSC.SUBCATEGORYID,CSC.SUBSEQUENCE,CSC.MAINSEQUENCE,ET1.ENTITYVALUE MAINCATEGORYNAME,ET.ENTITYVALUE [SUBCATEGORYNAME],0 [SAFE],0 [UNSAFE],
CASE WHEN EXISTS(SELECT 1 FROM STOPCARDENTRYCATEGORYCOMMENTS WHERE CARDID = @CARDID AND MAINCATEGORYID = CSC.MAINCATEGORYID AND SUBCATEGORYID=CSC.SUBCATEGORYID ) OR EXISTS(SELECT 1 FROM STOPCARDENTRYATTACHMENTS WHERE CARDID = @CARDID AND MAINCATEGORYID = CSC.MAINCATEGORYID AND SUBCATEGORYID=CSC.SUBCATEGORYID) THEN 1 ELSE 0 END [COMMENTEXISTS]
,CS.ALLSAFECHECK,0,0,0
FROM CHECKLISTSETUP CS
INNER JOIN CHECKLISTSETUPCATEGORYASSIGNMENTS CSC ON CS.CHECKLISTSETUPID=CSC.CHECKLISTSETUPID
INNER JOIN MAINCATEGORIES M ON M.MAINCATEGORYID=CSC.MAINCATEGORYID
INNER JOIN SUBCATEGORIES S ON S.MAINCATEGORYID=CSC.MAINCATEGORYID AND S.SUBCATEGORYID=CSC.SUBCATEGORYID
INNER JOIN ENTITYTRANSLATION ET ON ET.PARENTID=CSC.MAINCATEGORYID AND ET.ENTITYID = CSC.SUBCATEGORYID AND ET.ENTITYTYPE='SUB_CTG' AND ET.LANGUAGEID IN (SELECT UI.LANGUAGEID FROM USERINFO UI WHERE UI.USERID = @USERID)
INNER JOIN ENTITYTRANSLATION ET1 ON ET1.PARENTID=CSC.MAINCATEGORYID  AND ET1.ENTITYTYPE='MAIN_CTG' AND ET1.LANGUAGEID IN (SELECT UI.LANGUAGEID FROM USERINFO UI WHERE UI.USERID = @USERID)
WHERE M.STATUS=1 AND S.STATUS=1 AND CS.STATUS IN (0,1,3) AND CSC.MAINISASSIGNED = 1 AND CSC.SUBISASSIGNED = 1
AND CS.CHECKLISTSETUPID=@CHECKLISTSETUPID
ORDER BY MAINSEQUENCE

SELECT MAINCATEGORYID,[MAINCATEGORYNAME],[COMMENTEXISTS],STARTINDEX,ENDINDEX,ALLSAFECHECK FROM(
SELECT DISTINCT CSC.MAINCATEGORYID,ET.ENTITYVALUE [MAINCATEGORYNAME],
CASE WHEN EXISTS(SELECT 1 FROM STOPCARDENTRYCATEGORYCOMMENTS WHERE CARDID = @CARDID AND MAINCATEGORYID = CSC.MAINCATEGORYID AND SUBCATEGORYID = 0) OR EXISTS(SELECT 1 FROM STOPCARDENTRYATTACHMENTS WHERE CARDID = @CARDID AND MAINCATEGORYID = CSC.MAINCATEGORYID AND SUBCATEGORYID = 0 ) THEN 1 ELSE 0 END [COMMENTEXISTS]
,(SELECT MIN(ID) FROM #FINALRESULTS A WHERE A.MAINCATEGORYID = CSC.MAINCATEGORYID) STARTINDEX
,(SELECT MAX(ID) FROM #FINALRESULTS B WHERE B.MAINCATEGORYID = CSC.MAINCATEGORYID) ENDINDEX
,(SELECT TOP 1 ALLSAFECHECK FROM #FINALRESULTS C WHERE C.CHECKLISTSETUPID = CSC.CHECKLISTSETUPID) ALLSAFECHECK
,CSC.MAINSEQUENCE

FROM CHECKLISTSETUP CS
INNER JOIN CHECKLISTSETUPCATEGORYASSIGNMENTS CSC ON CS.CHECKLISTSETUPID=CSC.CHECKLISTSETUPID
INNER JOIN MAINCATEGORIES M ON M.MAINCATEGORYID=CSC.MAINCATEGORYID
INNER JOIN SUBCATEGORIES S ON S.MAINCATEGORYID=CSC.MAINCATEGORYID AND S.SUBCATEGORYID=CSC.SUBCATEGORYID
INNER JOIN ENTITYTRANSLATION ET ON ET.ENTITYID = CSC.MAINCATEGORYID AND ET.ENTITYTYPE='MAIN_CTG' AND ET.LANGUAGEID IN (SELECT UI.LANGUAGEID FROM USERINFO UI WHERE UI.USERID = @USERID)
WHERE M.STATUS IN (1) AND S.STATUS =1 AND CS.STATUS IN (0,1,3) AND CSC.MAINISASSIGNED = 1 AND CSC.SUBISASSIGNED = 1
AND CS.CHECKLISTSETUPID=@CHECKLISTSETUPID)A ORDER BY MAINSEQUENCE

SELECT CHECKLISTSETUPID,MAINCATEGORYID,SUBCATEGORYID,SUBSEQUENCE,MAINCATEGORYNAME,SUBCATEGORYNAME,SAFE,UNSAFE,COMMENTEXISTS,0 OBSCAEXISTS ,0 CORRACTIONID,0 CAFROMOBS FROM #FINALRESULTS ORDER BY MAINSEQUENCE,SUBSEQUENCE,MAINCATEGORYID,SUBCATEGORYID

END
ELSE
BEGIN

SELECT @MULTIPLEOBS=@MULTIPLEOBS+LASTNAME+' '+FIRSTNAME+', '
FROM USERS U
INNER JOIN STOPCARDENTRYOBSERVERS SCO ON SCO.OBSERVERID=U.USERID
WHERE SCO.CARDID=@CARDID
IF LEN(ISNULL(@MULTIPLEOBS,''))>1
SELECT @MULTIPLEOBS=SUBSTRING(@MULTIPLEOBS,1,LEN(@MULTIPLEOBS)-1)

INSERT INTO #FINALRESULTS(CHECKLISTSETUPID,MAINCATEGORYID ,SUBCATEGORYID ,MAINCATEGORYNAME,SUBCATEGORYNAME,SAFE,UNSAFE,SAFECOMMENTS,UNSAFECOMMENTS,COMMENTEXISTS,ALLSAFECHECK,SUBSEQUENCE,MAINSEQUENCE,OBSCAEXISTS,CORRACTIONID,CAFROMOBS)
SELECT DISTINCT CS.CHECKLISTSETUPID,SCO.MAINCATEGORYID,SCO.SUBCATEGORYID,ET1.ENTITYVALUE [MAINCATEGORYNAME],ET.ENTITYVALUE [SUBCATEGORYNAME],SCO.SAFE,SCO.UNSAFE,SCC.SAFECOMMENTS,SCC.UNSAFECOMMENTS,
CASE WHEN EXISTS(SELECT 1 FROM STOPCARDENTRYCATEGORYCOMMENTS WHERE CARDID = @CARDID AND MAINCATEGORYID = SCO.MAINCATEGORYID AND SUBCATEGORYID=SCO.SUBCATEGORYID ) OR EXISTS(SELECT 1 FROM STOPCARDENTRYATTACHMENTS WHERE CARDID = @CARDID AND MAINCATEGORYID = SCO.MAINCATEGORYID AND SUBCATEGORYID=SCO.SUBCATEGORYID) THEN 1 ELSE 0 END [COMMENTEXISTS]
,CS.ALLSAFECHECK,CSCA.SUBSEQUENCE,CSCA.MAINSEQUENCE,CASE WHEN SCO.CAFROMOBS>0 THEN 1 ELSE 0 END  OBSCAEXISTS ,ISNULL(SCO.CAFROMOBS,0) CORRACTIONID
,CASE WHEN SCO.CAFROMOBS>0 THEN 1 ELSE 0 END CAFROMOBS
FROM STOPCARDENTRY SCE
INNER JOIN STOPCARDENTRYOBSERVATIONS SCO ON SCO.CARDID=SCE.CARDID
LEFT JOIN STOPCARDENTRYCATEGORYCOMMENTS SCC ON SCC.CARDID=SCE.CARDID AND SCO.MAINCATEGORYID=SCC.MAINCATEGORYID AND SCO.SUBCATEGORYID=SCC.SUBCATEGORYID
INNER JOIN CHECKLISTSETUP CS ON CS.CHECKLISTSETUPID=SCE.CHECKLISTSETUPID
INNER JOIN CHECKLISTSETUPCATEGORYASSIGNMENTS CSCA ON CSCA.CHECKLISTSETUPID=CS.CHECKLISTSETUPID AND SCO.MAINCATEGORYID=CSCA.MAINCATEGORYID AND SCO.SUBCATEGORYID=CSCA.SUBCATEGORYID
INNER JOIN MAINCATEGORIES M ON M.MAINCATEGORYID=CSCA.MAINCATEGORYID
INNER JOIN SUBCATEGORIES S ON S.MAINCATEGORYID=CSCA.MAINCATEGORYID AND S.SUBCATEGORYID=CSCA.SUBCATEGORYID
INNER JOIN ENTITYTRANSLATION ET ON ET.PARENTID=SCO.MAINCATEGORYID AND ET.ENTITYID = SCO.SUBCATEGORYID AND ET.ENTITYTYPE='SUB_CTG' AND ET.LANGUAGEID IN (SELECT UI.LANGUAGEID FROM USERINFO UI WHERE UI.USERID = @USERID)
INNER JOIN ENTITYTRANSLATION ET1 ON ET1.PARENTID=SCO.MAINCATEGORYID  AND ET1.ENTITYTYPE='MAIN_CTG' AND ET1.LANGUAGEID IN (SELECT UI.LANGUAGEID FROM USERINFO UI WHERE UI.USERID = @USERID)
WHERE SCO.CARDID = @CARDID AND M.STATUS !=2 AND S.STATUS!=2
AND CS.CHECKLISTSETUPID=@CHECKLISTSETUPID
ORDER BY MAINSEQUENCE

SELECT MAINCATEGORYID,[MAINCATEGORYNAME],[COMMENTEXISTS],STARTINDEX,ENDINDEX,ALLSAFECHECK FROM(
SELECT DISTINCT SCO.MAINCATEGORYID,ET.ENTITYVALUE [MAINCATEGORYNAME],
CASE WHEN EXISTS(SELECT 1 FROM STOPCARDENTRYCATEGORYCOMMENTS WHERE CARDID = @CARDID AND MAINCATEGORYID = SCO.MAINCATEGORYID AND SUBCATEGORYID = 0) OR EXISTS(SELECT 1 FROM STOPCARDENTRYATTACHMENTS WHERE CARDID = @CARDID AND MAINCATEGORYID = SCO.MAINCATEGORYID AND SUBCATEGORYID = 0 ) THEN 1 ELSE 0 END [COMMENTEXISTS]
,(SELECT MIN(ID) FROM #FINALRESULTS A WHERE A.MAINCATEGORYID = SCO.MAINCATEGORYID) STARTINDEX
,(SELECT MAX(ID) FROM #FINALRESULTS B WHERE B.MAINCATEGORYID = SCO.MAINCATEGORYID) ENDINDEX
,(SELECT TOP 1 ALLSAFECHECK FROM #FINALRESULTS C WHERE C.CHECKLISTSETUPID = CS.CHECKLISTSETUPID) ALLSAFECHECK
,CSCA.MAINSEQUENCE
FROM STOPCARDENTRY SCE
INNER JOIN STOPCARDENTRYOBSERVATIONS SCO ON SCO.CARDID=SCE.CARDID
INNER JOIN CHECKLISTSETUP CS ON CS.CHECKLISTSETUPID=SCE.CHECKLISTSETUPID
INNER JOIN CHECKLISTSETUPCATEGORYASSIGNMENTS CSCA ON CSCA.CHECKLISTSETUPID=CS.CHECKLISTSETUPID AND SCO.MAINCATEGORYID=CSCA.MAINCATEGORYID AND SCO.SUBCATEGORYID=CSCA.SUBCATEGORYID
INNER JOIN MAINCATEGORIES M ON M.MAINCATEGORYID=CSCA.MAINCATEGORYID
INNER JOIN SUBCATEGORIES S ON S.MAINCATEGORYID=CSCA.MAINCATEGORYID AND S.SUBCATEGORYID=CSCA.SUBCATEGORYID
INNER JOIN ENTITYTRANSLATION ET ON ET.ENTITYID = SCO.MAINCATEGORYID AND ET.ENTITYTYPE='MAIN_CTG' AND ET.LANGUAGEID IN (SELECT UI.LANGUAGEID FROM USERINFO UI WHERE UI.USERID = @USERID)
WHERE SCO.CARDID = @CARDID  AND M.STATUS!=2 AND S.STATUS!=2
AND CS.CHECKLISTSETUPID=@CHECKLISTSETUPID) A ORDER BY MAINSEQUENCE

SELECT MAINCATEGORYID ,SUBCATEGORYID ,SUBCATEGORYNAME,MAINCATEGORYNAME,SAFE,UNSAFE,SAFECOMMENTS,UNSAFECOMMENTS,COMMENTEXISTS,ALLSAFECHECK,OBSCAEXISTS,CORRACTIONID,CAFROMOBS FROM #FINALRESULTS ORDER BY MAINSEQUENCE,SUBSEQUENCE,MAINCATEGORYID,SUBCATEGORYID
END
DROP TABLE #FINALRESULTS

SELECT
SC.[SITEID],[SITENAME] + CASE WHEN S.STATUS=0 THEN '( InActive )' ELSE '' END SITENAME
,CONVERT(NVARCHAR(32),[OBSERVATIONDATE],@DATEFORMAT)[OBSERVATIONDATE]
,SC.[CHECKLISTSETUPID]
,@MULTIPLEOBS [OBSERVER]
,[SETUPNAME] + CASE WHEN CS.STATUS=0 THEN '( InActive )' WHEN EXISTS(SELECT 1 FROM CHECKLISTSETUPSITES WHERE SITEID=SC.SITEID AND CHECKLISTSETUPID=SC.CHECKLISTSETUPID AND STATUS=0) THEN ' ( Unassigned )' ELSE '' END [SETUPNAME]
,[AREAID],
(SELECT AREANAME FROM AREAS WHERE AREAID=SC.AREAID)[AREA]
,[SHIFTID],
(SELECT SHIFTNAME FROM SHIFTS WHERE SHIFTID=SC.SHIFTID)[SHIFT]
,[LENGTH]
,[PEOPLECONTACTED]
,[PEOPLEOBSERVED]
,[SAFECOMMENTS]
,[UNSAFECOMMENTS]
,CASE WHEN SC.STATUS=0 THEN 'LBLINACTIVE' ELSE 'LBLACTIVE' END [STATUS]
,CS.ENABLESAFEUNSAFE
,@EXPANDCATEGORY EXPANDCATEGORY
,ISINCOMPLETEOBS
,@CREATECA CREATECA
FROM [STOPCARDENTRY]SC
INNER JOIN SITES S
ON SC.SITEID = S.SITEID
INNER JOIN CHECKLISTSETUP CS
ON SC.CHECKLISTSETUPID = CS.CHECKLISTSETUPID
WHERE CARDID = @CARDID
END
ELSE IF @OBSAPPROVALPC=1
BEGIN
IF NOT EXISTS(SELECT 1 FROM STOPCARDENTRYOBSERVATIONS_OL WHERE CARDID = @CARDID)
BEGIN

INSERT INTO #FINALRESULTS(CHECKLISTSETUPID,MAINCATEGORYID,SUBCATEGORYID,SUBSEQUENCE,MAINSEQUENCE,MAINCATEGORYNAME,SUBCATEGORYNAME,SAFE,UNSAFE,COMMENTEXISTS,ALLSAFECHECK)
SELECT DISTINCT CS.CHECKLISTSETUPID,CSC.MAINCATEGORYID,CSC.SUBCATEGORYID,CSC.SUBSEQUENCE,CSC.MAINSEQUENCE,ET1.ENTITYVALUE MAINCATEGORYNAME,ET.ENTITYVALUE [SUBCATEGORYNAME],0 [SAFE],0 [UNSAFE],
CASE WHEN EXISTS(SELECT 1 FROM STOPCARDENTRYCATEGORYCOMMENTS_OL WHERE CARDID = @CARDID AND MAINCATEGORYID = CSC.MAINCATEGORYID AND SUBCATEGORYID=CSC.SUBCATEGORYID ) OR EXISTS(SELECT 1 FROM STOPCARDENTRYATTACHMENTS_OL WHERE CARDID = @CARDID AND MAINCATEGORYID = CSC.MAINCATEGORYID AND SUBCATEGORYID=CSC.SUBCATEGORYID) THEN 1 ELSE 0 END [COMMENTEXISTS]
,CS.ALLSAFECHECK
FROM CHECKLISTSETUP CS
INNER JOIN CHECKLISTSETUPCATEGORYASSIGNMENTS CSC ON CS.CHECKLISTSETUPID=CSC.CHECKLISTSETUPID
INNER JOIN MAINCATEGORIES M ON M.MAINCATEGORYID=CSC.MAINCATEGORYID
INNER JOIN SUBCATEGORIES S ON S.MAINCATEGORYID=CSC.MAINCATEGORYID AND S.SUBCATEGORYID=CSC.SUBCATEGORYID
INNER JOIN ENTITYTRANSLATION ET ON ET.PARENTID=CSC.MAINCATEGORYID AND ET.ENTITYID = CSC.SUBCATEGORYID AND ET.ENTITYTYPE='SUB_CTG' AND ET.LANGUAGEID IN (SELECT UI.LANGUAGEID FROM USERINFO UI WHERE UI.USERID = @USERID)
INNER JOIN ENTITYTRANSLATION ET1 ON ET1.PARENTID=CSC.MAINCATEGORYID  AND ET1.ENTITYTYPE='MAIN_CTG' AND ET1.LANGUAGEID IN (SELECT UI.LANGUAGEID FROM USERINFO UI WHERE UI.USERID = @USERID)
WHERE M.STATUS=1 AND S.STATUS=1 AND CS.STATUS IN (0,1,3) AND CSC.MAINISASSIGNED = 1 AND CSC.SUBISASSIGNED = 1
AND CS.CHECKLISTSETUPID=@CHECKLISTSETUPID
ORDER BY MAINSEQUENCE

SELECT MAINCATEGORYID,[MAINCATEGORYNAME],[COMMENTEXISTS],STARTINDEX,ENDINDEX,ALLSAFECHECK FROM(
SELECT DISTINCT CSC.MAINCATEGORYID,ET.ENTITYVALUE [MAINCATEGORYNAME],
CASE WHEN EXISTS(SELECT 1 FROM STOPCARDENTRYCATEGORYCOMMENTS_OL WHERE CARDID = @CARDID AND MAINCATEGORYID = CSC.MAINCATEGORYID AND SUBCATEGORYID = 0) OR EXISTS(SELECT 1 FROM STOPCARDENTRYATTACHMENTS_OL WHERE CARDID = @CARDID AND MAINCATEGORYID = CSC.MAINCATEGORYID AND SUBCATEGORYID = 0 ) THEN 1 ELSE 0 END [COMMENTEXISTS]
,(SELECT MIN(ID) FROM #FINALRESULTS A WHERE A.MAINCATEGORYID = CSC.MAINCATEGORYID) STARTINDEX
,(SELECT MAX(ID) FROM #FINALRESULTS B WHERE B.MAINCATEGORYID = CSC.MAINCATEGORYID) ENDINDEX
,(SELECT TOP 1 ALLSAFECHECK FROM #FINALRESULTS C WHERE C.CHECKLISTSETUPID = CSC.CHECKLISTSETUPID) ALLSAFECHECK
,CSC.MAINSEQUENCE

FROM CHECKLISTSETUP CS
INNER JOIN CHECKLISTSETUPCATEGORYASSIGNMENTS CSC ON CS.CHECKLISTSETUPID=CSC.CHECKLISTSETUPID
INNER JOIN MAINCATEGORIES M ON M.MAINCATEGORYID=CSC.MAINCATEGORYID
INNER JOIN SUBCATEGORIES S ON S.MAINCATEGORYID=CSC.MAINCATEGORYID AND S.SUBCATEGORYID=CSC.SUBCATEGORYID
INNER JOIN ENTITYTRANSLATION ET ON ET.ENTITYID = CSC.MAINCATEGORYID AND ET.ENTITYTYPE='MAIN_CTG' AND ET.LANGUAGEID IN (SELECT UI.LANGUAGEID FROM USERINFO UI WHERE UI.USERID = @USERID)
WHERE M.STATUS IN (1) AND S.STATUS =1 AND CS.STATUS IN (0,1,3) AND CSC.MAINISASSIGNED = 1 AND CSC.SUBISASSIGNED = 1
AND CS.CHECKLISTSETUPID=@CHECKLISTSETUPID)A ORDER BY MAINSEQUENCE

SELECT CHECKLISTSETUPID,MAINCATEGORYID,SUBCATEGORYID,SUBSEQUENCE,SUBCATEGORYNAME,MAINCATEGORYNAME,SAFE,UNSAFE,'' SAFECOMMENTS,'' UNSAFECOMMENTS,COMMENTEXISTS,OBSCAEXISTS,CORRACTIONID,CAFROMOBS FROM #FINALRESULTS ORDER BY MAINSEQUENCE,SUBSEQUENCE,MAINCATEGORYID,SUBCATEGORYID

END
ELSE
BEGIN

SELECT @MULTIPLEOBS=@MULTIPLEOBS+LASTNAME+' '+FIRSTNAME+', '
FROM USERS U
INNER JOIN STOPCARDENTRYOBSERVERS_OL SCO ON SCO.OBSERVERID=U.USERID
WHERE SCO.CARDID=@CARDID
IF LEN(ISNULL(@MULTIPLEOBS,''))>1
SELECT @MULTIPLEOBS=SUBSTRING(@MULTIPLEOBS,1,LEN(@MULTIPLEOBS)-1)

INSERT INTO #FINALRESULTS(CHECKLISTSETUPID,MAINCATEGORYID ,SUBCATEGORYID ,MAINCATEGORYNAME,SUBCATEGORYNAME,SAFE,UNSAFE,SAFECOMMENTS,UNSAFECOMMENTS,COMMENTEXISTS,ALLSAFECHECK,SUBSEQUENCE,MAINSEQUENCE)
SELECT DISTINCT CS.CHECKLISTSETUPID,SCO.MAINCATEGORYID,SCO.SUBCATEGORYID,ET1.ENTITYVALUE [MAINCATEGORYNAME],ET.ENTITYVALUE [SUBCATEGORYNAME],SCO.SAFE,SCO.UNSAFE,SCC.SAFECOMMENTS,SCC.UNSAFECOMMENTS,
CASE WHEN EXISTS(SELECT 1 FROM STOPCARDENTRYCATEGORYCOMMENTS_OL WHERE CARDID = @CARDID AND MAINCATEGORYID = SCO.MAINCATEGORYID AND SUBCATEGORYID=SCO.SUBCATEGORYID ) OR EXISTS(SELECT 1 FROM STOPCARDENTRYATTACHMENTS_OL WHERE CARDID = @CARDID AND MAINCATEGORYID = SCO.MAINCATEGORYID AND SUBCATEGORYID=SCO.SUBCATEGORYID) THEN 1 ELSE 0 END [COMMENTEXISTS]
,CS.ALLSAFECHECK,CSCA.SUBSEQUENCE,CSCA.MAINSEQUENCE
FROM STOPCARDENTRY_OL SCE
INNER JOIN STOPCARDENTRYOBSERVATIONS_OL SCO ON SCO.CARDID=SCE.CARDID
LEFT JOIN STOPCARDENTRYCATEGORYCOMMENTS_OL SCC ON SCC.CARDID=SCE.CARDID AND SCO.MAINCATEGORYID=SCC.MAINCATEGORYID AND SCO.SUBCATEGORYID=SCC.SUBCATEGORYID
INNER JOIN CHECKLISTSETUP CS ON CS.CHECKLISTSETUPID=SCE.CHECKLISTSETUPID
INNER JOIN CHECKLISTSETUPCATEGORYASSIGNMENTS CSCA ON CSCA.CHECKLISTSETUPID=CS.CHECKLISTSETUPID AND SCO.MAINCATEGORYID=CSCA.MAINCATEGORYID AND SCO.SUBCATEGORYID=CSCA.SUBCATEGORYID
INNER JOIN MAINCATEGORIES M ON M.MAINCATEGORYID=CSCA.MAINCATEGORYID
INNER JOIN SUBCATEGORIES S ON S.MAINCATEGORYID=CSCA.MAINCATEGORYID AND S.SUBCATEGORYID=CSCA.SUBCATEGORYID
INNER JOIN ENTITYTRANSLATION ET ON ET.PARENTID=SCO.MAINCATEGORYID AND ET.ENTITYID = SCO.SUBCATEGORYID AND ET.ENTITYTYPE='SUB_CTG' AND ET.LANGUAGEID IN (SELECT UI.LANGUAGEID FROM USERINFO UI WHERE UI.USERID = @USERID)
INNER JOIN ENTITYTRANSLATION ET1 ON ET1.PARENTID=SCO.MAINCATEGORYID  AND ET1.ENTITYTYPE='MAIN_CTG' AND ET1.LANGUAGEID IN (SELECT UI.LANGUAGEID FROM USERINFO UI WHERE UI.USERID = @USERID)
WHERE SCO.CARDID = @CARDID AND M.STATUS !=2 AND S.STATUS!=2
AND CS.CHECKLISTSETUPID=@CHECKLISTSETUPID
ORDER BY MAINSEQUENCE

SELECT MAINCATEGORYID,[MAINCATEGORYNAME],[COMMENTEXISTS],STARTINDEX,ENDINDEX,ALLSAFECHECK FROM(
SELECT DISTINCT SCO.MAINCATEGORYID,ET.ENTITYVALUE [MAINCATEGORYNAME],
CASE WHEN EXISTS(SELECT 1 FROM STOPCARDENTRYCATEGORYCOMMENTS_OL WHERE CARDID = @CARDID AND MAINCATEGORYID = SCO.MAINCATEGORYID AND SUBCATEGORYID = 0) OR EXISTS(SELECT 1 FROM STOPCARDENTRYATTACHMENTS_OL WHERE CARDID = @CARDID AND MAINCATEGORYID = SCO.MAINCATEGORYID AND SUBCATEGORYID = 0 ) THEN 1 ELSE 0 END [COMMENTEXISTS]
,(SELECT MIN(ID) FROM #FINALRESULTS A WHERE A.MAINCATEGORYID = SCO.MAINCATEGORYID) STARTINDEX
,(SELECT MAX(ID) FROM #FINALRESULTS B WHERE B.MAINCATEGORYID = SCO.MAINCATEGORYID) ENDINDEX
,(SELECT TOP 1 ALLSAFECHECK FROM #FINALRESULTS C WHERE C.CHECKLISTSETUPID = CS.CHECKLISTSETUPID) ALLSAFECHECK
,CSCA.MAINSEQUENCE
FROM STOPCARDENTRY_OL SCE
INNER JOIN STOPCARDENTRYOBSERVATIONS_OL SCO ON SCO.CARDID=SCE.CARDID
INNER JOIN CHECKLISTSETUP CS ON CS.CHECKLISTSETUPID=SCE.CHECKLISTSETUPID
INNER JOIN CHECKLISTSETUPCATEGORYASSIGNMENTS CSCA ON CSCA.CHECKLISTSETUPID=CS.CHECKLISTSETUPID AND SCO.MAINCATEGORYID=CSCA.MAINCATEGORYID AND SCO.SUBCATEGORYID=CSCA.SUBCATEGORYID
INNER JOIN MAINCATEGORIES M ON M.MAINCATEGORYID=CSCA.MAINCATEGORYID
INNER JOIN SUBCATEGORIES S ON S.MAINCATEGORYID=CSCA.MAINCATEGORYID AND S.SUBCATEGORYID=CSCA.SUBCATEGORYID
INNER JOIN ENTITYTRANSLATION ET ON ET.ENTITYID = SCO.MAINCATEGORYID AND ET.ENTITYTYPE='MAIN_CTG' AND ET.LANGUAGEID IN (SELECT UI.LANGUAGEID FROM USERINFO UI WHERE UI.USERID = @USERID)
WHERE SCO.CARDID = @CARDID
AND M.STATUS!=2 AND S.STATUS!=2
AND CS.CHECKLISTSETUPID=@CHECKLISTSETUPID) A ORDER BY MAINSEQUENCE

SELECT MAINCATEGORYID ,SUBCATEGORYID ,SUBCATEGORYNAME,MAINCATEGORYNAME,SAFE,UNSAFE,SAFECOMMENTS,UNSAFECOMMENTS,COMMENTEXISTS,ALLSAFECHECK,OBSCAEXISTS,CORRACTIONID,CAFROMOBS FROM #FINALRESULTS ORDER BY MAINSEQUENCE,SUBSEQUENCE,MAINCATEGORYID,SUBCATEGORYID
END
DROP TABLE #FINALRESULTS

SELECT
SC.[SITEID],[SITENAME] + CASE WHEN S.STATUS=0 THEN '( InActive )' ELSE '' END SITENAME
,CONVERT(NVARCHAR(32),[OBSERVATIONDATE],@DATEFORMAT)[OBSERVATIONDATE]
,SC.[CHECKLISTSETUPID]
,@MULTIPLEOBS [OBSERVER]
,[SETUPNAME] + CASE WHEN CS.STATUS=0 THEN '( InActive )' WHEN EXISTS(SELECT 1 FROM CHECKLISTSETUPSITES WHERE SITEID=SC.SITEID AND CHECKLISTSETUPID=SC.CHECKLISTSETUPID AND STATUS=0) THEN ' ( Unassigned )' ELSE '' END [SETUPNAME]
,[AREAID],
(SELECT AREANAME FROM AREAS WHERE AREAID=SC.AREAID)[AREA]
,[SHIFTID],
(SELECT SHIFTNAME FROM SHIFTS WHERE SHIFTID=SC.SHIFTID)[SHIFT]
,[LENGTH]
,[PEOPLECONTACTED]
,[PEOPLEOBSERVED]
,[SAFECOMMENTS]
,[UNSAFECOMMENTS]
,CASE WHEN SC.STATUS=0 THEN 'LBLINACTIVE' ELSE 'LBLACTIVE' END [STATUS]
,CS.ENABLESAFEUNSAFE
,@EXPANDCATEGORY EXPANDCATEGORY
,ISINCOMPLETEOBS
,0 CREATECA
FROM [STOPCARDENTRY_OL]SC
INNER JOIN SITES S
ON SC.SITEID = S.SITEID
INNER JOIN CHECKLISTSETUP CS
ON SC.CHECKLISTSETUPID = CS.CHECKLISTSETUPID
WHERE CARDID = @CARDID
END
