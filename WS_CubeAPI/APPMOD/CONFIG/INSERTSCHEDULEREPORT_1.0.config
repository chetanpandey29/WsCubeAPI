DECLARE @SCHEDULEID INT,@TIMEZONEDURATION INT
IF EXISTS(SELECT 1 FROM SCHEDULE WHERE SCHEDULENAME=@SCHEDULENAME AND STATUS!=2 AND SCHEDULETYPEID=9)
SELECT -1
ELSE
BEGIN
SELECT @TIMEZONEDURATION=DURATION FROM TIMEZONES WHERE TIMEZONEID=@TIMEZONE

INSERT INTO SCHEDULE(COMPANYID,SCHEDULENAME,SCHEDULETYPEID,DUPLICATEMAILFROM,REPLYTO,EMAILTO,CC,SUBJECT,BODY,REPORTID,DESIGNID,EXPORTTYPE,EXPORTFORMAT,STATUS,CREATEDBY,CREATEDDATE) VALUES
(@COMPANYID,@SCHEDULENAME,9,-1,'NOREPLY@DUPONT40.COM',@EMAILTO,@CC,@SUBJECT,@BODY,@REPORTID,@DESIGNID,@EXPORTTYPE,@EXPORTFORMAT,@STATUS,@CREATEDBY,GETDATE())
SELECT @SCHEDULEID=@@IDENTITY

IF EXISTS (SELECT 1 FROM SCHEDULETYPES WHERE SCHEDULETYPEID='9' AND ISEMAIL=1)
IF @DWM > 0
INSERT INTO SCHEDULEOPTIONS(SCHEDULEID,DWM,EVERYDWM,[DAY],[MONTH],STARTDATE,ENDDATE,TIMEZONE,STARTTIME,DAYLIST,RELATIVEFOR,RELATIVEOPTION,RELATIVEOPTIONTYPE,
PREVIOUSVALUE,TILLDATE,TIMEZONEDURATION) VALUES
(@SCHEDULEID,@DWM,@EVERYDWM,@DAY,@MONTH,@STARTDATE,@ENDDATE,@TIMEZONE,@STARTTIME,@DAYLIST,@RELATIVEFOR,@RELATIVEOPTION,@RELATIVEOPTIONTYPE,@PREVIOUSVALUE,@TILLDATE,@TIMEZONEDURATION)

DECLARE @D INT

IF(CONVERT(VARCHAR(11),@STARTDATE,101)>GETDATE())
BEGIN
      IF @DWM=1 AND @EVERYDWM>0
      BEGIN
            SELECT @D=DAY(CAST(@STARTDATE AS DATETIME)) 
            IF @D<@EVERYDWM AND MONTH(CAST(@STARTDATE AS DATETIME))=MONTH(GETDATE())
                  SELECT @SCHEDULEID,dbo.[USERTIMEEMAIL](DATEADD(DD,@EVERYDWM-@D,@STARTDATE),@STARTTIME,@TIMEZONEDURATION)
			ELSE IF @D=@EVERYDWM AND  (DATEPART(hh,GETDATE())*60.0)+ DATEPART(mi,GETDATE())> CAST(@STARTTIME AS INT)
				  SELECT @SCHEDULEID,dbo.[USERTIMEEMAIL](DATEADD(MM,1,CAST(@STARTDATE AS DATETIME)),@STARTTIME,@TIMEZONEDURATION)
	        ELSE IF @D>@EVERYDWM
            BEGIN
			      SELECT @D=DAY(DATEADD(MM,1,CAST(@STARTDATE AS DATETIME)))
                  SELECT @SCHEDULEID,dbo.[USERTIMEEMAIL](DATEADD(DD,@EVERYDWM-@D,DATEADD(MM,1,CAST(@STARTDATE AS DATETIME))),@STARTTIME,@TIMEZONEDURATION)
            END
            ELSE
                  SELECT @SCHEDULEID,dbo.[USERTIMEEMAIL](@STARTDATE,@STARTTIME,@TIMEZONEDURATION)      
                  
      END
      ELSE
            SELECT @SCHEDULEID,dbo.[USERTIMEEMAIL](@STARTDATE,@STARTTIME,@TIMEZONEDURATION)

END
ELSE
BEGIN
      IF @DWM=1 AND @EVERYDWM>0
      BEGIN
            SELECT @D=DAY(GETDATE())
            IF @D<@EVERYDWM
                  SELECT @SCHEDULEID,dbo.[USERTIMEEMAIL](DATEADD(DD,@EVERYDWM-@D,GETDATE()),@STARTTIME,@TIMEZONEDURATION)
            ELSE IF @D=@EVERYDWM AND  (DATEPART(hh,GETDATE())*60.0)+ DATEPART(mi,GETDATE())> CAST(@STARTTIME AS INT)
                          SELECT @SCHEDULEID,dbo.[USERTIMEEMAIL](DATEADD(MM,1,CAST(GETDATE() AS DATETIME)),@STARTTIME,@TIMEZONEDURATION)
            ELSE IF @D>@EVERYDWM
            BEGIN 
                  SELECT @D=DAY(DATEADD(MM,1,GETDATE()))
                  SELECT @SCHEDULEID,dbo.[USERTIMEEMAIL](DATEADD(DD,@EVERYDWM-@D,DATEADD(MM,1,GETDATE())),@STARTTIME,@TIMEZONEDURATION)
            END
            ELSE
                  SELECT @SCHEDULEID,dbo.[USERTIMEEMAIL](GETDATE(),@STARTTIME,@TIMEZONEDURATION)
      END
      ELSE
            SELECT @SCHEDULEID,dbo.[USERTIMEEMAIL](GETDATE(),@STARTTIME,@TIMEZONEDURATION)
END
END



DECLARE @TAB TABLE(ID INT IDENTITY(1,1),COL VARCHAR(MAX))
DECLARE @TEMP INT,@OPTIONID INT,@OPTIONLIST VARCHAR(MAX)
SET @TEMP = 1
INSERT INTO @TAB
SELECT ITEM
FROM dbo.FNSPLIT(@OPTIONVALUE,';')
IF @SCHEDULEID>0
BEGIN
IF EXISTS (SELECT 1 FROM SCHEDULEASSIGNMENTS WHERE SCHEDULEID=@SCHEDULEID AND OPTIONID=@OPTIONID)
DELETE FROM SCHEDULEASSIGNMENTS WHERE SCHEDULEID=@SCHEDULEID AND OPTIONID=@OPTIONID
ELSE
BEGIN
WHILE @TEMP < =(SELECT MAX(ID) FROM @TAB)
          BEGIN
              SELECT @OPTIONID=OPTIONID FROM REPORTOPTIONSMASTER WHERE REPORTPARAM=(SELECT SUBSTRING(COL,1,CHARINDEX('=',COL)-1) FROM @TAB WHERE ID = @TEMP)
              SELECT @OPTIONLIST=SUBSTRING(COL,CHARINDEX('=',COL)+1,LEN(COL)) FROM @TAB WHERE ID = @TEMP
              INSERT INTO SCHEDULEASSIGNMENTS(SCHEDULEID,OPTIONID,OPTIONVALUE)
              SELECT @SCHEDULEID,@OPTIONID,RESULT FROM DBO.CSVtoTable(@OPTIONLIST)
              SET @TEMP = @TEMP +1
          END
     END
END

