DECLARE @CC_TIMESTAMP DATETIME
SET @CC_TIMESTAMP=GETDATE()


DECLARE @TAB TABLE(ID INT IDENTITY(1,1),COL VARCHAR(MAX))
DECLARE @TEMP INT,@OPTIONID INT,@OPTIONLIST VARCHAR(MAX),@SOSTARTTIME VARCHAR(16),@TIMEZONEDURATION INT
DECLARE @SCHEDULETYPEID INT
SET @SOSTARTTIME=''
SELECT @SOSTARTTIME=STARTTIME,@TIMEZONEDURATION=TIMEZONEDURATION FROM SCHEDULEOPTIONS WHERE SCHEDULEID=@SCHEDULEID
SELECT @SCHEDULETYPEID=SCHEDULETYPEID FROM SCHEDULE WHERE SCHEDULEID = @SCHEDULEID

DECLARE @PMAINTOBESENT DATETIME, @PDURATION INT
DECLARE @TIMEZONES TABLE(DURATION INT,MAINTOBESENT DATETIME)



IF EXISTS(SELECT 1 FROM SCHEDULE WHERE SCHEDULEID!=@SCHEDULEID AND SCHEDULENAME=@SCHEDULENAME AND [STATUS]!=2 )
SELECT -1,'',''
ELSE
BEGIN

UPDATE SCHEDULE SET SCHEDULENAME=@SCHEDULENAME,REPLYTO=@REPLYTO,CC=@CC,[SUBJECT]=@SUBJECT,BODY=@BODY,[STATUS]=@STATUS,
UPDATEDBY=@UPDATEDBY,UPDATEDDATE=@CC_TIMESTAMP WHERE SCHEDULEID=@SCHEDULEID;
UPDATE SCHEDULEOPTIONS SET DWM=@DWM,EVERYDWM=@EVERYDWM,[DAY]=@DAY,[MONTH]=@MONTH,STARTDATE=GETUTCDATE(),ENDDATE=DATEADD(YYYY,10,GETUTCDATE()),STARTTIME=@STARTTIME,MAXEMAILS=@MAXEMAILS,
DAYLIST=@DAYLIST,PRIORNOTDAYS=@PRIORNOTDAYS WHERE SCHEDULEID = @SCHEDULEID

INSERT INTO @TIMEZONES(DURATION,MAINTOBESENT)
SELECT DURATION,dbo.USERTIMEEMAIL(GETUTCDATE(),@STARTTIME,DURATION) FROM TIMEZONES WHERE STATUS = 1  ORDER BY DURATION DESC


IF @SOSTARTTIME<>@STARTTIME
BEGIN

SELECT @PMAINTOBESENT=MIN(MAINTOBESENT) FROM @TIMEZONES WHERE MAINTOBESENT > = GETUTCDATE()
SELECT TOP 1 @PDURATION=DURATION FROM @TIMEZONES WHERE MAINTOBESENT=@PMAINTOBESENT ORDER BY MAINTOBESENT
IF @PDURATION IS NULL
SELECT @PDURATION=MIN(DURATION) FROM TIMEZONES WHERE STATUS=1

UPDATE SCHEDULEOPTIONS SET TIMEZONEDURATION=@PDURATION WHERE SCHEDULEID = @SCHEDULEID

IF @SCHEDULETYPEID IN (1,2) AND @EVERYDWM >1 AND @DWM=1
SELECT @SCHEDULEID,DATEADD(DD,CAST(@EVERYDWM AS INT)-1,@PMAINTOBESENT) TOKENSENTDATE,@PDURATION
ELSE
SELECT @SCHEDULEID,@PMAINTOBESENT TOKENSENTDATE,@PDURATION

END
ELSE
BEGIN

IF @SCHEDULETYPEID IN (1,2) AND @EVERYDWM >1 AND @DWM=1
SELECT @SCHEDULEID,DATEADD(DD,CAST(@EVERYDWM AS INT)-1,ISNULL(@PMAINTOBESENT,GETUTCDATE())) TOKENSENTDATE,@TIMEZONEDURATION
ELSE IF @SCHEDULETYPEID IN (1,2) AND @EVERYDWM =1 AND @DWM=1
SELECT @SCHEDULEID,(SELECT MIN(MAINTOBESENT) FROM @TIMEZONES) TOKENSENTDATE,@TIMEZONEDURATION
ELSE
SELECT @SCHEDULEID,NULL TOKENSENTDATE,@TIMEZONEDURATION

END
SET @TEMP = 1
INSERT INTO @TAB
SELECT ITEM
FROM dbo.FNSPLIT(@OPTIONVALUE,';')

IF EXISTS (SELECT 1 FROM SCHEDULEASSIGNMENTS WHERE SCHEDULEID=@SCHEDULEID)
DELETE FROM SCHEDULEASSIGNMENTS WHERE SCHEDULEID=@SCHEDULEID

WHILE @TEMP < =(SELECT MAX(ID) FROM @TAB)
          BEGIN
              SELECT @OPTIONID=OPTIONID FROM REPORTOPTIONSMASTER WHERE REPORTPARAM=(SELECT SUBSTRING(COL,1,CHARINDEX('=',COL)-1) FROM @TAB WHERE ID = @TEMP)
              SELECT @OPTIONLIST=SUBSTRING(COL,CHARINDEX('=',COL)+1,LEN(COL)) FROM @TAB WHERE ID = @TEMP
              INSERT INTO SCHEDULEASSIGNMENTS(SCHEDULEID,OPTIONID,OPTIONVALUE)
              SELECT @SCHEDULEID,@OPTIONID,RESULT FROM DBO.CSVtoTable(@OPTIONLIST)
              SET @TEMP = @TEMP +1
          END


END


INSERT INTO dbo.AUDIT(TABLENAME,TRANS,STAMP,LASTUPDATEDBY,DATA)
SELECT 'SCHEDULE/SCHEDULEOPTIONS/SCHEDULEASSIGNMENTS','UPDATE-UPDATEMAILINFO_1.0',@CC_TIMESTAMP,@UPDATEDBY,NULL
