DECLARE @CC_TIMESTAMP DATETIME
SET @CC_TIMESTAMP=GETDATE()
IF EXISTS(SELECT 1 FROM STOPCARDENTRY_OL WHERE CARDID=@CARDID AND EDITOR=1)
SELECT -4
ELSE
BEGIN
IF NOT EXISTS( SELECT 1 FROM STOPCARDENTRYOBSERVATIONS_OL WHERE CARDID=@CARDID)
BEGIN
INSERT INTO dbo.STOPCARDENTRYOBSERVATIONS_OL(CARDID,MAINCATEGORYID,SUBCATEGORYID,SAFE,UNSAFE,
STATUS,UPDATEDBY,UPDATEDDATE)
SELECT @CARDID,
TEMPOBSVATION.ITEM.value('@MAINCATEGORYID','BIGINT'),
TEMPOBSVATION.ITEM.value('@SUBCATEGORYID','BIGINT'),
TEMPOBSVATION.ITEM.value('@SAFE','INT'),
TEMPOBSVATION.ITEM.value('@UNSAFE','INT'),
1,@UPDATEDBY,@CC_TIMESTAMP
FROM @XMLOBSVATION.nodes('/ROOT/ROW') AS TEMPOBSVATION(ITEM)
END

ELSE
BEGIN
UPDATE STOPCARDENTRYOBSERVATIONS_OL SET
SAFE=TEMPOBSVATION.ITEM.value('@SAFE','INT'),
UNSAFE=TEMPOBSVATION.ITEM.value('@UNSAFE','INT'),
UPDATEDBY=@UPDATEDBY,UPDATEDDATE=@CC_TIMESTAMP
FROM STOPCARDENTRYOBSERVATIONS_OL SCO
INNER JOIN @XMLOBSVATION.nodes('/ROOT/ROW') AS TEMPOBSVATION(ITEM) ON
TEMPOBSVATION.ITEM.value('@MAINCATEGORYID','BIGINT')=SCO.MAINCATEGORYID AND
TEMPOBSVATION.ITEM.value('@SUBCATEGORYID','BIGINT')=SCO.SUBCATEGORYID
WHERE CARDID = @CARDID

END
UPDATE STOPCARDENTRY_OL SET ISINCOMPLETEOBS=0,UPDATEDBY=@UPDATEDBY,UPDATEDDATE=@CC_TIMESTAMP WHERE CARDID = @CARDID
SELECT @CARDID

INSERT INTO dbo.AUDIT(TABLENAME,TRANS,STAMP,LASTUPDATEDBY,DATA)
SELECT 'STOPCARDENTRYOBSERVATIONS_OL','INSERT-INSERTOFFLINESTOPCARDOBSERVATIONS_1.0',@CC_TIMESTAMP,@UPDATEDBY,NULL
END