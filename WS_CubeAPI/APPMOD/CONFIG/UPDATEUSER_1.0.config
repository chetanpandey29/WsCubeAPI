--UPDATEUSER_1.0
DECLARE @CC_TIMESTAMP DATETIME
SET @CC_TIMESTAMP=GETDATE()


DECLARE @COUSERSCOUNT INT
SELECT @COUSERSCOUNT=CASE WHEN OPTIONVALUE ='' THEN 0 ELSE CAST(OPTIONVALUE AS INT) END FROM COMPANYOPTIONS WHERE OPTIONNAME='MaxUserCount'

DECLARE @PWDUPDATE TINYINT,@OLDUSERTYPEID INT
SELECT @OLDUSERTYPEID=USERTYPEID FROM USERINFO WHERE USERID = @USERID
SET @PWDUPDATE=0
IF (SELECT DBO.FN40DECRYPT(PASSWORD) FROM USERS WHERE USERID =@USERID) != @PASSWORD
SELECT @PWDUPDATE=1

IF @USERTYPEID = 1
BEGIN
IF EXISTS(SELECT 1 FROM USERS WHERE USERID = @USERID AND STATUS=4)
UPDATE USERINFO SET LOGINATTEMPTS=0,UPDATEDBY = @UPDATEDBY, UPDATEDDATE = @CC_TIMESTAMP WHERE USERID = @USERID
UPDATE USERS  SET USERNAME=CASE WHEN @USERTYPEID = 1 THEN
(CASE WHEN ISNULL(@USERNAME,'') ='' THEN SUBSTRING(@LASTNAME,1,4)+SUBSTRING(@FIRSTNAME,1,1)+CAST(@USERID AS VARCHAR(8)) ELSE @USERNAME END)
ELSE @USERNAME END ,FIRSTNAME=@FIRSTNAME,LASTNAME=@LASTNAME,EMAIL=@EMAIL,[PASSWORD]=DBO.FN40ENCRYPT(@PASSWORD),
[STATUS]=@STATUS,UPDATEDBY = @UPDATEDBY, UPDATEDDATE = @CC_TIMESTAMP WHERE USERID=@USERID;

UPDATE USERINFO SET JOBTITLE=@JOBTITLE,USERTYPEID=@USERTYPEID,PASSWORDLASTUPDATE=@CC_TIMESTAMP,
LANGUAGEID=@LANGUAGEID,TIMEZONE=(SELECT TIMEZONEID FROM SITES WHERE SITEID=@DEFAULTSITEID),DATEFORMAT=@DATEFORMAT,OFFLINEACCESS=@OFFLINEACCESS,
APPROVEOFFLINE=@APPROVEOFFLINE,DEFAULTROLEID=@DEFAULTROLEID,DEFAULTSITEID=@DEFAULTSITEID,UPDATEDBY = @UPDATEDBY, UPDATEDDATE = @CC_TIMESTAMP
WHERE USERID=@USERID;

DELETE FROM USERQUICKLINKS WHERE USERID = @USERID AND ROLEID=@DEFAULTROLEID

INSERT INTO USERQUICKLINKS(USERID,ROLEID,PERMISSIONID,STATUS,CREATEDBY,CREATEDDATE)
SELECT TOP 5 @USERID,ROLEID,PERMISSIONID,1,@UPDATEDBY,@CC_TIMESTAMP FROM ROLEPERMISSIONS WHERE ROLEID = @DEFAULTROLEID AND PERMISSIONVALUE=1

--USERGROUPS
UPDATE UG SET UG.STATUS = 1, UG.UPDATEDBY = @UPDATEDBY, UG.UPDATEDDATE = @CC_TIMESTAMP
FROM USERGROUPS UG
INNER JOIN GROUPS G ON G.GROUPID = UG.GROUPID AND G.GROUPTYPEID = UG.GROUPTYPEID
WHERE UG.[STATUS] = 0 AND UG.USERID =@USERID AND
G.GROUPID IN (SELECT RESULT FROM DBO.CSVtoTable(@GROUPID));

INSERT INTO USERGROUPS(USERID,GROUPTYPEID,GROUPID,STATUS,UPDATEDBY,UPDATEDDATE)
SELECT @USERID,G.GROUPTYPEID,T.RESULT,1,@UPDATEDBY,@CC_TIMESTAMP FROM DBO.CSVtoTable(@GROUPID) T
INNER JOIN GROUPS G ON G.GROUPID = T.RESULT
WHERE RESULT NOT IN (SELECT GROUPID FROM USERGROUPS WHERE USERID =@USERID);

UPDATE USERGROUPS SET STATUS = 0,UPDATEDBY = @UPDATEDBY,UPDATEDDATE = @CC_TIMESTAMP
WHERE USERID =@USERID AND GROUPID NOT IN (SELECT RESULT FROM DBO.CSVtoTable(@GROUPID))

-- UPDATEUSRROLEASSGN_1.0
DELETE FROM USERROLES WHERE USERID = @USERID
IF @ROLEID!=-1
BEGIN
UPDATE USERROLES SET STATUS = 1,UPDATEDBY = @UPDATEDBY,UPDATEDDATE = @CC_TIMESTAMP
WHERE USERID =@USERID AND  ROLEID IN (SELECT RESULT FROM DBO.CSVtoTable(@ROLEID));

INSERT INTO USERROLES(USERID,ROLEID,STATUS,UPDATEDBY,UPDATEDDATE)
SELECT @USERID,RESULT,1,@UPDATEDBY,@CC_TIMESTAMP FROM DBO.CSVtoTable(@ROLEID)
WHERE RESULT NOT IN (SELECT ROLEID FROM USERROLES WHERE USERID =@USERID);

UPDATE USERROLES SET STATUS = 0,UPDATEDBY = @UPDATEDBY,UPDATEDDATE = @CC_TIMESTAMP
WHERE USERID =@USERID AND  ROLEID NOT IN (SELECT RESULT FROM DBO.CSVtoTable(@ROLEID))
END
-- UPDATEUSERSITEASSGN_1.0
UPDATE USERSITES SET STATUS = 1,UPDATEDBY = @UPDATEDBY,UPDATEDDATE = @CC_TIMESTAMP
WHERE USERID =@USERID AND  SITEID IN (SELECT RESULT FROM DBO.CSVtoTable(@SITEID));
INSERT INTO USERSITES(USERID,SITEID,STATUS,UPDATEDBY,UPDATEDDATE)
SELECT @USERID,RESULT,1,@UPDATEDBY,@CC_TIMESTAMP FROM DBO.CSVtoTable(@SITEID)
WHERE RESULT NOT IN (SELECT SITEID FROM USERSITES WHERE USERID =@USERID);
UPDATE USERSITES SET STATUS = 0,UPDATEDBY = @UPDATEDBY,UPDATEDDATE = @CC_TIMESTAMP
WHERE USERID =@USERID AND  SITEID NOT IN (SELECT RESULT FROM DBO.CSVtoTable(@SITEID))



SELECT CASE WHEN @PWDUPDATE=1 THEN @USERID ELSE 0 END
END

ELSE IF (SELECT COUNT(*) FROM USERS WHERE USERID IN(SELECT USERID FROM USERINFO WHERE USERTYPEID!=1)AND @USERTYPEID!=1 AND STATUS NOT IN(2,3)) >= @COUSERSCOUNT AND @OLDUSERTYPEID = 1 AND @USERTYPEID IN (0,2)
SELECT -4
ELSE IF EXISTS(SELECT 1 FROM USERS WHERE USERID!=@USERID AND USERNAME=@USERNAME AND STATUS!=2)
SELECT -1
ELSE IF EXISTS(SELECT 1 FROM USERS WHERE EMAIL=@EMAIL AND USERID != @USERID AND STATUS!=2)
SELECT -3
ELSE IF NOT EXISTS(SELECT 1 FROM SITES WHERE STATUS = 1 AND SITEID =@DEFAULTSITEID)
SELECT -5
ELSE
BEGIN

IF EXISTS(SELECT 1 FROM USERS WHERE USERID = @USERID AND STATUS=4)
UPDATE USERINFO SET LOGINATTEMPTS=0,UPDATEDBY = @UPDATEDBY, UPDATEDDATE = @CC_TIMESTAMP WHERE USERID = @USERID


UPDATE USERS  SET USERNAME=CASE WHEN @USERTYPEID = 1 THEN
(CASE WHEN ISNULL(@USERNAME,'') ='' THEN SUBSTRING(@LASTNAME,1,4)+SUBSTRING(@FIRSTNAME,1,1)+CAST(@USERID AS VARCHAR(8)) ELSE @USERNAME END)
ELSE @USERNAME END ,FIRSTNAME=@FIRSTNAME,LASTNAME=@LASTNAME,EMAIL=@EMAIL,[PASSWORD]=DBO.FN40ENCRYPT(@PASSWORD),
[STATUS]=@STATUS,UPDATEDBY = @UPDATEDBY, UPDATEDDATE = @CC_TIMESTAMP WHERE USERID=@USERID;

UPDATE USERINFO SET JOBTITLE=@JOBTITLE,USERTYPEID=@USERTYPEID,PASSWORDLASTUPDATE=@CC_TIMESTAMP,
LANGUAGEID=@LANGUAGEID,TIMEZONE=(SELECT TIMEZONEID FROM SITES WHERE SITEID=@DEFAULTSITEID),DATEFORMAT=@DATEFORMAT,OFFLINEACCESS=@OFFLINEACCESS,
APPROVEOFFLINE=@APPROVEOFFLINE,DEFAULTROLEID=@DEFAULTROLEID,DEFAULTSITEID=@DEFAULTSITEID,UPDATEDBY = @UPDATEDBY, UPDATEDDATE = @CC_TIMESTAMP
WHERE USERID=@USERID;

DELETE FROM USERQUICKLINKS WHERE USERID = @USERID AND ROLEID=@DEFAULTROLEID

INSERT INTO USERQUICKLINKS(USERID,ROLEID,PERMISSIONID,STATUS,CREATEDBY,CREATEDDATE)
SELECT TOP 5 @USERID,ROLEID,PERMISSIONID,1,NULL,@CC_TIMESTAMP FROM ROLEPERMISSIONS WHERE ROLEID = @DEFAULTROLEID AND PERMISSIONVALUE=1

--USERGROUPS
UPDATE UG SET UG.STATUS = 1, UG.UPDATEDBY = @UPDATEDBY, UG.UPDATEDDATE = @CC_TIMESTAMP
FROM USERGROUPS UG
INNER JOIN GROUPS G ON G.GROUPID = UG.GROUPID AND G.GROUPTYPEID = UG.GROUPTYPEID
WHERE UG.[STATUS] = 0 AND UG.USERID =@USERID AND
G.GROUPID IN (SELECT RESULT FROM DBO.CSVtoTable(@GROUPID));

INSERT INTO USERGROUPS(USERID,GROUPTYPEID,GROUPID,STATUS,UPDATEDBY,UPDATEDDATE)
SELECT @USERID,G.GROUPTYPEID,T.RESULT,1,@UPDATEDBY,@CC_TIMESTAMP FROM DBO.CSVtoTable(@GROUPID) T
INNER JOIN GROUPS G ON G.GROUPID = T.RESULT
WHERE RESULT NOT IN (SELECT GROUPID FROM USERGROUPS WHERE USERID =@USERID);

UPDATE USERGROUPS SET STATUS = 0,UPDATEDBY = @UPDATEDBY,UPDATEDDATE = @CC_TIMESTAMP
WHERE USERID =@USERID AND GROUPID NOT IN (SELECT RESULT FROM DBO.CSVtoTable(@GROUPID))


--UPDATEUSRROLEASSGN_1.0
DELETE FROM USERROLES WHERE USERID = @USERID
IF @ROLEID!=-1
BEGIN
UPDATE USERROLES SET STATUS = 1,UPDATEDBY = @UPDATEDBY,UPDATEDDATE = @CC_TIMESTAMP
WHERE USERID =@USERID AND  ROLEID IN (SELECT RESULT FROM DBO.CSVtoTable(@ROLEID));

INSERT INTO USERROLES(USERID,ROLEID,STATUS,UPDATEDBY,UPDATEDDATE)
SELECT @USERID,RESULT,1,@UPDATEDBY,@CC_TIMESTAMP FROM DBO.CSVtoTable(@ROLEID)
WHERE RESULT NOT IN (SELECT ROLEID FROM USERROLES WHERE USERID =@USERID);

UPDATE USERROLES SET STATUS = 0,UPDATEDBY = @UPDATEDBY,UPDATEDDATE = @CC_TIMESTAMP
WHERE USERID =@USERID AND  ROLEID NOT IN (SELECT RESULT FROM DBO.CSVtoTable(@ROLEID))
END
--UPDATEUSERSITEASSGN_1.0
UPDATE USERSITES SET STATUS = 1,UPDATEDBY = @UPDATEDBY,UPDATEDDATE = @CC_TIMESTAMP
WHERE USERID =@USERID AND  SITEID IN (SELECT RESULT FROM DBO.CSVtoTable(@SITEID));
INSERT INTO USERSITES(USERID,SITEID,STATUS,UPDATEDBY,UPDATEDDATE)
SELECT @USERID,RESULT,1,@UPDATEDBY,@CC_TIMESTAMP FROM DBO.CSVtoTable(@SITEID)
WHERE RESULT NOT IN (SELECT SITEID FROM USERSITES WHERE USERID =@USERID);
UPDATE USERSITES SET STATUS = 0,UPDATEDBY = @UPDATEDBY,UPDATEDDATE = @CC_TIMESTAMP
WHERE USERID =@USERID AND  SITEID NOT IN (SELECT RESULT FROM DBO.CSVtoTable(@SITEID))



SELECT CASE WHEN @PWDUPDATE=1 THEN @USERID ELSE 0 END
END

IF EXISTS(SELECT 1 FROM TARGETSITES WHERE SITEID=@DEFAULTSITEID)
BEGIN
INSERT INTO dbo.AUDIT(TABLENAME,TRANS,STAMP,LASTUPDATEDBY,DATA)
SELECT 'USERS/USERINFO/USERGROUPS/USERROLES/USERSITES/TARGETUSERS/WEEKLYTARGETUSERS','UPDATE-UPDATEUSER_1.0',@CC_TIMESTAMP,@UPDATEDBY,
(SELECT * FROM TARGETUSERS WHERE USERID=@USERID AND SITEID=@DEFAULTSITEID FOR XML AUTO)

DELETE FROM TARGETUSERS WHERE USERID=@USERID AND SITEID=@DEFAULTSITEID

INSERT INTO TARGETUSERS(SITEID,USERID,YEAR,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC,CREATEDBY,CREATEDDATE)
SELECT SITEID,@USERID USERID,YEAR,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC,@UPDATEDBY,@CC_TIMESTAMP FROM TARGETSITES WHERE SITEID=@DEFAULTSITEID

END

IF EXISTS(SELECT 1 FROM WEEKLYTARGETSITES WHERE SITEID=@DEFAULTSITEID)
BEGIN
INSERT INTO dbo.AUDIT(TABLENAME,TRANS,STAMP,LASTUPDATEDBY,DATA)
SELECT 'USERS/USERINFO/USERGROUPS/USERROLES/USERSITES/TARGETUSERS/WEEKLYTARGETUSERS','UPDATE-UPDATEUSER_1.0',@CC_TIMESTAMP,@UPDATEDBY,
(SELECT * FROM WEEKLYTARGETUSERS WHERE USERID=@USERID AND SITEID=@DEFAULTSITEID FOR XML AUTO)

DELETE FROM WEEKLYTARGETUSERS WHERE USERID=@USERID AND SITEID=@DEFAULTSITEID

INSERT INTO WEEKLYTARGETUSERS(SITEID,USERID,WEEKTARGET,CREATEDBY,CREATEDDATE)
SELECT SITEID,@USERID,WEEKTARGET,@UPDATEDBY,@CC_TIMESTAMP FROM WEEKLYTARGETSITES WHERE SITEID=@DEFAULTSITEID
END

INSERT INTO dbo.AUDIT(TABLENAME,TRANS,STAMP,LASTUPDATEDBY,DATA)
SELECT 'USERS/USERINFO/USERGROUPS/USERROLES/USERSITES/TARGETUSERS/WEEKLYTARGETUSERS','UPDATE-UPDATEUSER_1.0',@CC_TIMESTAMP,@UPDATEDBY,
(SELECT * FROM USERS WHERE UPDATEDBY=@UPDATEDBY AND UPDATEDDATE=@CC_TIMESTAMP FOR XML AUTO)

INSERT INTO dbo.AUDIT(TABLENAME,TRANS,STAMP,LASTUPDATEDBY,DATA)
SELECT 'USERS/USERINFO/USERGROUPS/USERROLES/USERSITES/TARGETUSERS/WEEKLYTARGETUSERS','UPDATE-UPDATEUSER_1.0',@CC_TIMESTAMP,@UPDATEDBY,
(SELECT * FROM USERINFO WHERE UPDATEDBY=@UPDATEDBY AND UPDATEDDATE=@CC_TIMESTAMP FOR XML AUTO)
