--GETUSERSLISTROLES_1.0
IF EXISTS(SELECT 1 FROM USERINFO UR INNER JOIN ROLES R ON R.ROLEID = UR.DEFAULTROLEID AND R.ALLSITES = 1 WHERE UR.USERID = @USERID AND R.STATUS=1)
BEGIN
SELECT '<option value="'+CAST(USERID AS VARCHAR(32))+'">'+LASTNAME+' '+FIRSTNAME+'</option>' AS 'data()' FROM USERS U
WHERE STATUS IN(1,4)
AND NOT EXISTS(SELECT 1 FROM USERINFO WHERE DEFAULTROLEID=@ROLEID AND USERID= U.USERID)
AND USERID !=@USERID
ORDER BY LASTNAME+' '+FIRSTNAME FOR XML PATH('')


SELECT '<option value="'+CAST(U.USERID AS VARCHAR(32))+'">'+U.LASTNAME+' '+U.FIRSTNAME +CASE WHEN U.STATUS = 0 THEN '( InActive )' WHEN U.STATUS = 4 THEN '( Locked )' ELSE '' END+'</option>' AS 'data()' FROM USERS U
INNER JOIN USERINFO UR ON UR.USERID = U.USERID
WHERE UR.DEFAULTROLEID = @ROLEID  AND U.STATUS IN (0,1,4)
AND U.USERID !=@USERID
ORDER BY U.LASTNAME+' '+U.FIRSTNAME FOR XML PATH('')
END
ELSE
BEGIN

SELECT '<option value="'+CAST(U.USERID AS VARCHAR(32))+'">'+U.LASTNAME+' '+U.FIRSTNAME+'</option>' AS 'data()' FROM USERS U
INNER JOIN USERSITES US ON US.USERID =U.USERID
WHERE US.SITEID IN (SELECT SITEID FROM USERSITES WHERE USERID = @USERID AND STATUS = 1)
AND NOT EXISTS(SELECT 1 FROM USERINFO WHERE DEFAULTROLEID = @ROLEID AND USERID=U.USERID) AND U.STATUS IN( 1,4)
AND U.USERID !=@USERID AND US.STATUS =1
ORDER BY U.LASTNAME+' '+U.FIRSTNAME FOR XML PATH('')

SELECT '<option value="'+CAST(U.USERID AS VARCHAR(32))+'">'+U.LASTNAME+' '+U.FIRSTNAME+CASE WHEN U.STATUS = 0 THEN '( InActive )' WHEN U.STATUS = 4 THEN '( Locked )' ELSE '' END+'</option>' AS 'data()'
FROM USERS U
INNER JOIN USERINFO UR ON UR.USERID = U.USERID
INNER JOIN USERSITES US ON US.USERID = U.USERID
WHERE UR.DEFAULTROLEID = @ROLEID AND U.STATUS IN(0,1,4)
AND US.SITEID IN (SELECT SITEID FROM USERSITES WHERE USERID = @USERID AND STATUS = 1)
AND US.STATUS =1
AND U.USERID !=@USERID
ORDER BY U.LASTNAME+' '+U.FIRSTNAME FOR XML PATH('')
END
