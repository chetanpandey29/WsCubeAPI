DECLARE @QRY VARCHAR(MAX),@QRY1 VARCHAR(MAX),@ISADMIN VARCHAR(8)
SET @ISADMIN='0'

IF EXISTS(SELECT 1 FROM ROLES WHERE ALLSITES=1 AND ROLEID =(SELECT DEFAULTROLEID FROM USERINFO WHERE USERID = @USERID))
SET @ISADMIN='1'
CREATE TABLE #FINALRESULTS(CARDID INT,OBSERVATIONDATE VARCHAR(32),OBSDATE DATETIME,OBSERVER NVARCHAR(512),AREAS NVARCHAR(512),STATUS VARCHAR(32),[TYPE] NVARCHAR(32) )
CREATE TABLE #INPUTSITES(SITEID INT)
SET @QRY=''
SET @QRY1=''


SELECT @QRY1='
INSERT INTO #INPUTSITES
SELECT RESULT FROM DBO.CSVTOTABLE('''+@SITEID+''')
'
EXEC(@QRY1)

IF EXISTS(SELECT 1 FROM USERINFO WHERE USERID = @USERID AND DEFAULTROLEID IN (4,5)) OR
EXISTS (SELECT 1 FROM USERINFO WHERE USERID =@USERID AND DEFAULTROLEID IN (SELECT ROLEID FROM ROLES WHERE STATUS =1 AND COPYFROM IN (4,5)))
BEGIN

SELECT @QRY='
DECLARE @DTFORMAT INT
SELECT @DTFORMAT=ISNULL(DATEFORMAT,101) FROM USERINFO WHERE USERID ='+ @USERID + '
SELECT SCE.CARDID,CONVERT(VARCHAR,OBSERVATIONDATE,@DTFORMAT)[OBSERVATION DATE],SCE.OBSERVATIONDATE ,
CASE OBSERVERCOUNT WHEN 0 THEN (SELECT LASTNAME+'',''+FIRSTNAME FROM USERS
WHERE USERID = (SELECT TOP 1 OBSERVERID FROM STOPCARDENTRYOBSERVERS WHERE CARDID=SCE.CARDID)) ELSE ''LBLMULTIPLEOBSERVERS'' END [OBSERVER],
(SELECT AREANAME FROM AREAS WHERE AREAID=SCE.AREAID)[AREAS],
CASE WHEN SCE.[STATUS]= 1 THEN ''LBLACTIVE'' WHEN SCE.[STATUS] = 0 THEN ''LBLINACTIVE''END AS [STATUS]
,''LBLOBSERVATION'' AS [TYPE]
FROM STOPCARDENTRY SCE
INNER JOIN CORRECTIVEACTIONS CA ON CA.CARDID=SCE.CARDID  '
+CASE WHEN ISNULL(@RESPONSIBLEPERSON,'')='' THEN ''
ELSE
' INNER JOIN CORRECTIVEACTIONSRESPONSIBLEPERSONS CAR ON CAR.CORRACTIONID=CA.CORRACTIONID
INNER JOIN DBO.CSVTOTABLE('''+@RESPONSIBLEPERSON+''') RP ON RP.RESULT=CAR.USERID ' END

+CASE WHEN ISNULL(@SITEID,'')='' THEN CASE WHEN @ISADMIN='1' THEN ' INNER JOIN SITES SS ON SS.SITEID=SCE.SITEID AND SS.STATUS =1 ' ELSE
'INNER JOIN USERSITES US ON US.USERID = '+ @USERID + ' AND US.SITEID =SCE.SITEID AND US.STATUS = 1' END
ELSE ' INNER JOIN #INPUTSITES SR ON SR.SITEID=SCE.SITEID' END
+CASE WHEN ISNULL(@AREAID,'')='' THEN '' ELSE ' INNER JOIN DBO.CSVTOTABLE('''+@AREAID+''') SA ON SA.RESULT=SCE.AREAID' END
+CASE WHEN ISNULL(@SHIFTID,'')='' THEN '' ELSE ' INNER JOIN DBO.CSVTOTABLE('''+@SHIFTID+''') SHR ON SHR.RESULT=SCE.SHIFTID' END
+CASE WHEN ISNULL(@OBSERVERID,'')='' THEN '' ELSE ' INNER JOIN STOPCARDENTRYOBSERVERS SCO ON SCO.CARDID=SCE.CARDID
INNER JOIN DBO.CSVTOTABLE('''+@OBSERVERID+''') [OR] ON [OR].RESULT=SCO.OBSERVERID' END

+' WHERE STOPCARDTYPE IN '+ CASE WHEN ISNULL(@CORRACTYPE,'')='' OR @CORRACTYPE='1,2' THEN '(1)' WHEN @CORRACTYPE='1' THEN ' (1) '  ELSE ' (9) ' END

+CASE WHEN ISNULL(@FROMDATE,'')='' THEN '' ELSE ' AND SCE.OBSERVATIONDATE BETWEEN CONVERT(DATETIME,'''+@FROMDATE+''') AND CONVERT(DATETIME,'''+@TODATE+''')' END
+CASE WHEN ISNULL(@STATUSID,'')='' THEN ' AND SCE.[STATUS]!=2 ' ELSE ' AND SCE.[STATUS] IN('+ @STATUSID + ')' END
+' AND ( EXISTS(SELECT 1 FROM CORRECTIVEACTIONS C WHERE C.CORRACTIONID=CA.CORRACTIONID AND CREATEDBY='+ @USERID + ')
OR EXISTS(SELECT 1 FROM CORRECTIVEACTIONS C WHERE C.CORRACTIONID=CA.CORRACTIONID AND OWNER='+ @USERID + ')
OR EXISTS(SELECT 1 FROM CORRECTIVEACTIONSRESPONSIBLEPERSONS C WHERE C.CORRACTIONID=CA.CORRACTIONID AND USERID='+ @USERID + ')
)'

INSERT INTO #FINALRESULTS
EXEC(@QRY)
SET @QRY =''
SELECT @QRY='
DECLARE @DTFORMAT INT
SELECT @DTFORMAT=ISNULL(DATEFORMAT,101) FROM USERINFO WHERE USERID ='+ @USERID + '
SELECT SCE.CARDID,CONVERT(VARCHAR,OBSERVATIONDATE,@DTFORMAT)[OBSERVATION DATE],SCE.OBSERVATIONDATE ,
CASE OBSERVERCOUNT WHEN 0 THEN (SELECT LASTNAME+'',''+FIRSTNAME FROM USERS
WHERE USERID = (SELECT TOP 1 OBSERVERID FROM STOPCARDENTRYOBSERVERS WHERE CARDID=SCE.CARDID)) ELSE ''LBLMULTIPLEOBSERVERS'' END [OBSERVER],
(SELECT AREANAME FROM AREAS WHERE AREAID=SCE.AREAID)[AREAS],
CASE WHEN SCE.[STATUS]= 1 THEN ''LBLACTIVE'' WHEN SCE.[STATUS] = 0 THEN ''LBLINACTIVE''END AS [STATUS]
,''LBLDIRECT''  AS [TYPE]
FROM STOPCARDENTRY SCE
'
+CASE WHEN ISNULL(@RESPONSIBLEPERSON,'')='' THEN ''
ELSE
' INNER JOIN CORRECTIVEACTIONS CA ON CA.CARDID=SCE.CARDID
INNER JOIN CORRECTIVEACTIONSRESPONSIBLEPERSONS CAR ON CAR.CORRACTIONID=CA.CORRACTIONID
INNER JOIN DBO.CSVTOTABLE('''+@RESPONSIBLEPERSON+''') RP ON RP.RESULT=CAR.USERID ' END

+CASE WHEN ISNULL(@SITEID,'')='' THEN CASE WHEN @ISADMIN='1' THEN ' INNER JOIN SITES SS ON SS.SITEID=SCE.SITEID AND SS.STATUS =1 ' ELSE
'INNER JOIN USERSITES US ON US.USERID = '+ @USERID + ' AND US.SITEID =SCE.SITEID AND US.STATUS = 1' END
ELSE ' INNER JOIN #INPUTSITES SR ON SR.SITEID=SCE.SITEID' END
+CASE WHEN ISNULL(@AREAID,'')='' THEN '' ELSE ' INNER JOIN DBO.CSVTOTABLE('''+@AREAID+''') SA ON SA.RESULT=SCE.AREAID' END
+CASE WHEN ISNULL(@SHIFTID,'')='' THEN '' ELSE ' INNER JOIN DBO.CSVTOTABLE('''+@SHIFTID+''') SHR ON SHR.RESULT=SCE.SHIFTID' END
+CASE WHEN ISNULL(@OBSERVERID,'')='' THEN '' ELSE ' INNER JOIN STOPCARDENTRYOBSERVERS SCO ON SCO.CARDID=SCE.CARDID
INNER JOIN DBO.CSVTOTABLE('''+@OBSERVERID+''') [OR] ON [OR].RESULT=SCO.OBSERVERID' END

+' WHERE STOPCARDTYPE IN '+ CASE WHEN ISNULL(@CORRACTYPE,'')='' OR @CORRACTYPE='1,2' THEN '(2)' WHEN @CORRACTYPE='2' THEN ' (2) ' ELSE ' (9) ' END

+CASE WHEN ISNULL(@FROMDATE,'')='' THEN '' ELSE ' AND SCE.OBSERVATIONDATE BETWEEN CONVERT(DATETIME,'''+@FROMDATE+''') AND CONVERT(DATETIME,'''+@TODATE+''')' END
+CASE WHEN ISNULL(@STATUSID,'')='' THEN ' AND SCE.[STATUS]!=2 ' ELSE ' AND SCE.[STATUS] IN('+ @STATUSID + ')' END
+' AND ( EXISTS(SELECT 1 FROM STOPCARDENTRY S INNER JOIN CORRECTIVEACTIONS C ON C.CARDID=S.CARDID WHERE S.CARDID=SCE.CARDID AND C.CREATEDBY='+ @USERID + ')
OR EXISTS(SELECT 1 FROM STOPCARDENTRY S INNER JOIN CORRECTIVEACTIONS C ON C.CARDID=S.CARDID WHERE S.CARDID=SCE.CARDID AND C.OWNER='+ @USERID + ')
OR EXISTS(SELECT 1 FROM STOPCARDENTRY S INNER JOIN CORRECTIVEACTIONS C ON C.CARDID=S.CARDID INNER JOIN CORRECTIVEACTIONSRESPONSIBLEPERSONS CR ON CR.CORRACTIONID=C.CORRACTIONID WHERE S.CARDID=SCE.CARDID AND CR.USERID='+ @USERID + ')
)'
PRINT @QRY
INSERT INTO #FINALRESULTS
EXEC(@QRY)


END
ELSE
BEGIN
SELECT @QRY='
DECLARE @DTFORMAT INT
SELECT @DTFORMAT=ISNULL(DATEFORMAT,101) FROM USERINFO WHERE USERID ='+ @USERID + '
SELECT SCE.CARDID,CONVERT(VARCHAR,OBSERVATIONDATE,@DTFORMAT)[OBSERVATION DATE],SCE.OBSERVATIONDATE ,
CASE OBSERVERCOUNT WHEN 0 THEN (SELECT LASTNAME+'',''+FIRSTNAME FROM USERS
WHERE USERID = (SELECT TOP 1 OBSERVERID FROM STOPCARDENTRYOBSERVERS WHERE CARDID=SCE.CARDID)) ELSE ''LBLMULTIPLEOBSERVERS'' END [OBSERVER],
(SELECT AREANAME FROM AREAS WHERE AREAID=SCE.AREAID)[AREAS],
CASE WHEN SCE.[STATUS]= 1 THEN ''LBLACTIVE'' WHEN SCE.[STATUS] = 0 THEN ''LBLINACTIVE''END AS [STATUS]
,''LBLOBSERVATION'' AS [TYPE]
FROM STOPCARDENTRY SCE
INNER JOIN CORRECTIVEACTIONS CA ON CA.CARDID=SCE.CARDID  '
+CASE WHEN ISNULL(@RESPONSIBLEPERSON,'')='' THEN ''
ELSE
' INNER JOIN CORRECTIVEACTIONSRESPONSIBLEPERSONS CAR ON CAR.CORRACTIONID=CA.CORRACTIONID
INNER JOIN DBO.CSVTOTABLE('''+@RESPONSIBLEPERSON+''') RP ON RP.RESULT=CAR.USERID ' END

+CASE WHEN ISNULL(@SITEID,'')='' THEN CASE WHEN @ISADMIN='1' THEN ' INNER JOIN SITES SS ON SS.SITEID=SCE.SITEID AND SS.STATUS =1 ' ELSE
'INNER JOIN USERSITES US ON US.USERID = '+ @USERID + ' AND US.SITEID =SCE.SITEID AND US.STATUS = 1' END
ELSE ' INNER JOIN #INPUTSITES SR ON SR.SITEID=SCE.SITEID' END
+CASE WHEN ISNULL(@AREAID,'')='' THEN '' ELSE ' INNER JOIN DBO.CSVTOTABLE('''+@AREAID+''') SA ON SA.RESULT=SCE.AREAID' END
+CASE WHEN ISNULL(@SHIFTID,'')='' THEN '' ELSE ' INNER JOIN DBO.CSVTOTABLE('''+@SHIFTID+''') SHR ON SHR.RESULT=SCE.SHIFTID' END
+CASE WHEN ISNULL(@OBSERVERID,'')='' THEN '' ELSE ' INNER JOIN STOPCARDENTRYOBSERVERS SCO ON SCO.CARDID=SCE.CARDID
INNER JOIN DBO.CSVTOTABLE('''+@OBSERVERID+''') [OR] ON [OR].RESULT=SCO.OBSERVERID' END

+' WHERE STOPCARDTYPE IN '+ CASE WHEN ISNULL(@CORRACTYPE,'')='' OR @CORRACTYPE='1,2' THEN '(1)' WHEN @CORRACTYPE='1' THEN ' (1) '  ELSE ' (9) ' END

+CASE WHEN ISNULL(@FROMDATE,'')='' THEN '' ELSE ' AND SCE.OBSERVATIONDATE BETWEEN CONVERT(DATETIME,'''+@FROMDATE+''') AND CONVERT(DATETIME,'''+@TODATE+''')' END
+CASE WHEN ISNULL(@STATUSID,'')='' THEN ' AND SCE.[STATUS]!=2 ' ELSE ' AND SCE.[STATUS] IN('+ @STATUSID + ')' END

INSERT INTO #FINALRESULTS
EXEC(@QRY)
SET @QRY =''
SELECT @QRY='
DECLARE @DTFORMAT INT
SELECT @DTFORMAT=ISNULL(DATEFORMAT,101) FROM USERINFO WHERE USERID ='+ @USERID + '
SELECT SCE.CARDID,CONVERT(VARCHAR,OBSERVATIONDATE,@DTFORMAT)[OBSERVATION DATE],SCE.OBSERVATIONDATE ,
CASE OBSERVERCOUNT WHEN 0 THEN (SELECT LASTNAME+'',''+FIRSTNAME FROM USERS
WHERE USERID = (SELECT TOP 1 OBSERVERID FROM STOPCARDENTRYOBSERVERS WHERE CARDID=SCE.CARDID)) ELSE ''LBLMULTIPLEOBSERVERS'' END [OBSERVER],
(SELECT AREANAME FROM AREAS WHERE AREAID=SCE.AREAID)[AREAS],
CASE WHEN SCE.[STATUS]= 1 THEN ''LBLACTIVE'' WHEN SCE.[STATUS] = 0 THEN ''LBLINACTIVE''END AS [STATUS]
,''LBLDIRECT''  AS [TYPE]
FROM STOPCARDENTRY SCE
'
+CASE WHEN ISNULL(@RESPONSIBLEPERSON,'')='' THEN ''
ELSE
' INNER JOIN CORRECTIVEACTIONS CA ON CA.CARDID=SCE.CARDID
INNER JOIN CORRECTIVEACTIONSRESPONSIBLEPERSONS CAR ON CAR.CORRACTIONID=CA.CORRACTIONID
INNER JOIN DBO.CSVTOTABLE('''+@RESPONSIBLEPERSON+''') RP ON RP.RESULT=CAR.USERID ' END

+CASE WHEN ISNULL(@SITEID,'')='' THEN CASE WHEN @ISADMIN='1' THEN ' INNER JOIN SITES SS ON SS.SITEID=SCE.SITEID AND SS.STATUS =1 ' ELSE
'INNER JOIN USERSITES US ON US.USERID = '+ @USERID + ' AND US.SITEID =SCE.SITEID AND US.STATUS = 1' END
ELSE ' INNER JOIN #INPUTSITES SR ON SR.SITEID=SCE.SITEID' END
+CASE WHEN ISNULL(@AREAID,'')='' THEN '' ELSE ' INNER JOIN DBO.CSVTOTABLE('''+@AREAID+''') SA ON SA.RESULT=SCE.AREAID' END
+CASE WHEN ISNULL(@SHIFTID,'')='' THEN '' ELSE ' INNER JOIN DBO.CSVTOTABLE('''+@SHIFTID+''') SHR ON SHR.RESULT=SCE.SHIFTID' END
+CASE WHEN ISNULL(@OBSERVERID,'')='' THEN '' ELSE ' INNER JOIN STOPCARDENTRYOBSERVERS SCO ON SCO.CARDID=SCE.CARDID
INNER JOIN DBO.CSVTOTABLE('''+@OBSERVERID+''') [OR] ON [OR].RESULT=SCO.OBSERVERID' END

+' WHERE STOPCARDTYPE IN '+ CASE WHEN ISNULL(@CORRACTYPE,'')='' OR @CORRACTYPE='1,2' THEN '(2)' WHEN @CORRACTYPE='2' THEN ' (2) ' ELSE ' (9) ' END

+CASE WHEN ISNULL(@FROMDATE,'')='' THEN '' ELSE ' AND SCE.OBSERVATIONDATE BETWEEN CONVERT(DATETIME,'''+@FROMDATE+''') AND CONVERT(DATETIME,'''+@TODATE+''')' END
+CASE WHEN ISNULL(@STATUSID,'')='' THEN ' AND SCE.[STATUS]!=2 ' ELSE ' AND SCE.[STATUS] IN('+ @STATUSID + ')' END
PRINT @QRY
INSERT INTO #FINALRESULTS
EXEC(@QRY)
END

SELECT DISTINCT CARDID,OBSERVATIONDATE,OBSERVER,AREAS,[TYPE],STATUS,OBSDATE FROM #FINALRESULTS ORDER BY OBSDATE DESC
DROP TABLE #FINALRESULTS
DROP TABLE #INPUTSITES
