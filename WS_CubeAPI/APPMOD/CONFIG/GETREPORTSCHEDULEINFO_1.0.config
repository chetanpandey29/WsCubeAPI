DECLARE @EMAIL TABLE(EMAIL VARCHAR(512))

DECLARE @DATEFORMAT INT,@EMAILTO VARCHAR(MAX),@EMAILTOINPUT VARCHAR(MAX)
SELECT @DATEFORMAT=101
SELECT @EMAILTOINPUT=EMAILTO FROM SCHEDULE WHERE SCHEDULEID =@SCHEDULEID
INSERT INTO @EMAIL
SELECT CAST(RESULT AS VARCHAR(8))+'~~!~~'+(SELECT LASTNAME+' '+FIRSTNAME FROM USERS WHERE USERID = RESULT)+',' FROM dbo.CSVtoTable(@EMAILTOINPUT)
SET @EMAILTO=''
SELECT @EMAILTO=@EMAILTO+EMAIL FROM @EMAIL

IF LEN(@EMAILTO)>0
SET @EMAILTO=SUBSTRING(@EMAILTO,1,LEN(@EMAILTO)-1)

SELECT REPORTID,DESIGNID,@EMAILTO EMAILTO,EMAILTO EMAILTOID,TIMEZONE,STARTTIME,EXPORTFORMAT,EXPORTTYPE,SCHEDULENAME,
CC,SUBJECT,BODY,S.STATUS,DWM,EVERYDWM,CONVERT(VARCHAR(32),STARTDATE,ISNULL(@DATEFORMAT,111)) STARTDATE,CONVERT(VARCHAR(32),ENDDATE,
ISNULL(@DATEFORMAT,111))ENDDATE,DAYLIST,SO.RELATIVEFOR,SO.RELATIVEOPTION,SO.RELATIVEOPTIONTYPE,SO.PREVIOUSVALUE,SO.TILLDATE
FROM SCHEDULE S
INNER JOIN SCHEDULETYPES ST ON ST.SCHEDULETYPEID=S.SCHEDULETYPEID
LEFT JOIN SCHEDULEOPTIONS SO ON SO.SCHEDULEID=S.SCHEDULEID
LEFT JOIN SCHEDULETYPES ST1 ON ST1.SCHEDULETYPEID=S.DUPLICATEMAILFROM
WHERE S.SCHEDULEID=@SCHEDULEID
