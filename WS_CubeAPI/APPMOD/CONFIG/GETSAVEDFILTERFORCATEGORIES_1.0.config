DECLARE @MAINCATEGORYID VARCHAR(MAX),@SUBCATEGORYID VARCHAR(MAX)
SET @MAINCATEGORYID='"MAINCATEGORYID":"'
SET @SUBCATEGORYID='"SUBCATEGORYID":"'
IF EXISTS(SELECT 1 FROM CORRECTIVEACTIONSCATEGORY WHERE CORRACTIONID=@CORRACTIONID AND SUBCATEGORYID=0)
SELECT @MAINCATEGORYID=@MAINCATEGORYID+ CAST(CAC.MAINCATEGORYID AS VARCHAR(10))+'~~!~~'+M.MAINCATEGORYNAME+',' FROM CORRECTIVEACTIONSCATEGORY CAC
INNER JOIN MAINCATEGORIES M ON M.MAINCATEGORYID=CAC.MAINCATEGORYID AND CAC.SUBCATEGORYID=0
WHERE CORRACTIONID=@CORRACTIONID AND CAC.SUBCATEGORYID=0
ORDER BY MAINCATEGORYNAME
ELSE
SELECT @MAINCATEGORYID=''

IF EXISTS(SELECT 1 FROM CORRECTIVEACTIONSCATEGORY WHERE CORRACTIONID=@CORRACTIONID AND SUBCATEGORYID>0)
SELECT @SUBCATEGORYID=@SUBCATEGORYID+CAST(CAC.SUBCATEGORYID AS VARCHAR(10))+'~~!~~'+S.SUBCATEGORYNAME+',' FROM CORRECTIVEACTIONSCATEGORY CAC
INNER JOIN SUBCATEGORIES S ON S.MAINCATEGORYID=CAC.MAINCATEGORYID AND S.SUBCATEGORYID=CAC.SUBCATEGORYID
WHERE CORRACTIONID=@CORRACTIONID AND CAC.SUBCATEGORYID>0
ORDER BY SUBCATEGORYNAME
ELSE
SELECT @SUBCATEGORYID=''

SELECT @MAINCATEGORYID=CASE WHEN @MAINCATEGORYID ='' THEN '' ELSE SUBSTRING(@MAINCATEGORYID,1,LEN(@MAINCATEGORYID)-1)+'"' END
SELECT @SUBCATEGORYID=CASE WHEN @SUBCATEGORYID ='' THEN '' ELSE SUBSTRING(@SUBCATEGORYID,1,LEN(@SUBCATEGORYID)-1)+'"' END


SELECT CASE WHEN @MAINCATEGORYID+@SUBCATEGORYID='' THEN '' ELSE '{' END+CASE WHEN @MAINCATEGORYID ='' THEN '' ELSE @MAINCATEGORYID+(CASE WHEN @SUBCATEGORYID ='' THEN '' ELSE ',' END) END +@SUBCATEGORYID+CASE WHEN @MAINCATEGORYID+@SUBCATEGORYID='' THEN '' ELSE '}' END
