--INSERTTARGETUSERS_1.0
DECLARE @CC_TIMESTAMP DATETIME
SET @CC_TIMESTAMP=GETDATE()

IF EXISTS(SELECT 1 FROM TARGETUSERS WHERE USERID = @USERID AND SITEID = @SITEID)
UPDATE TARGETUSERS SET JAN=@JAN,FEB=@FEB,MAR=@MAR,APR=@APR,MAY=@MAY,JUN=@JUN,JUL=@JUL,AUG=@AUG,SEP=@SEP,OCT=@OCT,NOV=@NOV,[DEC]=@DEC,CREATEDBY=@CREATEDBY,CREATEDDATE=@CC_TIMESTAMP WHERE USERID =@USERID AND SITEID =@SITEID

ELSE
INSERT INTO TARGETUSERS(SITEID,USERID,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,[DEC],CREATEDBY,CREATEDDATE) SELECT @SITEID,@USERID,@JAN,@FEB,@MAR,@APR,@MAY,@JUN,@JUL,@AUG,@SEP,@OCT,@NOV,@DEC,@CREATEDBY,@CC_TIMESTAMP

IF @TARGETALLSITES = 1
BEGIN
INSERT INTO TARGETUSERS(SITEID,USERID,CREATEDBY,CREATEDDATE)
SELECT SITEID,USERID,@CREATEDBY,@CC_TIMESTAMP FROM USERSITES WHERE USERID = @USERID AND SITEID NOT IN (SELECT SITEID FROM TARGETUSERS WHERE USERID =@USERID)
AND STATUS=1

UPDATE TARGETUSERS
SET JAN=@JAN,FEB=@FEB,MAR=@MAR,APR=@APR,MAY=@MAY,JUN=@JUN,JUL=@JUL,
AUG=@AUG,SEP=@SEP,OCT=@OCT,NOV=@NOV,[DEC]=@DEC,CREATEDBY=@CREATEDBY,
CREATEDDATE=@CC_TIMESTAMP WHERE USERID =@USERID
END

DECLARE @SITENAME NVARCHAR(512),@LASTNAME NVARCHAR(512),@FIRSTNAME NVARCHAR(512),@BODY NVARCHAR(MAX),@FROM NVARCHAR(512),@EMAILID NVARCHAR(512),@URL NVARCHAR(512),@CREATEDBYUSERNAME NVARCHAR(512)
SELECT @SITENAME='',@LASTNAME='',@FIRSTNAME='',@BODY='',@FROM ='',@EMAILID='',@URL='',@CREATEDBYUSERNAME=''
SELECT @LASTNAME=LASTNAME,@FIRSTNAME=FIRSTNAME,@EMAILID=EMAIL FROM USERS WHERE USERID=@USERID
SELECT @BODY=BODY FROM SCHEDULE WHERE SCHEDULETYPEID = 13
SELECT @URL = OPTIONVALUE FROM COMPANYOPTIONS WHERE OPTIONNAME ='URL'
SELECT @FROM = OPTIONVALUE FROM COMPANYOPTIONS WHERE OPTIONNAME ='MAILFROM'
SELECT @CREATEDBYUSERNAME=LASTNAME+' '+FIRSTNAME FROM USERS WHERE USERID=@CREATEDBY
IF @TARGETALLSITES=1
SET @SITENAME='ALL assigned sites'
ELSE
SELECT @SITENAME=SITENAME+' site' FROM SITES WHERE SITEID=@SITEID
SET @BODY=REPLACE(@BODY,'[TGTJAN]',@JAN)
SET @BODY=REPLACE(@BODY,'[TGTFEB]',@FEB)
SET @BODY=REPLACE(@BODY,'[TGTMAR]',@MAR)
SET @BODY=REPLACE(@BODY,'[TGTAPR]',@APR)
SET @BODY=REPLACE(@BODY,'[TGTMAY]',@MAY)
SET @BODY=REPLACE(@BODY,'[TGTJUN]',@JUN)
SET @BODY=REPLACE(@BODY,'[TGTJUL]',@JUL)
SET @BODY=REPLACE(@BODY,'[TGTAUG]',@AUG)
SET @BODY=REPLACE(@BODY,'[TGTSEP]',@SEP)
SET @BODY=REPLACE(@BODY,'[TGTOCT]',@OCT)
SET @BODY=REPLACE(@BODY,'[TGTNOV]',@NOV)
SET @BODY=REPLACE(@BODY,'[TGTDEC]',@DEC)

INSERT INTO USERINBOX (COMPANYID,USERID,[FROM],REPLYTO,[TO],CC,BCC,[SUBJECT],BODY,SENTDATE,READSTATUS,[TYPE],[STATUS],TOKENID)
SELECT COMPANYID,@USERID USERID,@FROM [FROM],REPLYTO [REPLYTO],@EMAILID [TO],'' CC,'' BCC,SUBJECT [SUBJECT],DBO.REGEXREPLACE(@BODY,'02|03|06|42',@LASTNAME+'|'+@FIRSTNAME+'|'+@SITENAME+'|'+@CREATEDBYUSERNAME) BODY,GETUTCDATE() SENTDATE,0 READSTATUS,1,1,SCHEDULEID
FROM SCHEDULE WHERE SCHEDULETYPEID=13

SELECT SCHEDULEID,COMPANYID,@USERID USERID, @FROM [FROM],REPLYTO [REPLYTO],@EMAILID [TO],'' CC,'' BCC,SUBJECT [SUBJECT],DBO.REGEXREPLACE(@BODY,'02|03|06|42',@LASTNAME+'|'+@FIRSTNAME+'|'+@SITENAME+'|'+@CREATEDBYUSERNAME) BODY,GETUTCDATE() SENTDATE ,0 READSTATUS,@URL URL
FROM SCHEDULE WHERE SCHEDULETYPEID=13


INSERT INTO dbo.AUDIT(TABLENAME,TRANS,STAMP,LASTUPDATEDBY,DATA)
SELECT 'TARGETUSERS','INSERT-INSERTTARGETUSERS_1.0',@CC_TIMESTAMP,@CREATEDBY,NULL