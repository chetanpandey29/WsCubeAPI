DECLARE @CC_TIMESTAMP DATETIME
SET @CC_TIMESTAMP=GETDATE()
DECLARE @PGLOBOPT_OLD INT
SELECT @PGLOBOPT_OLD = OPTIONVALUE FROM COMPANYOPTIONS WHERE OPTIONNAME='LOGINATTEMPTS'

IF (@PPASSWORDCOMPLEX = 0 OR @PPASSWORDCOMPLEX = 1)
BEGIN
SET @PASSWORDMINNUMCHAR = 0
SET @PASSWORDMINALPHACHAR = 0
SET @PASSWORDMINSPECCHAR = 0
END

IF (@PPASSWORDCOMPLEX = 2)
BEGIN
SET @PASSWORDMINSPECCHAR = 0
END

UPDATE COMPANYOPTIONS SET OPTIONVALUE=@PAUTOLOGOUT,UPDATEDBY=@UPDATEDBY,UPDATEDDATE=@CC_TIMESTAMP WHERE COMPANYID=@PCOMPANYID AND OPTIONNAME='AUTOLOGOUT'
UPDATE COMPANYOPTIONS SET OPTIONVALUE=@PDEFAULTDATEFORMAT,UPDATEDBY=@UPDATEDBY,UPDATEDDATE=@CC_TIMESTAMP WHERE COMPANYID=@PCOMPANYID AND OPTIONNAME='DEFAULTDATEFORMAT'

UPDATE COMPANYOPTIONS SET OPTIONVALUE=@PENABLELOGINATTEMPTS,UPDATEDBY=@UPDATEDBY,UPDATEDDATE=@CC_TIMESTAMP WHERE COMPANYID=@PCOMPANYID AND OPTIONNAME='ENABLELOGINATTEMPTS'

UPDATE COMPANYOPTIONS SET OPTIONVALUE=@PCOMPANYLOGO,UPDATEDBY=@UPDATEDBY,UPDATEDDATE=@CC_TIMESTAMP WHERE COMPANYID=@PCOMPANYID AND OPTIONNAME='COMPANYLOGO'
UPDATE COMPANYOPTIONS SET OPTIONVALUE=@PUSERNAMEMINLEN,UPDATEDBY=@UPDATEDBY,UPDATEDDATE=@CC_TIMESTAMP WHERE COMPANYID=@PCOMPANYID AND OPTIONNAME='USERNAMEMINLENGTH'
UPDATE COMPANYOPTIONS SET OPTIONVALUE=@PPASSWORDMINLEN,UPDATEDBY=@UPDATEDBY,UPDATEDDATE=@CC_TIMESTAMP WHERE COMPANYID=@PCOMPANYID AND OPTIONNAME='PASSWORDMINLENGTH'
UPDATE COMPANYOPTIONS SET OPTIONVALUE=@PPASSWORDCOMPLEX,UPDATEDBY=@UPDATEDBY,UPDATEDDATE=@CC_TIMESTAMP WHERE COMPANYID=@PCOMPANYID AND OPTIONNAME='PASSWORDCOMPLEXITY'
UPDATE COMPANYOPTIONS SET OPTIONVALUE=@PPWDEXPIRATIONPERIOD,UPDATEDBY=@UPDATEDBY,UPDATEDDATE=@CC_TIMESTAMP WHERE COMPANYID=@PCOMPANYID AND OPTIONNAME='PASSWORDEXPIRATIONPERIOD'

UPDATE COMPANYOPTIONS SET OPTIONVALUE=@PASSWORDMINNUMCHAR,UPDATEDBY=@UPDATEDBY,UPDATEDDATE=@CC_TIMESTAMP WHERE COMPANYID=@PCOMPANYID AND OPTIONNAME='PASSWORDMINNUMERICALCHAR'
UPDATE COMPANYOPTIONS SET OPTIONVALUE=@PASSWORDMINALPHACHAR,UPDATEDBY=@UPDATEDBY,UPDATEDDATE=@CC_TIMESTAMP WHERE COMPANYID=@PCOMPANYID AND OPTIONNAME='PASSWORDMINALPHACHAR'
UPDATE COMPANYOPTIONS SET OPTIONVALUE=@PASSWORDMINSPECCHAR,UPDATEDBY=@UPDATEDBY,UPDATEDDATE=@CC_TIMESTAMP WHERE COMPANYID=@PCOMPANYID AND OPTIONNAME='PASSWORDMINSPECIALCHAR'
UPDATE COMPANYOPTIONS SET OPTIONVALUE=@CUSTOMCOLOR,UPDATEDBY=@UPDATEDBY,UPDATEDDATE=@CC_TIMESTAMP WHERE COMPANYID=@PCOMPANYID AND OPTIONNAME='CUSTOMCOLOR'
UPDATE COMPANYOPTIONS SET OPTIONVALUE=@CUSTOMFONT,UPDATEDBY=@UPDATEDBY,UPDATEDDATE=@CC_TIMESTAMP WHERE COMPANYID=@PCOMPANYID AND OPTIONNAME='CUSTOMFONT'

IF @PENABLELOGINATTEMPTS = 1
BEGIN
UPDATE COMPANYOPTIONS SET OPTIONVALUE=@PLOGINATTEMPTS,UPDATEDBY=@UPDATEDBY,UPDATEDDATE=@CC_TIMESTAMP WHERE COMPANYID=@PCOMPANYID AND OPTIONNAME='LOGINATTEMPTS'
END


DECLARE @PGLOBOPT INT
SELECT @PGLOBOPT = OPTIONVALUE FROM COMPANYOPTIONS WHERE OPTIONNAME='LOGINATTEMPTS'

IF @PGLOBOPT_OLD!=@PGLOBOPT
BEGIN
	UPDATE USERS SET [STATUS]=4,UPDATEDBY=@UPDATEDBY,UPDATEDDATE=@CC_TIMESTAMP WHERE USERID IN(SELECT USERID FROM USERINFO WHERE LOGINATTEMPTS >= @PGLOBOPT)

	UPDATE UI SET UI.LOGINATTEMPTS=0,UPDATEDBY=@UPDATEDBY,UPDATEDDATE=@CC_TIMESTAMP
	FROM USERINFO UI
	INNER JOIN USERS U ON U.USERID = UI.USERID WHERE UI.LOGINATTEMPTS < @PGLOBOPT AND UI.LOGINATTEMPTS >= 0 AND U.STATUS = 4

	UPDATE U SET U.STATUS=1,UPDATEDBY=@UPDATEDBY,UPDATEDDATE=@CC_TIMESTAMP
	FROM USERS U
	INNER JOIN USERINFO UI ON U.USERID = UI.USERID WHERE UI.LOGINATTEMPTS < @PGLOBOPT AND UI.LOGINATTEMPTS >= 0 AND U.STATUS = 4   
END

SELECT 2


INSERT INTO dbo.AUDIT(TABLENAME,TRANS,STAMP,LASTUPDATEDBY,DATA)
SELECT 'COMPANYOPTIONS/USERS/USERINFO','UPDATE-UPDATEGLOBALOPTIONS_1.0',@CC_TIMESTAMP,@UPDATEDBY,
(SELECT USERID,STATUS FROM USERS WHERE UPDATEDBY=@UPDATEDBY AND UPDATEDDATE=@CC_TIMESTAMP FOR XML AUTO)

INSERT INTO dbo.AUDIT(TABLENAME,TRANS,STAMP,LASTUPDATEDBY,DATA)
SELECT 'COMPANYOPTIONS/USERS/USERINFO','UPDATE-UPDATEGLOBALOPTIONS_1.0',@CC_TIMESTAMP,@UPDATEDBY,
(SELECT USERID,LOGINATTEMPTS FROM USERINFO WHERE UPDATEDBY=@UPDATEDBY AND UPDATEDDATE=@CC_TIMESTAMP FOR XML AUTO)