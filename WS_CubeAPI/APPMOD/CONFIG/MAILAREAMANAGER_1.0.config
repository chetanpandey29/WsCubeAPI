--MAILAREAMANAGER_1.0
DECLARE @SITENAME NVARCHAR(512),@AREANAME NVARCHAR(512),@SHIFTNAME NVARCHAR(512),@OBSERVERNAME NVARCHAR(4000),@CHECKLISTNO NVARCHAR(64),@OBSERVATIONDATE DATETIME,
@CUSTOMFIELD1 NVARCHAR(512),@CUSTOMFIELD2 NVARCHAR(512),@CUSTOMFIELD3 NVARCHAR(512),@UNSAFEACTDETAILS NVARCHAR(MAX),@DATEFORMAT INT,@AREAMGRID INT,@AREAMGREMAILID NVARCHAR(512),@LANGUAGEID INT,
@ENTEREDBY NVARCHAR(512),@ENTEREDBYEMAILID NVARCHAR(512),@MGRLASTNAME NVARCHAR(512),@MGRFIRSTNAME NVARCHAR(512),@BODY NVARCHAR(MAX), @URL NVARCHAR(512), @FROM NVARCHAR(512)

SELECT @SITENAME='',@AREANAME ='',@SHIFTNAME ='',@OBSERVERNAME ='',@CHECKLISTNO ='',@OBSERVATIONDATE ='',
@CUSTOMFIELD1 ='',@CUSTOMFIELD2 ='',@CUSTOMFIELD3 ='',@UNSAFEACTDETAILS ='',@AREAMGREMAILID='',@ENTEREDBY='',@MGRLASTNAME='',@MGRFIRSTNAME=''
,@BODY='',@URL='',@FROM='',@ENTEREDBYEMAILID='',@CUSTOMFIELD1 ='',@CUSTOMFIELD2='',@CUSTOMFIELD3=''


SELECT @BODY=BODY FROM SCHEDULE WHERE SCHEDULETYPEID=17
SELECT @AREAMGRID=AREAMANAGER FROM STOPCARDENTRY WHERE CARDID=@CARDID
SELECT @AREAMGREMAILID=EMAIL FROM USERS WHERE USERID=@AREAMGRID AND STATUS !=2
SELECT @DATEFORMAT=DATEFORMAT,@LANGUAGEID=LANGUAGEID FROM USERINFO WHERE USERID=@AREAMGRID
SELECT @URL = OPTIONVALUE FROM COMPANYOPTIONS WHERE OPTIONNAME ='URL'
SELECT @FROM = OPTIONVALUE FROM COMPANYOPTIONS WHERE OPTIONNAME ='MAILFROM'
SELECT @CUSTOMFIELD1=ENTITYVALUE FROM ENTITYTRANSLATION WHERE ENTITYTYPE='CUS_NAME' AND PARENTID=1 AND LANGUAGEID=@LANGUAGEID
SELECT @CUSTOMFIELD2=ENTITYVALUE FROM ENTITYTRANSLATION WHERE ENTITYTYPE='CUS_NAME' AND PARENTID=2 AND LANGUAGEID=@LANGUAGEID
SELECT @CUSTOMFIELD3=ENTITYVALUE FROM ENTITYTRANSLATION WHERE ENTITYTYPE='CUS_NAME' AND PARENTID=3 AND LANGUAGEID=@LANGUAGEID

SELECT @BODY=REPLACE(@BODY,'SUB ZONE1',@CUSTOMFIELD1)
SELECT @BODY=REPLACE(@BODY,'SUB ZONE2',@CUSTOMFIELD2)
SELECT @BODY=REPLACE(@BODY,'SUB ZONE3',@CUSTOMFIELD3)

SELECT @CUSTOMFIELD1 ='',@CUSTOMFIELD2='',@CUSTOMFIELD3=''
SELECT @SITENAME=(SELECT SITENAME FROM SITES WHERE SITEID=SC.SITEID AND STATUS!=2)
,@AREANAME=(SELECT AREANAME FROM AREAS WHERE AREAID=SC.AREAID AND STATUS!=2)
,@SHIFTNAME=(SELECT SHIFTNAME FROM SHIFTS WHERE SHIFTID=SC.SHIFTID AND STATUS!=2)
,@OBSERVATIONDATE=OBSERVATIONDATE
,@ENTEREDBY=(SELECT LASTNAME+' '+ FIRSTNAME FROM USERS WHERE USERID=@CREATEDBY)
,@MGRLASTNAME=(SELECT LASTNAME FROM USERS WHERE USERID=SC.AREAMANAGER)
,@MGRFIRSTNAME=(SELECT FIRSTNAME FROM USERS WHERE USERID=SC.AREAMANAGER)
,@ENTEREDBYEMAILID=(SELECT EMAIL FROM USERS WHERE USERID=@CREATEDBY)
FROM STOPCARDENTRY SC
WHERE SC.CARDID=@CARDID

SELECT @OBSERVERNAME=STUFF((SELECT (U.LASTNAME+' '+U.FIRSTNAME+ CASE WHEN OBSERVERCOUNT=1 THEN ', ' ELSE '' END)as [text()]  FROM USERS U
INNER JOIN STOPCARDENTRYOBSERVERS SCO ON SCO.OBSERVERID=U.USERID
INNER JOIN STOPCARDENTRY SC ON SC.CARDID=SCO.CARDID
WHERE SCO.CARDID=@CARDID
ORDER BY U.LASTNAME+','+U.FIRSTNAME
FOR XML PATH('')), 1, 0, '')

SET @OBSERVERNAME = SUBSTRING(@OBSERVERNAME,1,LEN(@OBSERVERNAME)-1)
SELECT @CUSTOMFIELD1=ENTITYVALUE
FROM ENTITYTRANSLATION ET
INNER JOIN CUSTOMFIELDS CS ON CS.CUSTOMFIELDID=ET.PARENTID
INNER JOIN CUSTOMFIELDVALUES CSV ON CSV.CUSTOMFIELDID=ET.PARENTID AND CSV.CUSTOMFIELDVALUEID=ET.ENTITYID
INNER JOIN STOPCARDENTRYCUSTOMFIELDS SC ON SC.CUSTOMFIELD1=CSV.CUSTOMFIELDVALUEID
WHERE LANGUAGEID=@LANGUAGEID AND ENTITYTYPE='CUS_VALUE' AND CS.STATUS =1 AND CS.CUSTOMFIELDID=1 AND SC.STATUS!=2 AND SC.CARDID=@CARDID

SELECT @CUSTOMFIELD2=ENTITYVALUE
FROM ENTITYTRANSLATION ET
INNER JOIN CUSTOMFIELDS CS ON CS.CUSTOMFIELDID=ET.PARENTID
INNER JOIN CUSTOMFIELDVALUES CSV ON CSV.CUSTOMFIELDID=ET.PARENTID AND CSV.CUSTOMFIELDVALUEID=ET.ENTITYID
INNER JOIN STOPCARDENTRYCUSTOMFIELDS SC ON SC.CUSTOMFIELD2=CSV.CUSTOMFIELDVALUEID
WHERE LANGUAGEID=@LANGUAGEID AND ENTITYTYPE='CUS_VALUE' AND CS.STATUS =1 AND CS.CUSTOMFIELDID=2 AND SC.STATUS!=2 AND SC.CARDID=@CARDID

SELECT @CUSTOMFIELD3=ENTITYVALUE
FROM ENTITYTRANSLATION ET
INNER JOIN CUSTOMFIELDS CS ON CS.CUSTOMFIELDID=ET.PARENTID
INNER JOIN CUSTOMFIELDVALUES CSV ON CSV.CUSTOMFIELDID=ET.PARENTID AND CSV.CUSTOMFIELDVALUEID=ET.ENTITYID
INNER JOIN STOPCARDENTRYCUSTOMFIELDS SC ON SC.CUSTOMFIELD3=CSV.CUSTOMFIELDVALUEID
WHERE LANGUAGEID=@LANGUAGEID AND ENTITYTYPE='CUS_VALUE' AND CS.STATUS =1 AND CS.CUSTOMFIELDID=3 AND SC.STATUS!=2 AND SC.CARDID=@CARDID

SET @UNSAFEACTDETAILS='<table  border="1" style="text-align:center"> <tbody> 
<tr><td style="text-align:center"><strong> Main Category</strong> </td><td style="text-align:center"><strong> Sub Category</strong> </td><td style="text-align:center"><strong> Unsafe Count </strong></td><td style="text-align:center"><strong> Unsafe Comments </strong></td></tr>
'
DECLARE @MAINCATE TABLE(MAINCATEGORYNAME NVARCHAR(512),SUBCATEGORYNAME NVARCHAR(512),CONTENT NVARCHAR(MAX))
INSERT INTO @MAINCATE
SELECT (SELECT ENTITYVALUE FROM ENTITYTRANSLATION WHERE ENTITYTYPE='MAIN_CTG' AND LANGUAGEID=@LANGUAGEID AND PARENTID=SCO.MAINCATEGORYID),
 (SELECT ENTITYVALUE FROM ENTITYTRANSLATION WHERE ENTITYTYPE='SUB_CTG' AND LANGUAGEID=@LANGUAGEID AND PARENTID=SCO.MAINCATEGORYID AND ENTITYID=SCO.SUBCATEGORYID),
'<tr><td style="text-align:center">'+(SELECT ENTITYVALUE FROM ENTITYTRANSLATION WHERE ENTITYTYPE='MAIN_CTG' AND LANGUAGEID=@LANGUAGEID AND PARENTID=SCO.MAINCATEGORYID)+'</td>' +
'<td style="text-align:center">'+(SELECT ENTITYVALUE FROM ENTITYTRANSLATION WHERE ENTITYTYPE='SUB_CTG' AND LANGUAGEID=@LANGUAGEID AND PARENTID=SCO.MAINCATEGORYID AND ENTITYID=SCO.SUBCATEGORYID) +'</td>'+
'<td style="text-align:center">'+CAST(SCO.UNSAFE AS NVARCHAR(8))+'</td>'+
'<td style="text-align:center">'+ISNULL(SCC.UNSAFECOMMENTS,'')+'</td></tr>'
	FROM STOPCARDENTRYOBSERVATIONS SCO
	LEFT JOIN STOPCARDENTRYCATEGORYCOMMENTS SCC ON SCC.CARDID=SCO.CARDID AND SCC.MAINCATEGORYID=SCO.MAINCATEGORYID AND SCC.SUBCATEGORYID=SCO.SUBCATEGORYID
	WHERE UNSAFE>0 AND SCO.CARDID=@CARDID
	AND SCO.CARDID=@CARDID
	UNION
	SELECT (SELECT ENTITYVALUE FROM ENTITYTRANSLATION WHERE ENTITYTYPE='MAIN_CTG' AND LANGUAGEID=@LANGUAGEID AND PARENTID=SCO.MAINCATEGORYID),
	(SELECT ENTITYVALUE FROM ENTITYTRANSLATION WHERE ENTITYTYPE='SUB_CTG' AND LANGUAGEID=@LANGUAGEID AND PARENTID=SCO.MAINCATEGORYID AND ENTITYID=SCO.SUBCATEGORYID),
	'<tr>
		<td style="text-align:center">'+(SELECT ENTITYVALUE FROM ENTITYTRANSLATION WHERE ENTITYTYPE='MAIN_CTG' AND LANGUAGEID=@LANGUAGEID AND PARENTID=SCO.MAINCATEGORYID)+'</td>' +
		'<td style="text-align:center">'+(SELECT ENTITYVALUE FROM ENTITYTRANSLATION WHERE ENTITYTYPE='SUB_CTG' AND LANGUAGEID=@LANGUAGEID AND PARENTID=SCO.MAINCATEGORYID AND ENTITYID=SCO.SUBCATEGORYID) +'</td>'+
		'<td style="text-align:center">'+CAST(SCO.UNSAFE AS NVARCHAR(8))+'</td>'+
		'<td style="text-align:center">'+ISNULL(SCC.UNSAFECOMMENTS,'')+'</td>
	</tr>'
	FROM STOPCARDENTRYOBSERVATIONS SCO
	INNER JOIN STOPCARDENTRYCATEGORYCOMMENTS SCC ON SCC.CARDID=SCO.CARDID AND SCC.MAINCATEGORYID=SCO.MAINCATEGORYID AND SCC.SUBCATEGORYID=SCO.SUBCATEGORYID
	WHERE ISNULL(UNSAFE,0)=0 AND SCO.CARDID=@CARDID
	AND SCO.CARDID=@CARDID
	
	SELECT @UNSAFEACTDETAILS=@UNSAFEACTDETAILS+CONTENT FROM @MAINCATE ORDER BY MAINCATEGORYNAME,SUBCATEGORYNAME
	SET @UNSAFEACTDETAILS=@UNSAFEACTDETAILS+'</tbody></table>'

SELECT @BODY=REPLACE(@BODY,'unsafeactdetails',@UNSAFEACTDETAILS)

INSERT INTO USERINBOX(COMPANYID,USERID,[FROM],REPLYTO,[TO],CC,BCC,[SUBJECT],BODY,SENTDATE,READSTATUS,[TYPE],[STATUS],TOKENID)
SELECT DISTINCT  S.COMPANYID,@AREAMGRID,@FROM [FROM],REPLYTO [REPLYTO],@AREAMGREMAILID [TO],@ENTEREDBYEMAILID CC,'' BCC,SUBJECT [SUBJECT],DBO.REGEXREPLACE(@BODY,'02|03|42|41|35|38|06|07|47|48|49|08',@MGRLASTNAME+'|'+@MGRFIRSTNAME+'|'+@ENTEREDBY+'|'+CAST(@CARDID AS NVARCHAR(8))+'|'+@OBSERVERNAME+'|'+CONVERT(NVARCHAR(32),@OBSERVATIONDATE,@DATEFORMAT)+'|'+@SITENAME+'|'+@AREANAME+'|'+ISNULL(@CUSTOMFIELD1,'NA')+'|'+ISNULL(@CUSTOMFIELD2,'NA')+'|'+ISNULL(@CUSTOMFIELD3,'NA')+'|'+@SHIFTNAME) BODY,GETUTCDATE() SENTDATE,0 READSTATUS,1,1,S.SCHEDULEID
FROM SCHEDULE S
WHERE S.SCHEDULETYPEID=17

SELECT DISTINCT SCHEDULEID,COMPANYID,0 USERID, @FROM [FROM],REPLYTO [REPLYTO],@AREAMGREMAILID [TO],@ENTEREDBYEMAILID CC,'' BCC,SUBJECT [SUBJECT],DBO.REGEXREPLACE(@BODY,'02|03|42|41|35|38|06|07|47|48|49|08',@MGRLASTNAME+'|'+@MGRFIRSTNAME+'|'+@ENTEREDBY+'|'+CAST(@CARDID AS NVARCHAR(8))+'|'+@OBSERVERNAME+'|'+CONVERT(NVARCHAR(32),@OBSERVATIONDATE,@DATEFORMAT)+'|'+@SITENAME+'|'+@AREANAME+'|'+ISNULL(@CUSTOMFIELD1,'NA')+'|'+ISNULL(@CUSTOMFIELD2,'NA')+'|'+ISNULL(@CUSTOMFIELD3,'NA')+'|'+@SHIFTNAME) BODY,GETUTCDATE() SENTDATE ,0 READSTATUS,@URL URL
FROM SCHEDULE WHERE SCHEDULETYPEID=17

SELECT @DATEFORMAT=DATEFORMAT,@LANGUAGEID=LANGUAGEID FROM USERINFO WHERE USERID=@CREATEDBY

IF @AREAMGRID!=@CREATEDBY
INSERT INTO USERINBOX(COMPANYID,USERID,[FROM],REPLYTO,[TO],CC,BCC,[SUBJECT],BODY,SENTDATE,READSTATUS,[TYPE],[STATUS],TOKENID)
SELECT DISTINCT  S.COMPANYID,@CREATEDBY,@FROM [FROM],REPLYTO [REPLYTO],@AREAMGREMAILID [TO],@ENTEREDBYEMAILID CC,'' BCC,SUBJECT [SUBJECT],DBO.REGEXREPLACE(@BODY,'02|03|42|41|35|38|06|07|47|48|49|08',@MGRLASTNAME+'|'+@MGRFIRSTNAME+'|'+@ENTEREDBY+'|'+CAST(@CARDID AS NVARCHAR(8))+'|'+@OBSERVERNAME+'|'+CONVERT(NVARCHAR(32),@OBSERVATIONDATE,@DATEFORMAT)+'|'+@SITENAME+'|'+@AREANAME+'|'+ISNULL(@CUSTOMFIELD1,'NA')+'|'+ISNULL(@CUSTOMFIELD2,'NA')+'|'+ISNULL(@CUSTOMFIELD3,'NA')+'|'+@SHIFTNAME) BODY,GETUTCDATE() SENTDATE,0 READSTATUS,1,1,S.SCHEDULEID
FROM SCHEDULE S
WHERE S.SCHEDULETYPEID=17


