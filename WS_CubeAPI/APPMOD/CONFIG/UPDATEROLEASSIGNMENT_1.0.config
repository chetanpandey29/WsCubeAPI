--UPDATEROLEASSIGNMENT_1.0
DECLARE @CC_TIMESTAMP DATETIME
SET @CC_TIMESTAMP=GETDATE()

CREATE TABLE #USERLIST(USERID INT)
INSERT INTO #USERLIST(USERID)
SELECT RESULT FROM DBO.CSVTOTABLE(@USERID)

UPDATE UR SET STATUS = 0,UPDATEDBY=@UPDATEDBY,UPDATEDDATE= @CC_TIMESTAMP
FROM USERROLES UR
WHERE ROLEID = @ROLEID AND NOT EXISTS(SELECT 1 FROM #USERLIST WHERE USERID=UR.USERID)


UPDATE UI SET DEFAULTROLEID=-1,UPDATEDBY=@UPDATEDBY,UPDATEDDATE= @CC_TIMESTAMP
FROM USERINFO  UI
WHERE NOT EXISTS(SELECT 1 FROM #USERLIST WHERE USERID = UI.USERID)
AND DEFAULTROLEID= @ROLEID

UPDATE UR SET STATUS = 1,@UPDATEDBY=@UPDATEDBY,UPDATEDDATE= @CC_TIMESTAMP
FROM  USERROLES UR
INNER JOIN #USERLIST U ON U.USERID=UR.USERID
WHERE UR.ROLEID = @ROLEID

UPDATE UI SET DEFAULTROLEID=@ROLEID,UPDATEDBY=@UPDATEDBY,UPDATEDDATE= @CC_TIMESTAMP
FROM USERINFO UI
INNER JOIN #USERLIST U ON U.USERID=UI.USERID

INSERT INTO USERROLES(USERID,ROLEID,STATUS,UPDATEDBY,UPDATEDDATE)
SELECT USERID,@ROLEID,1,@UPDATEDBY,@CC_TIMESTAMP FROM #USERLIST U
WHERE NOT EXISTS(SELECT 1 FROM USERROLES WHERE ROLEID = @ROLEID AND USERID=U.USERID)

--DECLARE @USERROLES TABLE(ID INT IDENTITY(1,1),USERID INT,ROLEID INT)
--INSERT INTO @USERROLES(USERID,ROLEID)
--SELECT UI.USERID,@ROLEID FROM [dbo].USERINFO UI WHERE UI.USERID IN (SELECT RESULT FROM DBO.CSVTOTABLE(@USERID))
----AND NOT EXISTS(SELECT 1 FROM USERQUICKLINKS WHERE USERID =UI.USERID)
--DELETE FROM USERQUICKLINKS WHERE USERID IN (SELECT RESULT FROM DBO.CSVTOTABLE(@USERID))
--DECLARE @TEMP INT, @USERID1 INT

--SET @TEMP=1
--WHILE @TEMP<=(SELECT MAX(ID) FROM @USERROLES)
--BEGIN
--SELECT @USERID1=USERID,@ROLEID=ROLEID FROM @USERROLES WHERE ID=@TEMP

--INSERT INTO [dbo].USERQUICKLINKS
--SELECT TOP 5 @USERID1,@ROLEID,RP.PERMISSIONID,1,1,@CC_TIMESTAMP FROM ROLEPERMISSIONS RP
--INNER JOIN PERMISSIONS P ON P.PERMISSIONID=RP.PERMISSIONID
--WHERE PERMISSIONVALUE=1 AND ROLEID=@ROLEID AND P.PARENTID<>0 AND P.ISMENUDISPLAY<>0

--SET @TEMP=@TEMP+1
--END

SELECT 2

INSERT INTO dbo.AUDIT(TABLENAME,TRANS,STAMP,LASTUPDATEDBY,DATA)
SELECT 'USERINFO/USERROLES','UPDATE-UPDATEROLEASSIGNMENT_1.0',@CC_TIMESTAMP,@UPDATEDBY,
(SELECT * FROM USERINFO WHERE UPDATEDBY=@UPDATEDBY AND UPDATEDDATE=@CC_TIMESTAMP FOR XML AUTO)

DROP TABLE #USERLIST
