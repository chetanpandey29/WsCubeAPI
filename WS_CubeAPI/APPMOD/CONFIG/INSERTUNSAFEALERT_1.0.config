DECLARE @TAB TABLE(ID INT IDENTITY(1,1),COL VARCHAR(MAX))
DECLARE @TEMP INT,@OPTIONID INT,@OPTIONLIST VARCHAR(MAX),@SCHEDULEID INT
SELECT @SCHEDULEID =SCHEDULEID FROM SCHEDULE WHERE SCHEDULETYPEID=12 AND STATUS =1

SET @TEMP = 1
INSERT INTO @TAB
SELECT ITEM
FROM dbo.FNSPLIT(@OPTIONVALUE,';')
IF @SCHEDULEID>0
BEGIN
DELETE FROM SCHEDULEASSIGNMENTS WHERE SCHEDULEID=@SCHEDULEID AND ALERTUSERID=@USERID

WHILE @TEMP < =(SELECT MAX(ID) FROM @TAB)
     BEGIN
       SELECT @OPTIONID=OPTIONID FROM REPORTOPTIONSMASTER WHERE REPORTPARAM=(SELECT SUBSTRING(COL,1,CHARINDEX('=',COL)-1) FROM @TAB WHERE ID = @TEMP)
       SELECT @OPTIONLIST=SUBSTRING(COL,CHARINDEX('=',COL)+1,LEN(COL)) FROM @TAB WHERE ID = @TEMP
       INSERT INTO SCHEDULEASSIGNMENTS(SCHEDULEID,OPTIONID,OPTIONVALUE,ALERTUSERID,UPDATEDBY,UPDATEDDATE)
       SELECT @SCHEDULEID,@OPTIONID,RESULT,@USERID,@USERID,GETDATE() FROM DBO.CSVtoTable(@OPTIONLIST)
       SET @TEMP = @TEMP +1
     END
END

IF NOT EXISTS(SELECT 1 FROM SCHEDULEASSIGNMENTS WHERE SCHEDULEID=@SCHEDULEID AND ALERTUSERID=@USERID)
  INSERT INTO SCHEDULEASSIGNMENTS(SCHEDULEID,ALERTUSERID,UPDATEDBY,UPDATEDDATE)
  SELECT @SCHEDULEID,@USERID,@USERID,GETDATE()