DECLARE @CC_TIMESTAMP DATETIME
SET @CC_TIMESTAMP=GETDATE()

DECLARE @USERNAME VARCHAR(MAX),@RANDOMPWD NVARCHAR(16)
DECLARE @USERID INT,@LANGUAGEID INT,@TIMEZONEID INT,@DATEFORMAT INT
SET @RANDOMPWD=''
IF EXISTS(SELECT 1 FROM USERS WHERE EMAIL=@EMAIL AND STATUS !=2 )AND LEN(@EMAIL)>0
SELECT -1
ELSE
BEGIN
SELECT @RANDOMPWD=dbo.GETRANDOMPASSWORD()

INSERT INTO USERS(COMPANYID,FIRSTNAME,LASTNAME,EMAIL,PASSWORD,STATUS,CREATEDBY,CREATEDDATE) VALUES (@COMPANYID,@FIRSTNAME,@LASTNAME,@EMAIL,dbo.fn40Encrypt(@RANDOMPWD),1,@CREATEDBY,@CC_TIMESTAMP)
SELECT @USERID=@@IDENTITY
SELECT @USERNAME= @LASTNAME + CAST(@USERID AS VARCHAR(8))

SELECT @LANGUAGEID=(SELECT LANGUAGEID FROM LANGUAGES WHERE INTERNALNAME=OPTIONVALUE) FROM COMPANYOPTIONS WHERE OPTIONNAME='Languages'
--SELECT @TIMEZONEID=OPTIONVALUE FROM COMPANYOPTIONS WHERE OPTIONNAME='Timezone'
SELECT @TIMEZONEID= TIMEZONEID FROM SITES WHERE SITEID=@SITEID
SELECT @DATEFORMAT=OPTIONVALUE FROM COMPANYOPTIONS WHERE OPTIONNAME='DefaultDateFormat'

UPDATE USERS SET USERNAME= @USERNAME WHERE USERID = @USERID
INSERT INTO USERINFO(USERID,JOBTITLE,USERTYPEID,LOGINATTEMPTS,DEFAULTSITEID,LANGUAGEID,TIMEZONE,DATEFORMAT,OFFLINEACCESS,UPDATEDBY,UPDATEDDATE) VALUES(@USERID,@JOBTITLE,1,0,@SITEID,@LANGUAGEID,@TIMEZONEID,@DATEFORMAT,0,@CREATEDBY,@CC_TIMESTAMP)

INSERT INTO USERSITES(USERID,SITEID,STATUS,UPDATEDDATE,UPDATEDBY) VALUES (@USERID,@SITEID,1,@CC_TIMESTAMP,@UPDATEDBY)

--USERGROUPS
UPDATE UG SET UG.STATUS = 1, UG.UPDATEDBY = @CREATEDBY, UG.UPDATEDDATE = @CC_TIMESTAMP
FROM USERGROUPS UG
INNER JOIN GROUPS G ON G.GROUPID = UG.GROUPID AND G.GROUPTYPEID = UG.GROUPTYPEID
WHERE UG.[STATUS] = 0 AND UG.USERID =@USERID AND
G.GROUPID IN (SELECT RESULT FROM DBO.CSVtoTable(@GROUPID));

INSERT INTO USERGROUPS(USERID,GROUPTYPEID,GROUPID,STATUS,UPDATEDBY,UPDATEDDATE)
SELECT @USERID,G.GROUPTYPEID,T.RESULT,1,@CREATEDBY,@CC_TIMESTAMP FROM DBO.CSVtoTable(@GROUPID) T
INNER JOIN GROUPS G ON G.GROUPID = T.RESULT
WHERE RESULT NOT IN (SELECT GROUPID FROM USERGROUPS WHERE USERID =@USERID);

UPDATE USERGROUPS SET STATUS = 0,UPDATEDBY = @CREATEDBY,UPDATEDDATE = @CC_TIMESTAMP
WHERE USERID =@USERID AND GROUPID NOT IN (SELECT RESULT FROM DBO.CSVtoTable(@GROUPID))

SELECT @USERID
END
INSERT INTO dbo.AUDIT(TABLENAME,TRANS,STAMP,LASTUPDATEDBY,DATA)
SELECT 'USERS/USERINFO/USERSITES/USERGROUPS','INSERT-INSERTNEWOBSERVER_1.0',@CC_TIMESTAMP,@CREATEDBY,
(SELECT * FROM USERS WHERE CREATEDBY=@CREATEDBY AND CREATEDDATE=@CC_TIMESTAMP FOR XML AUTO)

INSERT INTO dbo.AUDIT(TABLENAME,TRANS,STAMP,LASTUPDATEDBY,DATA)
SELECT 'USERS/USERINFO/USERSITES/USERGROUPS','INSERT-INSERTNEWOBSERVER_1.0',@CC_TIMESTAMP,@CREATEDBY,
(SELECT * FROM USERINFO WHERE UPDATEDBY=@CREATEDBY AND UPDATEDDATE=@CC_TIMESTAMP FOR XML AUTO)

