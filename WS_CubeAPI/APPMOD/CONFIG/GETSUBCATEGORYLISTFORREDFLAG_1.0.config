IF @MODE=0
BEGIN

SELECT SC.SUBCATEGORYID,ET.ENTITYVALUE  [SUBCATEGORYNAME]
FROM SUBCATEGORIES SC
INNER JOIN ENTITYTRANSLATION ET ON ET.PARENTID = SC.MAINCATEGORYID AND ET.ENTITYID = SC.SUBCATEGORYID
INNER JOIN CHECKLISTSETUPCATEGORYASSIGNMENTS CS ON CS.SUBCATEGORYID=SC.SUBCATEGORYID
WHERE SC.MAINCATEGORYID = CASE WHEN @MAINCATEGORYID = -1 THEN SC.MAINCATEGORYID ELSE @MAINCATEGORYID END AND CS.SUBISASSIGNED = 1 AND CS.CHECKLISTSETUPID = @CHECKLISTSETUPID
AND LANGUAGEID=@LANGUAGECODE AND ET.ENTITYTYPE='SUB_CTG' AND SC.STATUS = 1 ORDER BY SUBCATEGORYNAME

END
ELSE
BEGIN
IF EXISTS (SELECT 1 FROM REDFLAGS WHERE REDFLAGID=@REDFLAGID AND SUBCATEGORYID=-1)

SELECT SC.SUBCATEGORYID,ET.ENTITYVALUE  [SUBCATEGORYNAME]
FROM SUBCATEGORIES SC
INNER JOIN ENTITYTRANSLATION ET ON ET.PARENTID = SC.MAINCATEGORYID AND ET.ENTITYID = SC.SUBCATEGORYID
INNER JOIN CHECKLISTSETUPCATEGORYASSIGNMENTS CS ON CS.SUBCATEGORYID=SC.SUBCATEGORYID
WHERE SC.MAINCATEGORYID = CASE WHEN @MAINCATEGORYID = -1 THEN SC.MAINCATEGORYID ELSE @MAINCATEGORYID END AND CS.SUBISASSIGNED IN(1) AND CS.CHECKLISTSETUPID = @CHECKLISTSETUPID
AND LANGUAGEID=@LANGUAGECODE AND ET.ENTITYTYPE='SUB_CTG' AND SC.STATUS IN(1) ORDER BY SUBCATEGORYNAME
ELSE
SELECT SUBCATEGORYID,[SUBCATEGORYNAME] FROM (
SELECT SC.SUBCATEGORYID,ET.ENTITYVALUE+CASE WHEN CS.SUBISASSIGNED =0 OR SC.STATUS = 0 THEN ' (Unassigned) ' ELSE '' END   [SUBCATEGORYNAME]
FROM SUBCATEGORIES SC
INNER JOIN REDFLAGS RF ON RF.REDFLAGID=@REDFLAGID AND RF.SUBCATEGORYID=SC.SUBCATEGORYID
INNER JOIN ENTITYTRANSLATION ET ON ET.PARENTID = SC.MAINCATEGORYID AND ET.ENTITYID = SC.SUBCATEGORYID
INNER JOIN CHECKLISTSETUPCATEGORYASSIGNMENTS CS ON CS.SUBCATEGORYID=SC.SUBCATEGORYID
WHERE SC.MAINCATEGORYID = CASE WHEN @MAINCATEGORYID = -1 THEN SC.MAINCATEGORYID ELSE @MAINCATEGORYID END AND CS.SUBISASSIGNED IN(0,1) AND CS.CHECKLISTSETUPID = @CHECKLISTSETUPID
AND LANGUAGEID=@LANGUAGECODE AND ET.ENTITYTYPE='SUB_CTG' AND SC.STATUS IN(0,1)
UNION
SELECT SC.SUBCATEGORYID,ET.ENTITYVALUE  [SUBCATEGORYNAME]
FROM SUBCATEGORIES SC
INNER JOIN ENTITYTRANSLATION ET ON ET.PARENTID = SC.MAINCATEGORYID AND ET.ENTITYID = SC.SUBCATEGORYID
INNER JOIN CHECKLISTSETUPCATEGORYASSIGNMENTS CS ON CS.SUBCATEGORYID=SC.SUBCATEGORYID
WHERE SC.MAINCATEGORYID = CASE WHEN @MAINCATEGORYID = -1 THEN SC.MAINCATEGORYID ELSE @MAINCATEGORYID END AND CS.SUBISASSIGNED IN(1) AND CS.CHECKLISTSETUPID = @CHECKLISTSETUPID
AND LANGUAGEID=@LANGUAGECODE AND ET.ENTITYTYPE='SUB_CTG' AND SC.STATUS IN(1)
AND SC.SUBCATEGORYID NOT IN (SELECT SUBCATEGORYID FROM REDFLAGS WHERE REDFLAGID = @REDFLAGID)
) A ORDER BY SUBCATEGORYNAME
END

